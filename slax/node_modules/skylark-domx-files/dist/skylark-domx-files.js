/**
 * skylark-domx-files - The filer features enhancement for skylark utils.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.1
 * @link www.skylarkjs.org
 * @license MIT
 */
!function(e,i){var t=i.define,require=i.require,s="function"==typeof t&&t.amd,n=!s&&"undefined"!=typeof exports;if(!s&&!t){var a={};t=i.define=function(e,i,t){"function"==typeof t?(a[e]={factory:t,deps:i.map(function(i){return function(e,i){if("."!==e[0])return e;var t=i.split("/"),s=e.split("/");t.pop();for(var n=0;n<s.length;n++)"."!=s[n]&&(".."==s[n]?t.pop():t.push(s[n]));return t.join("/")}(i,e)}),resolved:!1,exports:null},require(e)):a[e]={factory:null,resolved:!0,exports:t}},require=i.require=function(e){if(!a.hasOwnProperty(e))throw new Error("Module "+e+" has not been defined");var module=a[e];if(!module.resolved){var t=[];module.deps.forEach(function(e){t.push(require(e))}),module.exports=module.factory.apply(i,t)||null,module.resolved=!0}return module.exports}}if(!t)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(e,require){e("skylark-domx-files/files",["skylark-langx/skylark"],function(e){var i=function(){return i};return e.attach("domx.files",i)}),e("skylark-domx-files/dropzone",["skylark-langx/arrays","skylark-langx/Deferred","skylark-domx-styler","skylark-domx-eventer","./files","skylark-io-diskfs/webentry"],function(e,i,t,s,n,a){return n.dropzone=function(i,n){var r=(n=n||{}).hoverClass||"dropzone",l=n.dropped,o=0;return s.on(i,"dragenter",function(e){e.dataTransfer&&e.dataTransfer.types.indexOf("Files")>-1&&(s.stop(e),o++,t.addClass(i,r))}),s.on(i,"dragover",function(e){e.dataTransfer&&e.dataTransfer.types.indexOf("Files")>-1&&s.stop(e)}),s.on(i,"dragleave",function(e){e.dataTransfer&&e.dataTransfer.types.indexOf("Files")>-1&&0==--o&&t.removeClass(i,r)}),s.on(i,"drop",function(n){if(n.dataTransfer&&n.dataTransfer.types.indexOf("Files")>-1&&(t.removeClass(i,r),s.stop(n),l)){var o=n.dataTransfer.items;o&&o.length&&(o[0].webkitGetAsEntry||o[0].getAsEntry)?a.all(e.map(o,function(e){return e.webkitGetAsEntry?e.webkitGetAsEntry():e.getAsEntry()})).then(l):l(n.dataTransfer.files)}}),this}}),e("skylark-domx-files/pastezone",["skylark-langx/objects","skylark-domx-eventer","./files"],function(e,i,t){return t.pastezone=function(t,s){(s=s||{}).hoverClass;var n=s.pasted;return i.on(t,"paste",function(i){var t=i.originalEvent&&i.originalEvent.clipboardData&&i.originalEvent.clipboardData.items,s=[];t&&t.length&&e.each(t,function(e,i){var t=i.getAsFile&&i.getAsFile();t&&s.push(t)}),n&&s.length&&n(s)}),this}}),e("skylark-domx-files/picker",["skylark-langx/objects","skylark-domx-eventer","./files","skylark-io-diskfs/select"],function(e,i,t,s){return t.picker=function(e,t){return i.on(e,"click",function(e){e.preventDefault(),s(t)}),this}}),e("skylark-domx-files/MultiUploader",["skylark-langx/skylark","skylark-langx/langx","skylark-domx-query","skylark-domx-velm","skylark-net-http/Upload","skylark-domx-plugins","./files"],function(e,i,t,s,n,a,r){var l=a.Plugin.inherit({klassName:"Uploader",pluginName:"lark.multiuploader",options:{uploadUrl:"/upload",params:{formParamName:"file"},maxConnections:3,allowedExtensions:[],sizeLimit:0,minSizeLimit:0,autoUpload:!1,selectors:{fileList:".file-list",fileItem:".file-item",nodata:".file-list .no-data",picker:".file-picker",dropzone:".file-dropzone",pastezone:".file-pastezone",startUploads:".start-uploads",cancelUploads:".cancel-uploads"},template:'<div class="lark-multiuploader">    <h3 class="popover-title">Upload files</h3>    <div class="popover-content container-fluid" class="file-list file-dropzone file-pastezone">        <div class="no-data"><em>Add files.</em></div>    </div>    <footer>        <button class="btn btn-warning pull-right btn-sm" id="cancel-uploads-button"><i class="icon-cancel"></i>Cancel uploads</button>        <span class="btn btn-success fileinput-button btn-sm" id="fileinput-button">            <i class="icon-plus"></i>            <span>Add files...</span>            <input id="fileupload" type="file" name="files[]" multiple="multiple">        </span>        <button class="btn btn-primary btn-sm" id="start-uploads-button"><i class="icon-start"></i>Start uploads</button>    </footer></div>',dataType:"json",fileItem:{selectors:{name:".name",size:".size",cancel:".cancel",clear:".clear",progress:".progress",message:".message"},template:'<div class="file-item row">   <div class="col-md-6"><span class="name"></span></div>   <div class="col-md-3">    <span class="size"></span>    <div class="progress hidden">        <div class="progress-label"></div>        <div class="bar"></div>    </div>    <span class="message hidden"></span>   </div>   <div class="col-md-3">    <button class="btn btn-warning btn-xs cancel"><i class="icon-remove"></i>Cancel</button>    <button class="btn btn-xs clear hidden">Clear</button>   </div></div>'}},_construct:function(e,i){this.overrided(e,i),this._velm=s(this._elm),this._initEventHandler(),this._initFileHandlers(),this._initUpoadHandler(),this._updateFileList()},_initFileHandlers:function(){var e=this,i=this.options.selectors,t=i.dropzone,s=i.pastezone,n=i.picker;t&&this._velm.$(t).dropzone({dropped:function(i){e._addFiles(i)}}),s&&this._velm.$(s).pastezone({pasted:function(i){e._addFiles(i)}}),n&&this._velm.$(n).picker({multiple:!0,picked:function(i){e._addFiles(i)}})},_initUpoadHandler:function(){var e=this;this._handler=new n({url:this.options.uploadUrl,maxConnections:this.options.maxConnections,onProgress:function(i,t,s,n){e._onProgress(i,t,s,n)},onComplete:function(i,t,s){e._onComplete(i,t,s)},onCancel:function(i,t){e._onCancel(i,t)},onFailure:function(i,t,s){e._onFailure(i,t,s)}})},_initEventHandler:function(){var e=this,i=this.options.selectors,s=this.options.fileItem.selectors;this._listElement;this._velm.$(i.fileList).on("click",s.cancel,function(s){var n=t(this).closest(i.fileItem),a=n.data("fileId");e._handler.cancel(a),n.remove(),e._updateFileList()}),this._velm.$(i.fileList).on("click",s.clear,function(s){var n=t(this).closest(i.fileItem);n.data("fileId");n.remove(),e._updateFileList()}),this._velm.$(i.cancelUploads).click(function(){var s=e._velm.$(i.fileList).find(i.fileItem);s.forEach(function(i){var s=t(i),n=s.data("fileId");e._handler.cancel(n),s.remove()}),e._updateFileList()}),this._velm.$(i.startUploads).click(function(){var s=e._velm.$(i.fileList).find(i.fileItem);s.forEach(function(i){var s=t(i),n=s.data("fileId");s.data("status")||e._handler.send(n,e.options.params)})})},_onProgress:function(e,i,t,s){var n=this._getItemByFileId(e),a=parseInt(t/s*100,10),r=this._formatSize(t)+" of "+this._formatSize(s);n.data("status","running"),n.find(".progress").find(".bar").css("width",a+"%").parent().find(".progress-label").html(r),this._updateFile(n)},_onComplete:function(e,i,t){this._filesInProgress--;var s=this._getItemByFileId(e);s.data("status","done"),s.find(".message").html('<i class="icon-success"></i> '+(this.doneMsg||"Uploaded")),this._updateFile(s)},_onFailure:function(e,i,t){this._filesInProgress--;var s=this._getItemByFileId(e);s.data("status","error"),s.find(".message").html('<i class="icon-error"></i> '),this._updateFile(s)},_onCancel:function(e,i){this._filesInProgress--;var t=this._getItemByFileId(e);t.data("status","cancel"),this._updateFile(t)},_addToList:function(e,i){var i=this._handler.getName(e),s=this._handler.getSize(e),n=t(this.options.fileItem.template);n.data("fileId",e),n.find(this.options.fileItem.selectors.name).html(this._formatFileName(i)),n.find(this.options.fileItem.selectors.size).html(this._formatSize(s)),this._velm.$(this.options.selectors.fileList).append(n),this._updateFileList()},_updateFileList:function(){var e=this.options.selectors,i=(this.options.fileItem.selectors,this._velm.$(e.fileList).find(e.fileItem)),t=this._velm.$(e.cancelUploads+","+e.startUploads),s=this._velm.$(e.nodata);i.length>0?(t.removeClass("hidden"),s.addClass("hidden")):(t.addClass("hidden"),s.removeClass("hidden"))},_updateFile:function(e){var i=this.options.fileItem.selectors,t=e.find(i.size+","+i.cancel),s=e.find(i.progress+","+i.cancel),n=e.find(i.message+","+i.clear),a=e.data("status");"pending"==a?(s.add(n).addClass("hidden"),t.removeClass("hidden")):"running"==a?(t.add(n).addClass("hidden"),s.removeClass("hidden")):"done"!=a&&"error"!=a||(t.add(s).addClass("hidden"),n.removeClass("hidden"))},_getItemByFileId:function(e){for(var i,s=this.options.selectors,n=this._velm.$(s.fileList).find(s.fileItem),a=0;a<n.length;a++){var r=n[a];if(t(r).data("fileId")==e){i=r;break}}if(i)return t(i)},_addFiles:function(e){for(var i=0;i<e.length;i++)if(!this._validateFile(e[i]))return;for(var i=0;i<e.length;i++)this._addFile(e[i])},_addFile:function(e){var i=this._handler.add(e);this._filesInProgress++,this._addToList(i)},_validateFile:function(e){var i,t;return e.value?i=e.value.replace(/.*(\/|\\)/,""):(i=null!=e.fileName?e.fileName:e.name,t=null!=e.fileSize?e.fileSize:e.size),this._isAllowedExtension(i)?0===t?(this._error("emptyError",i),!1):t&&this.options.sizeLimit&&t>this.options.sizeLimit?(this._error("sizeError",i),!1):!(t&&t<this.options.minSizeLimit)||(this._error("minSizeError",i),!1):(this._error("typeError",i),!1)},_error:function(e,i){var t=this.options.messages[e];function s(e,i){t=t.replace(e,i)}s("{file}",this._formatFileName(i)),s("{extensions}",this.options.allowedExtensions.join(", ")),s("{sizeLimit}",this._formatSize(this.options.sizeLimit)),s("{minSizeLimit}",this._formatSize(this.options.minSizeLimit)),this.options.showMessage(t)},_formatFileName:function(e){return e.length>33&&(e=e.slice(0,19)+"..."+e.slice(-13)),e},_isAllowedExtension:function(e){var i=-1!==e.indexOf(".")?e.replace(/.*[.]/,"").toLowerCase():"",t=this.options.allowedExtensions;if(!t.length)return!0;for(var s=0;s<t.length;s++)if(t[s].toLowerCase()==i)return!0;return!1},_formatSize:function(e){var i=-1;do{e/=1024,i++}while(e>99);return Math.max(e,.1).toFixed(1)+["KB","MB","GB","TB","PB","EB"][i]}});return a.register(l),r.MultiUploader=l}),e("skylark-domx-files/main",["./files","skylark-domx-velm","skylark-domx-query","./dropzone","./pastezone","./picker","./MultiUploader"],function(e,i,t){return i.delegate(["dropzone","pastezone","picker"],e),t.fn.pastezone=t.wraps.wrapper_every_act(e.pastezone,e),t.fn.dropzone=t.wraps.wrapper_every_act(e.dropzone,e),t.fn.picker=t.wraps.wrapper_every_act(e.picker,e),e}),e("skylark-domx-files",["skylark-domx-files/main"],function(e){return e})}(t),!s){var r=require("skylark-langx-ns");n?module.exports=r:i.skylarkjs=r}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-domx-files.js.map
