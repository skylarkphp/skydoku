{"version":3,"sources":["addons/state.js"],"names":["define","langx","browser","eventer","noder","geom","$","jstree","plugins","state","to","defaults","key","events","ttl","filter","preserve_loaded","options","parent","this","bind","call","proxy","element","on","settings","clearTimeout","setTimeout","save_state","trigger","e","data","one","restore_state","tm","get_state","core","loaded","st","sec","Date","vakata","storage","set","JSON","stringify","k","get","parse","ex","isFunction","instance","extend","set_state","clear_state","del","undefined","val","window","localStorage","setItem","getItem","removeItem"],"mappings":";;;;;;;AAAAA,QACE,sBACA,uBACA,uBACA,qBACA,oBACA,qBACA,gBACA,SAASC,EAAMC,EAAQC,EAAQC,EAAMC,EAAKC,EAAEC,GAE7C,aAEA,IAAGD,EAAEC,OAAOC,QAAQC,MAApB,CAEA,IAAIC,GAAK,EAoHT,OA9GAJ,EAAEC,OAAOI,SAASF,OAMjBG,IAAO,SAMPC,OAAS,0FAMTC,KAAO,EAMPC,QAAS,EAMTC,iBAAkB,GAEnBV,EAAEC,OAAOC,QAAQC,MAAQ,SAAUQ,EAASC,GAC3CC,KAAKC,KAAO,WACXF,EAAOE,KAAKC,KAAKF,MACjB,IAAIC,EAAOnB,EAAMqB,MAAM,WACtBH,KAAKI,QAAQC,GAAGL,KAAKM,SAAShB,MAAMI,OAAQZ,EAAMqB,MAAM,WACpDZ,GAAMgB,aAAahB,GACtBA,EAAKiB,WAAW1B,EAAMqB,MAAM,WAAcH,KAAKS,cAAiBT,MAAO,MACrEA,OAOHA,KAAKU,QAAQ,gBACXV,MACHA,KAAKI,QACHC,GAAG,eAAgBvB,EAAMqB,MAAM,SAAUQ,EAAGC,GAC3CZ,KAAKI,QAAQS,IAAI,uBAAwBZ,GACrCD,KAAKc,iBAAmBb,KAC1BD,QAONA,KAAKS,WAAa,WACjB,IAAIM,EAAKf,KAAKgB,YACThB,KAAKM,SAAShB,MAAMO,wBACjBkB,EAAGE,KAAKC,OAEhB,IAAIC,GAAO7B,MAAUyB,EAAIpB,IAAQK,KAAKM,SAAShB,MAAMK,IAAKyB,KAAS,IAAKC,MACxElC,EAAEmC,OAAOC,QAAQC,IAAIxB,KAAKM,SAAShB,MAAMG,IAAKgC,KAAKC,UAAUP,KAO9DnB,KAAKc,cAAgB,WACpB,IAAIa,EAAIxC,EAAEmC,OAAOC,QAAQK,IAAI5B,KAAKM,SAAShB,MAAMG,KACjD,GAAKkC,EAAK,IAAMA,EAAIF,KAAKI,MAAMF,GAAM,MAAMG,GAAM,OAAO,EACxD,QAAKH,GAAKA,EAAEhC,KAAOgC,EAAEP,MAAQ,IAAKC,KAAUM,EAAEP,IAAMO,EAAEhC,OACjDgC,GAAKA,EAAErC,QAASqC,EAAIA,EAAErC,OACtBqC,GAAK7C,EAAMiD,WAAW/B,KAAKM,SAAShB,MAAMM,UAAW+B,EAAI3B,KAAKM,SAAShB,MAAMM,OAAOM,KAAKF,KAAM2B,MAC/FA,IACC3B,KAAKM,SAAShB,MAAMO,wBACjB8B,EAAEV,KAAKC,OAEflB,KAAKI,QAAQS,IAAI,mBAAoB,SAAUF,EAAGC,GAAQA,EAAKoB,SAAStB,QAAQ,iBAAmBpB,MAAUR,EAAMmD,QAAO,KAAUN,OACpI3B,KAAKkC,UAAUP,IACR,KAST3B,KAAKmC,YAAc,WAClB,OAAOhD,EAAEmC,OAAOC,QAAQa,IAAIpC,KAAKM,SAAShB,MAAMG,OAIjD,SAAUN,EAAGkD,GACblD,EAAEmC,OAAOC,SAERC,IAAM,SAAU/B,EAAK6C,GAAO,OAAOC,OAAOC,aAAaC,QAAQhD,EAAK6C,IACpEV,IAAM,SAAUnC,GAAO,OAAO8C,OAAOC,aAAaE,QAAQjD,IAC1D2C,IAAM,SAAU3C,GAAO,OAAO8C,OAAOC,aAAaG,WAAWlD,KAL/D,CAOEN,GAKKA","file":"../../addons/state.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-browser\",\r\n  \"skylark-domx-eventer\",\r\n  \"skylark-domx-noder\",\r\n  \"skylark-domx-geom\",\r\n  \"skylark-domx-query\",\r\n  \"../Hierarchy\"\r\n],function(langx,browser,eventer,noder,geom,$,jstree){\r\n\r\n\t\"use strict\";\r\n\r\n\tif($.jstree.plugins.state) { return; }\r\n\r\n\tvar to = false;\r\n\t/**\r\n\t * stores all defaults for the state plugin\r\n\t * @name $.jstree.defaults.state\r\n\t * @plugin state\r\n\t */\r\n\t$.jstree.defaults.state = {\r\n\t\t/**\r\n\t\t * A string for the key to use when saving the current tree (change if using multiple trees in your project). Defaults to `jstree`.\r\n\t\t * @name $.jstree.defaults.state.key\r\n\t\t * @plugin state\r\n\t\t */\r\n\t\tkey\t\t: 'jstree',\r\n\t\t/**\r\n\t\t * A space separated list of events that trigger a state save. Defaults to `changed.jstree open_node.jstree close_node.jstree`.\r\n\t\t * @name $.jstree.defaults.state.events\r\n\t\t * @plugin state\r\n\t\t */\r\n\t\tevents\t: 'changed.jstree open_node.jstree close_node.jstree check_node.jstree uncheck_node.jstree',\r\n\t\t/**\r\n\t\t * Time in milliseconds after which the state will expire. Defaults to 'false' meaning - no expire.\r\n\t\t * @name $.jstree.defaults.state.ttl\r\n\t\t * @plugin state\r\n\t\t */\r\n\t\tttl\t\t: false,\r\n\t\t/**\r\n\t\t * A function that will be executed prior to restoring state with one argument - the state object. Can be used to clear unwanted parts of the state.\r\n\t\t * @name $.jstree.defaults.state.filter\r\n\t\t * @plugin state\r\n\t\t */\r\n\t\tfilter\t: false,\r\n\t\t/**\r\n\t\t * Should loaded nodes be restored (setting this to true means that it is possible that the whole tree will be loaded for some users - use with caution). Defaults to `false`\r\n\t\t * @name $.jstree.defaults.state.preserve_loaded\r\n\t\t * @plugin state\r\n\t\t */\r\n\t\tpreserve_loaded : false\r\n\t};\r\n\t$.jstree.plugins.state = function (options, parent) {\r\n\t\tthis.bind = function () {\r\n\t\t\tparent.bind.call(this);\r\n\t\t\tvar bind = langx.proxy(function () {\r\n\t\t\t\tthis.element.on(this.settings.state.events, langx.proxy(function () {\r\n\t\t\t\t\tif(to) { clearTimeout(to); }\r\n\t\t\t\t\tto = setTimeout(langx.proxy(function () { this.save_state(); }, this), 100);\r\n\t\t\t\t}, this));\r\n\t\t\t\t/**\r\n\t\t\t\t * triggered when the state plugin is finished restoring the state (and immediately after ready if there is no state to restore).\r\n\t\t\t\t * @event\r\n\t\t\t\t * @name state_ready.jstree\r\n\t\t\t\t * @plugin state\r\n\t\t\t\t */\r\n\t\t\t\tthis.trigger('state_ready');\r\n\t\t\t}, this);\r\n\t\t\tthis.element\r\n\t\t\t\t.on(\"ready.jstree\", langx.proxy(function (e, data) {\r\n\t\t\t\t\t\tthis.element.one(\"restore_state.jstree\", bind);\r\n\t\t\t\t\t\tif(!this.restore_state()) { bind(); }\r\n\t\t\t\t\t}, this));\r\n\t\t};\r\n\t\t/**\r\n\t\t * save the state\r\n\t\t * @name save_state()\r\n\t\t * @plugin state\r\n\t\t */\r\n\t\tthis.save_state = function () {\r\n\t\t\tvar tm = this.get_state();\r\n\t\t\tif (!this.settings.state.preserve_loaded) {\r\n\t\t\t\tdelete tm.core.loaded;\r\n\t\t\t}\r\n\t\t\tvar st = { 'state' : tm, 'ttl' : this.settings.state.ttl, 'sec' : +(new Date()) };\r\n\t\t\t$.vakata.storage.set(this.settings.state.key, JSON.stringify(st));\r\n\t\t};\r\n\t\t/**\r\n\t\t * restore the state from the user's computer\r\n\t\t * @name restore_state()\r\n\t\t * @plugin state\r\n\t\t */\r\n\t\tthis.restore_state = function () {\r\n\t\t\tvar k = $.vakata.storage.get(this.settings.state.key);\r\n\t\t\tif(!!k) { try { k = JSON.parse(k); } catch(ex) { return false; } }\r\n\t\t\tif(!!k && k.ttl && k.sec && +(new Date()) - k.sec > k.ttl) { return false; }\r\n\t\t\tif(!!k && k.state) { k = k.state; }\r\n\t\t\tif(!!k && langx.isFunction(this.settings.state.filter)) { k = this.settings.state.filter.call(this, k); }\r\n\t\t\tif(!!k) {\r\n\t\t\t\tif (!this.settings.state.preserve_loaded) {\r\n\t\t\t\t\tdelete k.core.loaded;\r\n\t\t\t\t}\r\n\t\t\t\tthis.element.one(\"set_state.jstree\", function (e, data) { data.instance.trigger('restore_state', { 'state' : langx.extend(true, {}, k) }); });\r\n\t\t\t\tthis.set_state(k);\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t};\r\n\t\t/**\r\n\t\t * clear the state on the user's computer\r\n\t\t * @name clear_state()\r\n\t\t * @plugin state\r\n\t\t */\r\n\t\tthis.clear_state = function () {\r\n\t\t\treturn $.vakata.storage.del(this.settings.state.key);\r\n\t\t};\r\n\t};\r\n\r\n\t(function ($, undefined) {\r\n\t\t$.vakata.storage = {\r\n\t\t\t// simply specifying the functions in FF throws an error\r\n\t\t\tset : function (key, val) { return window.localStorage.setItem(key, val); },\r\n\t\t\tget : function (key) { return window.localStorage.getItem(key); },\r\n\t\t\tdel : function (key) { return window.localStorage.removeItem(key); }\r\n\t\t};\r\n\t}($));\r\n\r\n\t// include the state plugin by default\r\n\t// $.jstree.defaults.plugins.push(\"state\");\r\n\r\n\treturn $;\r\n\t\r\n});"]}