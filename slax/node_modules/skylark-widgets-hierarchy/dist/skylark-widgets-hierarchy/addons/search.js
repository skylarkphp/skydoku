/**
 * skylark-widgets-hierarchy - The skylark hierarchy widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-hierarchy/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-browser","skylark-domx-eventer","skylark-domx-noder","skylark-domx-geom","skylark-domx-query","../Hierarchy"],function(e,a,s,t,r,h,i){"use strict";if(!h.jstree.plugins.search)return h.jstree.defaults.search={ajax:!1,fuzzy:!1,case_sensitive:!1,show_only_matches:!1,show_only_matches_children:!1,close_opened_onclear:!0,search_leaves_only:!1,search_callback:!1},h.jstree.plugins.search=function(a,s){this.bind=function(){s.bind.call(this),this._data.search.str="",this._data.search.dom=h(),this._data.search.res=[],this._data.search.opn=[],this._data.search.som=!1,this._data.search.smc=!1,this._data.search.hdn=[],this.element.on("search.jstree",h.proxy(function(e,a){if(this._data.search.som&&a.res.length){var s,t,r,i,c=this._model.data,n=[];for(s=0,t=a.res.length;s<t;s++)if(c[a.res[s]]&&!c[a.res[s]].state.hidden&&(n.push(a.res[s]),n=n.concat(c[a.res[s]].parents),this._data.search.smc))for(r=0,i=c[a.res[s]].children_d.length;r<i;r++)c[c[a.res[s]].children_d[r]]&&!c[c[a.res[s]].children_d[r]].state.hidden&&n.push(c[a.res[s]].children_d[r]);n=h.vakata.array_remove_item(h.vakata.array_unique(n),h.jstree.root),this._data.search.hdn=this.hide_all(!0),this.show_node(n,!0),this.redraw(!0)}},this)).on("clear_search.jstree",e.proxy(function(e,a){this._data.search.som&&a.res.length&&(this.show_node(this._data.search.hdn,!0),this.redraw(!0))},this))},this.search=function(a,s,t,r,i,c){if(!1===a||""===e.trim(a.toString()))return this.clear_search();r=(r=this.get_node(r))&&r.id?r.id:null,a=a.toString();var n,d,o=this.settings.search,l=!!o.ajax&&o.ajax,_=this._model.data,u=null,f=[],m=[];if(this._data.search.res.length&&!i&&this.clear_search(),void 0===t&&(t=o.show_only_matches),void 0===c&&(c=o.show_only_matches_children),!s&&!1!==l)return e.isFunction(l)?l.call(this,a,e.proxy(function(s){s&&s.d&&(s=s.d),this._load_nodes(e.isArray(s)?h.vakata.array_unique(s):[],function(){this.search(a,!0,t,r,i,c)})},this),r):((l=e.extend({},l)).data||(l.data={}),l.data.str=a,r&&(l.data.inside=r),this._data.search.lastRequest&&this._data.search.lastRequest.abort(),this._data.search.lastRequest=ajax(l).fail(e.proxy(function(){this._data.core.last_error={error:"ajax",plugin:"search",id:"search_01",reason:"Could not load search parents",data:JSON.stringify(l)},this.settings.core.error.call(this,this._data.core.last_error)},this)).done(e.proxy(function(s){s&&s.d&&(s=s.d),this._load_nodes(e.isArray(s)?h.vakata.array_unique(s):[],function(){this.search(a,!0,t,r,i,c)})},this)),this._data.search.lastRequest);if(i||(this._data.search.str=a,this._data.search.dom=h(),this._data.search.res=[],this._data.search.opn=[],this._data.search.som=t,this._data.search.smc=c),u=new h.vakata.search(a,!0,{caseSensitive:o.case_sensitive,fuzzy:o.fuzzy}),e.each(_[r||h.jstree.root].children_d,function(e,s){var t=_[s];t.text&&!t.state.hidden&&(!o.search_leaves_only||t.state.loaded&&0===t.children.length)&&(o.search_callback&&o.search_callback.call(this,a,t)||!o.search_callback&&u.search(t.text).isMatch)&&(f.push(s),m=m.concat(t.parents))}),f.length){for(n=0,d=(m=h.vakata.array_unique(m)).length;n<d;n++)m[n]!==h.jstree.root&&_[m[n]]&&!0===this.open_node(m[n],null,0)&&this._data.search.opn.push(m[n]);i?(this._data.search.dom=this._data.search.dom.add(h(this.element[0].querySelectorAll("#"+e.map(f,function(e){return-1!=="0123456789".indexOf(e[0])?"\\3"+e[0]+" "+e.substr(1).replace(h.jstree.idregex,"\\$&"):e.replace(h.jstree.idregex,"\\$&")}).join(", #")))),this._data.search.res=h.vakata.array_unique(this._data.search.res.concat(f))):(this._data.search.dom=h(this.element[0].querySelectorAll("#"+e.map(f,function(e){return-1!=="0123456789".indexOf(e[0])?"\\3"+e[0]+" "+e.substr(1).replace(h.jstree.idregex,"\\$&"):e.replace(h.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.res=f),this._data.search.dom.children(".jstree-anchor").addClass("jstree-search")}this.trigger("search",{nodes:this._data.search.dom,str:a,res:this._data.search.res,show_only_matches:t})},this.clear_search=function(){this.settings.search.close_opened_onclear&&this.close_node(this._data.search.opn,0),this.trigger("clear_search",{nodes:this._data.search.dom,str:this._data.search.str,res:this._data.search.res}),this._data.search.res.length&&(this._data.search.dom=h(this.element[0].querySelectorAll("#"+e.map(this._data.search.res,function(e){return-1!=="0123456789".indexOf(e[0])?"\\3"+e[0]+" "+e.substr(1).replace(h.jstree.idregex,"\\$&"):e.replace(h.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.dom.children(".jstree-anchor").removeClass("jstree-search")),this._data.search.str="",this._data.search.res=[],this._data.search.opn=[],this._data.search.dom=h()},this.redraw_node=function(a,t,r,h){if((a=s.redraw_node.apply(this,arguments))&&-1!==e.inArray(a.id,this._data.search.res)){var i,c,n=null;for(i=0,c=a.childNodes.length;i<c;i++)if(a.childNodes[i]&&a.childNodes[i].className&&-1!==a.childNodes[i].className.indexOf("jstree-anchor")){n=a.childNodes[i];break}n&&(n.className+=" jstree-search")}return a}},function(a){a.vakata.search=function(s,t,r){r=r||{},!1!==(r=e.extend({},a.vakata.search.defaults,r)).fuzzy&&(r.fuzzy=!0),s=r.caseSensitive?s:s.toLowerCase();var h,i,c,n,d=r.location,o=r.distance,l=r.threshold,_=s.length;return _>32&&(r.fuzzy=!1),r.fuzzy&&(h=1<<_-1,i=function(){var e={},a=0;for(a=0;a<_;a++)e[s.charAt(a)]=0;for(a=0;a<_;a++)e[s.charAt(a)]|=1<<_-a-1;return e}(),c=function(e,a){var s=e/_,t=Math.abs(d-a);return o?s+t/o:t?1:s}),n=function(e){if(e=r.caseSensitive?e:e.toLowerCase(),s===e||-1!==e.indexOf(s))return{isMatch:!0,score:0};if(!r.fuzzy)return{isMatch:!1,score:1};var a,t,n,o,u,f,m,y,x,g=e.length,p=l,v=e.indexOf(s,d),k=_+g,j=1,z=[];for(-1!==v&&(p=Math.min(c(0,v),p),-1!==(v=e.lastIndexOf(s,d+_))&&(p=Math.min(c(0,v),p))),v=-1,a=0;a<_;a++){for(n=0,o=k;n<o;)c(a,d+o)<=p?n=o:k=o,o=Math.floor((k-n)/2+n);for(k=o,f=Math.max(1,d-o+1),m=Math.min(d+o,g)+_,(y=new Array(m+2))[m+1]=(1<<a)-1,t=m;t>=f;t--)if(x=i[e.charAt(t-1)],y[t]=0===a?(y[t+1]<<1|1)&x:(y[t+1]<<1|1)&x|(u[t+1]|u[t])<<1|1|u[t+1],y[t]&h&&(j=c(a,t-1))<=p){if(p=j,v=t-1,z.push(v),!(v>d))break;f=Math.max(1,2*d-v)}if(c(a+1,d)>p)break;u=y}return{isMatch:v>=0,score:j}},!0===t?{search:n}:n(t)},a.vakata.search.defaults={location:0,distance:100,threshold:.6,fuzzy:!1,caseSensitive:!1}}(h),h});
//# sourceMappingURL=../sourcemaps/addons/search.js.map
