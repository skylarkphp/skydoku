/**
 * skylark-widgets-hierarchy - The skylark hierarchy widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-hierarchy/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-browser","skylark-domx-eventer","skylark-domx-noder","skylark-domx-geom","skylark-domx-query","../Hierarchy"],function(e,t,s,c,i,d,h){"use strict";if(!d.jstree.plugins.checkbox){var n=document.createElement("I");return n.className="jstree-icon jstree-checkbox",n.setAttribute("role","presentation"),d.jstree.defaults.checkbox={visible:!0,three_state:!0,whole_node:!0,keep_selected_style:!0,cascade:"",tie_selection:!0,cascade_to_disabled:!0,cascade_to_hidden:!0},d.jstree.plugins.checkbox=function(t,s){this.bind=function(){s.bind.call(this),this._data.checkbox.uto=!1,this._data.checkbox.selected=[],this.settings.checkbox.three_state&&(this.settings.checkbox.cascade="up+down+undetermined"),this.element.on("init.jstree",e.proxy(function(){this._data.checkbox.visible=this.settings.checkbox.visible,this.settings.checkbox.keep_selected_style||this.element.addClass("jstree-checkbox-no-clicked"),this.settings.checkbox.tie_selection&&this.element.addClass("jstree-checkbox-selection")},this)).on("loading.jstree",e.proxy(function(){this[this._data.checkbox.visible?"show_checkboxes":"hide_checkboxes"]()},this)),-1!==this.settings.checkbox.cascade.indexOf("undetermined")&&this.element.on("changed.jstree uncheck_node.jstree check_node.jstree uncheck_all.jstree check_all.jstree move_node.jstree copy_node.jstree redraw.jstree open_node.jstree",e.proxy(function(){this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto),this._data.checkbox.uto=setTimeout(e.proxy(this._undetermined,this),50)},this)),this.settings.checkbox.tie_selection||this.element.on("model.jstree",e.proxy(function(e,t){var s,c,i=this._model.data,d=(i[t.parent],t.nodes);for(s=0,c=d.length;s<c;s++)i[d[s]].state.checked=i[d[s]].state.checked||i[d[s]].original&&i[d[s]].original.state&&i[d[s]].original.state.checked,i[d[s]].state.checked&&this._data.checkbox.selected.push(d[s])},this)),-1===this.settings.checkbox.cascade.indexOf("up")&&-1===this.settings.checkbox.cascade.indexOf("down")||this.element.on("model.jstree",e.proxy(function(e,t){var s,c,i,h,n,r,a=this._model.data,o=a[t.parent],l=t.nodes,_=[],k=this.settings.checkbox.cascade,g=this.settings.checkbox.tie_selection;if(-1!==k.indexOf("down"))if(o.state[g?"selected":"checked"]){for(c=0,i=l.length;c<i;c++)a[l[c]].state[g?"selected":"checked"]=!0;this._data[g?"core":"checkbox"].selected=this._data[g?"core":"checkbox"].selected.concat(l)}else for(c=0,i=l.length;c<i;c++)if(a[l[c]].state[g?"selected":"checked"]){for(h=0,n=a[l[c]].children_d.length;h<n;h++)a[a[l[c]].children_d[h]].state[g?"selected":"checked"]=!0;this._data[g?"core":"checkbox"].selected=this._data[g?"core":"checkbox"].selected.concat(a[l[c]].children_d)}if(-1!==k.indexOf("up")){for(c=0,i=o.children_d.length;c<i;c++)a[o.children_d[c]].children.length||_.push(a[o.children_d[c]].parent);for(h=0,n=(_=d.vakata.array_unique(_)).length;h<n;h++)for(o=a[_[h]];o&&o.id!==d.jstree.root;){for(s=0,c=0,i=o.children.length;c<i;c++)s+=a[o.children[c]].state[g?"selected":"checked"];if(s!==i)break;o.state[g?"selected":"checked"]=!0,this._data[g?"core":"checkbox"].selected.push(o.id),(r=this.get_node(o,!0))&&r.length&&r.attr("aria-selected",!0).children(".jstree-anchor").addClass(g?"jstree-clicked":"jstree-checked"),o=this.get_node(o.parent)}}this._data[g?"core":"checkbox"].selected=d.vakata.array_unique(this._data[g?"core":"checkbox"].selected)},this)).on(this.settings.checkbox.tie_selection?"select_node.jstree":"check_node.jstree",e.proxy(function(e,t){var s,c,i,h,n=t.node,r=this._model.data,a=this.get_node(n.parent),o=this.settings.checkbox.cascade,l=this.settings.checkbox.tie_selection,_={},k=this._data[l?"core":"checkbox"].selected;for(s=0,c=k.length;s<c;s++)_[k[s]]=!0;if(-1!==o.indexOf("down")){var g=this._cascade_new_checked_state(n.id,!0),x=n.children_d.concat(n.id);for(s=0,c=x.length;s<c;s++)g.indexOf(x[s])>-1?_[x[s]]=!0:delete _[x[s]]}if(-1!==o.indexOf("up"))for(;a&&a.id!==d.jstree.root;){for(i=0,s=0,c=a.children.length;s<c;s++)i+=r[a.children[s]].state[l?"selected":"checked"];if(i!==c)break;a.state[l?"selected":"checked"]=!0,_[a.id]=!0,(h=this.get_node(a,!0))&&h.length&&h.attr("aria-selected",!0).children(".jstree-anchor").addClass(l?"jstree-clicked":"jstree-checked"),a=this.get_node(a.parent)}for(s in k=[],_)_.hasOwnProperty(s)&&k.push(s);this._data[l?"core":"checkbox"].selected=k},this)).on(this.settings.checkbox.tie_selection?"deselect_all.jstree":"uncheck_all.jstree",e.proxy(function(e,t){var s,c,i,h=this.get_node(d.jstree.root),n=this._model.data;for(s=0,c=h.children_d.length;s<c;s++)(i=n[h.children_d[s]])&&i.original&&i.original.state&&i.original.state.undetermined&&(i.original.state.undetermined=!1)},this)).on(this.settings.checkbox.tie_selection?"deselect_node.jstree":"uncheck_node.jstree",e.proxy(function(e,t){var s,c,i,d=t.node,h=(this.get_node(d,!0),this.settings.checkbox.cascade),n=this.settings.checkbox.tie_selection,r=this._data[n?"core":"checkbox"].selected,a=d.children_d.concat(d.id);if(-1!==h.indexOf("down")){var o=this._cascade_new_checked_state(d.id,!1);r=r.filter(function(e){return-1===a.indexOf(e)||o.indexOf(e)>-1})}if(-1!==h.indexOf("up")&&-1===r.indexOf(d.id)){for(s=0,c=d.parents.length;s<c;s++)(i=this._model.data[d.parents[s]]).state[n?"selected":"checked"]=!1,i&&i.original&&i.original.state&&i.original.state.undetermined&&(i.original.state.undetermined=!1),(i=this.get_node(d.parents[s],!0))&&i.length&&i.attr("aria-selected",!1).children(".jstree-anchor").removeClass(n?"jstree-clicked":"jstree-checked");r=r.filter(function(e){return-1===d.parents.indexOf(e)})}this._data[n?"core":"checkbox"].selected=r},this)),-1!==this.settings.checkbox.cascade.indexOf("up")&&this.element.on("delete_node.jstree",e.proxy(function(e,t){for(var s,c,i,h,n=this.get_node(t.parent),r=this._model.data,a=this.settings.checkbox.tie_selection;n&&n.id!==d.jstree.root&&!n.state[a?"selected":"checked"];){for(i=0,s=0,c=n.children.length;s<c;s++)i+=r[n.children[s]].state[a?"selected":"checked"];if(!(c>0&&i===c))break;n.state[a?"selected":"checked"]=!0,this._data[a?"core":"checkbox"].selected.push(n.id),(h=this.get_node(n,!0))&&h.length&&h.attr("aria-selected",!0).children(".jstree-anchor").addClass(a?"jstree-clicked":"jstree-checked"),n=this.get_node(n.parent)}},this)).on("move_node.jstree",e.proxy(function(e,t){var s,c,i,h,n,r=t.is_multi,a=t.old_parent,o=this.get_node(t.parent),l=this._model.data,_=this.settings.checkbox.tie_selection;if(!r)for(s=this.get_node(a);s&&s.id!==d.jstree.root&&!s.state[_?"selected":"checked"];){for(c=0,i=0,h=s.children.length;i<h;i++)c+=l[s.children[i]].state[_?"selected":"checked"];if(!(h>0&&c===h))break;s.state[_?"selected":"checked"]=!0,this._data[_?"core":"checkbox"].selected.push(s.id),(n=this.get_node(s,!0))&&n.length&&n.attr("aria-selected",!0).children(".jstree-anchor").addClass(_?"jstree-clicked":"jstree-checked"),s=this.get_node(s.parent)}for(s=o;s&&s.id!==d.jstree.root;){for(c=0,i=0,h=s.children.length;i<h;i++)c+=l[s.children[i]].state[_?"selected":"checked"];if(c===h)s.state[_?"selected":"checked"]||(s.state[_?"selected":"checked"]=!0,this._data[_?"core":"checkbox"].selected.push(s.id),(n=this.get_node(s,!0))&&n.length&&n.attr("aria-selected",!0).children(".jstree-anchor").addClass(_?"jstree-clicked":"jstree-checked"));else{if(!s.state[_?"selected":"checked"])break;s.state[_?"selected":"checked"]=!1,this._data[_?"core":"checkbox"].selected=d.vakata.array_remove_item(this._data[_?"core":"checkbox"].selected,s.id),(n=this.get_node(s,!0))&&n.length&&n.attr("aria-selected",!1).children(".jstree-anchor").removeClass(_?"jstree-clicked":"jstree-checked")}s=this.get_node(s.parent)}},this))},this.get_undetermined=function(e){if(-1===this.settings.checkbox.cascade.indexOf("undetermined"))return[];var t,s,c,i,h={},n=this._model.data,r=this.settings.checkbox.tie_selection,a=this._data[r?"core":"checkbox"].selected,o=[],l=this,_=[];for(t=0,s=a.length;t<s;t++)if(n[a[t]]&&n[a[t]].parents)for(c=0,i=n[a[t]].parents.length;c<i&&void 0===h[n[a[t]].parents[c]];c++)n[a[t]].parents[c]!==d.jstree.root&&(h[n[a[t]].parents[c]]=!0,o.push(n[a[t]].parents[c]));for(this.element.find(".jstree-closed").not(":has(.jstree-children)").each(function(){var e,r=l.get_node(this);if(r)if(r.state.loaded){for(t=0,s=r.children_d.length;t<s;t++)if(!(e=n[r.children_d[t]]).state.loaded&&e.original&&e.original.state&&e.original.state.undetermined&&!0===e.original.state.undetermined)for(void 0===h[e.id]&&e.id!==d.jstree.root&&(h[e.id]=!0,o.push(e.id)),c=0,i=e.parents.length;c<i;c++)void 0===h[e.parents[c]]&&e.parents[c]!==d.jstree.root&&(h[e.parents[c]]=!0,o.push(e.parents[c]))}else if(r.original&&r.original.state&&r.original.state.undetermined&&!0===r.original.state.undetermined)for(void 0===h[r.id]&&r.id!==d.jstree.root&&(h[r.id]=!0,o.push(r.id)),c=0,i=r.parents.length;c<i;c++)void 0===h[r.parents[c]]&&r.parents[c]!==d.jstree.root&&(h[r.parents[c]]=!0,o.push(r.parents[c]))}),t=0,s=o.length;t<s;t++)n[o[t]].state[r?"selected":"checked"]||_.push(e?n[o[t]]:o[t]);return _},this._undetermined=function(){if(null!==this.element){var e,t,s,c=this.get_undetermined(!1);for(this.element.find(".jstree-undetermined").removeClass("jstree-undetermined"),e=0,t=c.length;e<t;e++)(s=this.get_node(c[e],!0))&&s.length&&s.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-undetermined")}},this.redraw_node=function(t,c,i,d){if(t=s.redraw_node.apply(this,arguments)){var h,r,a=null,o=null;for(h=0,r=t.childNodes.length;h<r;h++)if(t.childNodes[h]&&t.childNodes[h].className&&-1!==t.childNodes[h].className.indexOf("jstree-anchor")){a=t.childNodes[h];break}a&&(!this.settings.checkbox.tie_selection&&this._model.data[t.id].state.checked&&(a.className+=" jstree-checked"),o=n.cloneNode(!1),this._model.data[t.id].state.checkbox_disabled&&(o.className+=" jstree-checkbox-disabled"),a.insertBefore(o,a.childNodes[0]))}return i||-1===this.settings.checkbox.cascade.indexOf("undetermined")||(this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto),this._data.checkbox.uto=setTimeout(e.proxy(this._undetermined,this),50)),t},this.show_checkboxes=function(){this._data.core.themes.checkboxes=!0,this.get_container_ul().removeClass("jstree-no-checkboxes")},this.hide_checkboxes=function(){this._data.core.themes.checkboxes=!1,this.get_container_ul().addClass("jstree-no-checkboxes")},this.toggle_checkboxes=function(){this._data.core.themes.checkboxes?this.hide_checkboxes():this.show_checkboxes()},this.is_undetermined=function(t){t=this.get_node(t);var s,c,i=this.settings.checkbox.cascade,d=this.settings.checkbox.tie_selection,h=this._data[d?"core":"checkbox"].selected,n=this._model.data;if(!t||!0===t.state[d?"selected":"checked"]||-1===i.indexOf("undetermined")||-1===i.indexOf("down")&&-1===i.indexOf("up"))return!1;if(!t.state.loaded&&!0===t.original.state.undetermined)return!0;for(s=0,c=t.children_d.length;s<c;s++)if(-1!==e.inArray(t.children_d[s],h)||!n[t.children_d[s]].state.loaded&&n[t.children_d[s]].original.state.undetermined)return!0;return!1},this.disable_checkbox=function(t){var s,c,i;if(e.isArray(t)){for(s=0,c=(t=t.slice()).length;s<c;s++)this.disable_checkbox(t[s]);return!0}if(!(t=this.get_node(t))||t.id===d.jstree.root)return!1;i=this.get_node(t,!0),t.state.checkbox_disabled||(t.state.checkbox_disabled=!0,i&&i.length&&i.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-checkbox-disabled"),this.trigger("disable_checkbox",{node:t}))},this.enable_checkbox=function(t){var s,c,i;if(e.isArray(t)){for(s=0,c=(t=t.slice()).length;s<c;s++)this.enable_checkbox(t[s]);return!0}if(!(t=this.get_node(t))||t.id===d.jstree.root)return!1;i=this.get_node(t,!0),t.state.checkbox_disabled&&(t.state.checkbox_disabled=!1,i&&i.length&&i.children(".jstree-anchor").children(".jstree-checkbox").removeClass("jstree-checkbox-disabled"),this.trigger("enable_checkbox",{node:t}))},this.activate_node=function(e,t){return!d(t.target).hasClass("jstree-checkbox-disabled")&&(this.settings.checkbox.tie_selection&&(this.settings.checkbox.whole_node||d(t.target).hasClass("jstree-checkbox"))&&(t.ctrlKey=!0),this.settings.checkbox.tie_selection||!this.settings.checkbox.whole_node&&!d(t.target).hasClass("jstree-checkbox")?s.activate_node.call(this,e,t):!this.is_disabled(e)&&(this.is_checked(e)?this.uncheck_node(e,t):this.check_node(e,t),void this.trigger("activate_node",{node:this.get_node(e)})))},this._cascade_new_checked_state=function(e,t){var s,c,i,d=this.settings.checkbox.tie_selection,h=this._model.data[e],n=[],r=[];if(!this.settings.checkbox.cascade_to_disabled&&h.state.disabled||!this.settings.checkbox.cascade_to_hidden&&h.state.hidden)i=this.get_checked_descendants(e),h.state[d?"selected":"checked"]&&i.push(h.id),n=n.concat(i);else{if(h.children)for(s=0,c=h.children.length;s<c;s++){var a=h.children[s];i=this._cascade_new_checked_state(a,t),n=n.concat(i),i.indexOf(a)>-1&&r.push(a)}var o=this.get_node(h,!0),l=r.length>0&&r.length<h.children.length;h.original&&h.original.state&&h.original.state.undetermined&&(h.original.state.undetermined=l),l?(h.state[d?"selected":"checked"]=!1,o.attr("aria-selected",!1).children(".jstree-anchor").removeClass(d?"jstree-clicked":"jstree-checked")):t&&r.length===h.children.length?(h.state[d?"selected":"checked"]=t,n.push(h.id),o.attr("aria-selected",!0).children(".jstree-anchor").addClass(d?"jstree-clicked":"jstree-checked")):(h.state[d?"selected":"checked"]=!1,o.attr("aria-selected",!1).children(".jstree-anchor").removeClass(d?"jstree-clicked":"jstree-checked"))}return n},this.get_checked_descendants=function(e){var t=this,s=t.settings.checkbox.tie_selection;return t._model.data[e].children_d.filter(function(e){return t._model.data[e].state[s?"selected":"checked"]})},this.check_node=function(t,s){if(this.settings.checkbox.tie_selection)return this.select_node(t,!1,!0,s);var c,i,h;if(e.isArray(t)){for(i=0,h=(t=t.slice()).length;i<h;i++)this.check_node(t[i],s);return!0}if(!(t=this.get_node(t))||t.id===d.jstree.root)return!1;c=this.get_node(t,!0),t.state.checked||(t.state.checked=!0,this._data.checkbox.selected.push(t.id),c&&c.length&&c.children(".jstree-anchor").addClass("jstree-checked"),this.trigger("check_node",{node:t,selected:this._data.checkbox.selected,event:s}))},this.uncheck_node=function(t,s){if(this.settings.checkbox.tie_selection)return this.deselect_node(t,!1,s);var c,i,h;if(e.isArray(t)){for(c=0,i=(t=t.slice()).length;c<i;c++)this.uncheck_node(t[c],s);return!0}if(!(t=this.get_node(t))||t.id===d.jstree.root)return!1;h=this.get_node(t,!0),t.state.checked&&(t.state.checked=!1,this._data.checkbox.selected=d.vakata.array_remove_item(this._data.checkbox.selected,t.id),h.length&&h.children(".jstree-anchor").removeClass("jstree-checked"),this.trigger("uncheck_node",{node:t,selected:this._data.checkbox.selected,event:s}))},this.check_all=function(){if(this.settings.checkbox.tie_selection)return this.select_all();var e,t;this._data.checkbox.selected.concat([]);for(this._data.checkbox.selected=this._model.data[d.jstree.root].children_d.concat(),e=0,t=this._data.checkbox.selected.length;e<t;e++)this._model.data[this._data.checkbox.selected[e]]&&(this._model.data[this._data.checkbox.selected[e]].state.checked=!0);this.redraw(!0),this.trigger("check_all",{selected:this._data.checkbox.selected})},this.uncheck_all=function(){if(this.settings.checkbox.tie_selection)return this.deselect_all();var e,t,s=this._data.checkbox.selected.concat([]);for(e=0,t=this._data.checkbox.selected.length;e<t;e++)this._model.data[this._data.checkbox.selected[e]]&&(this._model.data[this._data.checkbox.selected[e]].state.checked=!1);this._data.checkbox.selected=[],this.element.find(".jstree-checked").removeClass("jstree-checked"),this.trigger("uncheck_all",{selected:this._data.checkbox.selected,node:s})},this.is_checked=function(e){return this.settings.checkbox.tie_selection?this.is_selected(e):!(!(e=this.get_node(e))||e.id===d.jstree.root)&&e.state.checked},this.get_checked=function(t){return this.settings.checkbox.tie_selection?this.get_selected(t):t?e.map(this._data.checkbox.selected,e.proxy(function(e){return this.get_node(e)},this)):this._data.checkbox.selected},this.get_top_checked=function(t){if(this.settings.checkbox.tie_selection)return this.get_top_selected(t);var s,c,i,d,h=this.get_checked(!0),n={};for(s=0,c=h.length;s<c;s++)n[h[s].id]=h[s];for(s=0,c=h.length;s<c;s++)for(i=0,d=h[s].children_d.length;i<d;i++)n[h[s].children_d[i]]&&delete n[h[s].children_d[i]];for(s in h=[],n)n.hasOwnProperty(s)&&h.push(s);return t?e.map(h,e.proxy(function(e){return this.get_node(e)},this)):h},this.get_bottom_checked=function(t){if(this.settings.checkbox.tie_selection)return this.get_bottom_selected(t);var s,c,i=this.get_checked(!0),d=[];for(s=0,c=i.length;s<c;s++)i[s].children.length||d.push(i[s].id);return t?e.map(d,e.proxy(function(e){return this.get_node(e)},this)):d},this.load_node=function(t,c){var i,h,n;if(!e.isArray(t)&&!this.settings.checkbox.tie_selection&&(n=this.get_node(t))&&n.state.loaded)for(i=0,h=n.children_d.length;i<h;i++)this._model.data[n.children_d[i]].state.checked&&(!0,this._data.checkbox.selected=d.vakata.array_remove_item(this._data.checkbox.selected,n.children_d[i]));return s.load_node.apply(this,arguments)},this.get_state=function(){var e=s.get_state.apply(this,arguments);return this.settings.checkbox.tie_selection?e:(e.checkbox=this._data.checkbox.selected.slice(),e)},this.set_state=function(t,c){var i=s.set_state.apply(this,arguments);if(i&&t.checkbox){if(!this.settings.checkbox.tie_selection){this.uncheck_all();var d=this;e.each(t.checkbox,function(e,t){d.check_node(t)})}return delete t.checkbox,this.set_state(t,c),!1}return i},this.refresh=function(e,t){return this.settings.checkbox.tie_selection||(this._data.checkbox.selected=[]),s.refresh.apply(this,arguments)}},d}});
//# sourceMappingURL=../sourcemaps/addons/checkbox.js.map
