/**
 * skylark-widgets-hierarchy - The skylark hierarchy widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-hierarchy/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-browser","skylark-domx-eventer","skylark-domx-noder","skylark-domx-geom","skylark-domx-query","../Hierarchy"],function(e,t,a,r,n,s,i){"use strict";var o,d;if(!s.jstree.plugins.dnd)return s.jstree.defaults.dnd={copy:!0,open_timeout:500,is_draggable:!0,check_while_dragging:!0,always_copy:!1,inside_pos:0,drag_selection:!0,touch:!0,large_drop_target:!1,large_drag_target:!1,use_html5:!1},s.jstree.plugins.dnd=function(t,a){this.init=function(e,t){a.init.call(this,e,t),this.settings.dnd.use_html5=this.settings.dnd.use_html5&&"draggable"in document.createElement("span")},this.bind=function(){a.bind.call(this),this.element.on(this.settings.dnd.use_html5?"dragstart.jstree":"mousedown.jstree touchstart.jstree",this.settings.dnd.large_drag_target?".jstree-node":".jstree-anchor",e.proxy(function(t){if(this.settings.dnd.large_drag_target&&s(t.target).closest(".jstree-node")[0]!==t.currentTarget)return!0;if("touchstart"===t.type&&(!this.settings.dnd.touch||"selected"===this.settings.dnd.touch&&!s(t.currentTarget).closest(".jstree-node").children(".jstree-anchor").hasClass("jstree-clicked")))return!0;var a=this.get_node(t.target),r=this.is_selected(a)&&this.settings.dnd.drag_selection?this.get_top_selected().length:1,n=r>1?r+" "+this.get_string("nodes"):this.get_text(t.currentTarget);if(this.settings.core.force_text&&(n=s.vakata.html.escape(n)),a&&a.id&&a.id!==s.jstree.root&&(1===t.which||"touchstart"===t.type||"dragstart"===t.type)&&(!0===this.settings.dnd.is_draggable||e.isFunction(this.settings.dnd.is_draggable)&&this.settings.dnd.is_draggable.call(this,r>1?this.get_top_selected(!0):[a],t))){if(o={jstree:!0,origin:this,obj:this.get_node(a,!0),nodes:r>1?this.get_top_selected():[a.id]},d=t.currentTarget,!this.settings.dnd.use_html5)return this.element.trigger("mousedown.jstree"),s.vakata.dnd.start(t,o,'<div id="jstree-dnd" class="jstree-'+this.get_theme()+" jstree-"+this.get_theme()+"-"+this.get_theme_variant()+" "+(this.settings.core.themes.responsive?" jstree-dnd-responsive":"")+'"><i class="jstree-icon jstree-er"></i>'+n+'<ins class="jstree-copy" style="display:none;">+</ins></div>');s.vakata.dnd._trigger("start",t,{helper:s(),element:d,data:o})}},this)),this.settings.dnd.use_html5&&this.element.on("dragover.jstree",function(e){return e.preventDefault(),s.vakata.dnd._trigger("move",e,{helper:s(),element:d,data:o}),!1}).on("drop.jstree",e.proxy(function(e){return e.preventDefault(),s.vakata.dnd._trigger("stop",e,{helper:s(),element:d,data:o}),!1},this))},this.redraw_node=function(e,t,r,n){if((e=a.redraw_node.apply(this,arguments))&&this.settings.dnd.use_html5)if(this.settings.dnd.large_drag_target)e.setAttribute("draggable",!0);else{var s,i,o=null;for(s=0,i=e.childNodes.length;s<i;s++)if(e.childNodes[s]&&e.childNodes[s].className&&-1!==e.childNodes[s].className.indexOf("jstree-anchor")){o=e.childNodes[s];break}o&&o.setAttribute("draggable",!0)}return e}},s(function(){var t=!1,a=!1,r=!1,n=!1,i=s('<div id="jstree-marker">&#160;</div>').hide();s(document).on("dnd_start.vakata.jstree",function(e,a){t=!1,r=!1,a&&a.data&&a.data.jstree&&i.appendTo(document.body)}).on("dnd_move.vakata.jstree",function(o,d){var l=d.event.target!==r.target;if(n&&(d.event&&"dragover"===d.event.type&&!l||clearTimeout(n)),d&&d.data&&d.data.jstree&&(!d.event.target.id||"jstree-marker"!==d.event.target.id)){r=d.event;var g,c,h,p,_,v,u,f,m,k,y,j,T,w,x,E,b=s.jstree.reference(d.event.target),Y=!1,X=!1,C=!1;if(b&&b._data&&b._data.dnd)if(i.attr("class","jstree-"+b.get_theme()+(b.settings.core.themes.responsive?" jstree-dnd-responsive":"")),x=d.data.origin&&(d.data.origin.settings.dnd.always_copy||d.data.origin.settings.dnd.copy&&(d.event.metaKey||d.event.ctrlKey)),d.helper.children().attr("class","jstree-"+b.get_theme()+" jstree-"+b.get_theme()+"-"+b.get_theme_variant()+" "+(b.settings.core.themes.responsive?" jstree-dnd-responsive":"")).find(".jstree-copy").first()[x?"show":"hide"](),d.event.target!==b.element[0]&&d.event.target!==b.get_container_ul()[0]||0!==b.get_container_ul().children().length){if((Y=b.settings.dnd.large_drop_target?s(d.event.target).closest(".jstree-node").children(".jstree-anchor"):s(d.event.target).closest(".jstree-anchor"))&&Y.length&&Y.parent().is(".jstree-closed, .jstree-open, .jstree-leaf")&&(X=Y.offset(),C=(void 0!==d.event.pageY?d.event.pageY:d.event.originalEvent.pageY)-X.top,h=Y.outerHeight(),v=C<h/3?["b","i","a"]:C>h-h/3?["a","i","b"]:C>h/2?["i","a","b"]:["i","b","a"],e.each(v,function(r,o){switch(o){case"b":g=X.left-6,c=X.top,p=b.get_parent(Y),_=Y.parent().index();break;case"i":T=b.settings.dnd.inside_pos,w=b.get_node(Y.parent()),g=X.left-2,c=X.top+h/2+1,p=w.id,_="first"===T?0:"last"===T?w.children.length:Math.min(T,w.children.length);break;case"a":g=X.left-6,c=X.top+h,p=b.get_parent(Y),_=Y.parent().index()+1}for(u=!0,f=0,m=d.data.nodes.length;f<m;f++)if(k=d.data.origin&&(d.data.origin.settings.dnd.always_copy||d.data.origin.settings.dnd.copy&&(d.event.metaKey||d.event.ctrlKey))?"copy_node":"move_node",y=_,"move_node"===k&&"a"===o&&d.data.origin&&d.data.origin===b&&p===b.get_parent(d.data.nodes[f])&&(j=b.get_node(p),y>e.inArray(d.data.nodes[f],j.children)&&(y-=1)),!(u=u&&(b&&b.settings&&b.settings.dnd&&!1===b.settings.dnd.check_while_dragging||b.check(k,d.data.origin&&d.data.origin!==b?d.data.origin.get_node(d.data.nodes[f]):d.data.nodes[f],p,y,{dnd:!0,ref:b.get_node(Y.parent()),pos:o,origin:d.data.origin,is_multi:d.data.origin&&d.data.origin!==b,is_foreign:!d.data.origin})))){b&&b.last_error&&(a=b.last_error());break}var C,K;if("i"===o&&Y.parent().is(".jstree-closed")&&b.settings.dnd.open_timeout&&(d.event&&"dragover"===d.event.type&&!l||(n&&clearTimeout(n),n=setTimeout((C=b,K=Y,function(){C.open_node(K)}),b.settings.dnd.open_timeout))),u)return(E=b.get_node(p,!0)).hasClass(".jstree-dnd-parent")||(s(".jstree-dnd-parent").removeClass("jstree-dnd-parent"),E.addClass("jstree-dnd-parent")),t={ins:b,par:p,pos:"i"!==o||"last"!==T||0!==_||b.is_loaded(w)?_:"last"},i.css({left:g+"px",top:c+"px"}).show(),d.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok"),d.event.originalEvent&&d.event.originalEvent.dataTransfer&&(d.event.originalEvent.dataTransfer.dropEffect=x?"copy":"move"),a={},v=!0,!1}),!0===v))return}else{for(u=!0,f=0,m=d.data.nodes.length;f<m&&(u=u&&b.check(d.data.origin&&(d.data.origin.settings.dnd.always_copy||d.data.origin.settings.dnd.copy&&(d.event.metaKey||d.event.ctrlKey))?"copy_node":"move_node",d.data.origin&&d.data.origin!==b?d.data.origin.get_node(d.data.nodes[f]):d.data.nodes[f],s.jstree.root,"last",{dnd:!0,ref:b.get_node(s.jstree.root),pos:"i",origin:d.data.origin,is_multi:d.data.origin&&d.data.origin!==b,is_foreign:!d.data.origin}));f++);if(u)return t={ins:b,par:s.jstree.root,pos:"last"},i.hide(),d.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok"),void(d.event.originalEvent&&d.event.originalEvent.dataTransfer&&(d.event.originalEvent.dataTransfer.dropEffect=x?"copy":"move"))}s(".jstree-dnd-parent").removeClass("jstree-dnd-parent"),t=!1,d.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er"),d.event.originalEvent&&d.event.originalEvent.dataTransfer&&(d.event.originalEvent.dataTransfer.dropEffect="none"),i.hide()}}).on("dnd_scroll.vakata.jstree",function(e,a){a&&a.data&&a.data.jstree&&(i.hide(),t=!1,r=!1,a.helper.find(".jstree-icon").first().removeClass("jstree-ok").addClass("jstree-er"))}).on("dnd_stop.vakata.jstree",function(e,o){if(s(".jstree-dnd-parent").removeClass("jstree-dnd-parent"),n&&clearTimeout(n),o&&o.data&&o.data.jstree){i.hide().detach();var d,l,g=[];if(t){for(d=0,l=o.data.nodes.length;d<l;d++)g[d]=o.data.origin?o.data.origin.get_node(o.data.nodes[d]):o.data.nodes[d];t.ins[o.data.origin&&(o.data.origin.settings.dnd.always_copy||o.data.origin.settings.dnd.copy&&(o.event.metaKey||o.event.ctrlKey))?"copy_node":"move_node"](g,t.par,t.pos,!1,!1,!1,o.data.origin)}else(d=s(o.event.target).closest(".jstree")).length&&a&&a.error&&"check"===a.error&&(d=d.jstree(!0))&&d.settings.core.error.call(this,a);r=!1,t=!1}}).on("keyup.jstree keydown.jstree",function(e,o){(o=s.vakata.dnd._get())&&o.data&&o.data.jstree&&("keyup"===e.type&&27===e.which?(n&&clearTimeout(n),t=!1,a=!1,r=!1,n=!1,i.hide().detach(),s.vakata.dnd._clean()):(o.helper.find(".jstree-copy").first()[o.data.origin&&(o.data.origin.settings.dnd.always_copy||o.data.origin.settings.dnd.copy&&(e.metaKey||e.ctrlKey))?"show":"hide"](),r&&(r.metaKey=e.metaKey,r.ctrlKey=e.ctrlKey,s.vakata.dnd._trigger("move",r))))})}),function(t){t.vakata.html={div:t("<div />"),escape:function(e){return t.vakata.html.div.text(e).html()},strip:function(a){return t.vakata.html.div.empty().append(e.parseHTML(a)).text()}};var a={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1};t.vakata.dnd={settings:{scroll_speed:10,scroll_proximity:20,helper_left:5,helper_top:10,threshold:5,threshold_touch:10},_trigger:function(e,a,r){void 0===r&&(r=t.vakata.dnd._get()),r.event=a,t(document).trigger("dnd_"+e+".vakata",r)},_get:function(){return{data:a.data,element:a.element,helper:a.helper}},_clean:function(){a.helper&&a.helper.remove(),a.scroll_i&&(clearInterval(a.scroll_i),a.scroll_i=!1),a={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1},t(document).off("mousemove.vakata.jstree touchmove.vakata.jstree",t.vakata.dnd.drag),t(document).off("mouseup.vakata.jstree touchend.vakata.jstree",t.vakata.dnd.stop)},_scroll:function(e){if(!a.scroll_e||!a.scroll_l&&!a.scroll_t)return a.scroll_i&&(clearInterval(a.scroll_i),a.scroll_i=!1),!1;if(!a.scroll_i)return a.scroll_i=setInterval(t.vakata.dnd._scroll,100),!1;if(!0===e)return!1;var r=a.scroll_e.scrollTop(),n=a.scroll_e.scrollLeft();a.scroll_e.scrollTop(r+a.scroll_t*t.vakata.dnd.settings.scroll_speed),a.scroll_e.scrollLeft(n+a.scroll_l*t.vakata.dnd.settings.scroll_speed),r===a.scroll_e.scrollTop()&&n===a.scroll_e.scrollLeft()||t.vakata.dnd._trigger("scroll",a.scroll_e)},start:function(e,r,n){"touchstart"===e.type&&e.originalEvent&&e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0]&&(e.pageX=e.originalEvent.changedTouches[0].pageX,e.pageY=e.originalEvent.changedTouches[0].pageY,e.target=document.elementFromPoint(e.originalEvent.changedTouches[0].pageX-window.pageXOffset,e.originalEvent.changedTouches[0].pageY-window.pageYOffset)),a.is_drag&&t.vakata.dnd.stop({});try{e.currentTarget.unselectable="on",e.currentTarget.onselectstart=function(){return!1},e.currentTarget.style&&(e.currentTarget.style.touchAction="none",e.currentTarget.style.msTouchAction="none",e.currentTarget.style.MozUserSelect="none")}catch(e){}return a.init_x=e.pageX,a.init_y=e.pageY,a.data=r,a.is_down=!0,a.element=e.currentTarget,a.target=e.target,a.is_touch="touchstart"===e.type,!1!==n&&(a.helper=t("<div id='vakata-dnd'></div>").html(n).css({display:"block",margin:"0",padding:"0",position:"absolute",top:"-2000px",lineHeight:"16px",zIndex:"10000"})),t(document).on("mousemove.vakata.jstree touchmove.vakata.jstree",t.vakata.dnd.drag),t(document).on("mouseup.vakata.jstree touchend.vakata.jstree",t.vakata.dnd.stop),!1},drag:function(e){if("touchmove"===e.type&&e.originalEvent&&e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0]&&(e.pageX=e.originalEvent.changedTouches[0].pageX,e.pageY=e.originalEvent.changedTouches[0].pageY,e.target=document.elementFromPoint(e.originalEvent.changedTouches[0].pageX-window.pageXOffset,e.originalEvent.changedTouches[0].pageY-window.pageYOffset)),a.is_down){if(!a.is_drag){if(!(Math.abs(e.pageX-a.init_x)>(a.is_touch?t.vakata.dnd.settings.threshold_touch:t.vakata.dnd.settings.threshold)||Math.abs(e.pageY-a.init_y)>(a.is_touch?t.vakata.dnd.settings.threshold_touch:t.vakata.dnd.settings.threshold)))return;a.helper&&(a.helper.appendTo(document.body),a.helper_w=a.helper.outerWidth()),a.is_drag=!0,t(a.target).one("click.vakata",!1),t.vakata.dnd._trigger("start",e)}var r=!1,n=!1,s=!1,i=!1,o=!1,d=!1,l=!1,g=!1,c=!1,h=!1;return a.scroll_t=0,a.scroll_l=0,a.scroll_e=!1,t(t(e.target).parentsUntil("body").addBack().get().reverse()).filter(function(){return/^auto|scroll$/.test(t(this).css("overflow"))&&(this.scrollHeight>this.offsetHeight||this.scrollWidth>this.offsetWidth)}).each(function(){var r=t(this),n=r.offset();if(this.scrollHeight>this.offsetHeight&&(n.top+r.height()-e.pageY<t.vakata.dnd.settings.scroll_proximity&&(a.scroll_t=1),e.pageY-n.top<t.vakata.dnd.settings.scroll_proximity&&(a.scroll_t=-1)),this.scrollWidth>this.offsetWidth&&(n.left+r.width()-e.pageX<t.vakata.dnd.settings.scroll_proximity&&(a.scroll_l=1),e.pageX-n.left<t.vakata.dnd.settings.scroll_proximity&&(a.scroll_l=-1)),a.scroll_t||a.scroll_l)return a.scroll_e=t(this),!1}),a.scroll_e||(r=t(document),n=t(window),s=r.height(),i=n.height(),o=r.width(),d=n.width(),l=r.scrollTop(),g=r.scrollLeft(),s>i&&e.pageY-l<t.vakata.dnd.settings.scroll_proximity&&(a.scroll_t=-1),s>i&&i-(e.pageY-l)<t.vakata.dnd.settings.scroll_proximity&&(a.scroll_t=1),o>d&&e.pageX-g<t.vakata.dnd.settings.scroll_proximity&&(a.scroll_l=-1),o>d&&d-(e.pageX-g)<t.vakata.dnd.settings.scroll_proximity&&(a.scroll_l=1),(a.scroll_t||a.scroll_l)&&(a.scroll_e=r)),a.scroll_e&&t.vakata.dnd._scroll(!0),a.helper&&(c=parseInt(e.pageY+t.vakata.dnd.settings.helper_top,10),h=parseInt(e.pageX+t.vakata.dnd.settings.helper_left,10),s&&c+25>s&&(c=s-50),o&&h+a.helper_w>o&&(h=o-(a.helper_w+2)),a.helper.css({left:h+"px",top:c+"px"})),t.vakata.dnd._trigger("move",e),!1}},stop:function(e){if("touchend"===e.type&&e.originalEvent&&e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0]&&(e.pageX=e.originalEvent.changedTouches[0].pageX,e.pageY=e.originalEvent.changedTouches[0].pageY,e.target=document.elementFromPoint(e.originalEvent.changedTouches[0].pageX-window.pageXOffset,e.originalEvent.changedTouches[0].pageY-window.pageYOffset)),a.is_drag)e.target!==a.target&&t(a.target).off("click.vakata"),t.vakata.dnd._trigger("stop",e);else if("touchend"===e.type&&e.target===a.target){var r=setTimeout(function(){t(e.target).click()},100);t(e.target).one("click",function(){r&&clearTimeout(r)})}return t.vakata.dnd._clean(),!1}}}(s),s});
//# sourceMappingURL=../sourcemaps/addons/dnd.js.map
