/**
 * skylark-domx-contents - A dom plugin for  editing  the content of html element.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
!function(t,n){var i=n.define,s=n.require,r="function"==typeof i&&i.amd,o=!r&&"undefined"!=typeof exports;if(!r&&!i){var a={};i=n.define=function(e,t,n){"function"==typeof n?(a[e]={factory:n,deps:t.map(function(t){return function(e,t){if("."!==e[0])return e;var n=t.split("/"),i=e.split("/");n.pop();for(var s=0;s<i.length;s++)"."!=i[s]&&(".."==i[s]?n.pop():n.push(i[s]));return n.join("/")}(t,e)}),resolved:!1,exports:null},s(e)):a[e]={factory:null,resolved:!0,exports:n}},s=n.require=function(e){if(!a.hasOwnProperty(e))throw new Error("Module "+e+" has not been defined");var t=a[e];if(!t.resolved){var i=[];t.deps.forEach(function(e){i.push(s(e))}),t.exports=t.factory.apply(n,i)||null,t.resolved=!0}return t.exports}}if(!i)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(t,n){t("skylark-domx-contents/contents",["skylark-langx/skylark","skylark-langx/langx","skylark-domx-noder","skylark-domx-data"],function(e,t,n,i){"use strict";var s=function(){return s};return e.attach("domx.contents",s)}),t("skylark-domx-contents/Hotkeys",["skylark-langx/langx","skylark-domx-query","./contents"],function(e,t,n){var i=e.Evented.inherit({});return i.count=0,i.keyNameMap={8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",91:"Meta",93:"Meta",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"Multiply",107:"Add",109:"Subtract",110:"Decimal",111:"Divide",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",59:";",61:"=",186:";",187:"=",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},i.aliases={escape:"esc",delete:"del",return:"enter",ctrl:"control",space:"spacebar",ins:"insert",cmd:"meta",command:"meta",wins:"meta",windows:"meta"},i.normalize=function(e){var t,n,i,s,r,o;for(r=e.toLowerCase().replace(/\s+/gi,"").split("+"),t=n=0,o=r.length;n<o;t=++n)i=r[t],r[t]=this.aliases[i]||i;return s=r.pop(),r.sort().push(s),r.join("_")},i.prototype.opts={el:document},i.prototype.init=function(){var e;this.id=++this.constructor.count,this._map={},this._delegate="string"==typeof this.opts.el?document:this.opts.el,t(this._delegate).on("keydown.simple-hotkeys-"+this.id,this.opts.el,(e=this,function(t){var n;return null!=(n=e._getHander(t))?n.call(e,t):void 0}))},i.prototype._getHander=function(e){var t,n;if(t=this.constructor.keyNameMap[e.which])return n="",e.altKey&&(n+="alt_"),e.ctrlKey&&(n+="control_"),e.metaKey&&(n+="meta_"),e.shiftKey&&(n+="shift_"),n+=t.toLowerCase(),this._map[n]},i.prototype.respondTo=function(e){return"string"==typeof e?null!=this._map[this.constructor.normalize(e)]:null!=this._getHander(e)},i.prototype.add=function(e,t){return this._map[this.constructor.normalize(e)]=t,this},i.prototype.remove=function(e){return delete this._map[this.constructor.normalize(e)],this},i.prototype.destroy=function(){return t(this._delegate).off(".simple-hotkeys-"+this.id),this._map={},this},n.Hotkeys=i}),t("skylark-domx-contents/Util",["skylark-langx/langx","skylark-domx-query","./contents"],function(e,t,n){var i,s,r,o,a,l,d,c,h,u,p,f,g=e.Evented.inherit({init:function(t,n){if(this.editor=t,this.opts=e.extend({},this.opts,n),this.browser.msie&&this.browser.version<11)return this.phBr=""}});return g.pluginName="Util",g.prototype.phBr="<br/>",g.prototype.os=(i={},/Mac/.test(navigator.appVersion)?i.mac=!0:/Linux/.test(navigator.appVersion)?i.linux=!0:/Win/.test(navigator.appVersion)?i.win=!0:/X11/.test(navigator.appVersion)&&(i.unix=!0),/Mobi/.test(navigator.appVersion)&&(i.mobile=!0),i),g.prototype.browser=(f=navigator.userAgent,a=/(msie|trident)/i.test(f),s=/chrome|crios/i.test(f),p=/safari/i.test(f)&&!s,o=/firefox/i.test(f),r=/edge/i.test(f),a?{msie:!0,version:1*(null!=(l=f.match(/(msie |rv:)(\d+(\.\d+)?)/i))?l[2]:void 0)}:r?{edge:!0,webkit:!0,version:1*(null!=(d=f.match(/edge\/(\d+(\.\d+)?)/i))?d[1]:void 0)}:s?{webkit:!0,chrome:!0,version:1*(null!=(c=f.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))?c[1]:void 0)}:p?{webkit:!0,safari:!0,version:1*(null!=(h=f.match(/version\/(\d+(\.\d+)?)/i))?h[1]:void 0)}:o?{mozilla:!0,firefox:!0,version:1*(null!=(u=f.match(/firefox\/(\d+(\.\d+)?)/i))?u[1]:void 0)}:{}),g.prototype.support={onselectionchange:function(){var e;if(void 0!==(e=document.onselectionchange))try{return document.onselectionchange=0,null===document.onselectionchange}catch(e){}finally{document.onselectionchange=e}return!1}(),oninput:!/(msie|trident)/i.test(navigator.userAgent)},g.prototype.reflow=function(e){return null==e&&(e=document),t(e)[0].offsetHeight},g.prototype.metaKey=function(e){return/Mac/.test(navigator.userAgent)?e.metaKey:e.ctrlKey},g.prototype.isEmptyNode=function(e){var n;return(n=t(e)).is(":empty")||!n.text()&&!n.find(":not(br, span, div)").length},g.prototype.isDecoratedNode=function(e){return t(e).is('[class^="'+this.opts.classPrefix+'"]')},g.prototype.blockNodes=["div","p","ul","ol","li","blockquote","hr","pre","h1","h2","h3","h4","h5","table"],g.prototype.isBlockNode=function(e){return!(!(e=t(e)[0])||3===e.nodeType)&&new RegExp("^("+this.blockNodes.join("|")+")$").test(e.nodeName.toLowerCase())},g.prototype.getNodeLength=function(e){switch((e=t(e)[0]).nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}},g.prototype.dataURLtoBlob=function(e){var t,n,i,s,r,o,a,l,d,c,h;if(o=window.Blob&&function(){try{return Boolean(new Blob)}catch(e){return e,!1}}(),r=o&&window.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return e,!1}}(),t=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,!((o||t)&&window.atob&&window.ArrayBuffer&&window.Uint8Array))return!1;for(s=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):decodeURIComponent(e.split(",")[1]),n=new ArrayBuffer(s.length),l=new Uint8Array(n),a=d=0,h=s.length;0<=h?d<=h:d>=h;a=0<=h?++d:--d)l[a]=s.charCodeAt(a);return c=e.split(",")[0].split(":")[1].split(";")[0],o?new Blob([r?l:n],{type:c}):((i=new t).append(n),i.getBlob(c))},g.prototype.throttle=function(e,t){var n,i,s,r,o,a,l;return r=0,l=0,s=n=o=null,i=function(){return l=0,r=+new Date,o=e.apply(s,n),s=null,n=null},(a=function(){var e;return s=this,n=arguments,e=new Date-r,l||(e>=t?i():l=setTimeout(i,t-e)),o}).clear=function(){if(l)return clearTimeout(l),i()},a},g.prototype.formatHTML=function(t){var n,i,s,r,o,a,l,d;for(o=/<(\/?)(.+?)(\/?)>/g,l="",s=0,i=null,"  ",a=function(e,t){return new Array(t+1).join(e)};null!==(r=o.exec(t));)r.isBlockNode=e.inArray(r[2],this.blockNodes)>-1,r.isStartTag="/"!==r[1]&&"/"!==r[3],r.isEndTag="/"===r[1]||"/"===r[3],n=i?i.index+i[0].length:0,(d=t.substring(n,r.index)).length>0&&e.trim(d)&&(l+=d),r.isBlockNode&&r.isEndTag&&!r.isStartTag&&(s-=1),r.isBlockNode&&r.isStartTag&&(i&&i.isBlockNode&&i.isEndTag||(l+="\n"),l+=a("  ",s)),l+=r[0],r.isBlockNode&&r.isEndTag&&(l+="\n"),r.isBlockNode&&r.isStartTag&&(s+=1),i=r;return e.trim(l)},n.Util=g}),t("skylark-domx-contents/InputManager",["skylark-langx/langx","skylark-domx-query","./contents"],function(e,t,n){var i=[].indexOf,s=e.Evented.inherit({init:function(n,i){var s,r,o;this.editable=n,this.opts=e.extend({},this.opts,i),this.throttledValueChanged=this.editable.util.throttle((o=this,function(e){return setTimeout(function(){return o.editable.trigger("valuechanged",e)},10)}),300),this.throttledSelectionChanged=this.editable.util.throttle(function(e){return function(){return e.editable.trigger("selectionchanged")}}(this),50),t(document).on("selectionchange.simditor"+this.editable.id,function(e){return function(t){var n;if(e.focused&&!e.editable.clipboard.pasting)return(n=function(){return e._selectionTimer&&(clearTimeout(e._selectionTimer),e._selectionTimer=null),e.editable.selection._selection.rangeCount>0?e.throttledSelectionChanged():e._selectionTimer=setTimeout(function(){if(e._selectionTimer=null,e.focused)return n()},10)})()}}(this)),this.editable.on("valuechanged",function(e){return function(){var n;if(e.lastCaretPosition=null,n=e.editable.body.children().filter(function(t,n){return e.editable.util.isBlockNode(n)}),e.focused&&0===n.length&&(e.editable.selection.save(),e.editable.formatter.format(),e.editable.selection.restore()),e.editable.body.find("hr, pre, ."+e.opts.classPrefix+"table").each(function(n,i){var s,r;if(((s=t(i)).parent().is("blockquote")||s.parent()[0]===e.editable.body[0])&&(r=!1,0===s.next().length&&(t("<p/>").append(e.editable.util.phBr).insertAfter(s),r=!0),0===s.prev().length&&(t("<p/>").append(e.editable.util.phBr).insertBefore(s),r=!0),r))return e.throttledValueChanged()}),e.editable.body.find("pre:empty").append(e.editable.util.phBr),!e.editable.util.support.onselectionchange&&e.focused)return e.throttledSelectionChanged()}}(this)),this.editable.body.on("keydown",e.proxy(this._onKeyDown,this)).on("keypress",e.proxy(this._onKeyPress,this)).on("keyup",e.proxy(this._onKeyUp,this)).on("mouseup",e.proxy(this._onMouseUp,this)).on("focus",e.proxy(this._onFocus,this)).on("blur",e.proxy(this._onBlur,this)).on("drop",e.proxy(this._onDrop,this)).on("input",e.proxy(this._onInput,this)),this.editable.util.browser.firefox&&(this.editable.hotkeys.add("cmd+left",function(e){return function(t){return t.preventDefault(),e.editable.selection._selection.modify("move","backward","lineboundary"),!1}}(this)),this.editable.hotkeys.add("cmd+right",function(e){return function(t){return t.preventDefault(),e.editable.selection._selection.modify("move","forward","lineboundary"),!1}}(this)),s=this.editable.util.os.mac?"cmd+a":"ctrl+a",this.editable.hotkeys.add(s,function(e){return function(t){var n,i,s,r;if((n=e.editable.body.children()).length>0)return i=n.first().get(0),s=n.last().get(0),(r=document.createRange()).setStart(i,0),r.setEnd(s,e.editable.util.getNodeLength(s)),e.editable.selection.range(r),!1}}(this))),r=this.editable.util.os.mac?"cmd+enter":"ctrl+enter",this.editable.hotkeys.add(r,function(e){return function(t){return e.editable.$el.closest("form").find("button:submit").click(),!1}}(this))}});return s.pluginName="InputManager",s.prototype._modifierKeys=[16,17,18,91,93,224],s.prototype._arrowKeys=[37,38,39,40],s.prototype._onFocus=function(e){var t;if(!this.editable.clipboard.pasting)return this.editable.$el.addClass("focus").removeClass("error"),this.focused=!0,setTimeout((t=this,function(){var e,n;if((n=t.editable.selection._selection.getRangeAt(0)).startContainer===t.editable.body[0]&&(t.lastCaretPosition?t.editable.undoManager.caretPosition(t.lastCaretPosition):(e=t.editable.body.children().first(),n=document.createRange(),t.editable.selection.setRangeAtStartOf(e,n),console.log("aaaaaa"))),t.lastCaretPosition=null,t.editable.trigger("focus"),!t.editable.util.support.onselectionchange)return t.throttledSelectionChanged()}),0)},s.prototype._onBlur=function(e){var t;if(!this.editable.clipboard.pasting)return this.editable.$el.removeClass("focus"),this.editable.sync(),this.focused=!1,this.lastCaretPosition=null!=(t=this.editable.undoManager.currentState())?t.caret:void 0,this.editable.trigger("blur")},s.prototype._onMouseUp=function(e){if(!this.editable.util.support.onselectionchange)return this.throttledSelectionChanged()},s.prototype._onKeyDown=function(e){var t,n;if(!1===this.editable.trigger(e))return!1;if(!this.editable.hotkeys.respondTo(e)){if(this.editable.keystroke.respondTo(e))return this.throttledValueChanged(),!1;if(!(t=e.which,i.call(this._modifierKeys,t)>=0||(n=e.which,i.call(this._arrowKeys,n)>=0)||this.editable.util.metaKey(e)&&86===e.which))return this.editable.util.support.oninput||this.throttledValueChanged(["typing"]),null}},s.prototype._onKeyPress=function(e){if(!1===this.editable.trigger(e))return!1},s.prototype._onKeyUp=function(e){var n,s;if(!1===this.editable.trigger(e))return!1;!this.editable.util.support.onselectionchange&&(s=e.which,i.call(this._arrowKeys,s)>=0)?this.throttledValueChanged():8!==e.which&&46!==e.which||!this.editable.util.isEmptyNode(this.editable.body)||(this.editable.body.empty(),n=t("<p/>").append(this.editable.util.phBr).appendTo(this.editable.body),this.editable.selection.setRangeAtStartOf(n))},s.prototype._onDrop=function(e){return!1!==this.editable.trigger(e)&&this.throttledValueChanged()},s.prototype._onInput=function(e){return this.throttledValueChanged(["oninput"])},n.InputManager=s}),t("skylark-domx-contents/Selection",["skylark-langx/langx","skylark-domx-noder","skylark-domx-query","./contents"],function(e,t,n,i){var s=e.Evented.inherit({_range:null,_startNodes:null,_endNodes:null,_containerNode:null,_nodes:null,_blockNodes:null,_rootNodes:null,init:function(t,n){var i=this;this.editable=t,this.opts=e.extend({},this.opts,n),this._selection=document.getSelection(),this.editable.on("selectionchanged",function(e){return console.log("selectionchanged"),i.reset(),i._range=i._selection.getRangeAt(0)}),this.editable.on("blur",function(e){return i.reset()}),this.editable.on("focus",function(e){return i.reset(),i._range=i._selection.getRangeAt(0)})},reset:function(){return this._range=null,this._startNodes=null,this._endNodes=null,this._containerNode=null,this._nodes=null,this._blockNodes=null,this._rootNodes=null},clear:function(){try{this._selection.removeAllRanges(),console.log("clear")}catch(e){e}return this.reset()},range:function(t){var n;return t?(this.clear(),this._selection.addRange(t),this._range=t,n=e.hoster.browser.mozilla||e.hoster.browser.msie,!this.editable.inputManager.focused&&n&&this.editable.body.focus()):!this._range&&this.editable.inputManager.focused&&this._selection.rangeCount&&(this._range=this._selection.getRangeAt(0)),this._range},startNodes:function(){var e;return this._range&&(this._startNodes||(this._startNodes=(e=this,function(){var t;return(t=n(e._range.startContainer).parentsUntil(e.editable.body).get()).unshift(e._range.startContainer),n(t)})())),this._startNodes},endNodes:function(){var e;return this._range&&(this._endNodes||(this._endNodes=this._range.collapsed?this.startNodes():((e=n(this._range.endContainer).parentsUntil(this.editable.body).get()).unshift(this._range.endContainer),n(e)))),this._endNodes},containerNode:function(){return this._range&&(this._containerNode||(this._containerNode=n(this._range.commonAncestorContainer))),this._containerNode},nodes:function(){var t;return this._range&&(this._nodes||(this._nodes=(t=this,function(){var i;return i=[],t.startNodes().first().is(t.endNodes().first())?i=t.startNodes().get():(t.startNodes().each(function(s,r){var o,a,l,d,c,h,u;return a=n(r),t.endNodes().index(a)>-1?i.push(r):a.parent().is(t.editable.body)||(h=t.endNodes().index(a.parent()))>-1?(o=h&&h>-1?t.endNodes().eq(h-1):t.endNodes().last(),l=a.parent().contents(),u=l.index(a),d=l.index(o),e.merge(i,l.slice(u,d).get())):(l=a.parent().contents(),c=l.index(a),e.merge(i,l.slice(c).get()))}),t.endNodes().each(function(s,r){var o,a,l;return(o=n(r)).parent().is(t.editable.body)||t.startNodes().index(o.parent())>-1?(i.push(r),!1):(a=o.parent().contents(),l=a.index(o),e.merge(i,a.slice(0,l+1)))})),n(e.uniq(i))})())),this._nodes},blockNodes:function(){var e;if(this._range)return this._blockNodes||(this._blockNodes=(e=this,function(){return e.nodes().filter(function(t,n){return e.editable.util.isBlockNode(n)})})()),this._blockNodes},rootNodes:function(){var e;if(this._range)return this._rootNodes||(this._rootNodes=(e=this,function(){return e.nodes().filter(function(t,i){var s;return(s=n(i).parent()).is(e.editable.body)||s.is("blockquote")})})()),this._rootNodes},rangeAtEndOf:function(e,i){var s,r,o,a,l,d;if(null==i&&(i=this.range()),i&&i.collapsed)return e=n(e)[0],o=i.endContainer,a=this.editable.util.getNodeLength(o),r=i.endOffset===a-1,l=n(o).contents().last().is("br"),s=i.endOffset===a,!!(r&&l||s)&&(e===o||!!t.contains(e,o)&&(d=!0,n(o).parentsUntil(e).addBack().each(function(e,t){var i,s,r,o;if(o=n(t).parent().contents().filter(function(){return!(this!==t&&3===this.nodeType&&!this.nodeValue)}),i=o.last(),r=i.get(0)===t,s=i.is("br")&&i.prev().get(0)===t,!r&&!s)return d=!1,!1}),d))},rangeAtStartOf:function(e,i){var s,r;if(null==i&&(i=this.range()),i&&i.collapsed)return e=n(e)[0],r=i.startContainer,0===i.startOffset&&(e===r||!!t.contains(e,r)&&(s=!0,n(r).parentsUntil(e).addBack().each(function(e,t){if(n(t).parent().contents().filter(function(){return!(this!==t&&3===this.nodeType&&!this.nodeValue)}).first().get(0)!==t)return s=!1}),s))},insertNode:function(e,t){if(null==t&&(t=this.range()),t)return e=n(e)[0],t.insertNode(e),this.setRangeAfter(e,t)},setRangeAfter:function(e,t){if(null==t&&(t=this.range()),null!=t)return e=n(e)[0],t.setEndAfter(e),t.collapse(!1),this.range(t)},setRangeBefore:function(e,t){if(null==t&&(t=this.range()),null!=t)return e=n(e)[0],t.setEndBefore(e),t.collapse(!1),this.range(t)},setRangeAtStartOf:function(e,t){return null==t&&(t=this.range()),e=n(e).get(0),t.setEnd(e,0),t.collapse(!1),this.range(t)},setRangeAtEndOf:function(e,t){var i,s,r,o,a,l,d;if(null==t&&(t=this.range()),s=n(e),e=s[0])return s.is("pre")?(r=s.contents()).length>0?(o=r.last(),l=o.text(),a=this.editable.util.getNodeLength(o[0]),"\n"===l.charAt(l.length-1)?t.setEnd(o[0],a-1):t.setEnd(o[0],a)):t.setEnd(e,0):(d=this.editable.util.getNodeLength(e),3!==e.nodeType&&d>0&&((i=n(e).contents().last()).is("br")?d-=1:3!==i[0].nodeType&&this.editable.util.isEmptyNode(i)&&(i.append(this.editable.util.phBr),e=i[0],d=0)),t.setEnd(e,d)),t.collapse(!1),this.range(t)},deleteRangeContents:function(e){var t,n,i,s;return null==e&&(e=this.range()),s=e.cloneRange(),i=e.cloneRange(),s.collapse(!0),i.collapse(!1),n=this.rangeAtStartOf(this.editable.body,s),t=this.rangeAtEndOf(this.editable.body,i),!e.collapsed&&n&&t?(this.editable.body.empty(),e.setStart(this.editable.body[0],0),e.collapse(!0),this.range(e)):e.deleteContents(),e},breakBlockEl:function(e,t){var i;return null==t&&(t=this.range()),i=n(e),t.collapsed?(t.setStartBefore(i.get(0)),t.collapsed?i:i.before(t.extractContents())):i},save:function(e){var t,i,s;if(null==e&&(e=this.range()),!this._selectionSaved)return(i=e.cloneRange()).collapse(!1),s=n("<span/>").addClass(this.opts.classPrefix+"caret-start"),t=n("<span/>").addClass(this.opts.classPrefix+"caret-end"),i.insertNode(t[0]),e.insertNode(s[0]),this.clear(),this._selectionSaved=!0},restore:function(){var e,t,n,i,s,r,o;return!!this._selectionSaved&&(s=this.editable.body.find("."+this.opts.classPrefix+"caret-start"),e=this.editable.body.find("."+this.opts.classPrefix+"caret-end"),s.length&&e.length?(r=s.parent(),o=r.contents().index(s),t=e.parent(),n=t.contents().index(e),r[0]===t[0]&&(n-=1),(i=document.createRange()).setStart(r.get(0),o),i.setEnd(t.get(0),n),s.remove(),e.remove(),this.range(i)):(s.remove(),e.remove()),this._selectionSaved=!1,i)}});return s.pluginName="Selection",i.Selection=s}),t("skylark-domx-contents/UndoManager",["skylark-langx/langx","skylark-domx-query","./contents"],function(e,t,n){var i=e.Evented.inherit({init:function(t,n){var i,s,r;this.editable=t,this.opts=e.extend({},this.opts,n),this._stack=[],this.editable.util.os.mac?(s="cmd+z",i="shift+cmd+z"):this.editable.util.os.win?(s="ctrl+z",i="ctrl+y"):(s="ctrl+z",i="shift+ctrl+z"),this.editable.hotkeys.add(s,(r=this,function(e){return e.preventDefault(),r.undo(),!1})),this.editable.hotkeys.add(i,function(e){return function(t){return t.preventDefault(),e.redo(),!1}}(this)),this.throttledPushState=this.editable.util.throttle(function(e){return function(){return e._pushUndoState()}}(this),2e3),this.editable.on("valuechanged",function(e){return function(t,n){if("undo"!==n&&"redo"!==n)return e.throttledPushState()}}(this)),this.editable.on("selectionchanged",function(e){return function(t){return e.resetCaretPosition(),e.update()}}(this)),this.editable.on("focus",function(e){return function(t){if(0===e._stack.length)return e._pushUndoState()}}(this)),this.editable.on("blur",function(e){return function(t){return e.resetCaretPosition()}}(this))}});return i.pluginName="UndoManager",i.prototype._index=-1,i.prototype._capacity=20,i.prototype._startPosition=null,i.prototype._endPosition=null,i.prototype.resetCaretPosition=function(){return this._startPosition=null,this._endPosition=null},i.prototype.startPosition=function(){return this.editable.selection._range&&(this._startPosition||(this._startPosition=this._getPosition("start"))),this._startPosition},i.prototype.endPosition=function(){var e;return this.editable.selection._range&&(this._endPosition||(this._endPosition=(e=this,function(){return e.editable.selection.range().collapsed?e._startPosition:e._getPosition("end")})())),this._endPosition},i.prototype._pushUndoState=function(){if(!1!==this.editable.trigger("pushundostate")&&this.caretPosition().start)return this._index+=1,this._stack.length=this._index,this._stack.push({html:this.editable.body.html(),caret:this.caretPosition()}),this._stack.length>this._capacity?(this._stack.shift(),this._index-=1):void 0},i.prototype.currentState=function(){return this._stack.length&&this._index>-1?this._stack[this._index]:null},i.prototype.undo=function(){var e;if(!(this._index<1||this._stack.length<2))return this.editable.hidePopover(),this._index-=1,e=this._stack[this._index],this.editable.body.get(0).innerHTML=e.html,this.caretPosition(e.caret),this.editable.body.find(".selected").removeClass("selected"),this.editable.sync(),this.editable.trigger("valuechanged",["undo"])},i.prototype.redo=function(){var e;if(!(this._index<0||this._stack.length<this._index+2))return this.editable.hidePopover(),this._index+=1,e=this._stack[this._index],this.editable.body.get(0).innerHTML=e.html,this.caretPosition(e.caret),this.editable.body.find(".selected").removeClass("selected"),this.editable.sync(),this.editable.trigger("valuechanged",["redo"])},i.prototype.update=function(){var e;if(e=this.currentState())return e.html=this.editable.body.html(),e.caret=this.caretPosition()},i.prototype._getNodeOffset=function(n,i){var s,r,o;return s=e.isNumber(i)?t(n):t(n).parent(),o=0,r=!1,s.contents().each(function(e,t){return n!==t&&(i!==e||0!==e)&&(t.nodeType===Node.TEXT_NODE?!r&&t.nodeValue.length>0&&(o+=1,r=!0):(o+=1,r=!1),i-1!==e&&null)}),o},i.prototype._getPosition=function(e){var n,i,s,r,o,a,l,d;if(null==e&&(e="start"),l=this.editable.selection.range(),r=l[e+"Offset"],n=this.editable.selection[e+"Nodes"](),(i=n.first()[0]).nodeType===Node.TEXT_NODE){for(a=i.previousSibling;a&&a.nodeType===Node.TEXT_NODE;)i=a,r+=this.editable.util.getNodeLength(a),a=a.previousSibling;(s=n.get())[0]=i,n=t(s)}else r=this._getNodeOffset(i,r);return o=[r],n.each((d=this,function(e,t){return o.unshift(d._getNodeOffset(t))})),o},i.prototype._getNodeByPosition=function(e){var n,i,s,r,o,a,l,d;for(a=this.editable.body[0],d=e.slice(0,e.length-1),s=r=0,o=d.length;r<o;s=++r){if(l=d[s],i=a.childNodes,l>i.length-1){if(s!==e.length-2||!t(a).is(":empty")){a=null;break}n=document.createTextNode(""),a.appendChild(n),i=a.childNodes}a=i[l]}return a},i.prototype.caretPosition=function(e){var t,n,i,s,r;if(e){if(!e.start)return;return s=this._getNodeByPosition(e.start),r=e.start[e.start.length-1],e.collapsed?(t=s,n=r):(t=this._getNodeByPosition(e.end),n=e.start[e.start.length-1]),s&&t?((i=document.createRange()).setStart(s,r),i.setEnd(t,n),this.editable.selection.range(i)):void("undefined"!=typeof console&&null!==console&&"function"==typeof console.warn&&console.warn("simditor: invalid caret state"))}return i=this.editable.selection.range(),e=this.editable.inputManager.focused&&null!=i?{start:this.startPosition(),end:this.endPosition(),collapsed:i.collapsed}:{}},n.UndoManager=i}),t("skylark-domx-contents/Keystroke",["skylark-langx/langx","skylark-domx-query","./contents"],function(e,t,n){var i=e.Evented.inherit({init:function(t,n){this.editable=t,this.opts=e.extend({},this.opts,n),this._keystrokeHandlers={},this._initKeystrokeHandlers()}});return i.pluginName="Keystroke",i.prototype.add=function(e,t,n){return e=e.toLowerCase(),e=this.editable.hotkeys.constructor.aliases[e]||e,this._keystrokeHandlers[e]||(this._keystrokeHandlers[e]={}),this._keystrokeHandlers[e][t]=n},i.prototype.respondTo=function(e){var n,i,s,r,o;if(i=null!=(s=this.editable.hotkeys.constructor.keyNameMap[e.which])?s.toLowerCase():void 0)return!!(i in this._keystrokeHandlers&&((r="function"==typeof(n=this._keystrokeHandlers[i])["*"]?n["*"](e):void 0)||this.editable.selection.startNodes().each((o=this,function(n,s){var a,l;if(s.nodeType===Node.ELEMENT_NODE)return a=null!=(l=o._keystrokeHandlers[i])?l[s.tagName.toLowerCase()]:void 0,!0!==(r="function"==typeof a?a(e,t(s)):void 0)&&!1!==r&&void 0})),r))||void 0},i.prototype._initKeystrokeHandlers=function(){var e,n;return this.editable.util.browser.safari&&this.add("enter","*",(n=this,function(e){var i,s;if(e.shiftKey&&!(i=n.editable.selection.blockNodes().last()).is("pre"))return s=t("<br/>"),n.editable.selection.rangeAtEndOf(i)?(n.editable.selection.insertNode(s),n.editable.selection.insertNode(t("<br/>")),n.editable.selection.setRangeBefore(s)):n.editable.selection.insertNode(s),!0})),(this.editable.util.browser.webkit||this.editable.util.browser.msie)&&(e=function(e){return function(n,i){var s;if(e.editable.selection.rangeAtEndOf(i))return s=t("<p/>").append(e.editable.util.phBr).insertAfter(i),e.editable.selection.setRangeAtStartOf(s),!0}}(this),this.add("enter","h1",e),this.add("enter","h2",e),this.add("enter","h3",e),this.add("enter","h4",e),this.add("enter","h5",e),this.add("enter","h6",e)),this.add("backspace","*",function(e){return function(t){var n,i,s;return s=e.editable.selection.rootNodes().first(),(i=s.prev()).is("hr")&&e.editable.selection.rangeAtStartOf(s)?(e.editable.selection.save(),i.remove(),e.editable.selection.restore(),!0):((n=e.editable.selection.blockNodes().last()).is("."+this.opts.classPrefix+"resize-handle")&&s.is("."+this.opts.classPrefix+"table")&&(t.preventDefault(),s.remove(),e.editable.selection.setRangeAtEndOf(i)),i.is("."+this.opts.classPrefix+"table")&&!n.is("table")&&e.editable.util.isEmptyNode(n)&&(t.preventDefault(),n.remove(),e.editable.selection.setRangeAtEndOf(i)),e.editable.util.browser.webkit&&e.editable.selection.rangeAtStartOf(n)?(e.editable.selection.save(),e.editable.formatter.cleanNode(n,!0),e.editable.selection.restore(),null):void 0)}}(this)),this.add("enter","div",function(e){return function(n,i){var s;if(i.is("."+this.opts.classPrefix+"table")&&e.editable.selection.blockNodes().last().is("."+this.opts.classPrefix+"resize-handle"))return n.preventDefault(),s=t("<p/>").append(e.editable.util.phBr).insertAfter(i),e.editable.selection.setRangeAtStartOf(s)}}(this)),this.add("enter","li",function(e){return function(n,i){var s,r,o,a;if((s=i.clone()).find("ul, ol").remove(),e.editable.util.isEmptyNode(s)&&i.is(e.editable.selection.blockNodes().last())){if(r=i.parent(),i.next("li").length>0){if(!e.editable.util.isEmptyNode(i))return;r.parent("li").length>0?(o=t("<li/>").append(e.editable.util.phBr).insertAfter(r.parent("li")),a=t("<"+r[0].tagName+"/>").append(i.nextAll("li")),o.append(a)):(o=t("<p/>").append(e.editable.util.phBr).insertAfter(r),a=t("<"+r[0].tagName+"/>").append(i.nextAll("li")),o.after(a))}else r.parent("li").length>0?(o=t("<li/>").insertAfter(r.parent("li")),i.contents().length>0?o.append(i.contents()):o.append(e.editable.util.phBr)):(o=t("<p/>").append(e.editable.util.phBr).insertAfter(r),i.children("ul, ol").length>0&&o.after(i.children("ul, ol")));return i.prev("li").length?i.remove():i.prev("ul").length||i.prev("ol").length?i.remove():r.remove(),e.editable.selection.setRangeAtStartOf(o),!0}}}(this)),this.add("enter","pre",function(e){return function(n,i){var s,r,o;return n.preventDefault(),n.shiftKey?(s=t("<p/>").append(e.editable.util.phBr).insertAfter(i),e.editable.selection.setRangeAtStartOf(s),!0):(o=e.editable.selection.range(),r=null,o.deleteContents(),r=!e.editable.util.browser.msie&&e.editable.selection.rangeAtEndOf(i)?document.createTextNode("\n\n"):document.createTextNode("\n"),o.insertNode(r),o.setEnd(r,1),o.collapse(!1),e.editable.selection.range(o),!0)}}(this)),this.add("enter","blockquote",function(e){return function(t,n){var i,s;if((i=e.editable.selection.blockNodes().last()).is("p")&&!i.next().length&&e.editable.util.isEmptyNode(i))return n.after(i),s=document.createRange(),e.editable.selection.setRangeAtStartOf(i,s),!0}}(this)),this.add("backspace","li",function(e){return function(n,i){var s,r,o,a,l,d,c,h,u;return r=i.children("ul, ol"),l=i.prev("li"),r.length>0&&l.length>0&&(u="",d=null,i.contents().each(function(e,n){return(1!==n.nodeType||!/UL|OL/.test(n.nodeName))&&(1===n.nodeType&&/BR/.test(n.nodeName)?void 0:(3===n.nodeType&&n.nodeValue?u+=n.nodeValue:1===n.nodeType&&(u+=t(n).text()),d=t(n)))}),c=e.editable.util.browser.firefox&&!d.next("br").length,d&&1===u.length&&c?(s=t(e.editable.util.phBr).insertAfter(d),d.remove(),e.editable.selection.setRangeBefore(s),!0):!(u.length>0)&&(h=document.createRange(),(a=l.children("ul, ol")).length>0?(o=t("<li/>").append(e.editable.util.phBr).appendTo(a),a.append(r.children("li")),i.remove(),e.editable.selection.setRangeAtEndOf(o,h)):(e.editable.selection.setRangeAtEndOf(l,h),l.append(r),i.remove(),e.editable.selection.range(h)),!0))}}(this)),this.add("backspace","pre",function(e){return function(n,i){var s,r,o;if(e.editable.selection.rangeAtStartOf(i))return r=i.html().replace("\n","<br/>")||e.editable.util.phBr,s=t("<p/>").append(r).insertAfter(i),i.remove(),o=document.createRange(),e.editable.selection.setRangeAtStartOf(s,o),!0}}(this)),this.add("backspace","blockquote",function(e){return function(t,n){var i,s;if(e.editable.selection.rangeAtStartOf(n))return i=n.children().first().unwrap(),s=document.createRange(),e.editable.selection.setRangeAtStartOf(i,s),!0}}(this))},n.Keystroke=i}),t("skylark-domx-contents/Formatter",["skylark-langx/langx","skylark-domx-query","./contents"],function(e,t,n){var i=[].indexOf,s=e.Evented.inherit({opts:{allowedTags:[],allowedAttributes:{},allowedStyles:{}},init:function(t,n){this.editable=t,this.opts=e.extend({},this.opts,n),this._allowedTags=e.merge(["br","span","a","img","b","strong","i","strike","u","font","p","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","hr"],this.opts.allowedTags),this._allowedAttributes=e.extend({img:["src","alt","width","height","data-non-image"],a:["href","target"],font:["color"],code:["class"]},this.opts.allowedAttributes),this._allowedStyles=e.extend({span:["color","font-size"],b:["color","font-size"],i:["color","font-size"],strong:["color","font-size"],strike:["color","font-size"],u:["color","font-size"],p:["margin-left","text-align"],h1:["margin-left","text-align"],h2:["margin-left","text-align"],h3:["margin-left","text-align"],h4:["margin-left","text-align"]},this.opts.allowedStyles),this.editable.body.on("click","a",function(e){return!1})},decorate:function(e){return null==e&&(e=this.editable.body),this.editable.trigger("decorate",[e]),e},undecorate:function(e){return null==e&&(e=this.editable.body.clone()),this.editable.trigger("undecorate",[e]),e},autolink:function(e){var n,i,s,r,o,a,l,d,c,h,u,p,f;for(null==e&&(e=this.editable.body),l=[],(s=function(n){return n.contents().each(function(n,i){var r,o;if(!(r=t(i)).is("a")&&!r.closest("a, pre",e).length)return!r.is("iframe")&&r.contents().length?s(r):(o=r.text())&&/https?:\/\/|www\./gi.test(o)?l.push(r):void 0})})(e),c=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,r=0,a=l.length;r<a;r++){for(i=l[r],p=i.text(),h=[],d=null,o=0;null!==(d=c.exec(p));)u=p.substring(o,d.index),h.push(document.createTextNode(u)),o=c.lastIndex,f=/^(http(s)?:\/\/|\/)/.test(d[0])?d[0]:"http://"+d[0],n=t('<a href="'+f+'" rel="nofollow"></a>').text(d[0]),h.push(n[0]);h.push(document.createTextNode(p.substring(o))),i.replaceWith(t(h))}return e},format:function(e){var n,i,s,r,o,a,l,d,c,h;if(null==e&&(e=this.editable.body),e.is(":empty"))return e.append("<p>"+this.editable.util.phBr+"</p>"),e;for(c=e.contents(),s=0,o=c.length;s<o;s++)l=c[s],this.cleanNode(l,!0);for(h=e.contents(),r=0,a=h.length;r<a;r++)d=h[r],(n=t(d)).is("br")?(void 0!==i&&null!==i&&(i=null),n.remove()):this.editable.util.isBlockNode(d)?n.is("li")?i&&i.is("ul, ol")?i.append(d):(i=t("<ul/>").insertBefore(d)).append(d):i=null:(i&&!i.is("ul, ol")||(i=t("<p/>").insertBefore(d)),i.append(d),this.editable.util.isEmptyNode(i)&&i.append(this.editable.util.phBr));return e},cleanNode:function(n,s){var r,o,a,l,d,c,h,u,p,f,g,b,m,y,v,k,x,_;if((a=t(n)).length>0){if(3!==a[0].nodeType){if(u=a.is("iframe")?null:a.contents(),p=this.editable.util.isDecoratedNode(a),a.is(this._allowedTags.join(","))||p){if(a.is("a")&&(o=a.find("img")).length>0&&(a.replaceWith(o),a=o,u=null),a.is("td")&&(r=a.find(this.editable.util.blockNodes.join(","))).length>0&&(r.each(function(e,n){return t(n).contents().unwrap()}),u=a.contents()),a.is("img")&&a.hasClass("uploading")&&a.remove(),!p){for(c=this._allowedAttributes[a[0].tagName.toLowerCase()],v=e.makeArray(a[0].attributes),f=0,b=v.length;f<b;f++)"style"!==(h=v[f]).name&&(null!=c&&(k=h.name,i.call(c,k)>=0)||a.removeAttr(h.name));this._cleanNodeStyles(a),a.is("span")&&(0===a[0].attributes.length&&a.contents().first().unwrap(),2===a[0].style.length&&"rgb(51, 51, 51)"===a[0].style.color&&"16px"===a[0].style.fontSize&&a.contents().unwrap())}}else 1!==a[0].nodeType||a.is(":empty")?(a.remove(),u=null):a.is("div, article, dl, header, footer, tr")?(a.append("<br/>"),u.first().unwrap()):a.is("table")?(l=t("<p/>"),a.find("tr").each(function(e,n){return l.append(t(n).text()+"<br/>")}),a.replaceWith(l),u=null):a.is("thead, tfoot")?(a.remove(),u=null):a.is("th")?(d=t("<td/>").append(a.contents()),a.replaceWith(d)):u.first().unwrap();if(s&&null!=u&&!a.is("pre"))for(g=0,m=u.length;g<m;g++)y=u[g],this.cleanNode(y,!0);return null}(x=a.text().replace(/(\r\n|\n|\r)/gm,""))?(_=document.createTextNode(x),a.replaceWith(_)):a.remove()}},_cleanNodeStyles:function(t){var n,s,r,o,a,l,d,c,h;if(c=t.attr("style")){if(t.removeAttr("style"),!((n=this._allowedStyles[t[0].tagName.toLowerCase()])&&n.length>0))return t;for(h={},a=c.split(";"),s=0,r=a.length;s<r;s++)d=a[s],d=e.trim(d),2===(o=d.split(":")).length&&("font-size"===o[0]&&o[1].indexOf("px")>0&&parseInt(o[1],10)<12||(l=o[0],i.call(n,l)>=0&&(h[e.trim(o[0])]=e.trim(o[1]))));return Object.keys(h).length>0&&t.css(h),t}},clearHtml:function(e,n){var i,s,r,o;return null==n&&(n=!0),i=t("<div/>").append(e),s=i.contents(),r="",s.each((o=this,function(e,i){var a,l;return 3===i.nodeType?r+=i.nodeValue:1===i.nodeType&&(a=t(i),(l=a.is("iframe")?null:a.contents())&&l.length>0&&(r+=o.clearHtml(l)),n&&e<s.length-1&&a.is("br, p, div, li,tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2,h3, h4, header"))?r+="\n":void 0})),r},beautify:function(e){var n;return n=function(e){return!!(e.is("p")&&!e.text()&&e.children(":not(br)").length<1)},e.each(function(e,i){var s;return s=t(i),(s.is(':not(img, br, col, td, hr, [class^="'+this.opts.classPrefix+'"]):empty')||n(s))&&s.remove(),s.find(':not(img, br, col, td, hr, [class^="'+this.opts.classPrefix+'"]):empty').remove()})}});return s.pluginName="Formatter",n.Formatter=s}),t("skylark-domx-contents/Indentation",["skylark-langx/langx","skylark-domx-noder","skylark-domx-query","./contents"],function(e,t,n,i){var s=e.Evented.inherit({});return s.pluginName="Indentation",s.prototype.opts={tabIndent:!0,indentWidth:40},s.prototype.init=function(t,n){var i;this.editable=t,this.opts=e.extend({},this.opts,n),this.editable.keystroke.add("tab","*",(i=this,function(e){var t;if(t=i.editable.toolbar.findButton("code"),i.opts.tabIndent||t&&t.active)return i.indent(e.shiftKey)}))},s.prototype.indent=function(e){var i,s,r,o;return this.editable.selection.startNodes(),this.editable.selection.endNodes(),i=this.editable.selection.blockNodes(),s=[],i=i.each(function(e,n){var i,r,o,a,l;for(i=!0,r=o=0,a=s.length;o<a;r=++o){if(l=s[r],t.contains(n,l)){i=!1;break}if(t.contains(l,n)){s.splice(r,1,n),i=!1;break}}if(i)return s.push(n)}),i=n(s),r=!1,i.each((o=this,function(t,n){var i;if(i=e?o.outdentBlock(n):o.indentBlock(n))return r=i})),r},s.prototype.indentBlock=function(e){var t,i,s,r,o,a,l,d,c,h;if((t=n(e)).length){if(t.is("pre")){if(!(a=this.editable.selection.containerNode()).is(t)&&!a.closest("pre").is(t))return;this.indentText(this.editable.selection.range())}else if(t.is("li")){if((o=t.prev("li")).length<1)return;this.editable.selection.save(),h=t.parent()[0].tagName,(i=o.children("ul, ol")).length>0?i.append(t):n("<"+h+"/>").append(t).appendTo(o),this.editable.selection.restore()}else if(t.is("p, h1, h2, h3, h4"))c=parseInt(t.css("margin-left"))||0,c=(Math.round(c/this.opts.indentWidth)+1)*this.opts.indentWidth,t.css("margin-left",c);else{if(!t.is("table")&&!t.is("."+this.opts.classPrefix+"table"))return!1;if(l=this.editable.selection.containerNode().closest("td, th"),(s=l.next("td, th")).length>0||(d=l.parent("tr"),(r=d.next("tr")).length<1&&d.parent().is("thead")&&(r=d.parent("thead").next("tbody").find("tr:first")),s=r.find("td:first, th:first")),!(l.length>0&&s.length>0))return;this.editable.selection.setRangeAtEndOf(s)}return!0}},s.prototype.indentText=function(e){var t,n;return t=e.toString().replace(/^(?=.+)/gm,"  "),n=document.createTextNode(t||"  "),e.deleteContents(),e.insertNode(n),t?(e.selectNode(n),this.editable.selection.range(e)):this.editable.selection.setRangeAfter(n)},s.prototype.outdentBlock=function(e){var t,i,s,r,o,a,l,d,c,h;if((t=n(e))&&t.length>0){if(t.is("pre")){if(!(r=this.editable.selection.containerNode()).is(t)&&!r.closest("pre").is(t))return;this.outdentText(h)}else if(t.is("li"))i=t.parent(),s=i.parent("li"),this.editable.selection.save(),s.length<1?((h=document.createRange()).setStartBefore(i[0]),h.setEndBefore(t[0]),i.before(h.extractContents()),n("<p/>").insertBefore(i).after(t.children("ul, ol")).append(t.contents()),t.remove()):(t.next("li").length>0&&n("<"+i[0].tagName+"/>").append(t.nextAll("li")).appendTo(t),t.insertAfter(s),i.children("li").length<1&&i.remove()),this.editable.selection.restore();else if(t.is("p, h1, h2, h3, h4"))c=parseInt(t.css("margin-left"))||0,c=Math.max(Math.round(c/this.opts.indentWidth)-1,0)*this.opts.indentWidth,t.css("margin-left",0===c?"":c);else{if(!t.is("table")&&!t.is("."+this.opts.classPrefix+"table"))return!1;if(l=this.editable.selection.containerNode().closest("td, th"),(o=l.prev("td, th")).length>0||(d=l.parent("tr"),(a=d.prev("tr")).length<1&&d.parent().is("tbody")&&(a=d.parent("tbody").prev("thead").find("tr:first")),o=a.find("td:last, th:last")),!(l.length>0&&o.length>0))return;this.editable.selection.setRangeAtEndOf(o)}return!0}},s.prototype.outdentText=function(e){},i.Indentation=s}),t("skylark-domx-contents/Clipboard",["skylark-langx/langx","skylark-domx-query","./contents"],function(e,t,n){var i=e.Evented.inherit({});return i.pluginName="Clipboard",i.prototype.opts={pasteImage:!1,cleanPaste:!1},i.prototype.init=function(t,n){var i;this.editable=t,this.opts=e.extend({},this.opts,n),this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this.editable.body.on("paste",(i=this,function(e){var t;if(!i.pasting&&!i._pasteBin)return!1!==i.editable.trigger(e)&&(t=i.editable.selection.deleteRangeContents(),i.editable.body.html()?t.collapsed||t.collapse(!0):(i.editable.formatter.format(),i.editable.selection.setRangeAtStartOf(i.editable.body.find("p:first"))),!i._processPasteByClipboardApi(e)&&(i.editable.inputManager.throttledValueChanged.clear(),i.editable.inputManager.throttledSelectionChanged.clear(),i.editable.undoManager.throttledPushState.clear(),i.editable.selection.reset(),i.editable.undoManager.resetCaretPosition(),i.pasting=!0,i._getPasteContent(function(e){return i._processPasteContent(e),i._pasteInBlockEl=null,i._pastePlainText=null,i.pasting=!1})))}))},i.prototype._processPasteByClipboardApi=function(e){var t,n,i,s;if(!this.editable.util.browser.edge&&e.originalEvent.clipboardData&&e.originalEvent.clipboardData.items&&e.originalEvent.clipboardData.items.length>0&&(n=e.originalEvent.clipboardData.items[0],/^image\//.test(n.type))){if(null==(t=n.getAsFile())||!this.opts.pasteImage)return;if(t.name||(t.name="Clipboard Image.png"),!1===this.editable.triggerHandler("pasting",[t]))return;return(s={})[this.opts.pasteImage]=!0,null!=(i=this.editable.uploader)&&i.upload(t,s),!0}},i.prototype._getPasteContent=function(e){var n,i;return this._pasteBin=t('<div contenteditable="true" />').addClass(this.opts.classPrefix+"paste-bin").attr("tabIndex","-1").appendTo(this.editable.$el),n={html:this.editable.body.html(),caret:this.editable.undoManager.caretPosition()},this._pasteBin.focus(),setTimeout((i=this,function(){var s;return i.editable.hidePopover(),i.editable.body.get(0).innerHTML=n.html,i.editable.undoManager.caretPosition(n.caret),i.editable.body.focus(),i.editable.selection.reset(),i.editable.selection.range(),i._pasteInBlockEl=i.editable.selection.blockNodes().last(),i._pastePlainText=i.opts.cleanPaste||i._pasteInBlockEl.is("pre, table"),i._pastePlainText?s=i.editable.formatter.clearHtml(i._pasteBin.html(),!0):((s=t("<div/>").append(i._pasteBin.contents())).find("style").remove(),s.find("table colgroup").remove(),i._cleanPasteFontSize(s),i.editable.formatter.format(s),i.editable.formatter.decorate(s),i.editable.formatter.beautify(s.children()),s=s.contents()),i._pasteBin.remove(),i._pasteBin=null,e(s)}),0)},i.prototype._processPasteContent=function(e){var n,i,s,r,o,a,l,d,c,h,u,p,f,g,b,m,y,v,k,x,_,N,w,C,A,B;if(!1!==this.editable.triggerHandler("pasting",[e])&&(n=this._pasteInBlockEl,e)){if(this._pastePlainText)if(n.is("table")){for(y=e.split("\n"),h=y.pop(),d=0,u=y.length;d<u;d++)m=y[d],this.editable.selection.insertNode(document.createTextNode(m)),this.editable.selection.insertNode(t("<br/>"));this.editable.selection.insertNode(document.createTextNode(h))}else for(e=t("<div/>").text(e),N=e.contents(),c=0,p=N.length;c<p;c++)k=N[c],this.editable.selection.insertNode(t(k)[0]);else if(n.is(this.editable.body))for(v=0,f=e.length;v<f;v++)k=e[v],this.editable.selection.insertNode(k);else{if(e.length<1)return;if(1===e.length)if(e.is("p")){if(r=e.contents(),n.is("h1, h2, h3, h4, h5")&&r.length&&r.css("font-size",""),1===r.length&&r.is("img")){if(/^data:image/.test((i=r).attr("src"))){if(!this.opts.pasteImage)return;return(s=this.editable.util.dataURLtoBlob(i.attr("src"))).name="Clipboard Image.png",(A={})[this.opts.pasteImage]=!0,void(null!=(w=this.editable.uploader)&&w.upload(s,A))}if(new RegExp("^blob:"+location.origin+"/").test(i.attr("src"))){if(!this.opts.pasteImage)return;return(A={})[this.opts.pasteImage]=!0,o=this.editable.util.dataURLtoBlob,B=this.editable.uploader,(a=new Image).onload=function(){var e;(e=document.createElement("canvas")).width=a.naturalWidth,e.height=a.naturalHeight,e.getContext("2d").drawImage(a,0,0),(s=o(e.toDataURL("image/png"))).name="Clipboard Image.png",null!==B&&B.upload(s,A)},void(a.src=i.attr("src"))}if(i.is('img[src^="webkit-fake-url://"]'))return}for(x=0,g=r.length;x<g;x++)k=r[x],this.editable.selection.insertNode(k)}else if(n.is("p")&&this.editable.util.isEmptyNode(n))n.replaceWith(e),this.editable.selection.setRangeAtEndOf(e);else if(e.is("ul, ol"))if(1===e.find("li").length)for(e=t("<div/>").text(e.text()),C=e.contents(),_=0,b=C.length;_<b;_++)k=C[_],this.editable.selection.insertNode(t(k)[0]);else n.is("li")?(n.parent().after(e),this.editable.selection.setRangeAtEndOf(e)):(n.after(e),this.editable.selection.setRangeAtEndOf(e));else n.after(e),this.editable.selection.setRangeAtEndOf(e);else n.is("li")&&(n=n.parent()),this.editable.selection.rangeAtStartOf(n)?l="before":this.editable.selection.rangeAtEndOf(n)?l="after":(this.editable.selection.breakBlockEl(n),l="before"),n[l](e),this.editable.selection.setRangeAtEndOf(e.last())}return this.editable.inputManager.throttledValueChanged()}},i.prototype._cleanPasteFontSize=function(n){var i,s;if((i=t(n)).length>0)return s=["1.5em","1.25em","0.75em","0.5em"],i.find('[style*="font-size"]').map(function(n,i){var r;if(r=t(i),e.inArray(r.css("font-size"),s)<0)return r.css("font-size","")})},n.Clipboard=i}),t("skylark-domx-contents/Editable",["skylark-langx/langx","skylark-domx-noder","skylark-domx-query","./contents","./Hotkeys","./Util","./InputManager","./Selection","./UndoManager","./Keystroke","./Formatter","./Indentation","./Clipboard"],function(t,n,i,s,r,o,a,l,d,c,h,u,p){var f=t.Evented.inherit({init:function(t,n){this.$el=i(t),this.textarea=i(n.textarea),this.body=i(n.body);var s={classPrefix:n.classPrefix};if(this.util=new o(this,s),this.hotkeys=new r({el:this.body}),this.inputManager=new a(this,s),this.selection=new l(this,s),this.undoManager=new d(this,s),this.keystroke=new c(this,s),this.formatter=new h(this,s),this.indentation=new u(this,s),this.clipboard=new p(this,s),this.util.os.mac?this.$el.addClass(n.classPrefix+"mac"):this.util.os.linux&&this.$el.addClass(n.classPrefix+"linux"),this.util.os.mobile&&this.$el.addClass(n.classPrefix+"mobile"),this.util.browser.mozilla){this.util.reflow();try{return document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(t){e=t}}},setValue:function(e){this.textarea.val(e),this.body.get(0).innerHTML=e,this.formatter.format(),this.formatter.decorate(),this.util.reflow(this.body),this.inputManager.lastCaretPosition=null},getValue:function(){return this.sync()},sync:function(){var e,n,i,s,r,o;for(n=this.body.clone(),this.formatter.undecorate(n),this.formatter.format(n),this.formatter.autolink(n),e=n.children(),r=e.last("p"),s=e.first("p");r.is("p")&&this.util.isEmptyNode(r);)i=r,r=r.prev("p"),i.remove();for(;s.is("p")&&this.util.isEmptyNode(s);)i=s,s=r.next("p"),i.remove();return n.find("img.uploading").remove(),o=t.trim(n.html()),this.textarea.val(o),o},focus:function(){var e,t;if(this.body.is(":visible")&&this.body.is("[contenteditable]"))return this.inputManager.lastCaretPosition?(this.undoManager.caretPosition(this.inputManager.lastCaretPosition),this.inputManager.lastCaretPosition=null):((e=this.body.children().last()).is("p")||(e=i("<p/>").append(this.util.phBr).appendTo(this.body)),t=document.createRange(),this.selection.setRangeAtEndOf(e,t));this.$el.find("textarea:visible").focus()},blur:function(){return this.body.is(":visible")&&this.body.is("[contenteditable]")?this.body.blur():this.body.find("textarea:visible").blur()},isActive:function(e){return!0===document.queryCommandState(e)},status:function(e,t){if("alignment"===e){var n=this.selection.nodes().filter(t);return n.length<1?null:n.first().css("text-align")}},alignment:function(e,t){if("left"!==e&&"center"!==e&&"right"!==e)throw new Error("simditor alignment button: invalid align "+e);var n=this.selection.nodes().filter(t);return n.css({"text-align":"left"===e?"":e}),this.trigger("valuechanged"),this.inputManager.throttledSelectionChanged()},blockquote:function(e,t){var n,s,r,o;return n=(n=this.selection.rootNodes()).filter(function(e,t){return!i(t).parent().is("blockquote")}),this.selection.save(),r=[],o=this,s=function(){if(r.length>0)return i("<"+o.htmlTag+"/>").insertBefore(r[0]).append(r),r.length=0},n.each(function(n){return function(o,a){var l;if((l=i(a)).parent().is(n.body))return l.is(e)?(s(),l.children().unwrap()):l.is(t)||n.util.isDecoratedNode(l)?s():r.push(a)}}(this)),s(),this.selection.restore(),this.trigger("valuechanged")},blockCode:function(e,t){var n,s,r,o,a;return n=this.selection.rootNodes(),r=[],o=[],a=this,s=function(){var t;if(r.length>0)return t=i("<"+e+"/>").insertBefore(r[0]).text(a.formatter.clearHtml(r)),o.push(t[0]),r.length=0},n.each(function(n){return function(a,l){var d,c;return(d=i(l)).is(e)?(s(),c=i("<p/>").append(d.html().replace("\n","<br/>")).replaceAll(d),o.push(c[0])):d.is(t)||n.util.isDecoratedNode(d)||d.is("blockquote")?s():r.push(l)}}(this)),s(),this.selection.setRangeAtEndOf(i(o).last()),this.trigger("valuechanged")},fontColor:function(e,t,n){var i=this.selection.range();if(!t&&i.collapsed&&(textNode=document.createTextNode(n),i.insertNode(textNode),i.selectNodeContents(textNode)),this.selection.range(i),document.execCommand("styleWithCSS",!1,!0),document.execCommand("foreColor",!1,e),document.execCommand("styleWithCSS",!1,!1),!this.util.support.oninput)return this.trigger("valuechanged")},fontScale:function(e,t){var n,s;if(t||(t={"x-large":"1.5em",large:"1.25em",small:".75em","x-small":".5em"}),!(s=this.selection.range()).collapsed)return this.selection.range(s),document.execCommand("styleWithCSS",!1,!0),document.execCommand("fontSize",!1,e),document.execCommand("styleWithCSS",!1,!1),this.selection.reset(),this.selection.range(),n=this.selection.containerNode(),(n[0].nodeType===Node.TEXT_NODE?n.closest('span[style*="font-size"]'):n.find('span[style*="font-size"]')).each(function(e,n){var s,r;return s=i(n),r=n.style.fontSize,/large|x-large|small|x-small/.test(r)?s.css("fontSize",t[r]):"medium"===r?s[0].style.length>1?s.css("fontSize",""):s.replaceWith(s.contents()):void 0}),this.trigger("valuechanged")},hr:function(){var e,t,n;return n=this.selection.rootNodes().first(),n.next().length>0?this.selection.save():t=i("<p/>").append(this.util.phBr),e=i("<hr/>").insertAfter(n),t?(t.insertAfter(e),this.selection.setRangeAtStartOf(t)):this.selection.restore(),this.trigger("valuechanged")},inlineCode:function(e){var t,n,s;return s=this.selection.range(),this.active?(s.selectNodeContents(this.node[0]),this.selection.save(s),this.node.contents().unwrap(),this.selection.restore()):(n=i(s.extractContents()),t=i("<"+this.htmlTag+"/>").append(n.contents()),s.insertNode(t[0]),s.selectNodeContents(t[0]),this.selection.range(s)),this.trigger("valuechanged")},indent:function(){return this.indentation.indent()},link:function(e,t){var n,s,r,o,a,l;if(a=this.selection.range(),e){var d=this.selection.startNodes();l=document.createTextNode(d.text()),d.replaceWith(l),a.selectNode(l)}else n=i(a.extractContents()),o=this.formatter.clearHtml(n.contents(),!1),s=i("<a/>",{href:"",target:"_blank",text:o||t}),this.selection.blockNodes().length>0?a.insertNode(s[0]):(r=i("<p/>").append(s),a.insertNode(r[0])),a.selectNodeContents(s[0]);return this.selection.range(a),this.trigger("valuechanged")},list:function(e,t,s){var r,o,a,l;return o=this.selection.blockNodes(),a="ul"===e?"ol":"ul",this.selection.save(),r=null,o.each((l=this,function(t,o){var d;if(!((d=i(o)).is("blockquote, li")||d.is(s)||l.util.isDecoratedNode(d))&&n.contains(document,o))return d.is(e)?(d.children("li").each(function(e,t){return i(t).children("ul, ol").insertAfter(d),i("<p/>").append(i(t).html()||l.util.phBr).insertBefore(d)}),d.remove()):d.is(a)?i("<"+e+"/>").append(d.contents()).replaceAll(d):r&&d.prev().is(r)?(i("<li/>").append(d.html()||l.util.phBr).appendTo(r),d.remove()):((r=i("<"+e+"><li></li></"+e+">")).find("li").append(d.html()||l.util.phBr),r.replaceAll(d))})),this.selection.restore(),this.trigger("valuechanged")},outdent:function(){return this.indentation.indent(!0)},title:function(e,t){var n,s;return n=this.selection.rootNodes(),this.selection.save(),n.each((s=this,function(n,r){var o;if(!((o=i(r)).is("blockquote")||o.is(e)||o.is(t)||s.util.isDecoratedNode(o)))return i("<"+e+"/>").append(o.contents()).replaceAll(o)})),this.selection.restore(),this.trigger("valuechanged")}});return["bold","insertImage","insertorderedlist","insertunorderedlist","italic","justifyLeft","justifyCenter","justifyFull","justifyRight","strikethrough","underline","undo"].forEach(function(e){f.prototype[e]=function(){return document.execCommand(e,!1,null),this.util.support.oninput||this.trigger("valuechanged"),i(document).trigger("selectionchange")}}),s.Editable=f}),t("skylark-domx-contents/main",["./contents","./Editable"],function(e){return e}),t("skylark-domx-contents",["skylark-domx-contents/main"],function(e){return e})}(i),!r){var l=s("skylark-langx/skylark");o?module.exports=l:n.skylarkjs=l}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-domx-contents.js.map
