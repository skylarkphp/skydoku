/**
 * skylark-domx-contents - A dom plugin for  editing  the content of html element.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-query","./contents"],function(t,e,n){var i=[].indexOf,l=t.Evented.inherit({opts:{allowedTags:[],allowedAttributes:{},allowedStyles:{}},init:function(e,n){this.editable=e,this.opts=t.extend({},this.opts,n),this._allowedTags=t.merge(["br","span","a","img","b","strong","i","strike","u","font","p","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","hr"],this.opts.allowedTags),this._allowedAttributes=t.extend({img:["src","alt","width","height","data-non-image"],a:["href","target"],font:["color"],code:["class"]},this.opts.allowedAttributes),this._allowedStyles=t.extend({span:["color","font-size"],b:["color","font-size"],i:["color","font-size"],strong:["color","font-size"],strike:["color","font-size"],u:["color","font-size"],p:["margin-left","text-align"],h1:["margin-left","text-align"],h2:["margin-left","text-align"],h3:["margin-left","text-align"],h4:["margin-left","text-align"]},this.opts.allowedStyles),this.editable.body.on("click","a",function(t){return!1})},decorate:function(t){return null==t&&(t=this.editable.body),this.editable.trigger("decorate",[t]),t},undecorate:function(t){return null==t&&(t=this.editable.body.clone()),this.editable.trigger("undecorate",[t]),t},autolink:function(t){var n,i,l,r,o,s,a,d,h,u,c,p,f;for(null==t&&(t=this.editable.body),a=[],(l=function(n){return n.contents().each(function(n,i){var r,o;if(!(r=e(i)).is("a")&&!r.closest("a, pre",t).length)return!r.is("iframe")&&r.contents().length?l(r):(o=r.text())&&/https?:\/\/|www\./gi.test(o)?a.push(r):void 0})})(t),h=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,r=0,s=a.length;r<s;r++){for(p=(i=a[r]).text(),u=[],d=null,o=0;null!==(d=h.exec(p));)c=p.substring(o,d.index),u.push(document.createTextNode(c)),o=h.lastIndex,f=/^(http(s)?:\/\/|\/)/.test(d[0])?d[0]:"http://"+d[0],n=e('<a href="'+f+'" rel="nofollow"></a>').text(d[0]),u.push(n[0]);u.push(document.createTextNode(p.substring(o))),i.replaceWith(e(u))}return t},format:function(t){var n,i,l,r,o,s,a,d,h,u;if(null==t&&(t=this.editable.body),t.is(":empty"))return t.append("<p>"+this.editable.util.phBr+"</p>"),t;for(l=0,o=(h=t.contents()).length;l<o;l++)a=h[l],this.cleanNode(a,!0);for(r=0,s=(u=t.contents()).length;r<s;r++)d=u[r],(n=e(d)).is("br")?(void 0!==i&&null!==i&&(i=null),n.remove()):this.editable.util.isBlockNode(d)?n.is("li")?i&&i.is("ul, ol")?i.append(d):(i=e("<ul/>").insertBefore(d)).append(d):i=null:(i&&!i.is("ul, ol")||(i=e("<p/>").insertBefore(d)),i.append(d),this.editable.util.isEmptyNode(i)&&i.append(this.editable.util.phBr));return t},cleanNode:function(n,l){var r,o,s,a,d,h,u,c,p,f,g,m,b,y,x,w,v,N;if((s=e(n)).length>0){if(3!==s[0].nodeType){if(c=s.is("iframe")?null:s.contents(),p=this.editable.util.isDecoratedNode(s),s.is(this._allowedTags.join(","))||p){if(s.is("a")&&(o=s.find("img")).length>0&&(s.replaceWith(o),s=o,c=null),s.is("td")&&(r=s.find(this.editable.util.blockNodes.join(","))).length>0&&(r.each(function(t,n){return e(n).contents().unwrap()}),c=s.contents()),s.is("img")&&s.hasClass("uploading")&&s.remove(),!p){for(h=this._allowedAttributes[s[0].tagName.toLowerCase()],f=0,m=(x=t.makeArray(s[0].attributes)).length;f<m;f++)"style"!==(u=x[f]).name&&(null!=h&&(w=u.name,i.call(h,w)>=0)||s.removeAttr(u.name));this._cleanNodeStyles(s),s.is("span")&&(0===s[0].attributes.length&&s.contents().first().unwrap(),2===s[0].style.length&&"rgb(51, 51, 51)"===s[0].style.color&&"16px"===s[0].style.fontSize&&s.contents().unwrap())}}else 1!==s[0].nodeType||s.is(":empty")?(s.remove(),c=null):s.is("div, article, dl, header, footer, tr")?(s.append("<br/>"),c.first().unwrap()):s.is("table")?(a=e("<p/>"),s.find("tr").each(function(t,n){return a.append(e(n).text()+"<br/>")}),s.replaceWith(a),c=null):s.is("thead, tfoot")?(s.remove(),c=null):s.is("th")?(d=e("<td/>").append(s.contents()),s.replaceWith(d)):c.first().unwrap();if(l&&null!=c&&!s.is("pre"))for(g=0,b=c.length;g<b;g++)y=c[g],this.cleanNode(y,!0);return null}(v=s.text().replace(/(\r\n|\n|\r)/gm,""))?(N=document.createTextNode(v),s.replaceWith(N)):s.remove()}},_cleanNodeStyles:function(e){var n,l,r,o,s,a,d,h,u;if(h=e.attr("style")){if(e.removeAttr("style"),!((n=this._allowedStyles[e[0].tagName.toLowerCase()])&&n.length>0))return e;for(u={},l=0,r=(s=h.split(";")).length;l<r;l++)d=s[l],2===(o=(d=t.trim(d)).split(":")).length&&("font-size"===o[0]&&o[1].indexOf("px")>0&&parseInt(o[1],10)<12||(a=o[0],i.call(n,a)>=0&&(u[t.trim(o[0])]=t.trim(o[1]))));return Object.keys(u).length>0&&e.css(u),e}},clearHtml:function(t,n){var i,l,r,o;return null==n&&(n=!0),i=e("<div/>").append(t),l=i.contents(),r="",l.each((o=this,function(t,i){var s,a;return 3===i.nodeType?r+=i.nodeValue:1===i.nodeType&&((a=(s=e(i)).is("iframe")?null:s.contents())&&a.length>0&&(r+=o.clearHtml(a)),n&&t<l.length-1&&s.is("br, p, div, li,tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2,h3, h4, header"))?r+="\n":void 0})),r},beautify:function(t){var n;return n=function(t){return!!(t.is("p")&&!t.text()&&t.children(":not(br)").length<1)},t.each(function(t,i){var l;return((l=e(i)).is(':not(img, br, col, td, hr, [class^="'+this.opts.classPrefix+'"]):empty')||n(l))&&l.remove(),l.find(':not(img, br, col, td, hr, [class^="'+this.opts.classPrefix+'"]):empty').remove()})}});return l.pluginName="Formatter",n.Formatter=l});
//# sourceMappingURL=sourcemaps/Formatter.js.map
