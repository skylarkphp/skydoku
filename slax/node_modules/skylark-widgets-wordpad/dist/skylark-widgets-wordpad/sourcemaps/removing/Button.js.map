{"version":3,"sources":["removing/Button.js"],"names":["define","langx","$","Widget","Wordpad","i18n","Button","inherit","options","template","menu","menuWrapper","menuItem","separator","_construct","opts","this","toolbar","editor","title","translate","name","prototype","call","icon","text","htmlTag","disableTag","active","disabled","needFocus","shortcut","_init","k","len","ref","tag","_this","render","el","on","e","noFocus","param","preventDefault","editable","inputManager","focused","hasClass","focus","wrapper","toggleClass","siblings","removeClass","is","offset","left","outerWidth","css","right","trigger","data","command","btn","currentTarget","body","clipboard","pasting","setActive","setDisabled","hotkeys","add","mousedown","split","length","trim","inArray","formatter","_allowedTags","push","_status","iconClassOf","setIcon","find","addClass","addToolItem","_elm","attr","appendTo","renderMenu","$menuBtnEl","ref1","results","isArray","menuEl","data-param","_disableStatus","endNodes","startNodes","selection","filter","_activeStatus","endNode","startNode","node","_t"],"mappings":"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","file":"../../removing/Button.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-query\",\r\n  \"skylark-widgets-base/Widget\",\r\n  \"./Wordpad\",\r\n  \"./i18n\"\r\n],function(langx, $, Widget, Wordpad,i18n){ \r\n  var slice = [].slice;\r\n\r\n  var Button = Widget.inherit( {\r\n\r\n    options : {\r\n      template: '<li><a tabindex=\"-1\" unselectable=\"on\" class=\"toolbar-item\" href=\"javascript:;\"><span></span></a></li>',\r\n\r\n      menu : {\r\n        menuWrapper: '<div class=\"toolbar-menu\"></div>',\r\n        menuItem: '<li><a tabindex=\"-1\" unselectable=\"on\" class=\"menu-item\" href=\"javascript:;\"><span></span></a></li>',\r\n        separator: '<li><span class=\"separator\"></span></li>'      \r\n      }\r\n\r\n    },\r\n\r\n\r\n    _construct : function(opts) {\r\n      this.toolbar = opts.toolbar;\r\n      this.editor = opts.toolbar.editor;\r\n      this.title = i18n.translate(this.name);\r\n      Widget.prototype._construct.call(this,opts);\r\n    }\r\n  }); \r\n\r\n\r\n  Button.prototype.name = '';\r\n\r\n  Button.prototype.icon = '';\r\n\r\n  Button.prototype.title = '';\r\n\r\n  Button.prototype.text = '';\r\n\r\n  Button.prototype.htmlTag = '';\r\n\r\n  Button.prototype.disableTag = '';\r\n\r\n  Button.prototype.menu = false;\r\n\r\n  Button.prototype.active = false;\r\n\r\n  Button.prototype.disabled = false;\r\n\r\n  Button.prototype.needFocus = true;\r\n\r\n  Button.prototype.shortcut = null;\r\n\r\n\r\n  Button.prototype._init = function() {\r\n    var k, len, ref, tag;\r\n    this.render();\r\n    this.el.on('mousedown', (function(_this) {\r\n      return function(e) {\r\n        var exceed, noFocus, param;\r\n        e.preventDefault();\r\n        noFocus = _this.needFocus && !_this.editor.editable.inputManager.focused;\r\n        if (_this.el.hasClass('disabled')) {\r\n          return false;\r\n        }\r\n        if (noFocus) {\r\n          _this.editor.focus();\r\n        }\r\n        if (_this.menu) {\r\n          _this.wrapper.toggleClass('menu-on').siblings('li').removeClass('menu-on');\r\n          if (_this.wrapper.is('.menu-on')) {\r\n            exceed = _this.menuWrapper.offset().left + _this.menuWrapper.outerWidth() + 5 - _this.editor.wrapper.offset().left - _this.editor.wrapper.outerWidth();\r\n            if (exceed > 0) {\r\n              _this.menuWrapper.css({\r\n                'left': 'auto',\r\n                'right': 0\r\n              });\r\n            }\r\n            _this.trigger('menuexpand');\r\n          }\r\n          return false;\r\n        }\r\n        param = _this.el.data('param');\r\n        _this.command(param);\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.wrapper.on('click', 'a.menu-item', (function(_this) {\r\n      return function(e) {\r\n        var btn, noFocus, param;\r\n        e.preventDefault();\r\n        btn = $(e.currentTarget);\r\n        _this.wrapper.removeClass('menu-on');\r\n        noFocus = _this.needFocus && !_this.editor.editable.inputManager.focused;\r\n        if (btn.hasClass('disabled') || noFocus) {\r\n          return false;\r\n        }\r\n        _this.toolbar.wrapper.removeClass('menu-on');\r\n        param = btn.data('param');\r\n        _this.command(param);\r\n        return false;\r\n      };\r\n    })(this));\r\n    this.wrapper.on('mousedown', 'a.menu-item', function(e) {\r\n      return false;\r\n    });\r\n    this.editor.on('blur', (function(_this) {\r\n      return function() {\r\n        var editorActive;\r\n        editorActive = _this.editor.body.is(':visible') && _this.editor.body.is('[contenteditable]');\r\n        if (!(editorActive && !_this.editor.editable.clipboard.pasting)) {\r\n          return;\r\n        }\r\n        _this.setActive(false);\r\n        return _this.setDisabled(false);\r\n      };\r\n    })(this));\r\n    if (this.shortcut != null) {\r\n      this.editor.editable.hotkeys.add(this.shortcut, (function(_this) {\r\n        return function(e) {\r\n          _this.el.mousedown();\r\n          return false;\r\n        };\r\n      })(this));\r\n    }\r\n    ref = this.htmlTag.split(',');\r\n    for (k = 0, len = ref.length; k < len; k++) {\r\n      tag = ref[k];\r\n      tag = langx.trim(tag);\r\n      if (tag && langx.inArray(tag, this.editor.editable.formatter._allowedTags) < 0) {\r\n        this.editor.editable.formatter._allowedTags.push(tag);\r\n      }\r\n    }\r\n    return this.editor.on('selectionchanged', (function(_this) {\r\n      return function(e) {\r\n        if (_this.editor.editable.inputManager.focused) {\r\n          return _this._status();\r\n        }\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  Button.prototype.iconClassOf = function(icon) {\r\n    if (icon) {\r\n      return \"wordpad-icon wordpad-icon-\" + icon;\r\n    } else {\r\n      return '';\r\n    }\r\n  };\r\n\r\n  Button.prototype.setIcon = function(icon) {\r\n    return this.el.find('span').removeClass().addClass(this.iconClassOf(icon)).text(this.text);\r\n  };\r\n\r\n  Button.prototype.render = function() {\r\n\r\n    //this.wrapper = $(this._tpl.item).appendTo(this.toolbar.list);\r\n    this.toolbar.addToolItem(this);\r\n    this.wrapper = $(this._elm);\r\n\r\n    this.el = this.wrapper.find('a.toolbar-item');\r\n    this.el.attr('title', this.title).addClass(\"toolbar-item-\" + this.name).data('button', this);\r\n    this.setIcon(this.icon);\r\n    if (!this.menu) {\r\n      return;\r\n    }\r\n    this.menuWrapper = $(this.options.menu.menuWrapper).appendTo(this.wrapper);\r\n    this.menuWrapper.addClass(\"toolbar-menu-\" + this.name);\r\n    return this.renderMenu();\r\n  };\r\n\r\n  Button.prototype.renderMenu = function() {\r\n    var $menuBtnEl, $menuItemEl, k, len, menuItem, ref, ref1, results;\r\n    if (!langx.isArray(this.menu)) {\r\n      return;\r\n    }\r\n    this.menuEl = $('<ul/>').appendTo(this.menuWrapper);\r\n    ref = this.menu;\r\n    results = [];\r\n    for (k = 0, len = ref.length; k < len; k++) {\r\n      menuItem = ref[k];\r\n      if (menuItem === '|') {\r\n        $(this.options.menu.separator).appendTo(this.menuEl);\r\n        continue;\r\n      }\r\n      $menuItemEl = $(this.options.menu.menuItem).appendTo(this.menuEl);\r\n      $menuBtnEl = $menuItemEl.find('a.menu-item').attr({\r\n        'title': (ref1 = menuItem.title) != null ? ref1 : menuItem.text,\r\n        'data-param': menuItem.param\r\n      }).addClass('menu-item-' + menuItem.name);\r\n      if (menuItem.icon) {\r\n        results.push($menuBtnEl.find('span').addClass(this.iconClassOf(menuItem.icon)));\r\n      } else {\r\n        results.push($menuBtnEl.find('span').text(menuItem.text));\r\n      }\r\n    }\r\n    return results;\r\n  };\r\n\r\n  Button.prototype.setActive = function(active) {\r\n    if (active === this.active) {\r\n      return;\r\n    }\r\n    this.active = active;\r\n    return this.el.toggleClass('active', this.active);\r\n  };\r\n\r\n  Button.prototype.setDisabled = function(disabled) {\r\n    if (disabled === this.disabled) {\r\n      return;\r\n    }\r\n    this.disabled = disabled;\r\n    return this.el.toggleClass('disabled', this.disabled);\r\n  };\r\n\r\n  Button.prototype._disableStatus = function() {\r\n    var disabled, endNodes, startNodes;\r\n    startNodes = this.editor.editable.selection.startNodes();\r\n    endNodes = this.editor.editable.selection.endNodes();\r\n    disabled = startNodes.filter(this.disableTag).length > 0 || endNodes.filter(this.disableTag).length > 0;\r\n    this.setDisabled(disabled);\r\n    if (this.disabled) {\r\n      this.setActive(false);\r\n    }\r\n    return this.disabled;\r\n  };\r\n\r\n  Button.prototype._activeStatus = function() {\r\n    var active, endNode, endNodes, startNode, startNodes;\r\n    startNodes = this.editor.editable.selection.startNodes();\r\n    endNodes = this.editor.editable.selection.endNodes();\r\n    startNode = startNodes.filter(this.htmlTag);\r\n    endNode = endNodes.filter(this.htmlTag);\r\n    active = startNode.length > 0 && endNode.length > 0 && startNode.is(endNode);\r\n    this.node = active ? startNode : null;\r\n    this.setActive(active);\r\n    return this.active;\r\n  };\r\n\r\n  Button.prototype._status = function() {\r\n    this._disableStatus();\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n    return this._activeStatus();\r\n  };\r\n\r\n  Button.prototype.command = function(param) {};\r\n\r\n  Button.prototype._t = i18n.translate;\r\n  \r\n\r\n  Wordpad.Button = Button;\r\n\r\n  return Button;\r\n});"]}