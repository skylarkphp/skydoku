{"version":3,"sources":["uploader.js"],"names":["define","langx","$","id","Uploader","Evented","inherit","init","_this","this","files","queue","count","on","e","file","splice","inArray","length","opts","connectionCount","upload","shift","uploading","window","originalEvent","returnValue","_t","prototype","url","params","fileKey","generateId","f","i","key","len","isArray","FileList","is","attr","makeArray","obj","getFile","extend","push","trigger","_xhrUpload","fileObj","name","ref","ref1","File","Blob","fileName","size","fileSize","ext","split","pop","toLowerCase","formData","k","v","FormData","append","xhr","data","processData","contentType","type","headers","X-File-Name","encodeURIComponent","req","ajaxSettings","onprogress","progress","lengthComputable","loaded","total","error","status","err","success","result","document","complete","responseText","cancel","abort","readImageFile","callback","fileReader","img","isFunction","Image","onload","onerror","FileReader","readAsDataURL","test","src","target","destroy","off","i18n","zh-CN","leaveConfirm","locale"],"mappings":"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","file":"../uploader.js","sourcesContent":["define([\n  \"skylark-langx/langx\",\n  \"skylark-domx-query\"\n],function(langx,$){ \n\n  var Uploader = langx.Evented.inherit({\n    init : function() {\n      this.files = [];\n      this.queue = [];\n      this.id = ++Uploader.count;\n      this.on('uploadcomplete', (function(_this) {\n        return function(e, file) {\n          _this.files.splice(langx.inArray(file, _this.files), 1);\n          if (_this.queue.length > 0 && _this.files.length < _this.opts.connectionCount) {\n            return _this.upload(_this.queue.shift());\n          } else {\n            return _this.uploading = false;\n          }\n        };\n      })(this));\n      return $(window).on('beforeunload.uploader-' + this.id, (function(_this) {\n        return function(e) {\n          if (!_this.uploading) {\n            return;\n          }\n          e.originalEvent.returnValue = _this._t('leaveConfirm');\n          return _this._t('leaveConfirm');  \n        };\n      })(this));\n    }\n\n  });\n\n  Uploader.count = 0;\n\n  Uploader.prototype.opts = {\n    url: '',\n    params: null,\n    fileKey: 'upload_file',\n    connectionCount: 3\n  };\n\n\n\n  Uploader.prototype.generateId = (function() {\n    var id;\n    id = 0;\n    return function() {\n      return id += 1;\n    };\n  })();\n\n  Uploader.prototype.upload = function(file, opts) {\n    var f, i, key, len;\n    if (opts == null) {\n      opts = {};\n    }\n    if (file == null) {\n      return;\n    }\n    if (langx.isArray(file) || file instanceof FileList) {\n      for (i = 0, len = file.length; i < len; i++) {\n        f = file[i];\n        this.upload(f, opts);\n      }\n    } else if ($(file).is('input:file')) {\n      key = $(file).attr('name');\n      if (key) {\n        opts.fileKey = key;\n      }\n      this.upload(langx.makeArray($(file)[0].files), opts);\n    } else if (!file.id || !file.obj) {\n      file = this.getFile(file);\n    }\n    if (!(file && file.obj)) {\n      return;\n    }\n    langx.extend(file, opts);\n    if (this.files.length >= this.opts.connectionCount) {\n      this.queue.push(file);\n      return;\n    }\n    if (this.trigger('beforeupload', [file]) === false) {\n      return;\n    }\n    this.files.push(file);\n    this._xhrUpload(file);\n    return this.uploading = true;\n  };\n\n  Uploader.prototype.getFile = function(fileObj) {\n    var name, ref, ref1;\n    if (fileObj instanceof window.File || fileObj instanceof window.Blob) {\n      name = (ref = fileObj.fileName) != null ? ref : fileObj.name;\n    } else {\n      return null;\n    }\n    return {\n      id: this.generateId(),\n      url: this.opts.url,\n      params: this.opts.params,\n      fileKey: this.opts.fileKey,\n      name: name,\n      size: (ref1 = fileObj.fileSize) != null ? ref1 : fileObj.size,\n      ext: name ? name.split('.').pop().toLowerCase() : '',\n      obj: fileObj\n    };\n  };\n\n  Uploader.prototype._xhrUpload = function(file) {\n    var formData, k, ref, v;\n    formData = new FormData();\n    formData.append(file.fileKey, file.obj);\n    formData.append(\"original_filename\", file.name);\n    if (file.params) {\n      ref = file.params;\n      for (k in ref) {\n        v = ref[k];\n        formData.append(k, v);\n      }\n    }\n\n    //TODO\n    return file.xhr = langx.xhr({\n      url: file.url,\n      data: formData,\n      processData: false,\n      contentType: false,\n      type: 'POST',\n      headers: {\n        'X-File-Name': encodeURIComponent(file.name)\n      },\n      xhr: function() {\n        var req;\n        req = $.ajaxSettings.xhr();\n        if (req) {\n          req.upload.onprogress = (function(_this) {\n            return function(e) {\n              return _this.progress(e);\n            };\n          })(this);\n        }\n        return req;\n      },\n      progress: (function(_this) {\n        return function(e) {\n          if (!e.lengthComputable) {\n            return;\n          }\n          return _this.trigger('uploadprogress', [file, e.loaded, e.total]);\n        };\n      })(this),\n      error: (function(_this) {\n        return function(xhr, status, err) {\n          return _this.trigger('uploaderror', [file, xhr, status]);\n        };\n      })(this),\n      success: (function(_this) {\n        return function(result) {\n          _this.trigger('uploadprogress', [file, file.size, file.size]);\n          _this.trigger('uploadsuccess', [file, result]);\n          return $(document).trigger('uploadsuccess', [file, result, _this]);\n        };\n      })(this),\n      complete: (function(_this) {\n        return function(xhr, status) {\n          return _this.trigger('uploadcomplete', [file, xhr.responseText]);\n        };\n      })(this)\n    });\n  };\n\n  Uploader.prototype.cancel = function(file) {\n    var f, i, len, ref;\n    if (!file.id) {\n      ref = this.files;\n      for (i = 0, len = ref.length; i < len; i++) {\n        f = ref[i];\n        if (f.id === file * 1) {\n          file = f;\n          break;\n        }\n      }\n    }\n    this.trigger('uploadcancel', [file]);\n    if (file.xhr) {\n      file.xhr.abort();\n    }\n    return file.xhr = null;\n  };\n\n  Uploader.prototype.readImageFile = function(fileObj, callback) {\n    var fileReader, img;\n    if (!langx.isFunction(callback)) {\n      return;\n    }\n    img = new Image();\n    img.onload = function() {\n      return callback(img);\n    };\n    img.onerror = function() {\n      return callback();\n    };\n    if (window.FileReader && FileReader.prototype.readAsDataURL && /^image/.test(fileObj.type)) {\n      fileReader = new FileReader();\n      fileReader.onload = function(e) {\n        return img.src = e.target.result;\n      };\n      return fileReader.readAsDataURL(fileObj);\n    } else {\n      return callback();\n    }\n  };\n\n  Uploader.prototype.destroy = function() {\n    var file, i, len, ref;\n    this.queue.length = 0;\n    ref = this.files;\n    for (i = 0, len = ref.length; i < len; i++) {\n      file = ref[i];\n      this.cancel(file);\n    }\n    $(window).off('.uploader-' + this.id);\n    return $(document).off('.uploader-' + this.id);\n  };\n\n  Uploader.i18n = {\n    'zh-CN': {\n      leaveConfirm: '正在上传文件，如果离开上传会自动取消'\n    }\n  };\n\n  Uploader.locale = 'zh-CN';\n\n  return  function(opts) {\n    return new Uploader(opts);\n  };\n\n});\n"]}