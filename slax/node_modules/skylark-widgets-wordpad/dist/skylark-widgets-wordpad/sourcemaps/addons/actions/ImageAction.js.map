{"version":3,"sources":["addons/actions/ImageAction.js"],"names":["define","langx","$","addons","Action","ImagePopover","i18n","ImageAction","inherit","name","icon","htmlTag","disableTag","defaultImage","needFocus","_init","item","k","len","ref","_this","this","editor","opts","imageAction","Array","isArray","menu","length","push","text","_t","uploader","translate","body","on","e","$img","range","currentTarget","document","createRange","selectNode","editable","selection","util","support","onselectionchange","trigger","$contents","cloneContents","contents","is","startContainer","eq","startOffset","popover","action","show","hide","$masks","wrapper","find","each","i","mask","$mask","file","data","parent","remove","cancel","prototype","call","render","args","arguments","slice","apply","_initUploader","el","renderMenu","$uploadItem","$input","createInput","uploadProgress","menuEl","type","title","multiple","accept","appendTo","stopPropagation","inputManager","focused","upload","inline","one","focus","removeClass","img","createImage","addClass","readImageFile","obj","src","hasClass","loadImage","active","refresh","srcEl","val","prop","proxy","throttle","loaded","total","percent","toFixed","height","result","img_path","msg","JSON","parse","_error","success","alert","file_path","removeData","xhr","statusText","responseText","_status","_disableStatus","callback","positionMask","imgOffset","wrapperOffset","offset","css","top","left","width","Image","onload","attr","data-image-size","reflow","isFunction","onerror","deleteContents","insertNode","setRangeAfter","_execute","click","select","actions","image"],"mappings":"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","file":"../../../addons/actions/ImageAction.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-query\",\r\n  \"../../addons\",\r\n  \"../../Action\",\r\n  \"./ImagePopover\",\r\n  \"../../i18n\"\r\n],function(langx, $,addons,Action,ImagePopover,i18n){ \r\n   var ImageAction = Action.inherit({\r\n      name : 'image',\r\n\r\n      icon : 'picture-o',\r\n\r\n      htmlTag : 'img',\r\n\r\n      disableTag : 'pre, table',\r\n\r\n      defaultImage : '',\r\n\r\n      needFocus : false,\r\n\r\n      _init : function() {\r\n        var item, k, len, ref;\r\n        if (this.editor.opts.imageAction) {\r\n          if (Array.isArray(this.editor.opts.imageAction)) {\r\n            this.menu = [];\r\n            ref = this.editor.opts.imageAction;\r\n            for (k = 0, len = ref.length; k < len; k++) {\r\n              item = ref[k];\r\n              this.menu.push({\r\n                name: item + '-image',\r\n                text: this._t(item + 'Image')\r\n              });\r\n            }\r\n          } else {\r\n            this.menu = false;\r\n          }\r\n        } else {\r\n          if (this.editor.uploader != null) {\r\n            this.menu = [\r\n              {\r\n                name: 'upload-image',\r\n                text: i18n.translate('uploadImage')\r\n              }, {\r\n                name: 'external-image',\r\n                text: i18n.translate('externalImage')\r\n              }\r\n            ];\r\n          } else {\r\n            this.menu = false;\r\n          }\r\n        }\r\n        this.defaultImage = this.editor.opts.defaultImage;\r\n        this.editor.body.on('click', 'img:not([data-non-image])', (function(_this) {\r\n          return function(e) {\r\n            var $img, range;\r\n            $img = $(e.currentTarget);\r\n            range = document.createRange();\r\n            range.selectNode($img[0]);\r\n            _this.editor.editable.selection.range(range);\r\n            if (!_this.editor.editable.util.support.onselectionchange) {\r\n              _this.editor.trigger('selectionchanged');\r\n            }\r\n            return false;\r\n          };\r\n        })(this));\r\n        this.editor.body.on('mouseup', 'img:not([data-non-image])', function(e) {\r\n          return false;\r\n        });\r\n        this.editor.on('selectionchanged.image', (function(_this) {\r\n          return function() {\r\n            var $contents, $img, range;\r\n            range = _this.editor.editable.selection.range();\r\n            if (range == null) {\r\n              return;\r\n            }\r\n            $contents = $(range.cloneContents()).contents();\r\n            if ($contents.length === 1 && $contents.is('img:not([data-non-image])')) {\r\n              $img = $(range.startContainer).contents().eq(range.startOffset);\r\n              if (!_this.popover) {\r\n                _this.popover = new ImagePopover({\r\n                  action: _this\r\n                });                \r\n              }\r\n\r\n              return _this.popover.show($img);\r\n            } else {\r\n              if (_this.popover) {\r\n                  return _this.popover.hide();\r\n              }\r\n            }\r\n          };\r\n        })(this));\r\n        this.editor.on('valuechanged.image', (function(_this) {\r\n          return function() {\r\n            var $masks;\r\n            $masks = _this.editor.wrapper.find('.wordpad-image-loading');\r\n            if (!($masks.length > 0)) {\r\n              return;\r\n            }\r\n            return $masks.each(function(i, mask) {\r\n              var $img, $mask, file;\r\n              $mask = $(mask);\r\n              $img = $mask.data('img');\r\n              if (!($img && $img.parent().length > 0)) {\r\n                $mask.remove();\r\n                if ($img) {\r\n                  file = $img.data('file');\r\n                  if (file) {\r\n                    _this.editor.uploader.cancel(file);\r\n                    if (_this.editor.body.find('img.uploading').length < 1) {\r\n                      return _this.editor.uploader.trigger('uploadready', [file]);\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            });\r\n          };\r\n        })(this));\r\n        return Action.prototype._init.call(this);\r\n      },\r\n\r\n      render : function() {\r\n        var args;\r\n        args = 1 <= arguments.length ? Array.prototype.slice.call(arguments, 0) : [];\r\n        Action.prototype.render.apply(this, args);\r\n        this.popover = new ImagePopover({\r\n          Action: this\r\n        });\r\n        if (this.editor.opts.imageAction === 'upload') {\r\n          return this._initUploader(this.el);\r\n        }\r\n      },\r\n\r\n      renderMenu : function() {\r\n        Action.prototype.renderMenu.call(this);\r\n        return this._initUploader();\r\n      },\r\n\r\n      _initUploader : function($uploadItem) {\r\n        var $input, createInput, uploadProgress;\r\n        if ($uploadItem == null) {\r\n          $uploadItem = this.menuEl.find('.menu-item-upload-image');\r\n        }\r\n        if (this.editor.uploader == null) {\r\n          this.el.find('.btn-upload').remove();\r\n          return;\r\n        }\r\n        $input = null;\r\n        createInput = (function(_this) {\r\n          return function() {\r\n            if ($input) {\r\n              $input.remove();\r\n            }\r\n            return $input = $('<input/>', {\r\n              type: 'file',\r\n              title: _this._t('uploadImage'),\r\n              multiple: true,\r\n              accept: 'image/gif,image/jpeg,image/jpg,image/png,image/svg'\r\n            }).appendTo($uploadItem);\r\n          };\r\n        })(this);\r\n        createInput();\r\n        $uploadItem.on('click mousedown', 'input[type=file]', function(e) {\r\n          return e.stopPropagation();\r\n        });\r\n        $uploadItem.on('change', 'input[type=file]', (function(_this) {\r\n          return function(e) {\r\n            if (_this.editor.editable.inputManager.focused) {\r\n              _this.editor.uploader.upload($input, {\r\n                inline: true\r\n              });\r\n              createInput();\r\n            } else {\r\n              _this.editor.one('focus', function(e) {\r\n                _this.editor.uploader.upload($input, {\r\n                  inline: true\r\n                });\r\n                return createInput();\r\n              });\r\n              _this.editor.focus();\r\n            }\r\n            return _this.wrapper.removeClass('menu-on');\r\n          };\r\n        })(this));\r\n        this.editor.uploader.on('beforeupload', (function(_this) {\r\n          return function(e, file) {\r\n            var $img;\r\n            if (!file.inline) {\r\n              return;\r\n            }\r\n            if (file.img) {\r\n              $img = $(file.img);\r\n            } else {\r\n              $img = _this.createImage(file.name);\r\n              file.img = $img;\r\n            }\r\n            $img.addClass('uploading');\r\n            $img.data('file', file);\r\n            return _this.editor.uploader.readImageFile(file.obj, function(img) {\r\n              var src;\r\n              if (!$img.hasClass('uploading')) {\r\n                return;\r\n              }\r\n              src = img ? img.src : _this.defaultImage;\r\n              return _this.loadImage($img, src, function() {\r\n                if (_this.popover.active) {\r\n                  _this.popover.refresh();\r\n                  return _this.popover.srcEl.val(_this._t('uploading')).prop('disabled', true);\r\n                }\r\n              });\r\n            });\r\n          };\r\n        })(this));\r\n        uploadProgress = langx.proxy(this.editor.editable.util.throttle(function(e, file, loaded, total) {\r\n          var $img, $mask, percent;\r\n          if (!file.inline) {\r\n            return;\r\n          }\r\n          $mask = file.img.data('mask');\r\n          if (!$mask) {\r\n            return;\r\n          }\r\n          $img = $mask.data('img');\r\n          if (!($img.hasClass('uploading') && $img.parent().length > 0)) {\r\n            $mask.remove();\r\n            return;\r\n          }\r\n          percent = loaded / total;\r\n          percent = (percent * 100).toFixed(0);\r\n          if (percent > 99) {\r\n            percent = 99;\r\n          }\r\n          return $mask.find('.progress').height((100 - percent) + \"%\");\r\n        }, 500), this);\r\n        this.editor.uploader.on('uploadprogress', uploadProgress);\r\n        this.editor.uploader.on('uploadsuccess', (function(_this) {\r\n          return function(e, file, result) {\r\n            var $img, img_path, msg;\r\n            if (!file.inline) {\r\n              return;\r\n            }\r\n            $img = file.img;\r\n            if (!($img.hasClass('uploading') && $img.parent().length > 0)) {\r\n              return;\r\n            }\r\n            if (typeof result !== 'object') {\r\n              try {\r\n                result = JSON.parse(result);\r\n              } catch (_error) {\r\n                e = _error;\r\n                result = {\r\n                  success: false\r\n                };\r\n              }\r\n            }\r\n            if (result.success === false) {\r\n              msg = result.msg || _this._t('uploadFailed');\r\n              alert(msg);\r\n              img_path = _this.defaultImage;\r\n            } else {\r\n              img_path = result.file_path;\r\n            }\r\n            _this.loadImage($img, img_path, function() {\r\n              var $mask;\r\n              $img.removeData('file');\r\n              $img.removeClass('uploading').removeClass('loading');\r\n              $mask = $img.data('mask');\r\n              if ($mask) {\r\n                $mask.remove();\r\n              }\r\n              $img.removeData('mask');\r\n              _this.editor.trigger('valuechanged');\r\n              if (_this.editor.body.find('img.uploading').length < 1) {\r\n                return _this.editor.uploader.trigger('uploadready', [file, result]);\r\n              }\r\n            });\r\n            if (_this.popover.active) {\r\n              _this.popover.srcEl.prop('disabled', false);\r\n              return _this.popover.srcEl.val(result.file_path);\r\n            }\r\n          };\r\n        })(this));\r\n        return this.editor.uploader.on('uploaderror', (function(_this) {\r\n          return function(e, file, xhr) {\r\n            var $img, msg, result;\r\n            if (!file.inline) {\r\n              return;\r\n            }\r\n            if (xhr.statusText === 'abort') {\r\n              return;\r\n            }\r\n            if (xhr.responseText) {\r\n              try {\r\n                result = JSON.parse(xhr.responseText);\r\n                msg = result.msg;\r\n              } catch (_error) {\r\n                e = _error;\r\n                msg = _this._t('uploadError');\r\n              }\r\n            }\r\n            $img = file.img;\r\n            if (!($img.hasClass('uploading') && $img.parent().length > 0)) {\r\n              return;\r\n            }\r\n            _this.loadImage($img, _this.defaultImage, function() {\r\n              var $mask;\r\n              $img.removeData('file');\r\n              $img.removeClass('uploading').removeClass('loading');\r\n              $mask = $img.data('mask');\r\n              if ($mask) {\r\n                $mask.remove();\r\n              }\r\n              return $img.removeData('mask');\r\n            });\r\n            if (_this.popover.active) {\r\n              _this.popover.srcEl.prop('disabled', false);\r\n              _this.popover.srcEl.val(_this.defaultImage);\r\n            }\r\n            _this.editor.trigger('valuechanged');\r\n            if (_this.editor.body.find('img.uploading').length < 1) {\r\n              return _this.editor.uploader.trigger('uploadready', [file, result]);\r\n            }\r\n          };\r\n        })(this));\r\n      },\r\n\r\n      _status : function() {\r\n        return this._disableStatus();\r\n      },\r\n\r\n      loadImage : function($img, src, callback) {\r\n        var $mask, img, positionMask;\r\n        positionMask = (function(_this) {\r\n          return function() {\r\n            var imgOffset, wrapperOffset;\r\n            imgOffset = $img.offset();\r\n            wrapperOffset = _this.editor.wrapper.offset();\r\n            return $mask.css({\r\n              top: imgOffset.top - wrapperOffset.top,\r\n              left: imgOffset.left - wrapperOffset.left,\r\n              width: $img.width(),\r\n              height: $img.height()\r\n            }).show();\r\n          };\r\n        })(this);\r\n        $img.addClass('loading');\r\n        $mask = $img.data('mask');\r\n        if (!$mask) {\r\n          $mask = $('<div class=\"wordpad-image-loading\">\\n  <div class=\"progress\"></div>\\n</div>').hide().appendTo(this.editor.wrapper);\r\n          positionMask();\r\n          $img.data('mask', $mask);\r\n          $mask.data('img', $img);\r\n        }\r\n        img = new Image();\r\n        img.onload = (function(_this) {\r\n          return function() {\r\n            var height, width;\r\n            if (!$img.hasClass('loading') && !$img.hasClass('uploading')) {\r\n              return;\r\n            }\r\n            width = img.width;\r\n            height = img.height;\r\n            $img.attr({\r\n              src: src,\r\n              width: width,\r\n              height: height,\r\n              'data-image-size': width + ',' + height\r\n            }).removeClass('loading');\r\n            if ($img.hasClass('uploading')) {\r\n              _this.editor.editable.util.reflow(_this.editor.body);\r\n              positionMask();\r\n            } else {\r\n              $mask.remove();\r\n              $img.removeData('mask');\r\n            }\r\n            if (langx.isFunction(callback)) {\r\n              return callback(img);\r\n            }\r\n          };\r\n        })(this);\r\n        img.onerror = function() {\r\n          if (langx.isFunction(callback)) {\r\n            callback(false);\r\n          }\r\n          $mask.remove();\r\n          return $img.removeData('mask').removeClass('loading');\r\n        };\r\n        return img.src = src;\r\n      },\r\n\r\n      createImage : function(name) {\r\n        var $img, range;\r\n        if (name == null) {\r\n          name = 'Image';\r\n        }\r\n        if (!this.editor.editable.inputManager.focused) {\r\n          this.editor.focus();\r\n        }\r\n        range = this.editor.editable.selection.range();\r\n        range.deleteContents();\r\n        this.editor.editable.selection.range(range);\r\n        $img = $('<img/>').attr('alt', name);\r\n        range.insertNode($img[0]);\r\n        this.editor.editable.selection.setRangeAfter($img, range);\r\n        this.editor.trigger('valuechanged');\r\n        return $img;\r\n      },\r\n\r\n      _execute : function(src) {\r\n        var $img;\r\n        $img = this.createImage();\r\n        return this.loadImage($img, src || this.defaultImage, (function(_this) {\r\n          return function() {\r\n            _this.editor.trigger('valuechanged');\r\n            _this.editor.editable.util.reflow($img);\r\n            $img.click();\r\n            return _this.popover.one('popovershow', function() {\r\n              _this.popover.srcEl.focus();\r\n              return _this.popover.srcEl[0].select();\r\n            });\r\n          };\r\n        })(this));\r\n      }\r\n\r\n   });\r\n\r\n   addons.actions.image = ImageAction; \r\n\r\n   return ImageAction;\r\n\r\n});"]}