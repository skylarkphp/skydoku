{"version":3,"sources":["Wordpad.js"],"names":["define","skylark","langx","$","Editable","Widget","Toolbar","uploader","i18n","addons","Wordpad","inherit","options","srcNodeRef","placeholder","defaultImage","params","upload","template","_init","editor","uploadOpts","this","_actions","opts","textarea","attr","length","Error","data","destroy","id","count","_render","self","editable","_elm","classPrefix","body","on","e","trigger","type","toolbar","toolbarFloat","toolbarHidden","toolbarFloatOffset","_placeholder","setValue","val","trim","focus","prototype","triggerHandler","args","concat","Evented","apply","key","ref","results","el","insertBefore","wrapper","find","placeholderEl","append","blur","push","name","value","insertAfter","children","util","isEmptyNode","parseInt","css","indentWidth","show","hide","hidePopover","getValue","findAction","constructor","actions","each","i","popover","active","closest","off","selection","clear","inputManager","focused","removeData","remove","document","window","attach"],"mappings":"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","file":"../Wordpad.js","sourcesContent":["define([\n  \"skylark-langx/skylark\",\n  \"skylark-langx/langx\",\n  \"skylark-domx-query\",\n  \"skylark-domx-contents/Editable\",\n  \"skylark-widgets-base/Widget\",\n  \"./Toolbar\",\n  \"./uploader\",\n  \"./i18n\",\n  \"./addons\"\n\n],function(skylark,langx, $, Editable,Widget,Toolbar,uploader,i18n,addons){ \n\n  var Wordpad = Widget.inherit({\n      options : {\n        srcNodeRef: null,\n        placeholder: '',\n        defaultImage: 'images/image.png',\n        params: {},\n        upload: false,\n        template : \"<div class=\\\"wordpad\\\">\\n  <div class=\\\"wordpad-wrapper\\\">\\n    <div class=\\\"wordpad-placeholder\\\"></div>\\n    <div class=\\\"wordpad-body\\\" contenteditable=\\\"true\\\">\\n    </div>\\n  </div>\\n</div>\"\n      },\n\n\n    _init : function() {\n      this._actions = [];\n\n      //this.opts = langx.extend({}, this.opts, opts);\n      this.opts = this.options;\n\n      var e, editor, uploadOpts;\n      this.textarea = $(this.opts.srcNodeRef);\n\n      this.opts.placeholder = this.opts.placeholder || this.textarea.attr('placeholder');\n\n      if (!this.textarea.length) {\n        throw new Error('Wordpad: param textarea is required.');\n        return;\n      }\n\n      editor = this.textarea.data('wordpad');\n      if (editor != null) {\n        editor.destroy();\n      }\n      this.id = ++Wordpad.count;\n      this._render();\n\n\n      var self = this;\n      this.editable = new Editable(this._elm,{\n        classPrefix : \"wordpad-\",\n        textarea : this.textarea,\n        body : this.body\n      });\n\n      // TODO\n      this.editable.on(\"all\",function(e,data){\n        return self.trigger(e.type,data);\n      });\n\n      if (this.opts.upload && uploader) {\n        uploadOpts = typeof this.opts.upload === 'object' ? this.opts.upload : {};\n        this.uploader = uploader(uploadOpts);\n      }\n\n      this.toolbar = new Toolbar(this,{\n        toolbar: this.opts.toolbar,\n        toolbarFloat:  this.opts.toolbarFloat,\n        toolbarHidden:  this.opts.toolbarHidden,\n        toolbarFloatOffset:  this.opts.toolbarFloatOffset\n\n      });\n\n      if (this.opts.placeholder) {\n        this.on('valuechanged', function() {\n          return self._placeholder();\n        });\n      }\n      this.setValue(this.textarea.val().trim() || '');\n      if (this.textarea.attr('autofocus')) {\n        return self.focus();\n      }\n\n\n    }\n  });\n\n  Wordpad.prototype.triggerHandler =  Wordpad.prototype.trigger = function(type,data) {\n    var args, ref;\n    args = [type];\n    if (data) {\n      args = args.concat(data);\n    }\n    langx.Evented.prototype.trigger.apply(this, args);\n    return this;\n  };\n\n\n  //Wordpad.connect(Util);\n\n  //Wordpad.connect(InputManager);\n\n  //Wordpad.connect(Selection);\n\n  //Wordpad.connect(UndoManager);\n\n  //Wordpad.connect(Keystroke);\n\n  //Wordpad.connect(Formatter);\n\n  //Wordpad.connect(Toolbar);\n\n  //Wordpad.connect(Indentation);\n\n  //Wordpad.connect(Clipboard);\n\n  Wordpad.count = 0;\n\n\n  Wordpad.prototype._render = function() {\n    var key, ref, results, val;\n\n    //this.el = $(this._tpl).insertBefore(this.textarea);\n    this.el = $(this._elm).insertBefore (this.textarea);\n\n    this.wrapper = this.el.find('.wordpad-wrapper');\n    this.body = this.wrapper.find('.wordpad-body');\n    this.placeholderEl = this.wrapper.find('.wordpad-placeholder').append(this.opts.placeholder);\n    this.el.data('wordpad', this);\n    this.wrapper.append(this.textarea);\n    this.textarea.data('wordpad', this).blur();\n    this.body.attr('tabindex', this.textarea.attr('tabindex'));\n\n    if (this.opts.params) {\n      ref = this.opts.params;\n      results = [];\n      for (key in ref) {\n        val = ref[key];\n        results.push($('<input/>', {\n          type: 'hidden',\n          name: key,\n          value: val\n        }).insertAfter(this.textarea));\n      }\n      return results;\n    }\n  };\n\n  Wordpad.prototype._placeholder = function() {\n    var children;\n    children = this.body.children();\n    if (children.length === 0 || (children.length === 1 && this.util.isEmptyNode(children) && parseInt(children.css('margin-left') || 0) < this.opts.indentWidth)) {\n      return this.placeholderEl.show();\n    } else {\n      return this.placeholderEl.hide();\n    }\n  };\n\n  Wordpad.prototype.setValue = function(val) {\n    this.hidePopover();\n\n    this.editable.setValue(val);\n\n    return this.trigger('valuechanged');\n  };\n\n  Wordpad.prototype.getValue = function() {\n    return this.editable.getValue();\n  };\n\n  Wordpad.prototype.focus = function() {\n    return this.editable.focus();\n  };\n\n  Wordpad.prototype.blur = function() {\n    return this.editable.blur();\n  };\n\n  Wordpad.prototype.findAction = function(name) {\n    if (!this._actions[name]) {\n      if (!this.constructor.addons.actions[name]) {\n        throw new Error(\"Wordpad: invalid action \" + name);\n      }\n\n      this._actions[name] = new this.constructor.addons.actions[name]({\n        editor: this\n      });\n\n    }\n\n    return this._actions[name];\n  };\n\n  Wordpad.prototype.hidePopover = function() {\n    return this.el.find('.wordpad-popover').each(function(i, popover) {\n      popover = $(popover).data('popover');\n      if (popover.active) {\n        return popover.hide();\n      }\n    });\n  };\n\n  Wordpad.prototype.destroy = function() {\n    this.trigger('destroy');\n    this.textarea.closest('form').off('.Wordpad .wordpad-' + this.id);\n    this.selection.clear();\n    this.inputManager.focused = false;\n    this.textarea.insertBefore(this.el).hide().val('').removeData('wordpad');\n    this.el.remove();\n    $(document).off('.wordpad-' + this.id);\n    $(window).off('.wordpad-' + this.id);\n    return this.off();\n  };\n\n\n  Wordpad.Toolbar = Toolbar;\n\n  Wordpad.i18n = i18n;\n\n  Wordpad.addons = addons;\n\n\n  return skylark.attach(\"widgets.Wordpad\",Wordpad);\n\n});\n"]}