/**
 * skylark-widgets-wordpad - The skylark richeditor widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-wordpad/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-query"],function(e,t){var n,r=e.Evented.inherit({init:function(){var n;return this.files=[],this.queue=[],this.id=++r.count,this.on("uploadcomplete",(n=this,function(t,r){return n.files.splice(e.inArray(r,n.files),1),n.queue.length>0&&n.files.length<n.opts.connectionCount?n.upload(n.queue.shift()):n.uploading=!1})),t(window).on("beforeunload.uploader-"+this.id,function(e){return function(t){if(e.uploading)return t.originalEvent.returnValue=e._t("leaveConfirm"),e._t("leaveConfirm")}}(this))}});return r.count=0,r.prototype.opts={url:"",params:null,fileKey:"upload_file",connectionCount:3},r.prototype.generateId=(n=0,function(){return n+=1}),r.prototype.upload=function(n,r){var i,o,u,a;if(null==r&&(r={}),null!=n){if(e.isArray(n)||n instanceof FileList)for(o=0,a=n.length;o<a;o++)i=n[o],this.upload(i,r);else t(n).is("input:file")?((u=t(n).attr("name"))&&(r.fileKey=u),this.upload(e.makeArray(t(n)[0].files),r)):n.id&&n.obj||(n=this.getFile(n));if(n&&n.obj)if(e.extend(n,r),this.files.length>=this.opts.connectionCount)this.queue.push(n);else if(!1!==this.trigger("beforeupload",[n]))return this.files.push(n),this._xhrUpload(n),this.uploading=!0}},r.prototype.getFile=function(e){var t,n,r;return e instanceof window.File||e instanceof window.Blob?(t=null!=(n=e.fileName)?n:e.name,{id:this.generateId(),url:this.opts.url,params:this.opts.params,fileKey:this.opts.fileKey,name:t,size:null!=(r=e.fileSize)?r:e.size,ext:t?t.split(".").pop().toLowerCase():"",obj:e}):null},r.prototype._xhrUpload=function(n){var r,i,o,u,a;if((r=new FormData).append(n.fileKey,n.obj),r.append("original_filename",n.name),n.params)for(i in o=n.params)u=o[i],r.append(i,u);return n.xhr=e.xhr({url:n.url,data:r,processData:!1,contentType:!1,type:"POST",headers:{"X-File-Name":encodeURIComponent(n.name)},xhr:function(){var e,n;return(e=t.ajaxSettings.xhr())&&(e.upload.onprogress=(n=this,function(e){return n.progress(e)})),e},progress:(a=this,function(e){if(e.lengthComputable)return a.trigger("uploadprogress",[n,e.loaded,e.total])}),error:function(e){return function(t,r,i){return e.trigger("uploaderror",[n,t,r])}}(this),success:function(e){return function(r){return e.trigger("uploadprogress",[n,n.size,n.size]),e.trigger("uploadsuccess",[n,r]),t(document).trigger("uploadsuccess",[n,r,e])}}(this),complete:function(e){return function(t,r){return e.trigger("uploadcomplete",[n,t.responseText])}}(this)})},r.prototype.cancel=function(e){var t,n,r,i;if(!e.id)for(n=0,r=(i=this.files).length;n<r;n++)if((t=i[n]).id===1*e){e=t;break}return this.trigger("uploadcancel",[e]),e.xhr&&e.xhr.abort(),e.xhr=null},r.prototype.readImageFile=function(t,n){var r,i;if(e.isFunction(n))return(i=new Image).onload=function(){return n(i)},i.onerror=function(){return n()},window.FileReader&&FileReader.prototype.readAsDataURL&&/^image/.test(t.type)?((r=new FileReader).onload=function(e){return i.src=e.target.result},r.readAsDataURL(t)):n()},r.prototype.destroy=function(){var e,n,r,i;for(this.queue.length=0,n=0,r=(i=this.files).length;n<r;n++)e=i[n],this.cancel(e);return t(window).off(".uploader-"+this.id),t(document).off(".uploader-"+this.id)},r.i18n={"zh-CN":{leaveConfirm:"正在上传文件，如果离开上传会自动取消"}},r.locale="zh-CN",function(e){return new r(e)}});
//# sourceMappingURL=sourcemaps/uploader.js.map
