/**
 * skylark-widgets-wordpad - The skylark richeditor widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-wordpad/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-query","../Toolbar","../Wordpad","../Button","./ImagePopover","../i18n"],function(e,t,o,i,r,a,n){var d=r.inherit({});return d.prototype.name="image",d.prototype.icon="picture-o",d.prototype.htmlTag="img",d.prototype.disableTag="pre, table",d.prototype.defaultImage="",d.prototype.needFocus=!1,d.prototype._init=function(){var e,o,i,a,d;if(this.editor.opts.imageButton)if(Array.isArray(this.editor.opts.imageButton))for(this.menu=[],o=0,i=(a=this.editor.opts.imageButton).length;o<i;o++)e=a[o],this.menu.push({name:e+"-image",text:this._t(e+"Image")});else this.menu=!1;else null!=this.editor.uploader?this.menu=[{name:"upload-image",text:n.translate("uploadImage")},{name:"external-image",text:n.translate("externalImage")}]:this.menu=!1;return this.defaultImage=this.editor.opts.defaultImage,this.editor.body.on("click","img:not([data-non-image])",(d=this,function(e){var o,i;return o=t(e.currentTarget),(i=document.createRange()).selectNode(o[0]),d.editor.editable.selection.range(i),d.editor.editable.util.support.onselectionchange||d.editor.trigger("selectionchanged"),!1})),this.editor.body.on("mouseup","img:not([data-non-image])",function(e){return!1}),this.editor.on("selectionchanged.image",function(e){return function(){var o,i,r;if(null!=(r=e.editor.editable.selection.range()))return 1===(o=t(r.cloneContents()).contents()).length&&o.is("img:not([data-non-image])")?(i=t(r.startContainer).contents().eq(r.startOffset),e.popover.show(i)):e.popover.hide()}}(this)),this.editor.on("valuechanged.image",function(e){return function(){var o;if((o=e.editor.wrapper.find(".wordpad-image-loading")).length>0)return o.each(function(o,i){var r,a,n;if(!((r=(a=t(i)).data("img"))&&r.parent().length>0)&&(a.remove(),r&&(n=r.data("file"))&&(e.editor.uploader.cancel(n),e.editor.body.find("img.uploading").length<1)))return e.editor.uploader.trigger("uploadready",[n])})}}(this)),r.prototype._init.call(this)},d.prototype.render=function(){var e;if(e=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],r.prototype.render.apply(this,e),this.popover=new a({button:this}),"upload"===this.editor.opts.imageButton)return this._initUploader(this.el)},d.prototype.renderMenu=function(){return r.prototype.renderMenu.call(this),this._initUploader()},d.prototype._initUploader=function(o){var i,r,a,n;if(null==o&&(o=this.menuEl.find(".menu-item-upload-image")),null!=this.editor.uploader)return i=null,n=this,(r=function(){return i&&i.remove(),i=t("<input/>",{type:"file",title:n._t("uploadImage"),multiple:!0,accept:"image/gif,image/jpeg,image/jpg,image/png,image/svg"}).appendTo(o)})(),o.on("click mousedown","input[type=file]",function(e){return e.stopPropagation()}),o.on("change","input[type=file]",function(e){return function(t){return e.editor.editable.inputManager.focused?(e.editor.uploader.upload(i,{inline:!0}),r()):(e.editor.one("focus",function(t){return e.editor.uploader.upload(i,{inline:!0}),r()}),e.editor.focus()),e.wrapper.removeClass("menu-on")}}(this)),this.editor.uploader.on("beforeupload",function(e){return function(o,i){var r;if(i.inline)return i.img?r=t(i.img):(r=e.createImage(i.name),i.img=r),r.addClass("uploading"),r.data("file",i),e.editor.uploader.readImageFile(i.obj,function(t){var o;if(r.hasClass("uploading"))return o=t?t.src:e.defaultImage,e.loadImage(r,o,function(){if(e.popover.active)return e.popover.refresh(),e.popover.srcEl.val(e._t("uploading")).prop("disabled",!0)})})}}(this)),a=e.proxy(this.editor.editable.util.throttle(function(e,t,o,i){var r,a,n;if(t.inline&&(a=t.img.data("mask"))){if((r=a.data("img")).hasClass("uploading")&&r.parent().length>0)return(n=(100*(n=o/i)).toFixed(0))>99&&(n=99),a.find(".progress").height(100-n+"%");a.remove()}},500),this),this.editor.uploader.on("uploadprogress",a),this.editor.uploader.on("uploadsuccess",function(e){return function(t,o,i){var r,a,n;if(o.inline&&(r=o.img).hasClass("uploading")&&r.parent().length>0){if("object"!=typeof i)try{i=JSON.parse(i)}catch(e){e,i={success:!1}}return!1===i.success?(n=i.msg||e._t("uploadFailed"),alert(n),a=e.defaultImage):a=i.file_path,e.loadImage(r,a,function(){var t;if(r.removeData("file"),r.removeClass("uploading").removeClass("loading"),(t=r.data("mask"))&&t.remove(),r.removeData("mask"),e.editor.trigger("valuechanged"),e.editor.body.find("img.uploading").length<1)return e.editor.uploader.trigger("uploadready",[o,i])}),e.popover.active?(e.popover.srcEl.prop("disabled",!1),e.popover.srcEl.val(i.file_path)):void 0}}}(this)),this.editor.uploader.on("uploaderror",function(e){return function(t,o,i){var r,a;if(o.inline&&"abort"!==i.statusText){if(i.responseText)try{(a=JSON.parse(i.responseText)).msg}catch(t){t,e._t("uploadError")}if((r=o.img).hasClass("uploading")&&r.parent().length>0)return e.loadImage(r,e.defaultImage,function(){var e;return r.removeData("file"),r.removeClass("uploading").removeClass("loading"),(e=r.data("mask"))&&e.remove(),r.removeData("mask")}),e.popover.active&&(e.popover.srcEl.prop("disabled",!1),e.popover.srcEl.val(e.defaultImage)),e.editor.trigger("valuechanged"),e.editor.body.find("img.uploading").length<1?e.editor.uploader.trigger("uploadready",[o,a]):void 0}}}(this));this.el.find(".btn-upload").remove()},d.prototype._status=function(){return this._disableStatus()},d.prototype.loadImage=function(o,i,r){var a,n,d,l;return l=this,d=function(){var e,t;return e=o.offset(),t=l.editor.wrapper.offset(),a.css({top:e.top-t.top,left:e.left-t.left,width:o.width(),height:o.height()}).show()},o.addClass("loading"),(a=o.data("mask"))||(a=t('<div class="wordpad-image-loading">\n  <div class="progress"></div>\n</div>').hide().appendTo(this.editor.wrapper),d(),o.data("mask",a),a.data("img",o)),(n=new Image).onload=function(t){return function(){var l,s;if(o.hasClass("loading")||o.hasClass("uploading"))return s=n.width,l=n.height,o.attr({src:i,width:s,height:l,"data-image-size":s+","+l}).removeClass("loading"),o.hasClass("uploading")?(t.editor.editable.util.reflow(t.editor.body),d()):(a.remove(),o.removeData("mask")),e.isFunction(r)?r(n):void 0}}(this),n.onerror=function(){return e.isFunction(r)&&r(!1),a.remove(),o.removeData("mask").removeClass("loading")},n.src=i},d.prototype.createImage=function(e){var o,i;return null==e&&(e="Image"),this.editor.editable.inputManager.focused||this.editor.focus(),(i=this.editor.editable.selection.range()).deleteContents(),this.editor.editable.selection.range(i),o=t("<img/>").attr("alt",e),i.insertNode(o[0]),this.editor.editable.selection.setRangeAfter(o,i),this.editor.trigger("valuechanged"),o},d.prototype.command=function(e){var t,o;return t=this.createImage(),this.loadImage(t,e||this.defaultImage,(o=this,function(){return o.editor.trigger("valuechanged"),o.editor.editable.util.reflow(t),t.click(),o.popover.one("popovershow",function(){return o.popover.srcEl.focus(),o.popover.srcEl[0].select()})}))},i.Toolbar.addButton(d),d});
//# sourceMappingURL=../../sourcemaps/removing/buttons/ImageButton.js.map
