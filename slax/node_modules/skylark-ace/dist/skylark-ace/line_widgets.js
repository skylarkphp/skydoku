/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(e,i,t){"use strict";e("./lib/oop");var s=e("./lib/dom");e("./range").Range;function n(e){this.session=e,this.session.widgetManager=this,this.session.getRowLength=this.getRowLength,this.session.$getWidgetScreenLength=this.$getWidgetScreenLength,this.updateOnChange=this.updateOnChange.bind(this),this.renderWidgets=this.renderWidgets.bind(this),this.measureWidgets=this.measureWidgets.bind(this),this.session._changedWidgets=[],this.$onChangeEditor=this.$onChangeEditor.bind(this),this.session.on("change",this.updateOnChange),this.session.on("changeFold",this.updateOnFold),this.session.on("changeEditor",this.$onChangeEditor)}(function(){this.getRowLength=function(e){var i;return i=this.lineWidgets&&this.lineWidgets[e]&&this.lineWidgets[e].rowCount||0,this.$useWrapMode&&this.$wrapData[e]?this.$wrapData[e].length+1+i:1+i},this.$getWidgetScreenLength=function(){var e=0;return this.lineWidgets.forEach(function(i){i&&i.rowCount&&!i.hidden&&(e+=i.rowCount)}),e},this.$onChangeEditor=function(e){this.attach(e.editor)},this.attach=function(e){e&&e.widgetManager&&e.widgetManager!=this&&e.widgetManager.detach(),this.editor!=e&&(this.detach(),this.editor=e,e&&(e.widgetManager=this,e.renderer.on("beforeRender",this.measureWidgets),e.renderer.on("afterRender",this.renderWidgets)))},this.detach=function(e){var i=this.editor;if(i){this.editor=null,i.widgetManager=null,i.renderer.off("beforeRender",this.measureWidgets),i.renderer.off("afterRender",this.renderWidgets);var t=this.session.lineWidgets;t&&t.forEach(function(e){e&&e.el&&e.el.parentNode&&(e._inDocument=!1,e.el.parentNode.removeChild(e.el))})}},this.updateOnFold=function(e,i){var t=i.lineWidgets;if(t&&e.action){for(var s=e.data,n=s.start.row,o=s.end.row,r="add"==e.action,d=n+1;d<o;d++)t[d]&&(t[d].hidden=r);t[o]&&(r?t[n]?t[o].hidden=r:t[n]=t[o]:(t[n]==t[o]&&(t[n]=void 0),t[o].hidden=r))}},this.updateOnChange=function(e){var i=this.session.lineWidgets;if(i){var t=e.start.row,s=e.end.row-t;if(0===s);else if("remove"==e.action){i.splice(t+1,s).forEach(function(e){e&&this.removeLineWidget(e)},this),this.$updateRows()}else{var n=new Array(s);n.unshift(t,0),i.splice.apply(i,n),this.$updateRows()}}},this.$updateRows=function(){var e=this.session.lineWidgets;if(e){var i=!0;e.forEach(function(e,t){if(e)for(i=!1,e.row=t;e.$oldWidget;)e.$oldWidget.row=t,e=e.$oldWidget}),i&&(this.session.lineWidgets=null)}},this.addLineWidget=function(e){this.session.lineWidgets||(this.session.lineWidgets=new Array(this.session.getLength()));var i=this.session.lineWidgets[e.row];i&&(e.$oldWidget=i,i.el&&i.el.parentNode&&(i.el.parentNode.removeChild(i.el),i._inDocument=!1)),this.session.lineWidgets[e.row]=e,e.session=this.session;var t=this.editor.renderer;e.html&&!e.el&&(e.el=s.createElement("div"),e.el.innerHTML=e.html),e.el&&(s.addCssClass(e.el,"ace_lineWidgetContainer"),e.el.style.position="absolute",e.el.style.zIndex=5,t.container.appendChild(e.el),e._inDocument=!0),e.coverGutter||(e.el.style.zIndex=3),null==e.pixelHeight&&(e.pixelHeight=e.el.offsetHeight),null==e.rowCount&&(e.rowCount=e.pixelHeight/t.layerConfig.lineHeight);var n=this.session.getFoldAt(e.row,0);if(e.$fold=n,n){var o=this.session.lineWidgets;e.row!=n.end.row||o[n.start.row]?e.hidden=!0:o[n.start.row]=e}return this.session._emit("changeFold",{data:{start:{row:e.row}}}),this.$updateRows(),this.renderWidgets(null,t),this.onWidgetChanged(e),e},this.removeLineWidget=function(e){if(e._inDocument=!1,e.session=null,e.el&&e.el.parentNode&&e.el.parentNode.removeChild(e.el),e.editor&&e.editor.destroy)try{e.editor.destroy()}catch(e){}if(this.session.lineWidgets){var i=this.session.lineWidgets[e.row];if(i==e)this.session.lineWidgets[e.row]=e.$oldWidget,e.$oldWidget&&this.onWidgetChanged(e.$oldWidget);else for(;i;){if(i.$oldWidget==e){i.$oldWidget=e.$oldWidget;break}i=i.$oldWidget}}this.session._emit("changeFold",{data:{start:{row:e.row}}}),this.$updateRows()},this.getWidgetsAtRow=function(e){for(var i=this.session.lineWidgets,t=i&&i[e],s=[];t;)s.push(t),t=t.$oldWidget;return s},this.onWidgetChanged=function(e){this.session._changedWidgets.push(e),this.editor&&this.editor.renderer.updateFull()},this.measureWidgets=function(e,i){var t=this.session._changedWidgets,s=i.layerConfig;if(t&&t.length){for(var n=1/0,o=0;o<t.length;o++){var r=t[o];if(r&&r.el&&r.session==this.session){if(!r._inDocument){if(this.session.lineWidgets[r.row]!=r)continue;r._inDocument=!0,i.container.appendChild(r.el)}r.h=r.el.offsetHeight,r.fixedWidth||(r.w=r.el.offsetWidth,r.screenWidth=Math.ceil(r.w/s.characterWidth));var d=r.h/s.lineHeight;r.coverLine&&(d-=this.session.getRowLineCount(r.row))<0&&(d=0),r.rowCount!=d&&(r.rowCount=d,r.row<n&&(n=r.row))}}n!=1/0&&(this.session._emit("changeFold",{data:{start:{row:n}}}),this.session.lineWidgetWidth=null),this.session._changedWidgets=[]}},this.renderWidgets=function(e,i){var t=i.layerConfig,s=this.session.lineWidgets;if(s){for(var n=Math.min(this.firstRow,t.firstRow),o=Math.max(this.lastRow,t.lastRow,s.length);n>0&&!s[n];)n--;this.firstRow=t.firstRow,this.lastRow=t.lastRow,i.$cursorLayer.config=t;for(var r=n;r<=o;r++){var d=s[r];if(d&&d.el)if(d.hidden)d.el.style.top=-100-(d.pixelHeight||0)+"px";else{d._inDocument||(d._inDocument=!0,i.container.appendChild(d.el));var h=i.$cursorLayer.getPixelPosition({row:r,column:0},!0).top;d.coverLine||(h+=t.lineHeight*this.session.getRowLineCount(d.row)),d.el.style.top=h-t.offset+"px";var a=d.coverGutter?0:i.gutterWidth;d.fixedWidth||(a-=i.scrollLeft),d.el.style.left=a+"px",d.fullWidth&&d.screenWidth&&(d.el.style.minWidth=t.width+2*t.padding+"px"),d.fixedWidth?d.el.style.right=i.scrollBar.getWidth()+"px":d.el.style.right=""}}}}}).call(n.prototype),i.LineWidgets=n});
//# sourceMappingURL=sourcemaps/line_widgets.js.map
