/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(require,exports,module){"use strict";var e=require("../../lib/oop"),t=(require("../../lib/lang"),require("../../range").Range),n=require("./fold_mode").FoldMode,o=require("../../token_iterator").TokenIterator,r=exports.FoldMode=function(t,o){n.call(this),this.voidElements=t||{},this.optionalEndTags=e.mixin({},this.voidElements),o&&e.mixin(this.optionalEndTags,o)};e.inherits(r,n);var a=function(){this.tagName="",this.closing=!1,this.selfClosing=!1,this.start={row:0,column:0},this.end={row:0,column:0}};function l(e,t){return e.type.lastIndexOf(t+".xml")>-1}(function(){this.getFoldWidget=function(e,t,n){var o=this._getFirstTagInLine(e,n);return o?o.closing||!o.tagName&&o.selfClosing?"markbeginend"==t?"end":"":!o.tagName||o.selfClosing||this.voidElements.hasOwnProperty(o.tagName.toLowerCase())?"":this._findEndTagInLine(e,n,o.tagName,o.end.column)?"":"start":this.getCommentFoldWidget(e,n)},this.getCommentFoldWidget=function(e,t){return/comment/.test(e.getState(t))&&/<!-/.test(e.getLine(t))?"start":""},this._getFirstTagInLine=function(e,t){for(var n=e.getTokens(t),o=new a,r=0;r<n.length;r++){var i=n[r];if(l(i,"tag-open")){if(o.end.column=o.start.column+i.value.length,o.closing=l(i,"end-tag-open"),!(i=n[++r]))return null;for(o.tagName=i.value,o.end.column+=i.value.length,r++;r<n.length;r++)if(i=n[r],o.end.column+=i.value.length,l(i,"tag-close")){o.selfClosing="/>"==i.value;break}return o}if(l(i,"tag-close"))return o.selfClosing="/>"==i.value,o;o.start.column+=i.value.length}return null},this._findEndTagInLine=function(e,t,n,o){for(var r=e.getTokens(t),a=0,i=0;i<r.length;i++){var s=r[i];if(!((a+=s.value.length)<o)&&l(s,"end-tag-open")&&(s=r[i+1])&&s.value==n)return!0}return!1},this._readTagForward=function(e){var t=e.getCurrentToken();if(!t)return null;var n=new a;do{if(l(t,"tag-open"))n.closing=l(t,"end-tag-open"),n.start.row=e.getCurrentTokenRow(),n.start.column=e.getCurrentTokenColumn();else if(l(t,"tag-name"))n.tagName=t.value;else if(l(t,"tag-close"))return n.selfClosing="/>"==t.value,n.end.row=e.getCurrentTokenRow(),n.end.column=e.getCurrentTokenColumn()+t.value.length,e.stepForward(),n}while(t=e.stepForward());return null},this._readTagBackward=function(e){var t=e.getCurrentToken();if(!t)return null;var n=new a;do{if(l(t,"tag-open"))return n.closing=l(t,"end-tag-open"),n.start.row=e.getCurrentTokenRow(),n.start.column=e.getCurrentTokenColumn(),e.stepBackward(),n;l(t,"tag-name")?n.tagName=t.value:l(t,"tag-close")&&(n.selfClosing="/>"==t.value,n.end.row=e.getCurrentTokenRow(),n.end.column=e.getCurrentTokenColumn()+t.value.length)}while(t=e.stepBackward());return null},this._pop=function(e,t){for(;e.length;){var n=e[e.length-1];if(t&&n.tagName!=t.tagName){if(this.optionalEndTags.hasOwnProperty(n.tagName)){e.pop();continue}return null}return e.pop()}},this.getFoldWidgetRange=function(e,n,r){var a=this._getFirstTagInLine(e,r);if(!a)return this.getCommentFoldWidget(e,r)&&e.getCommentFoldRange(r,e.getLine(r).length);var l,i=[];if(a.closing||a.selfClosing){g=new o(e,r,a.end.column);for(var s={row:r,column:a.start.column};l=this._readTagBackward(g);){if(l.selfClosing){if(i.length)continue;return l.start.column+=l.tagName.length+2,l.end.column-=2,t.fromPoints(l.start,l.end)}if(l.closing)i.push(l);else if(this._pop(i,l),0==i.length)return l.start.column+=l.tagName.length+2,l.start.row==l.end.row&&l.start.column<l.end.column&&(l.start.column=l.end.column),t.fromPoints(l.start,s)}}else{var g=new o(e,r,a.start.column),u={row:r,column:a.start.column+a.tagName.length+2};for(a.start.row==a.end.row&&(u.column=a.end.column);l=this._readTagForward(g);){if(l.selfClosing){if(i.length)continue;return l.start.column+=l.tagName.length+2,l.end.column-=2,t.fromPoints(l.start,l.end)}if(l.closing){if(this._pop(i,l),0==i.length)return t.fromPoints(u,l.start)}else i.push(l)}}}}).call(r.prototype)});
//# sourceMappingURL=../../sourcemaps/mode/folding/xml.js.map
