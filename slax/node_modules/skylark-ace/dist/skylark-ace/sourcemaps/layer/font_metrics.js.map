{"version":3,"sources":["layer/font_metrics.js"],"names":["define","require","exports","module","oop","dom","lang","event","useragent","EventEmitter","USE_OBSERVER","ResizeObserver","L","FontMetrics","parentEl","this","el","createElement","$setMeasureNodeStyles","style","$main","$measureNode","appendChild","innerHTML","stringRepeat","$characterSize","width","height","$addObserver","checkForSizeChanges","implement","isRoot","left","top","visibility","position","whiteSpace","isIE","font","overflow","size","undefined","$measureSizes","fontWeight","boldSize","charSizes","Object","create","allowBoldFonts","_emit","data","self","$observer","window","e","rect","contentRect","observe","$pollSizeChanges","$pollSizeChangesTimer","onIdle","cb","setPolling","val","clearInterval","node","clientHeight","clientWidth","$measureCharWidth","ch","getBoundingClientRect","getCharacterWidth","w","destroy","disconnect","parentNode","removeChild","$getZoom","getZoom","element","getComputedStyle","zoom","parentElement","$initTransformMeasureNodes","t","l","els","buildDom","transformCoordinates","clientPos","elPos","mul","solve","l1","l2","r","det","sub","a","b","add","p","c","d","h","m1","m2","x","k","ut","u","f","call","prototype"],"mappings":";;;;;;;AA8BAA,OAAO,SAASC,EAASC,EAASC,GAElC,IAAIC,EAAMH,EAAQ,cACdI,EAAMJ,EAAQ,cACdK,EAAOL,EAAQ,eACfM,EAAQN,EAAQ,gBAChBO,EAAYP,EAAQ,oBACpBQ,EAAeR,EAAQ,wBAAwBQ,aAG/CC,EAAwC,mBAAlBC,eACtBC,EAAI,IAEJC,EAAcX,EAAQW,YAAc,SAASC,GAC7CC,KAAKC,GAAKX,EAAIY,cAAc,OAC5BF,KAAKG,sBAAsBH,KAAKC,GAAGG,OAAO,GAE1CJ,KAAKK,MAAQf,EAAIY,cAAc,OAC/BF,KAAKG,sBAAsBH,KAAKK,MAAMD,OAEtCJ,KAAKM,aAAehB,EAAIY,cAAc,OACtCF,KAAKG,sBAAsBH,KAAKM,aAAaF,OAG7CJ,KAAKC,GAAGM,YAAYP,KAAKK,OACzBL,KAAKC,GAAGM,YAAYP,KAAKM,cACzBP,EAASQ,YAAYP,KAAKC,IAE1BD,KAAKM,aAAaE,UAAYjB,EAAKkB,aAAa,IAnBnC,KAqBbT,KAAKU,gBAAkBC,MAAO,EAAGC,OAAQ,GAGrCjB,EACAK,KAAKa,eAELb,KAAKc,wBAGb,WAEIzB,EAAI0B,UAAUf,KAAMN,GAEpBM,KAAKU,gBAAkBC,MAAO,EAAGC,OAAQ,GAEzCZ,KAAKG,sBAAwB,SAASC,EAAOY,GACzCZ,EAAMO,MAAQP,EAAMQ,OAAS,OAC7BR,EAAMa,KAAOb,EAAMc,IAAM,MACzBd,EAAMe,WAAa,SACnBf,EAAMgB,SAAW,WACjBhB,EAAMiB,WAAa,MAEf5B,EAAU6B,KAAO,EACjBlB,EAAM,eAAiB,UAEvBA,EAAMmB,KAAO,UAEjBnB,EAAMoB,SAAWR,EAAS,SAAW,WAGzChB,KAAKc,oBAAsB,SAASW,GAGhC,QAFaC,IAATD,IACAA,EAAOzB,KAAK2B,iBACZF,IAASzB,KAAKU,eAAeC,QAAUc,EAAKd,OAASX,KAAKU,eAAeE,SAAWa,EAAKb,QAAS,CAClGZ,KAAKM,aAAaF,MAAMwB,WAAa,OACrC,IAAIC,EAAW7B,KAAK2B,gBACpB3B,KAAKM,aAAaF,MAAMwB,WAAa,GACrC5B,KAAKU,eAAiBe,EACtBzB,KAAK8B,UAAYC,OAAOC,OAAO,MAC/BhC,KAAKiC,eAAiBJ,GAAYA,EAASlB,QAAUc,EAAKd,OAASkB,EAASjB,SAAWa,EAAKb,OAC5FZ,KAAKkC,MAAM,uBAAwBC,KAAMV,MAIjDzB,KAAKa,aAAe,WAChB,IAAIuB,EAAOpC,KACXA,KAAKqC,UAAY,IAAIC,OAAO1C,eAAe,SAAS2C,GAChD,IAAIC,EAAOD,EAAE,GAAGE,YAChBL,EAAKtB,qBACDF,OAAQ4B,EAAK5B,OACbD,MAAO6B,EAAK7B,MAvEX,QA0ETX,KAAKqC,UAAUK,QAAQ1C,KAAKM,eAGhCN,KAAK2C,iBAAmB,WACpB,GAAI3C,KAAK4C,uBAAyB5C,KAAKqC,UACnC,OAAOrC,KAAK4C,sBAChB,IAAIR,EAAOpC,KAEX,OAAOA,KAAK4C,sBAAwBpD,EAAMqD,OAAO,SAASC,IACtDV,EAAKtB,sBACLtB,EAAMqD,OAAOC,EAAI,MAClB,MAGP9C,KAAK+C,WAAa,SAASC,GACnBA,EACAhD,KAAK2C,mBACE3C,KAAK4C,wBACZK,cAAcjD,KAAK4C,uBACnB5C,KAAK4C,sBAAwB,IAIrC5C,KAAK2B,cAAgB,SAASuB,GAC1B,IAAIzB,GACAb,QAASsC,GAAQlD,KAAKM,cAAc6C,aACpCxC,OAAQuC,GAAQlD,KAAKM,cAAc8C,YApG9B,KAyGT,OAAmB,IAAf3B,EAAKd,OAA+B,IAAhBc,EAAKb,OAClB,KACJa,GAGXzB,KAAKqD,kBAAoB,SAASC,GAG9B,OAFAtD,KAAKK,MAAMG,UAAYjB,EAAKkB,aAAa6C,EA/GhC,KAgHEtD,KAAKK,MAAMkD,wBACV5C,MAjHH,KAoHbX,KAAKwD,kBAAoB,SAASF,GAC9B,IAAIG,EAAIzD,KAAK8B,UAAUwB,GAIvB,YAHU5B,IAAN+B,IACAA,EAAIzD,KAAK8B,UAAUwB,GAAMtD,KAAKqD,kBAAkBC,GAAMtD,KAAKU,eAAeC,OAEvE8C,GAGXzD,KAAK0D,QAAU,WACXT,cAAcjD,KAAK4C,uBACf5C,KAAKqC,WACLrC,KAAKqC,UAAUsB,aACf3D,KAAKC,IAAMD,KAAKC,GAAG2D,YACnB5D,KAAKC,GAAG2D,WAAWC,YAAY7D,KAAKC,KAI5CD,KAAK8D,SAAW,SAASC,EAAQC,GAC7B,OAAKA,GACG1B,OAAO2B,iBAAiBD,GAASE,MAAQ,GAAKH,EAAQC,EAAQG,eADjD,GAGzBnE,KAAKoE,2BAA6B,WAC9B,IAAIC,EAAI,SAASA,EAAGC,GAChB,OAAQ,OACJlE,MAAO,0BAA4BiE,EAAI,WAAaC,EAAI,SAGhEtE,KAAKuE,IAAMjF,EAAIkF,UAAUH,EAAE,EAAG,GAAIA,EAAExE,EAAG,GAAIwE,EAAE,EAAGxE,GAAIwE,EAAExE,EAAGA,IAAKG,KAAKC,KAQvED,KAAKyE,qBAAuB,SAASC,EAAWC,GACxCD,IAEAA,EAAYE,EAAI,EADL5E,KAAK8D,SAAS9D,KAAKC,IACJyE,IAE9B,SAASG,EAAMC,EAAIC,EAAIC,GACnB,IAAIC,EAAMH,EAAG,GAAKC,EAAG,GAAKD,EAAG,GAAKC,EAAG,GACrC,SACMA,EAAG,GAAKC,EAAE,GAAKD,EAAG,GAAKC,EAAE,IAAMC,IAC/BH,EAAG,GAAKE,EAAE,GAAKF,EAAG,GAAKE,EAAE,IAAMC,GAGzC,SAASC,EAAIC,EAAGC,GAAK,OAAQD,EAAE,GAAKC,EAAE,GAAID,EAAE,GAAKC,EAAE,IACnD,SAASC,EAAIF,EAAGC,GAAK,OAAQD,EAAE,GAAKC,EAAE,GAAID,EAAE,GAAKC,EAAE,IACnD,SAASR,EAAIO,EAAGC,GAAK,OAAQD,EAAIC,EAAE,GAAID,EAAIC,EAAE,IAK7C,SAASE,EAAErF,GACP,IAAI+E,EAAI/E,EAAGsD,wBACX,OAAQyB,EAAE/D,KAAM+D,EAAE9D,KALjBlB,KAAKuE,KACNvE,KAAKoE,6BAOT,IAAIe,EAAIG,EAAEtF,KAAKuE,IAAI,IACfa,EAAIE,EAAEtF,KAAKuE,IAAI,IACfgB,EAAID,EAAEtF,KAAKuE,IAAI,IACfiB,EAAIF,EAAEtF,KAAKuE,IAAI,IAEfkB,EAAIZ,EAAMK,EAAIM,EAAGJ,GAAIF,EAAIM,EAAGD,GAAIL,EAAIG,EAAID,EAAGG,GAAIF,EAAIG,EAAGL,KAEtDO,EAAKd,EAAI,EAAIa,EAAE,GAAIP,EAAIE,EAAGD,IAC1BQ,EAAKf,EAAI,EAAIa,EAAE,GAAIP,EAAIK,EAAGJ,IAE9B,GAAIR,EAAO,CACP,IAAIiB,EAAIjB,EACJkB,EAAIJ,EAAE,GAAKG,EAAE,GAAK/F,EAAI4F,EAAE,GAAKG,EAAE,GAAK/F,EAAI,EACxCiG,EAAKT,EAAIT,EAAIgB,EAAE,GAAIF,GAAKd,EAAIgB,EAAE,GAAID,IACtC,OAAQN,EAAIT,EAAI,EAAIiB,EAAIhG,EAAGiG,GAAKX,GAEpC,IAAIY,EAAIb,EAAIR,EAAWS,GACnBa,EAAInB,EAAMK,EAAIQ,EAAId,EAAIa,EAAE,GAAIM,IAAKb,EAAIS,EAAIf,EAAIa,EAAE,GAAIM,IAAKA,GAC5D,OAAOnB,EAAI/E,EAAGmG,MAGnBC,KAAKnG,EAAYoG","file":"../../layer/font_metrics.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n * \r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n * \r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\r\nvar oop = require(\"../lib/oop\");\r\nvar dom = require(\"../lib/dom\");\r\nvar lang = require(\"../lib/lang\");\r\nvar event = require(\"../lib/event\");\r\nvar useragent = require(\"../lib/useragent\");\r\nvar EventEmitter = require(\"../lib/event_emitter\").EventEmitter;\r\n\r\nvar CHAR_COUNT = 256;\r\nvar USE_OBSERVER = typeof ResizeObserver == \"function\";\r\nvar L = 200;\r\n\r\nvar FontMetrics = exports.FontMetrics = function(parentEl) {\r\n    this.el = dom.createElement(\"div\");\r\n    this.$setMeasureNodeStyles(this.el.style, true);\r\n    \r\n    this.$main = dom.createElement(\"div\");\r\n    this.$setMeasureNodeStyles(this.$main.style);\r\n    \r\n    this.$measureNode = dom.createElement(\"div\");\r\n    this.$setMeasureNodeStyles(this.$measureNode.style);\r\n    \r\n    \r\n    this.el.appendChild(this.$main);\r\n    this.el.appendChild(this.$measureNode);\r\n    parentEl.appendChild(this.el);\r\n    \r\n    this.$measureNode.innerHTML = lang.stringRepeat(\"X\", CHAR_COUNT);\r\n    \r\n    this.$characterSize = {width: 0, height: 0};\r\n    \r\n    \r\n    if (USE_OBSERVER)\r\n        this.$addObserver();\r\n    else\r\n        this.checkForSizeChanges();\r\n};\r\n\r\n(function() {\r\n\r\n    oop.implement(this, EventEmitter);\r\n        \r\n    this.$characterSize = {width: 0, height: 0};\r\n    \r\n    this.$setMeasureNodeStyles = function(style, isRoot) {\r\n        style.width = style.height = \"auto\";\r\n        style.left = style.top = \"0px\";\r\n        style.visibility = \"hidden\";\r\n        style.position = \"absolute\";\r\n        style.whiteSpace = \"pre\";\r\n\r\n        if (useragent.isIE < 8) {\r\n            style[\"font-family\"] = \"inherit\";\r\n        } else {\r\n            style.font = \"inherit\";\r\n        }\r\n        style.overflow = isRoot ? \"hidden\" : \"visible\";\r\n    };\r\n\r\n    this.checkForSizeChanges = function(size) {\r\n        if (size === undefined)\r\n            size = this.$measureSizes();\r\n        if (size && (this.$characterSize.width !== size.width || this.$characterSize.height !== size.height)) {\r\n            this.$measureNode.style.fontWeight = \"bold\";\r\n            var boldSize = this.$measureSizes();\r\n            this.$measureNode.style.fontWeight = \"\";\r\n            this.$characterSize = size;\r\n            this.charSizes = Object.create(null);\r\n            this.allowBoldFonts = boldSize && boldSize.width === size.width && boldSize.height === size.height;\r\n            this._emit(\"changeCharacterSize\", {data: size});\r\n        }\r\n    };\r\n    \r\n    this.$addObserver = function() {\r\n        var self = this;\r\n        this.$observer = new window.ResizeObserver(function(e) {\r\n            var rect = e[0].contentRect;\r\n            self.checkForSizeChanges({\r\n                height: rect.height,\r\n                width: rect.width / CHAR_COUNT\r\n            });\r\n        });\r\n        this.$observer.observe(this.$measureNode);\r\n    };\r\n\r\n    this.$pollSizeChanges = function() {\r\n        if (this.$pollSizeChangesTimer || this.$observer)\r\n            return this.$pollSizeChangesTimer;\r\n        var self = this;\r\n        \r\n        return this.$pollSizeChangesTimer = event.onIdle(function cb() {\r\n            self.checkForSizeChanges();\r\n            event.onIdle(cb, 500);\r\n        }, 500);\r\n    };\r\n    \r\n    this.setPolling = function(val) {\r\n        if (val) {\r\n            this.$pollSizeChanges();\r\n        } else if (this.$pollSizeChangesTimer) {\r\n            clearInterval(this.$pollSizeChangesTimer);\r\n            this.$pollSizeChangesTimer = 0;\r\n        }\r\n    };\r\n\r\n    this.$measureSizes = function(node) {\r\n        var size = {\r\n            height: (node || this.$measureNode).clientHeight,\r\n            width: (node || this.$measureNode).clientWidth / CHAR_COUNT\r\n        };\r\n        \r\n        // Size and width can be null if the editor is not visible or\r\n        // detached from the document\r\n        if (size.width === 0 || size.height === 0)\r\n            return null;\r\n        return size;\r\n    };\r\n\r\n    this.$measureCharWidth = function(ch) {\r\n        this.$main.innerHTML = lang.stringRepeat(ch, CHAR_COUNT);\r\n        var rect = this.$main.getBoundingClientRect();\r\n        return rect.width / CHAR_COUNT;\r\n    };\r\n    \r\n    this.getCharacterWidth = function(ch) {\r\n        var w = this.charSizes[ch];\r\n        if (w === undefined) {\r\n            w = this.charSizes[ch] = this.$measureCharWidth(ch) / this.$characterSize.width;\r\n        }\r\n        return w;\r\n    };\r\n\r\n    this.destroy = function() {\r\n        clearInterval(this.$pollSizeChangesTimer);\r\n        if (this.$observer)\r\n            this.$observer.disconnect();\r\n        if (this.el && this.el.parentNode)\r\n            this.el.parentNode.removeChild(this.el);\r\n    };\r\n\r\n    \r\n    this.$getZoom = function getZoom(element) {\r\n        if (!element) return 1;\r\n        return (window.getComputedStyle(element).zoom || 1) * getZoom(element.parentElement);\r\n    };\r\n    this.$initTransformMeasureNodes = function() {\r\n        var t = function(t, l) {\r\n            return [\"div\", {\r\n                style: \"position: absolute;top:\" + t + \"px;left:\" + l + \"px;\"\r\n            }];\r\n        };\r\n        this.els = dom.buildDom([t(0, 0), t(L, 0), t(0, L), t(L, L)], this.el);\r\n    };\r\n    // general transforms from element coordinates x to screen coordinates u have the form\r\n    // | m1[0] m2[0] t[0] |   | x |       | u |\r\n    // | m1[1] m2[1] t[1] | . | y |  == k | v |\r\n    // | h[0]  h[1]  1    |   | 1 |       | 1 |\r\n    // this function finds the coeeficients of the matrix using positions of four points\r\n    //  \r\n    this.transformCoordinates = function(clientPos, elPos) {\r\n        if (clientPos) {\r\n            var zoom = this.$getZoom(this.el);\r\n            clientPos = mul(1 / zoom, clientPos);\r\n        }\r\n        function solve(l1, l2, r) {\r\n            var det = l1[1] * l2[0] - l1[0] * l2[1];\r\n            return [\r\n                (-l2[1] * r[0] + l2[0] * r[1]) / det,\r\n                (+l1[1] * r[0] - l1[0] * r[1]) / det\r\n            ];\r\n        }\r\n        function sub(a, b) { return [a[0] - b[0], a[1] - b[1]]; }\r\n        function add(a, b) { return [a[0] + b[0], a[1] + b[1]]; }\r\n        function mul(a, b) { return [a * b[0], a * b[1]]; }\r\n\r\n        if (!this.els)\r\n            this.$initTransformMeasureNodes();\r\n        \r\n        function p(el) {\r\n            var r = el.getBoundingClientRect();\r\n            return [r.left, r.top];\r\n        }\r\n\r\n        var a = p(this.els[0]);\r\n        var b = p(this.els[1]);\r\n        var c = p(this.els[2]);\r\n        var d = p(this.els[3]);\r\n\r\n        var h = solve(sub(d, b), sub(d, c), sub(add(b, c), add(d, a)));\r\n\r\n        var m1 = mul(1 + h[0], sub(b, a));\r\n        var m2 = mul(1 + h[1], sub(c, a));\r\n        \r\n        if (elPos) {\r\n            var x = elPos;\r\n            var k = h[0] * x[0] / L + h[1] * x[1] / L + 1;\r\n            var ut = add(mul(x[0], m1), mul(x[1], m2));\r\n            return  add(mul(1 / k / L, ut), a);\r\n        }\r\n        var u = sub(clientPos, a);\r\n        var f = solve(sub(m1, mul(h[0], u)), sub(m2, mul(h[1], u)), u);\r\n        return mul(L, f);\r\n    };\r\n    \r\n}).call(FontMetrics.prototype);\r\n\r\n});\r\n"]}