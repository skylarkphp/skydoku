{"version":3,"sources":["line_widgets.js"],"names":["define","require","exports","module","dom","Range","LineWidgets","session","this","widgetManager","getRowLength","$getWidgetScreenLength","updateOnChange","bind","renderWidgets","measureWidgets","_changedWidgets","$onChangeEditor","on","updateOnFold","row","h","lineWidgets","rowCount","$useWrapMode","$wrapData","length","screenRows","forEach","w","hidden","e","attach","editor","detach","renderer","off","el","parentNode","_inDocument","removeChild","action","fold","data","start","end","hide","i","undefined","delta","startRow","len","splice","removeLineWidget","$updateRows","args","Array","unshift","apply","noWidgets","$oldWidget","addLineWidget","getLength","old","html","createElement","innerHTML","addCssClass","style","position","zIndex","container","appendChild","coverGutter","pixelHeight","offsetHeight","layerConfig","lineHeight","getFoldAt","$fold","_emit","onWidgetChanged","destroy","w1","getWidgetsAtRow","list","push","updateFull","changedWidgets","config","min","Infinity","fixedWidth","offsetWidth","screenWidth","Math","ceil","characterWidth","coverLine","getRowLineCount","lineWidgetWidth","first","firstRow","last","max","lastRow","$cursorLayer","top","getPixelPosition","column","offset","left","gutterWidth","scrollLeft","fullWidth","minWidth","width","padding","right","scrollBar","getWidth","call","prototype"],"mappings":"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","file":"../line_widgets.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\"use strict\";\r\n\r\nvar oop = require(\"./lib/oop\");\r\nvar dom = require(\"./lib/dom\");\r\nvar Range = require(\"./range\").Range;\r\n\r\n\r\nfunction LineWidgets(session) {\r\n    this.session = session;\r\n    this.session.widgetManager = this;\r\n    this.session.getRowLength = this.getRowLength;\r\n    this.session.$getWidgetScreenLength = this.$getWidgetScreenLength;\r\n    this.updateOnChange = this.updateOnChange.bind(this);\r\n    this.renderWidgets = this.renderWidgets.bind(this);\r\n    this.measureWidgets = this.measureWidgets.bind(this);\r\n    this.session._changedWidgets = [];\r\n    this.$onChangeEditor = this.$onChangeEditor.bind(this);\r\n    \r\n    this.session.on(\"change\", this.updateOnChange);\r\n    this.session.on(\"changeFold\", this.updateOnFold);\r\n    this.session.on(\"changeEditor\", this.$onChangeEditor);\r\n}\r\n\r\n(function() {\r\n    this.getRowLength = function(row) {\r\n        var h;\r\n        if (this.lineWidgets)\r\n            h = this.lineWidgets[row] && this.lineWidgets[row].rowCount || 0;\r\n        else \r\n            h = 0;\r\n        if (!this.$useWrapMode || !this.$wrapData[row]) {\r\n            return 1 + h;\r\n        } else {\r\n            return this.$wrapData[row].length + 1 + h;\r\n        }\r\n    };\r\n\r\n    this.$getWidgetScreenLength = function() {\r\n        var screenRows = 0;\r\n        this.lineWidgets.forEach(function(w){\r\n            if (w && w.rowCount && !w.hidden)\r\n                screenRows += w.rowCount;\r\n        });\r\n        return screenRows;\r\n    };    \r\n    \r\n    this.$onChangeEditor = function(e) {\r\n        this.attach(e.editor);\r\n    };\r\n    \r\n    this.attach = function(editor) {\r\n        if (editor  && editor.widgetManager && editor.widgetManager != this)\r\n            editor.widgetManager.detach();\r\n\r\n        if (this.editor == editor)\r\n            return;\r\n\r\n        this.detach();\r\n        this.editor = editor;\r\n        \r\n        if (editor) {\r\n            editor.widgetManager = this;\r\n            editor.renderer.on(\"beforeRender\", this.measureWidgets);\r\n            editor.renderer.on(\"afterRender\", this.renderWidgets);\r\n        }\r\n    };\r\n    this.detach = function(e) {\r\n        var editor = this.editor;\r\n        if (!editor)\r\n            return;\r\n        \r\n        this.editor = null;\r\n        editor.widgetManager = null;\r\n        \r\n        editor.renderer.off(\"beforeRender\", this.measureWidgets);\r\n        editor.renderer.off(\"afterRender\", this.renderWidgets);\r\n        var lineWidgets = this.session.lineWidgets;\r\n        lineWidgets && lineWidgets.forEach(function(w) {\r\n            if (w && w.el && w.el.parentNode) {\r\n                w._inDocument = false;\r\n                w.el.parentNode.removeChild(w.el);\r\n            }\r\n        });\r\n    };\r\n\r\n    this.updateOnFold = function(e, session) {\r\n        var lineWidgets = session.lineWidgets;\r\n        if (!lineWidgets || !e.action)\r\n            return;\r\n        var fold = e.data;\r\n        var start = fold.start.row;\r\n        var end = fold.end.row;\r\n        var hide = e.action == \"add\";\r\n        for (var i = start + 1; i < end; i++) {\r\n            if (lineWidgets[i])\r\n                lineWidgets[i].hidden = hide;\r\n        }\r\n        if (lineWidgets[end]) {\r\n            if (hide) {\r\n                if (!lineWidgets[start])\r\n                    lineWidgets[start] = lineWidgets[end];\r\n                else\r\n                    lineWidgets[end].hidden = hide;\r\n            } else {\r\n                if (lineWidgets[start] == lineWidgets[end])\r\n                    lineWidgets[start] = undefined;\r\n                lineWidgets[end].hidden = hide;\r\n            }\r\n        }\r\n    };\r\n    \r\n    this.updateOnChange = function(delta) {\r\n        var lineWidgets = this.session.lineWidgets;\r\n        if (!lineWidgets) return;\r\n        \r\n        var startRow = delta.start.row;\r\n        var len = delta.end.row - startRow;\r\n\r\n        if (len === 0) {\r\n            // return\r\n        } else if (delta.action == 'remove') {\r\n            var removed = lineWidgets.splice(startRow + 1, len);\r\n            removed.forEach(function(w) {\r\n                w && this.removeLineWidget(w);\r\n            }, this);\r\n            this.$updateRows();\r\n        } else {\r\n            var args = new Array(len);\r\n            args.unshift(startRow, 0);\r\n            lineWidgets.splice.apply(lineWidgets, args);\r\n            this.$updateRows();\r\n        }\r\n    };\r\n    \r\n    this.$updateRows = function() {\r\n        var lineWidgets = this.session.lineWidgets;\r\n        if (!lineWidgets) return;\r\n        var noWidgets = true;\r\n        lineWidgets.forEach(function(w, i) {\r\n            if (w) {\r\n                noWidgets = false;\r\n                w.row = i;\r\n                while (w.$oldWidget) {\r\n                    w.$oldWidget.row = i;\r\n                    w = w.$oldWidget;\r\n                }\r\n            }\r\n        });\r\n        if (noWidgets)\r\n            this.session.lineWidgets = null;\r\n    };\r\n\r\n    this.addLineWidget = function(w) {\r\n        if (!this.session.lineWidgets)\r\n            this.session.lineWidgets = new Array(this.session.getLength());\r\n        \r\n        var old = this.session.lineWidgets[w.row];\r\n        if (old) {\r\n            w.$oldWidget = old;\r\n            if (old.el && old.el.parentNode) {\r\n                old.el.parentNode.removeChild(old.el);\r\n                old._inDocument = false;\r\n            }\r\n        }\r\n            \r\n        this.session.lineWidgets[w.row] = w;\r\n        \r\n        w.session = this.session;\r\n        \r\n        var renderer = this.editor.renderer;\r\n        if (w.html && !w.el) {\r\n            w.el = dom.createElement(\"div\");\r\n            w.el.innerHTML = w.html;\r\n        }\r\n        if (w.el) {\r\n            dom.addCssClass(w.el, \"ace_lineWidgetContainer\");\r\n            w.el.style.position = \"absolute\";\r\n            w.el.style.zIndex = 5;\r\n            renderer.container.appendChild(w.el);\r\n            w._inDocument = true;\r\n        }\r\n        \r\n        if (!w.coverGutter) {\r\n            w.el.style.zIndex = 3;\r\n        }\r\n        if (w.pixelHeight == null) {\r\n            w.pixelHeight = w.el.offsetHeight;\r\n        }\r\n        if (w.rowCount == null) {\r\n            w.rowCount = w.pixelHeight / renderer.layerConfig.lineHeight;\r\n        }\r\n        \r\n        var fold = this.session.getFoldAt(w.row, 0);\r\n        w.$fold = fold;\r\n        if (fold) {\r\n            var lineWidgets = this.session.lineWidgets;\r\n            if (w.row == fold.end.row && !lineWidgets[fold.start.row])\r\n                lineWidgets[fold.start.row] = w;\r\n            else\r\n                w.hidden = true;\r\n        }\r\n            \r\n        this.session._emit(\"changeFold\", {data:{start:{row: w.row}}});\r\n        \r\n        this.$updateRows();\r\n        this.renderWidgets(null, renderer);\r\n        this.onWidgetChanged(w);\r\n        return w;\r\n    };\r\n    \r\n    this.removeLineWidget = function(w) {\r\n        w._inDocument = false;\r\n        w.session = null;\r\n        if (w.el && w.el.parentNode)\r\n            w.el.parentNode.removeChild(w.el);\r\n        if (w.editor && w.editor.destroy) try {\r\n            w.editor.destroy();\r\n        } catch(e){}\r\n        if (this.session.lineWidgets) {\r\n            var w1 = this.session.lineWidgets[w.row];\r\n            if (w1 == w) {\r\n                this.session.lineWidgets[w.row] = w.$oldWidget;\r\n                if (w.$oldWidget)\r\n                    this.onWidgetChanged(w.$oldWidget);\r\n            } else {\r\n                while (w1) {\r\n                    if (w1.$oldWidget == w) {\r\n                        w1.$oldWidget = w.$oldWidget;\r\n                        break;\r\n                    }\r\n                    w1 = w1.$oldWidget;\r\n                }\r\n            }\r\n        }\r\n        this.session._emit(\"changeFold\", {data:{start:{row: w.row}}});\r\n        this.$updateRows();\r\n    };\r\n    \r\n    this.getWidgetsAtRow = function(row) {\r\n        var lineWidgets = this.session.lineWidgets;\r\n        var w = lineWidgets && lineWidgets[row];\r\n        var list = [];\r\n        while (w) {\r\n            list.push(w);\r\n            w = w.$oldWidget;\r\n        }\r\n        return list;\r\n    };\r\n    \r\n    this.onWidgetChanged = function(w) {\r\n        this.session._changedWidgets.push(w);\r\n        this.editor && this.editor.renderer.updateFull();\r\n    };\r\n    \r\n    this.measureWidgets = function(e, renderer) {\r\n        var changedWidgets = this.session._changedWidgets;\r\n        var config = renderer.layerConfig;\r\n        \r\n        if (!changedWidgets || !changedWidgets.length) return;\r\n        var min = Infinity;\r\n        for (var i = 0; i < changedWidgets.length; i++) {\r\n            var w = changedWidgets[i];\r\n            if (!w || !w.el) continue;\r\n            if (w.session != this.session) continue;\r\n            if (!w._inDocument) {\r\n                if (this.session.lineWidgets[w.row] != w)\r\n                    continue;\r\n                w._inDocument = true;\r\n                renderer.container.appendChild(w.el);\r\n            }\r\n            \r\n            w.h = w.el.offsetHeight;\r\n            \r\n            if (!w.fixedWidth) {\r\n                w.w = w.el.offsetWidth;\r\n                w.screenWidth = Math.ceil(w.w / config.characterWidth);\r\n            }\r\n            \r\n            var rowCount = w.h / config.lineHeight;\r\n            if (w.coverLine) {\r\n                rowCount -= this.session.getRowLineCount(w.row);\r\n                if (rowCount < 0)\r\n                    rowCount = 0;\r\n            }\r\n            if (w.rowCount != rowCount) {\r\n                w.rowCount = rowCount;\r\n                if (w.row < min)\r\n                    min = w.row;\r\n            }\r\n        }\r\n        if (min != Infinity) {\r\n            this.session._emit(\"changeFold\", {data:{start:{row: min}}});\r\n            this.session.lineWidgetWidth = null;\r\n        }\r\n        this.session._changedWidgets = [];\r\n    };\r\n    \r\n    this.renderWidgets = function(e, renderer) {\r\n        var config = renderer.layerConfig;\r\n        var lineWidgets = this.session.lineWidgets;\r\n        if (!lineWidgets)\r\n            return;\r\n        var first = Math.min(this.firstRow, config.firstRow);\r\n        var last = Math.max(this.lastRow, config.lastRow, lineWidgets.length);\r\n        \r\n        while (first > 0 && !lineWidgets[first])\r\n            first--;\r\n        \r\n        this.firstRow = config.firstRow;\r\n        this.lastRow = config.lastRow;\r\n\r\n        renderer.$cursorLayer.config = config;\r\n        for (var i = first; i <= last; i++) {\r\n            var w = lineWidgets[i];\r\n            if (!w || !w.el) continue;\r\n            if (w.hidden) {\r\n                w.el.style.top = -100 - (w.pixelHeight || 0) + \"px\";\r\n                continue;\r\n            }\r\n            if (!w._inDocument) {\r\n                w._inDocument = true;\r\n                renderer.container.appendChild(w.el);\r\n            }\r\n            var top = renderer.$cursorLayer.getPixelPosition({row: i, column:0}, true).top;\r\n            if (!w.coverLine)\r\n                top += config.lineHeight * this.session.getRowLineCount(w.row);\r\n            w.el.style.top = top - config.offset + \"px\";\r\n            \r\n            var left = w.coverGutter ? 0 : renderer.gutterWidth;\r\n            if (!w.fixedWidth)\r\n                left -= renderer.scrollLeft;\r\n            w.el.style.left = left + \"px\";\r\n            \r\n            if (w.fullWidth && w.screenWidth) {\r\n                w.el.style.minWidth = config.width + 2 * config.padding + \"px\";\r\n            }\r\n            \r\n            if (w.fixedWidth) {\r\n                w.el.style.right = renderer.scrollBar.getWidth() + \"px\";\r\n            } else {\r\n                w.el.style.right = \"\";\r\n            }\r\n        }\r\n    };\r\n    \r\n}).call(LineWidgets.prototype);\r\n\r\n\r\nexports.LineWidgets = LineWidgets;\r\n\r\n});\r\n\r\n\r\n    \r\n\r\n"]}