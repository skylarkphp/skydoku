{"version":3,"sources":["keyboard/textinput.js"],"names":["define","require","exports","module","event","useragent","dom","lang","BROKEN_SETDATA","isChrome","USE_IE_MIME_TYPE","isIE","HAS_FOCUS_ARGS","KEYS","MODS","KEY_MODS","isIOS","valueResetRegex","TextInput","parentNode","host","text","createElement","className","setAttribute","style","opacity","insertBefore","firstChild","copied","pasted","inComposition","sendingText","tempStyle","isMobile","fontSize","commandMode","ignoreFocusEvents","lastValue","lastSelectionStart","lastSelectionEnd","isFocused","document","activeElement","e","addListener","onBlur","isEdge","hasFocus","onFocus","setTimeout","resetSelection","this","$focusScroll","focus","preventScroll","top","position","isTransformed","getBoundingClientRect","ancestors","t","parentElement","nodeType","push","getRootNode","forEach","p","removeAttribute","blur","on","curOp","command","name","value","onCompositionEnd","newValue","selectionEnd","length","selection","isEmpty","setSelectionRange","afterContextMenu","range","getRange","row","cursor","selectionStart","start","column","end","line","session","getLine","prevLine","nextLine","slice","inputHandler","setInputHandler","cb","getInputHandler","sendText","fromInput","onPaste","extendLeft","extendRight","inserted","restoreStart","restoreEnd","i","onTextInput","onInput","onCompositionUpdate","data","MAX_LINE_LENGTH","test","handleClipboardData","forceIEMime","clipboardData","window","mime","setData","getData","doCopy","isCut","getCopyText","preventDefault","onCut","onCopy","select","addCommandKeyListener","onCommandKey","bind","isAllSelected","selectAll","isMac","metaKey","ctrlKey","keyCode","$readOnly","cancelComposition","useTextareaForIME","markerRange","context","compositionStartOffset","off","closeTimeout","syncComposition","delayedCall","schedule","onContextMenuClose","clearTimeout","cssText","renderer","$keepTextAreaAtCursor","$moveTextAreaToCursor","onCompositionStart","getSelectionRange","msGetInputContext","getInputContext","getElement","setCommandMode","readOnly","setReadOnly","setCopyWithEmptySelection","onContextMenu","_emit","target","domEvent","moveToMouse","bringToFront","characterWidth","rect","container","computedStyle","parseInt","borderTopWidth","left","borderLeftWidth","maxTop","bottom","clientHeight","move","clientX","Math","min","clientY","type","isWin","capture","textInput","scroller","typingResetTimeout","typing","addEventListener","detectArrowKeys","key","modifier","console","log","up","home","option","split","down","right","shift","removeEventListener","addIosSelectionHandler"],"mappings":"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","file":"../../keyboard/textinput.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\"use strict\";\r\n\r\nvar event = require(\"../lib/event\");\r\nvar useragent = require(\"../lib/useragent\");\r\nvar dom = require(\"../lib/dom\");\r\nvar lang = require(\"../lib/lang\");\r\nvar BROKEN_SETDATA = useragent.isChrome < 18;\r\nvar USE_IE_MIME_TYPE =  useragent.isIE;\r\nvar HAS_FOCUS_ARGS = useragent.isChrome > 63;\r\nvar MAX_LINE_LENGTH = 400;\r\n\r\nvar KEYS = require(\"../lib/keys\");\r\nvar MODS = KEYS.KEY_MODS;\r\nvar isIOS = useragent.isIOS;\r\nvar valueResetRegex = isIOS ? /\\s/ : /\\n/;\r\n\r\nvar TextInput = function(parentNode, host) {\r\n    var text = dom.createElement(\"textarea\");\r\n    text.className = \"ace_text-input\";\r\n\r\n    text.setAttribute(\"wrap\", \"off\");\r\n    text.setAttribute(\"autocorrect\", \"off\");\r\n    text.setAttribute(\"autocapitalize\", \"off\");\r\n    text.setAttribute(\"spellcheck\", false);\r\n\r\n    text.style.opacity = \"0\";\r\n    parentNode.insertBefore(text, parentNode.firstChild);\r\n\r\n    var copied = false;\r\n    var pasted = false;\r\n    var inComposition = false;\r\n    var sendingText = false;\r\n    var tempStyle = '';\r\n    var isSelectionEmpty = true;\r\n    var copyWithEmptySelection = false;\r\n    \r\n    if (!useragent.isMobile)\r\n        text.style.fontSize = \"1px\";\r\n\r\n    var commandMode = false;\r\n    var ignoreFocusEvents = false;\r\n    \r\n    var lastValue = \"\";\r\n    var lastSelectionStart = 0;\r\n    var lastSelectionEnd = 0;\r\n    \r\n    // FOCUS\r\n    // ie9 throws error if document.activeElement is accessed too soon\r\n    try { var isFocused = document.activeElement === text; } catch(e) {}\r\n    \r\n    event.addListener(text, \"blur\", function(e) {\r\n        if (ignoreFocusEvents) return;\r\n        host.onBlur(e);\r\n        isFocused = false;\r\n    });\r\n    event.addListener(text, \"focus\", function(e) {\r\n        if (ignoreFocusEvents) return;\r\n        isFocused = true;\r\n        if (useragent.isEdge) {\r\n            // on edge focus event nnis fired even if document itself is not focused\r\n            try {\r\n                if (!document.hasFocus())\r\n                    return;\r\n            } catch(e) {}\r\n        }\r\n        host.onFocus(e);\r\n        if (useragent.isEdge)\r\n            setTimeout(resetSelection);\r\n        else\r\n            resetSelection();\r\n    });\r\n    this.$focusScroll = false;\r\n    this.focus = function() {\r\n        if (tempStyle || HAS_FOCUS_ARGS || this.$focusScroll == \"browser\")\r\n            return text.focus({ preventScroll: true });\r\n\r\n        var top = text.style.top;\r\n        text.style.position = \"fixed\";\r\n        text.style.top = \"0px\";\r\n        try {\r\n            var isTransformed = text.getBoundingClientRect().top != 0;\r\n        } catch(e) {\r\n            // getBoundingClientRect on IE throws error if element is not in the dom tree\r\n            return;\r\n        }\r\n        var ancestors = [];\r\n        if (isTransformed) {\r\n            var t = text.parentElement;\r\n            while (t && t.nodeType == 1) {\r\n                ancestors.push(t);\r\n                t.setAttribute(\"ace_nocontext\", true);\r\n                if (!t.parentElement && t.getRootNode)\r\n                    t = t.getRootNode().host;\r\n                else\r\n                    t = t.parentElement;\r\n            }\r\n        }\r\n        text.focus({ preventScroll: true });\r\n        if (isTransformed) {\r\n            ancestors.forEach(function(p) {\r\n                p.removeAttribute(\"ace_nocontext\");\r\n            });\r\n        }\r\n        setTimeout(function() {\r\n            text.style.position = \"\";\r\n            if (text.style.top == \"0px\")\r\n                text.style.top = top;\r\n        }, 0);\r\n    };\r\n    this.blur = function() {\r\n        text.blur();\r\n    };\r\n    this.isFocused = function() {\r\n        return isFocused;\r\n    };\r\n    \r\n    host.on(\"beforeEndOperation\", function() {\r\n        if (host.curOp && host.curOp.command.name == \"insertstring\")\r\n            return;\r\n        if (inComposition) {\r\n            // exit composition from commands other than insertstring\r\n            lastValue = text.value = \"\";\r\n            onCompositionEnd();\r\n        }\r\n        // sync value of textarea\r\n        resetSelection();\r\n    });\r\n    \r\n    var resetSelection = isIOS\r\n    ? function(value) {\r\n        if (!isFocused || (copied && !value) || sendingText) return;\r\n        if (!value) \r\n            value = \"\";\r\n        var newValue = \"\\n ab\" + value + \"cde fg\\n\";\r\n        if (newValue != text.value)\r\n            text.value = lastValue = newValue;\r\n        \r\n        var selectionStart = 4;\r\n        var selectionEnd = 4 + (value.length || (host.selection.isEmpty() ? 0 : 1));\r\n\r\n        if (lastSelectionStart != selectionStart || lastSelectionEnd != selectionEnd) {\r\n            text.setSelectionRange(selectionStart, selectionEnd);\r\n        }\r\n        lastSelectionStart = selectionStart;\r\n        lastSelectionEnd = selectionEnd;\r\n    }\r\n    : function() {\r\n        if (inComposition || sendingText)\r\n            return;\r\n        // modifying selection of blured textarea can focus it (chrome mac/linux)\r\n        if (!isFocused && !afterContextMenu)\r\n            return;\r\n        // this prevents infinite recursion on safari 8 \r\n        // see https://github.com/ajaxorg/ace/issues/2114\r\n        inComposition = true;\r\n        \r\n        var selection = host.selection;\r\n        var range = selection.getRange();\r\n        var row = selection.cursor.row;\r\n        var selectionStart = range.start.column;\r\n        var selectionEnd = range.end.column;\r\n        var line = host.session.getLine(row);\r\n\r\n        if (range.start.row != row) {\r\n            var prevLine = host.session.getLine(row - 1);\r\n            selectionStart = range.start.row < row - 1 ? 0 : selectionStart;\r\n            selectionEnd += prevLine.length + 1;\r\n            line = prevLine + \"\\n\" + line;\r\n        }\r\n        else if (range.end.row != row) {\r\n            var nextLine = host.session.getLine(row + 1);\r\n            selectionEnd = range.end.row > row  + 1 ? nextLine.length : selectionEnd;\r\n            selectionEnd += line.length + 1;\r\n            line = line + \"\\n\" + nextLine;\r\n        }\r\n\r\n        if (line.length > MAX_LINE_LENGTH) {\r\n            if (selectionStart < MAX_LINE_LENGTH && selectionEnd < MAX_LINE_LENGTH) {\r\n                line = line.slice(0, MAX_LINE_LENGTH);\r\n            } else {\r\n                line = \"\\n\";\r\n                selectionStart = 0;\r\n                selectionEnd = 1;\r\n            }\r\n        }\r\n\r\n        var newValue = line + \"\\n\\n\";\r\n        if (newValue != lastValue) {\r\n            text.value = lastValue = newValue;\r\n            lastSelectionStart = lastSelectionEnd = newValue.length;\r\n        }\r\n        \r\n        // contextmenu on mac may change the selection\r\n        if (afterContextMenu) {\r\n            lastSelectionStart = text.selectionStart;\r\n            lastSelectionEnd = text.selectionEnd;\r\n        }\r\n        // on firefox this throws if textarea is hidden\r\n        if (\r\n            lastSelectionEnd != selectionEnd \r\n            || lastSelectionStart != selectionStart \r\n            || text.selectionEnd != lastSelectionEnd // on ie edge selectionEnd changes silently after the initialization\r\n        ) {\r\n            try {\r\n                text.setSelectionRange(selectionStart, selectionEnd);\r\n                lastSelectionStart = selectionStart;\r\n                lastSelectionEnd = selectionEnd;\r\n            } catch(e){}\r\n        }\r\n        inComposition = false;\r\n    };\r\n\r\n    if (isFocused)\r\n        host.onFocus();\r\n\r\n\r\n    var isAllSelected = function(text) {\r\n        return text.selectionStart === 0 && text.selectionEnd >= lastValue.length\r\n            && text.value === lastValue && lastValue\r\n            && text.selectionEnd !== lastSelectionEnd;\r\n    };\r\n\r\n    var onSelect = function(e) {\r\n        if (inComposition)\r\n            return;\r\n        if (copied) {\r\n            copied = false;\r\n        } else if (isAllSelected(text)) {\r\n            host.selectAll();\r\n            resetSelection();\r\n        }\r\n    };\r\n\r\n    var inputHandler = null;\r\n    this.setInputHandler = function(cb) {inputHandler = cb;};\r\n    this.getInputHandler = function() {return inputHandler;};\r\n    var afterContextMenu = false;\r\n    \r\n    var sendText = function(value, fromInput) {\r\n        if (afterContextMenu)\r\n            afterContextMenu = false;\r\n        if (pasted) {\r\n            resetSelection();\r\n            if (value)\r\n                host.onPaste(value);\r\n            pasted = false;\r\n            return \"\";\r\n        } else {\r\n            var selectionStart = text.selectionStart;\r\n            var selectionEnd = text.selectionEnd;\r\n        \r\n            var extendLeft = lastSelectionStart;\r\n            var extendRight = lastValue.length - lastSelectionEnd;\r\n            \r\n            var inserted = value;\r\n            var restoreStart = value.length - selectionStart;\r\n            var restoreEnd = value.length - selectionEnd;\r\n        \r\n            var i = 0;\r\n            while (extendLeft > 0 && lastValue[i] == value[i]) {\r\n                i++;\r\n                extendLeft--;\r\n            }\r\n            inserted = inserted.slice(i);\r\n            i = 1;\r\n            while (extendRight > 0 && lastValue.length - i > lastSelectionStart - 1  && lastValue[lastValue.length - i] == value[value.length - i]) {\r\n                i++;\r\n                extendRight--;\r\n            }\r\n            restoreStart -= i-1;\r\n            restoreEnd -= i-1;\r\n            inserted = inserted.slice(0, inserted.length - i+1);\r\n            \r\n            // composition update can be called without any change\r\n            if (!fromInput && restoreStart == inserted.length && !extendLeft && !extendRight && !restoreEnd)\r\n                return \"\";\r\n            \r\n            sendingText = true;\r\n            if (inserted && !extendLeft && !extendRight && !restoreStart && !restoreEnd || commandMode) {\r\n                host.onTextInput(inserted);\r\n            } else {\r\n                host.onTextInput(inserted, {\r\n                    extendLeft: extendLeft,\r\n                    extendRight: extendRight,\r\n                    restoreStart: restoreStart,\r\n                    restoreEnd: restoreEnd\r\n                });\r\n            }\r\n            sendingText = false;\r\n            \r\n            lastValue = value;\r\n            lastSelectionStart = selectionStart;\r\n            lastSelectionEnd = selectionEnd;\r\n            return inserted;\r\n        }\r\n    };\r\n    var onInput = function(e) {\r\n        if (inComposition)\r\n            return onCompositionUpdate();\r\n        var data = text.value;\r\n        var inserted = sendText(data, true);\r\n        if (data.length > MAX_LINE_LENGTH + 100 || valueResetRegex.test(inserted))\r\n            resetSelection();\r\n    };\r\n    \r\n    var handleClipboardData = function(e, data, forceIEMime) {\r\n        var clipboardData = e.clipboardData || window.clipboardData;\r\n        if (!clipboardData || BROKEN_SETDATA)\r\n            return;\r\n        // using \"Text\" doesn't work on old webkit but ie needs it\r\n        var mime = USE_IE_MIME_TYPE || forceIEMime ? \"Text\" : \"text/plain\";\r\n        try {\r\n            if (data) {\r\n                // Safari 5 has clipboardData object, but does not handle setData()\r\n                return clipboardData.setData(mime, data) !== false;\r\n            } else {\r\n                return clipboardData.getData(mime);\r\n            }\r\n        } catch(e) {\r\n            if (!forceIEMime)\r\n                return handleClipboardData(e, data, true);\r\n        }\r\n    };\r\n\r\n    var doCopy = function(e, isCut) {\r\n        var data = host.getCopyText();\r\n        if (!data)\r\n            return event.preventDefault(e);\r\n\r\n        if (handleClipboardData(e, data)) {\r\n            if (isIOS) {\r\n                resetSelection(data);\r\n                copied = data;\r\n                setTimeout(function () {\r\n                    copied = false;\r\n                }, 10);\r\n            }\r\n            isCut ? host.onCut() : host.onCopy();\r\n            event.preventDefault(e);\r\n        } else {\r\n            copied = true;\r\n            text.value = data;\r\n            text.select();\r\n            setTimeout(function(){\r\n                copied = false;\r\n                resetSelection();\r\n                isCut ? host.onCut() : host.onCopy();\r\n            });\r\n        }\r\n    };\r\n    \r\n    var onCut = function(e) {\r\n        doCopy(e, true);\r\n    };\r\n    \r\n    var onCopy = function(e) {\r\n        doCopy(e, false);\r\n    };\r\n    \r\n    var onPaste = function(e) {\r\n        var data = handleClipboardData(e);\r\n        if (typeof data == \"string\") {\r\n            if (data)\r\n                host.onPaste(data, e);\r\n            if (useragent.isIE)\r\n                setTimeout(resetSelection);\r\n            event.preventDefault(e);\r\n        }\r\n        else {\r\n            text.value = \"\";\r\n            pasted = true;\r\n        }\r\n    };\r\n\r\n    event.addCommandKeyListener(text, host.onCommandKey.bind(host));\r\n\r\n    event.addListener(text, \"select\", onSelect);\r\n    event.addListener(text, \"input\", onInput);\r\n\r\n    event.addListener(text, \"cut\", onCut);\r\n    event.addListener(text, \"copy\", onCopy);\r\n    event.addListener(text, \"paste\", onPaste);\r\n\r\n\r\n    // Opera has no clipboard events\r\n    if (!('oncut' in text) || !('oncopy' in text) || !('onpaste' in text)) {\r\n        event.addListener(parentNode, \"keydown\", function(e) {\r\n            if ((useragent.isMac && !e.metaKey) || !e.ctrlKey)\r\n                return;\r\n\r\n            switch (e.keyCode) {\r\n                case 67:\r\n                    onCopy(e);\r\n                    break;\r\n                case 86:\r\n                    onPaste(e);\r\n                    break;\r\n                case 88:\r\n                    onCut(e);\r\n                    break;\r\n            }\r\n        });\r\n    }\r\n\r\n\r\n    // COMPOSITION\r\n    var onCompositionStart = function(e) {\r\n        if (inComposition || !host.onCompositionStart || host.$readOnly) \r\n            return;\r\n        \r\n        inComposition = {};\r\n\r\n        if (commandMode)\r\n            return;\r\n        \r\n        setTimeout(onCompositionUpdate, 0);\r\n        host.on(\"mousedown\", cancelComposition);\r\n        \r\n        var range = host.getSelectionRange();\r\n        range.end.row = range.start.row;\r\n        range.end.column = range.start.column;\r\n        inComposition.markerRange = range;\r\n        inComposition.selectionStart = lastSelectionStart;\r\n        host.onCompositionStart(inComposition);\r\n        \r\n        if (inComposition.useTextareaForIME) {\r\n            text.value = \"\";\r\n            lastValue = \"\";\r\n            lastSelectionStart = 0;\r\n            lastSelectionEnd = 0;\r\n        }\r\n        else {\r\n            if (text.msGetInputContext)\r\n                inComposition.context = text.msGetInputContext();\r\n            if (text.getInputContext)\r\n                inComposition.context = text.getInputContext();\r\n        }\r\n    };\r\n\r\n    var onCompositionUpdate = function() {\r\n        if (!inComposition || !host.onCompositionUpdate || host.$readOnly)\r\n            return;\r\n        if (commandMode)\r\n            return cancelComposition();\r\n        \r\n        if (inComposition.useTextareaForIME) {\r\n            host.onCompositionUpdate(text.value);\r\n        }\r\n        else {\r\n            var data = text.value;\r\n            sendText(data);\r\n            if (inComposition.markerRange) {\r\n                if (inComposition.context) {\r\n                    inComposition.markerRange.start.column = inComposition.selectionStart\r\n                        = inComposition.context.compositionStartOffset;\r\n                }\r\n                inComposition.markerRange.end.column = inComposition.markerRange.start.column\r\n                    + lastSelectionEnd - inComposition.selectionStart;\r\n            }\r\n        }\r\n    };\r\n\r\n    var onCompositionEnd = function(e) {\r\n        if (!host.onCompositionEnd || host.$readOnly) return;\r\n        inComposition = false;\r\n        host.onCompositionEnd();\r\n        host.off(\"mousedown\", cancelComposition);\r\n        // note that resetting value of textarea at this point doesn't always work\r\n        // because textarea value can be silently restored\r\n        if (e) onInput();\r\n    };\r\n    \r\n\r\n    function cancelComposition() {\r\n        // force end composition\r\n        ignoreFocusEvents = true;\r\n        text.blur();\r\n        text.focus();\r\n        ignoreFocusEvents = false;\r\n    }\r\n\r\n    var syncComposition = lang.delayedCall(onCompositionUpdate, 50).schedule.bind(null, null);\r\n    \r\n    function onKeyup(e) {\r\n        // workaround for a bug in ie where pressing esc silently moves selection out of textarea\r\n        if (e.keyCode == 27 && text.value.length < text.selectionStart) {\r\n            if (!inComposition)\r\n                lastValue = text.value;\r\n            lastSelectionStart = lastSelectionEnd = -1;\r\n            resetSelection();\r\n        }\r\n        syncComposition();\r\n    }\r\n\r\n    event.addListener(text, \"compositionstart\", onCompositionStart);\r\n    event.addListener(text, \"compositionupdate\", onCompositionUpdate);\r\n    event.addListener(text, \"keyup\", onKeyup);\r\n    event.addListener(text, \"keydown\", syncComposition);\r\n    event.addListener(text, \"compositionend\", onCompositionEnd);\r\n\r\n    this.getElement = function() {\r\n        return text;\r\n    };\r\n    \r\n    // allows to ignore composition (used by vim keyboard handler in the normal mode)\r\n    // this is useful on mac, where with some keyboard layouts (e.g swedish) ^ starts composition\r\n    this.setCommandMode = function(value) {\r\n       commandMode = value;\r\n       text.readOnly = false;\r\n    };\r\n    \r\n    this.setReadOnly = function(readOnly) {\r\n        if (!commandMode)\r\n            text.readOnly = readOnly;\r\n    };\r\n\r\n    this.setCopyWithEmptySelection = function(value) {\r\n        copyWithEmptySelection = value;\r\n    };\r\n\r\n    this.onContextMenu = function(e) {\r\n        afterContextMenu = true;\r\n        resetSelection();\r\n        host._emit(\"nativecontextmenu\", {target: host, domEvent: e});\r\n        this.moveToMouse(e, true);\r\n    };\r\n    \r\n    this.moveToMouse = function(e, bringToFront) {\r\n        if (!tempStyle)\r\n            tempStyle = text.style.cssText;\r\n        text.style.cssText = (bringToFront ? \"z-index:100000;\" : \"\")\r\n            + (useragent.isIE ? \"opacity:0.1;\" : \"\")\r\n            + \"text-indent: -\" + (lastSelectionStart + lastSelectionEnd) * host.renderer.characterWidth * 0.5 + \"px;\";\r\n\r\n        var rect = host.container.getBoundingClientRect();\r\n        var style = dom.computedStyle(host.container);\r\n        var top = rect.top + (parseInt(style.borderTopWidth) || 0);\r\n        var left = rect.left + (parseInt(rect.borderLeftWidth) || 0);\r\n        var maxTop = rect.bottom - top - text.clientHeight -2;\r\n        var move = function(e) {\r\n            text.style.left = e.clientX - left - 2 + \"px\";\r\n            text.style.top = Math.min(e.clientY - top - 2, maxTop) + \"px\";\r\n        }; \r\n        move(e);\r\n\r\n        if (e.type != \"mousedown\")\r\n            return;\r\n\r\n        if (host.renderer.$keepTextAreaAtCursor)\r\n            host.renderer.$keepTextAreaAtCursor = null;\r\n\r\n        clearTimeout(closeTimeout);\r\n        // on windows context menu is opened after mouseup\r\n        if (useragent.isWin)\r\n            event.capture(host.container, move, onContextMenuClose);\r\n    };\r\n\r\n    this.onContextMenuClose = onContextMenuClose;\r\n    var closeTimeout;\r\n    function onContextMenuClose() {\r\n        clearTimeout(closeTimeout);\r\n        closeTimeout = setTimeout(function () {\r\n            if (tempStyle) {\r\n                text.style.cssText = tempStyle;\r\n                tempStyle = '';\r\n            }\r\n            if (host.renderer.$keepTextAreaAtCursor == null) {\r\n                host.renderer.$keepTextAreaAtCursor = true;\r\n                host.renderer.$moveTextAreaToCursor();\r\n            }\r\n        }, 0);\r\n    }\r\n\r\n    var onContextMenu = function(e) {\r\n        host.textInput.onContextMenu(e);\r\n        onContextMenuClose();\r\n    };\r\n    event.addListener(text, \"mouseup\", onContextMenu);\r\n    event.addListener(text, \"mousedown\", function(e) {\r\n        e.preventDefault();\r\n        onContextMenuClose();\r\n    });\r\n    event.addListener(host.renderer.scroller, \"contextmenu\", onContextMenu);\r\n    event.addListener(text, \"contextmenu\", onContextMenu);\r\n    \r\n    if (isIOS)\r\n        addIosSelectionHandler(parentNode, host, text);\r\n\r\n    function addIosSelectionHandler(parentNode, host, text) {\r\n        var typingResetTimeout = null;\r\n        var typing = false;\r\n \r\n        text.addEventListener(\"keydown\", function (e) {\r\n            if (typingResetTimeout) clearTimeout(typingResetTimeout);\r\n            typing = true;\r\n        }, true);\r\n\r\n        text.addEventListener(\"keyup\", function (e) {\r\n            typingResetTimeout = setTimeout(function () {\r\n                typing = false;\r\n            }, 100);\r\n        }, true);\r\n    \r\n        // IOS doesn't fire events for arrow keys, but this unique hack changes everything!\r\n        var detectArrowKeys = function(e) {\r\n            if (document.activeElement !== text) return;\r\n            if (typing || inComposition) return;\r\n\r\n            if (copied) {\r\n                return;\r\n            }\r\n            var selectionStart = text.selectionStart;\r\n            var selectionEnd = text.selectionEnd;\r\n            \r\n            var key = null;\r\n            var modifier = 0;\r\n            console.log(selectionStart, selectionEnd);\r\n            if (selectionStart == 0) {\r\n                key = KEYS.up;\r\n            } else if (selectionStart == 1) {\r\n                key = KEYS.home;\r\n            } else if (selectionEnd > lastSelectionEnd && lastValue[selectionEnd] == \"\\n\") {\r\n                key = KEYS.end;\r\n            } else if (selectionStart < lastSelectionStart && lastValue[selectionStart - 1] == \" \") {\r\n                key = KEYS.left;\r\n                modifier = MODS.option;\r\n            } else if (\r\n                selectionStart < lastSelectionStart\r\n                || (\r\n                    selectionStart == lastSelectionStart \r\n                    && lastSelectionEnd != lastSelectionStart\r\n                    && selectionStart == selectionEnd\r\n                )\r\n            ) {\r\n                key = KEYS.left;\r\n            } else if (selectionEnd > lastSelectionEnd && lastValue.slice(0, selectionEnd).split(\"\\n\").length > 2) {\r\n                key = KEYS.down;\r\n            } else if (selectionEnd > lastSelectionEnd && lastValue[selectionEnd - 1] == \" \") {\r\n                key = KEYS.right;\r\n                modifier = MODS.option;\r\n            } else if (\r\n                selectionEnd > lastSelectionEnd\r\n                || (\r\n                    selectionEnd == lastSelectionEnd \r\n                    && lastSelectionEnd != lastSelectionStart\r\n                    && selectionStart == selectionEnd\r\n                )\r\n            ) {\r\n                key = KEYS.right;\r\n            }\r\n            \r\n            if (selectionStart !== selectionEnd)\r\n                modifier |= MODS.shift;\r\n\r\n            if (key) {\r\n                host.onCommandKey(null, modifier, key);\r\n                lastSelectionStart = selectionStart;\r\n                lastSelectionEnd = selectionEnd;\r\n                resetSelection(\"\");\r\n            }\r\n        };\r\n        // On iOS, \"selectionchange\" can only be attached to the document object...\r\n        document.addEventListener(\"selectionchange\", detectArrowKeys);\r\n        host.on(\"destroy\", function() {\r\n            document.removeEventListener(\"selectionchange\", detectArrowKeys);\r\n        });\r\n    }\r\n\r\n};\r\n\r\nexports.TextInput = TextInput;\r\n});\r\n"]}