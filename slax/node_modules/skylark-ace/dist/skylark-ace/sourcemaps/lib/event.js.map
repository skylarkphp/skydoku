{"version":3,"sources":["lib/event.js"],"names":["define","require","exports","module","keys","useragent","pressedKeys","ts","addListener","elem","type","callback","addEventListener","attachEvent","wrapper","call","window","event","_wrapper","removeListener","removeEventListener","detachEvent","stopEvent","e","stopPropagation","preventDefault","cancelBubble","returnValue","getButton","isMac","ctrlKey","altKey","shiftKey","button","1","2","4","capture","el","eventHandler","releaseCaptureHandler","onMouseUp","document","addTouchMoveListener","startx","starty","touchObj","touches","clientX","clientY","length","wheelX","wheelY","addMouseWheelListener","undefined","wheelDeltaX","wheelDeltaY","wheelDelta","deltaMode","DOM_DELTA_PIXEL","deltaX","deltaY","DOM_DELTA_LINE","DOM_DELTA_PAGE","axis","HORIZONTAL_AXIS","detail","addMultiMouseDownListener","elements","timeouts","callbackName","startX","startY","timer","clicks","eventNames","3","onMousedown","isIE","isNewClick","Math","abs","clearTimeout","setTimeout","_clicks","onDblclick","Array","isArray","forEach","isOldIE","getModifierHash","isOpera","metaKey","normalizeCommandKeys","keyCode","hashId","getModifierState","altGr","location","keyLocation","timeStamp","MODIFIER_KEYS","defaultPrevented","isChromeOS","FUNCTION_KEYS","PRINTABLE_KEYS","resetPressedKeys","Object","create","getModifierString","KEY_MODS","addCommandKeyListener","isOldGecko","lastKeyDownKeyCode","lastDefaultPrevented","result","postMessage","postMessageId","nextTick","win","messageName","listener","data","$idleBlocked","onIdle","cb","timeout","handler","$idleBlockId","blockIdle","delay","nextFrame","requestAnimationFrame","mozRequestAnimationFrame","webkitRequestAnimationFrame","msRequestAnimationFrame","oRequestAnimationFrame","bind"],"mappings":"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","file":"../../lib/event.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\"use strict\";\r\n\r\nvar keys = require(\"./keys\");\r\nvar useragent = require(\"./useragent\");\r\n\r\nvar pressedKeys = null;\r\nvar ts = 0;\r\n\r\nexports.addListener = function(elem, type, callback) {\r\n    if (elem.addEventListener) {\r\n        return elem.addEventListener(type, callback, false);\r\n    }\r\n    if (elem.attachEvent) {\r\n        var wrapper = function() {\r\n            callback.call(elem, window.event);\r\n        };\r\n        callback._wrapper = wrapper;\r\n        elem.attachEvent(\"on\" + type, wrapper);\r\n    }\r\n};\r\n\r\nexports.removeListener = function(elem, type, callback) {\r\n    if (elem.removeEventListener) {\r\n        return elem.removeEventListener(type, callback, false);\r\n    }\r\n    if (elem.detachEvent) {\r\n        elem.detachEvent(\"on\" + type, callback._wrapper || callback);\r\n    }\r\n};\r\n\r\n/*\r\n* Prevents propagation and clobbers the default action of the passed event\r\n*/\r\nexports.stopEvent = function(e) {\r\n    exports.stopPropagation(e);\r\n    exports.preventDefault(e);\r\n    return false;\r\n};\r\n\r\nexports.stopPropagation = function(e) {\r\n    if (e.stopPropagation)\r\n        e.stopPropagation();\r\n    else\r\n        e.cancelBubble = true;\r\n};\r\n\r\nexports.preventDefault = function(e) {\r\n    if (e.preventDefault)\r\n        e.preventDefault();\r\n    else\r\n        e.returnValue = false;\r\n};\r\n\r\n/*\r\n * @return {Number} 0 for left button, 1 for middle button, 2 for right button\r\n */\r\nexports.getButton = function(e) {\r\n    if (e.type == \"dblclick\")\r\n        return 0;\r\n    if (e.type == \"contextmenu\" || (useragent.isMac && (e.ctrlKey && !e.altKey && !e.shiftKey)))\r\n        return 2;\r\n\r\n    // DOM Event\r\n    if (e.preventDefault) {\r\n        return e.button;\r\n    }\r\n    // old IE\r\n    else {\r\n        return {1:0, 2:2, 4:1}[e.button];\r\n    }\r\n};\r\n\r\nexports.capture = function(el, eventHandler, releaseCaptureHandler) {\r\n    function onMouseUp(e) {\r\n        eventHandler && eventHandler(e);\r\n        releaseCaptureHandler && releaseCaptureHandler(e);\r\n\r\n        exports.removeListener(document, \"mousemove\", eventHandler, true);\r\n        exports.removeListener(document, \"mouseup\", onMouseUp, true);\r\n        exports.removeListener(document, \"dragstart\", onMouseUp, true);\r\n    }\r\n\r\n    exports.addListener(document, \"mousemove\", eventHandler, true);\r\n    exports.addListener(document, \"mouseup\", onMouseUp, true);\r\n    exports.addListener(document, \"dragstart\", onMouseUp, true);\r\n    \r\n    return onMouseUp;\r\n};\r\n\r\nexports.addTouchMoveListener = function (el, callback) {\r\n    var startx, starty;\r\n    exports.addListener(el, \"touchstart\", function (e) {\r\n        var touches = e.touches;\r\n        var touchObj = touches[0];\r\n        startx = touchObj.clientX;\r\n        starty = touchObj.clientY;\r\n    });\r\n    exports.addListener(el, \"touchmove\", function (e) {\r\n        var touches = e.touches;\r\n        if (touches.length > 1) return;\r\n        \r\n        var touchObj = touches[0];\r\n\r\n        e.wheelX = startx - touchObj.clientX;\r\n        e.wheelY = starty - touchObj.clientY;\r\n\r\n        startx = touchObj.clientX;\r\n        starty = touchObj.clientY;\r\n\r\n        callback(e);\r\n    });\r\n};\r\n\r\nexports.addMouseWheelListener = function(el, callback) {\r\n    if (\"onmousewheel\" in el) {\r\n        exports.addListener(el, \"mousewheel\", function(e) {\r\n            var factor = 8;\r\n            if (e.wheelDeltaX !== undefined) {\r\n                e.wheelX = -e.wheelDeltaX / factor;\r\n                e.wheelY = -e.wheelDeltaY / factor;\r\n            } else {\r\n                e.wheelX = 0;\r\n                e.wheelY = -e.wheelDelta / factor;\r\n            }\r\n            callback(e);\r\n        });\r\n    } else if (\"onwheel\" in el) {\r\n        exports.addListener(el, \"wheel\",  function(e) {\r\n            var factor = 0.35;\r\n            switch (e.deltaMode) {\r\n                case e.DOM_DELTA_PIXEL:\r\n                    e.wheelX = e.deltaX * factor || 0;\r\n                    e.wheelY = e.deltaY * factor || 0;\r\n                    break;\r\n                case e.DOM_DELTA_LINE:\r\n                case e.DOM_DELTA_PAGE:\r\n                    e.wheelX = (e.deltaX || 0) * 5;\r\n                    e.wheelY = (e.deltaY || 0) * 5;\r\n                    break;\r\n            }\r\n            \r\n            callback(e);\r\n        });\r\n    } else {\r\n        exports.addListener(el, \"DOMMouseScroll\", function(e) {\r\n            if (e.axis && e.axis == e.HORIZONTAL_AXIS) {\r\n                e.wheelX = (e.detail || 0) * 5;\r\n                e.wheelY = 0;\r\n            } else {\r\n                e.wheelX = 0;\r\n                e.wheelY = (e.detail || 0) * 5;\r\n            }\r\n            callback(e);\r\n        });\r\n    }\r\n};\r\n\r\nexports.addMultiMouseDownListener = function(elements, timeouts, eventHandler, callbackName) {\r\n    var clicks = 0;\r\n    var startX, startY, timer; \r\n    var eventNames = {\r\n        2: \"dblclick\",\r\n        3: \"tripleclick\",\r\n        4: \"quadclick\"\r\n    };\r\n\r\n    function onMousedown(e) {\r\n        if (exports.getButton(e) !== 0) {\r\n            clicks = 0;\r\n        } else if (e.detail > 1) {\r\n            clicks++;\r\n            if (clicks > 4)\r\n                clicks = 1;\r\n        } else {\r\n            clicks = 1;\r\n        }\r\n        if (useragent.isIE) {\r\n            var isNewClick = Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5;\r\n            if (!timer || isNewClick)\r\n                clicks = 1;\r\n            if (timer)\r\n                clearTimeout(timer);\r\n            timer = setTimeout(function() {timer = null;}, timeouts[clicks - 1] || 600);\r\n\r\n            if (clicks == 1) {\r\n                startX = e.clientX;\r\n                startY = e.clientY;\r\n            }\r\n        }\r\n        \r\n        e._clicks = clicks;\r\n\r\n        eventHandler[callbackName](\"mousedown\", e);\r\n\r\n        if (clicks > 4)\r\n            clicks = 0;\r\n        else if (clicks > 1)\r\n            return eventHandler[callbackName](eventNames[clicks], e);\r\n    }\r\n    function onDblclick(e) {\r\n        clicks = 2;\r\n        if (timer)\r\n            clearTimeout(timer);\r\n        timer = setTimeout(function() {timer = null;}, timeouts[clicks - 1] || 600);\r\n        eventHandler[callbackName](\"mousedown\", e);\r\n        eventHandler[callbackName](eventNames[clicks], e);\r\n    }\r\n    if (!Array.isArray(elements))\r\n        elements = [elements];\r\n    elements.forEach(function(el) {\r\n        exports.addListener(el, \"mousedown\", onMousedown);\r\n        if (useragent.isOldIE)\r\n            exports.addListener(el, \"dblclick\", onDblclick);\r\n    });\r\n};\r\n\r\nvar getModifierHash = useragent.isMac && useragent.isOpera && !(\"KeyboardEvent\" in window)\r\n    ? function(e) {\r\n        return 0 | (e.metaKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.ctrlKey ? 8 : 0);\r\n    }\r\n    : function(e) {\r\n        return 0 | (e.ctrlKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.metaKey ? 8 : 0);\r\n    };\r\n\r\nexports.getModifierString = function(e) {\r\n    return keys.KEY_MODS[getModifierHash(e)];\r\n};\r\n\r\nfunction normalizeCommandKeys(callback, e, keyCode) {\r\n    var hashId = getModifierHash(e);\r\n\r\n    if (!useragent.isMac && pressedKeys) {\r\n        if (e.getModifierState && (e.getModifierState(\"OS\") || e.getModifierState(\"Win\")))\r\n            hashId |= 8;\r\n        if (pressedKeys.altGr) {\r\n            if ((3 & hashId) != 3)\r\n                pressedKeys.altGr = 0;\r\n            else\r\n                return;\r\n        }\r\n        if (keyCode === 18 || keyCode === 17) {\r\n            var location = \"location\" in e ? e.location : e.keyLocation;\r\n            if (keyCode === 17 && location === 1) {\r\n                if (pressedKeys[keyCode] == 1)\r\n                    ts = e.timeStamp;\r\n            } else if (keyCode === 18 && hashId === 3 && location === 2) {\r\n                var dt = e.timeStamp - ts;\r\n                if (dt < 50)\r\n                    pressedKeys.altGr = true;\r\n            }\r\n        }\r\n    }\r\n    \r\n    if (keyCode in keys.MODIFIER_KEYS) {\r\n        keyCode = -1;\r\n    }\r\n\r\n    // keyCode of right command is 93 on mac and 92 on windows.\r\n    // keyCode of left command key is 91\r\n    if (hashId & 8 && (keyCode >= 91 && keyCode <= 93)) {\r\n        keyCode = -1;\r\n    }\r\n    \r\n    if (!hashId && keyCode === 13) {\r\n        var location = \"location\" in e ? e.location : e.keyLocation;\r\n        if (location === 3) {\r\n            callback(e, hashId, -keyCode);\r\n            if (e.defaultPrevented)\r\n                return;\r\n        }\r\n    }\r\n    \r\n    if (useragent.isChromeOS && hashId & 8) {\r\n        callback(e, hashId, keyCode);\r\n        if (e.defaultPrevented)\r\n            return;\r\n        else\r\n            hashId &= ~8;\r\n    }\r\n\r\n    // If there is no hashId and the keyCode is not a function key, then\r\n    // we don't call the callback as we don't handle a command key here\r\n    // (it's a normal key/character input).\r\n    if (!hashId && !(keyCode in keys.FUNCTION_KEYS) && !(keyCode in keys.PRINTABLE_KEYS)) {\r\n        return false;\r\n    }\r\n    \r\n    return callback(e, hashId, keyCode);\r\n}\r\n\r\n\r\nexports.addCommandKeyListener = function(el, callback) {\r\n    var addListener = exports.addListener;\r\n    if (useragent.isOldGecko || (useragent.isOpera && !(\"KeyboardEvent\" in window))) {\r\n        // Old versions of Gecko aka. Firefox < 4.0 didn't repeat the keydown\r\n        // event if the user pressed the key for a longer time. Instead, the\r\n        // keydown event was fired once and later on only the keypress event.\r\n        // To emulate the 'right' keydown behavior, the keyCode of the initial\r\n        // keyDown event is stored and in the following keypress events the\r\n        // stores keyCode is used to emulate a keyDown event.\r\n        var lastKeyDownKeyCode = null;\r\n        addListener(el, \"keydown\", function(e) {\r\n            lastKeyDownKeyCode = e.keyCode;\r\n        });\r\n        addListener(el, \"keypress\", function(e) {\r\n            return normalizeCommandKeys(callback, e, lastKeyDownKeyCode);\r\n        });\r\n    } else {\r\n        var lastDefaultPrevented = null;\r\n\r\n        addListener(el, \"keydown\", function(e) {\r\n            pressedKeys[e.keyCode] = (pressedKeys[e.keyCode] || 0) + 1;\r\n            var result = normalizeCommandKeys(callback, e, e.keyCode);\r\n            lastDefaultPrevented = e.defaultPrevented;\r\n            return result;\r\n        });\r\n\r\n        addListener(el, \"keypress\", function(e) {\r\n            if (lastDefaultPrevented && (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey)) {\r\n                exports.stopEvent(e);\r\n                lastDefaultPrevented = null;\r\n            }\r\n        });\r\n\r\n        addListener(el, \"keyup\", function(e) {\r\n            pressedKeys[e.keyCode] = null;\r\n        });\r\n\r\n        if (!pressedKeys) {\r\n            resetPressedKeys();\r\n            addListener(window, \"focus\", resetPressedKeys);\r\n        }\r\n    }\r\n};\r\nfunction resetPressedKeys() {\r\n    pressedKeys = Object.create(null);\r\n}\r\n\r\nif (typeof window == \"object\" && window.postMessage && !useragent.isOldIE) {\r\n    var postMessageId = 1;\r\n    exports.nextTick = function(callback, win) {\r\n        win = win || window;\r\n        var messageName = \"zero-timeout-message-\" + (postMessageId++);\r\n        \r\n        var listener = function(e) {\r\n            if (e.data == messageName) {\r\n                exports.stopPropagation(e);\r\n                exports.removeListener(win, \"message\", listener);\r\n                callback();\r\n            }\r\n        };\r\n        \r\n        exports.addListener(win, \"message\", listener);\r\n        win.postMessage(messageName, \"*\");\r\n    };\r\n}\r\n\r\nexports.$idleBlocked = false;\r\nexports.onIdle = function(cb, timeout) {\r\n    return setTimeout(function handler() {\r\n        if (!exports.$idleBlocked) {\r\n            cb();\r\n        } else {\r\n            setTimeout(handler, 100);\r\n        }\r\n    }, timeout);\r\n};\r\n\r\nexports.$idleBlockId = null;\r\nexports.blockIdle = function(delay) {\r\n    if (exports.$idleBlockId)\r\n        clearTimeout(exports.$idleBlockId);\r\n        \r\n    exports.$idleBlocked = true;\r\n    exports.$idleBlockId = setTimeout(function() {\r\n        exports.$idleBlocked = false;\r\n    }, delay || 100);\r\n};\r\n\r\nexports.nextFrame = typeof window == \"object\" && (window.requestAnimationFrame\r\n    || window.mozRequestAnimationFrame\r\n    || window.webkitRequestAnimationFrame\r\n    || window.msRequestAnimationFrame\r\n    || window.oRequestAnimationFrame);\r\n\r\nif (exports.nextFrame)\r\n    exports.nextFrame = exports.nextFrame.bind(window);\r\nelse\r\n    exports.nextFrame = function(callback) {\r\n        setTimeout(callback, 17);\r\n    };\r\n});\r\n"]}