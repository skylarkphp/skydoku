{"version":3,"sources":["mouse/dragdrop_handler.js"],"names":["define","require","exports","module","dom","event","useragent","AUTOSCROLL_DELAY","SCROLL_CURSOR_DELAY","SCROLL_CURSOR_HYSTERESIS","DragdropHandler","mouseHandler","editor","blankImage","createElement","src","isOpera","style","cssText","forEach","x","this","addEventListener","onMouseDown","bind","dragSelectionMarker","y","timerId","range","dragCursor","dragOperation","isInternal","autoScrollStartTime","cursorMovedTime","cursorPointOnCaretMoved","mouseTarget","container","counter","onDragInterval","prevCursor","cursor","now","Date","vMovement","row","hMovement","column","moveCursorToPosition","calcDistance","renderer","scrollCursorIntoView","screenToTextCoordinates","lineHeight","layerConfig","characterWidth","editorRect","scroller","getBoundingClientRect","offsets","left","right","top","bottom","nearestXOffset","Math","min","nearestYOffset","scrollCursor","vScroll","hScroll","autoScroll","addDragMarker","selection","toOrientedRange","session","addMarker","getSelectionStyle","clearSelection","isFocused","$cursorLayer","setBlinking","clearInterval","setInterval","addListener","document","onMouseMove","clearDragMarker","removeMarker","fromOrientedRange","getReadOnly","removeListener","onDragStart","e","cancelDrag","draggable","self","setTimeout","startSelect","captureMouse","preventDefault","getSelectionRange","dataTransfer","effectAllowed","appendChild","scrollTop","setDragImage","removeChild","clearData","setData","getTextRange","setState","onDragEnd","dropEffect","remove","unsetStyle","setCursorStyle","onDragEnter","canAccept","clientX","clientY","getDropEffect","onDragOver","onMouseMoveTimer","onDragLeave","onDrop","contains","start","end","moveText","dropData","getData","insert","focus","types","Array","prototype","some","call","type","copyAllowed","copyModifierState","isMac","altKey","ctrlKey","toLowerCase","indexOf","ax","ay","bx","by","sqrt","pow","dragWait","mousedownEvent","time","getDragDelay","startDrag","dragWaitEnd","getDocumentPosition","selectEnd","dragReadyEnd","setStyle","cursorStyle","isWin","onMouseDrag","target","isIE","state","dragDrop","$dragEnabled","inSelection","button","getButton","domEvent","detail","inMultiSelectMode","getAccelKey","getShiftKey","eventTarget","srcElement","unselectable","isWebKit","defaultPrevented"],"mappings":"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","file":"../../mouse/dragdrop_handler.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\"use strict\";\r\n\r\nvar dom = require(\"../lib/dom\");\r\nvar event = require(\"../lib/event\");\r\nvar useragent = require(\"../lib/useragent\");\r\n\r\nvar AUTOSCROLL_DELAY = 200;\r\nvar SCROLL_CURSOR_DELAY = 200;\r\nvar SCROLL_CURSOR_HYSTERESIS = 5;\r\n\r\nfunction DragdropHandler(mouseHandler) {\r\n\r\n    var editor = mouseHandler.editor;\r\n\r\n    var blankImage = dom.createElement(\"img\");\r\n    // Safari crashes without image data\r\n    blankImage.src = \"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\";\r\n    if (useragent.isOpera)\r\n        blankImage.style.cssText = \"width:1px;height:1px;position:fixed;top:0;left:0;z-index:2147483647;opacity:0;\";\r\n\r\n    var exports = [\"dragWait\", \"dragWaitEnd\", \"startDrag\", \"dragReadyEnd\", \"onMouseDrag\"];\r\n\r\n     exports.forEach(function(x) {\r\n         mouseHandler[x] = this[x];\r\n    }, this);\r\n    editor.addEventListener(\"mousedown\", this.onMouseDown.bind(mouseHandler));\r\n\r\n\r\n    var mouseTarget = editor.container;\r\n    var dragSelectionMarker, x, y;\r\n    var timerId, range;\r\n    var dragCursor, counter = 0;\r\n    var dragOperation;\r\n    var isInternal;\r\n    var autoScrollStartTime;\r\n    var cursorMovedTime;\r\n    var cursorPointOnCaretMoved;\r\n\r\n    this.onDragStart = function(e) {\r\n        // webkit workaround, see this.onMouseDown\r\n        if (this.cancelDrag || !mouseTarget.draggable) {\r\n            var self = this;\r\n            setTimeout(function(){\r\n                self.startSelect();\r\n                self.captureMouse(e);\r\n            }, 0);\r\n            return e.preventDefault();\r\n        }\r\n        range = editor.getSelectionRange();\r\n\r\n        var dataTransfer = e.dataTransfer;\r\n        dataTransfer.effectAllowed = editor.getReadOnly() ? \"copy\" : \"copyMove\";\r\n        if (useragent.isOpera) {\r\n            editor.container.appendChild(blankImage);\r\n            // force layout\r\n            blankImage.scrollTop = 0;\r\n        }\r\n        dataTransfer.setDragImage && dataTransfer.setDragImage(blankImage, 0, 0);\r\n        if (useragent.isOpera) {\r\n            editor.container.removeChild(blankImage);\r\n        }\r\n        // clear Opera garbage\r\n        dataTransfer.clearData();\r\n        dataTransfer.setData(\"Text\", editor.session.getTextRange());\r\n\r\n        isInternal = true;\r\n        this.setState(\"drag\");\r\n    };\r\n\r\n    this.onDragEnd = function(e) {\r\n        mouseTarget.draggable = false;\r\n        isInternal = false;\r\n        this.setState(null);\r\n        if (!editor.getReadOnly()) {\r\n            var dropEffect = e.dataTransfer.dropEffect;\r\n            if (!dragOperation && dropEffect == \"move\")\r\n                // text was dragged outside the editor\r\n                editor.session.remove(editor.getSelectionRange());\r\n            editor.renderer.$cursorLayer.setBlinking(true);\r\n        }\r\n        this.editor.unsetStyle(\"ace_dragging\");\r\n        this.editor.renderer.setCursorStyle(\"\");\r\n    };\r\n\r\n    this.onDragEnter = function(e) {\r\n        if (editor.getReadOnly() || !canAccept(e.dataTransfer))\r\n            return;\r\n        x = e.clientX;\r\n        y = e.clientY;\r\n        if (!dragSelectionMarker)\r\n            addDragMarker();\r\n        counter++;\r\n        // dataTransfer object does not save dropEffect across events on IE, so we store it in dragOperation\r\n        e.dataTransfer.dropEffect = dragOperation = getDropEffect(e);\r\n        return event.preventDefault(e);\r\n    };\r\n\r\n    this.onDragOver = function(e) {\r\n        if (editor.getReadOnly() || !canAccept(e.dataTransfer))\r\n            return;\r\n        x = e.clientX;\r\n        y = e.clientY;\r\n        // Opera doesn't trigger dragenter event on drag start\r\n        if (!dragSelectionMarker) {\r\n            addDragMarker();\r\n            counter++;\r\n        }\r\n        if (onMouseMoveTimer !== null)\r\n            onMouseMoveTimer = null;\r\n\r\n        e.dataTransfer.dropEffect = dragOperation = getDropEffect(e);\r\n        return event.preventDefault(e);\r\n    };\r\n\r\n    this.onDragLeave = function(e) {\r\n        counter--;\r\n        if (counter <= 0 && dragSelectionMarker) {\r\n            clearDragMarker();\r\n            dragOperation = null;\r\n            return event.preventDefault(e);\r\n        }\r\n    };\r\n\r\n    this.onDrop = function(e) {\r\n        if (!dragCursor)\r\n            return;\r\n        var dataTransfer = e.dataTransfer;\r\n        if (isInternal) {\r\n            switch (dragOperation) {\r\n                case \"move\":\r\n                    if (range.contains(dragCursor.row, dragCursor.column)) {\r\n                        // clear selection\r\n                        range = {\r\n                            start: dragCursor,\r\n                            end: dragCursor\r\n                        };\r\n                    } else {\r\n                        // move text\r\n                        range = editor.moveText(range, dragCursor);\r\n                    }\r\n                    break;\r\n                case \"copy\":\r\n                    // copy text\r\n                    range = editor.moveText(range, dragCursor, true);\r\n                    break;\r\n            }\r\n        } else {\r\n            var dropData = dataTransfer.getData('Text');\r\n            range = {\r\n                start: dragCursor,\r\n                end: editor.session.insert(dragCursor, dropData)\r\n            };\r\n            editor.focus();\r\n            dragOperation = null;\r\n        }\r\n        clearDragMarker();\r\n        return event.preventDefault(e);\r\n    };\r\n\r\n    event.addListener(mouseTarget, \"dragstart\", this.onDragStart.bind(mouseHandler));\r\n    event.addListener(mouseTarget, \"dragend\", this.onDragEnd.bind(mouseHandler));\r\n    event.addListener(mouseTarget, \"dragenter\", this.onDragEnter.bind(mouseHandler));\r\n    event.addListener(mouseTarget, \"dragover\", this.onDragOver.bind(mouseHandler));\r\n    event.addListener(mouseTarget, \"dragleave\", this.onDragLeave.bind(mouseHandler));\r\n    event.addListener(mouseTarget, \"drop\", this.onDrop.bind(mouseHandler));\r\n\r\n    function scrollCursorIntoView(cursor, prevCursor) {\r\n        var now = Date.now();\r\n        var vMovement = !prevCursor || cursor.row != prevCursor.row;\r\n        var hMovement = !prevCursor || cursor.column != prevCursor.column;\r\n        if (!cursorMovedTime || vMovement || hMovement) {\r\n            editor.moveCursorToPosition(cursor);\r\n            cursorMovedTime = now;\r\n            cursorPointOnCaretMoved = {x: x, y: y};\r\n        } else {\r\n            var distance = calcDistance(cursorPointOnCaretMoved.x, cursorPointOnCaretMoved.y, x, y);\r\n            if (distance > SCROLL_CURSOR_HYSTERESIS) {\r\n                cursorMovedTime = null;\r\n            } else if (now - cursorMovedTime >= SCROLL_CURSOR_DELAY) {\r\n                editor.renderer.scrollCursorIntoView();\r\n                cursorMovedTime = null;\r\n            }\r\n        }\r\n    }\r\n\r\n    function autoScroll(cursor, prevCursor) {\r\n        var now = Date.now();\r\n        var lineHeight = editor.renderer.layerConfig.lineHeight;\r\n        var characterWidth = editor.renderer.layerConfig.characterWidth;\r\n        var editorRect = editor.renderer.scroller.getBoundingClientRect();\r\n        var offsets = {\r\n           x: {\r\n               left: x - editorRect.left,\r\n               right: editorRect.right - x\r\n           },\r\n           y: {\r\n               top: y - editorRect.top,\r\n               bottom: editorRect.bottom - y\r\n           }\r\n        };\r\n        var nearestXOffset = Math.min(offsets.x.left, offsets.x.right);\r\n        var nearestYOffset = Math.min(offsets.y.top, offsets.y.bottom);\r\n        var scrollCursor = {row: cursor.row, column: cursor.column};\r\n        if (nearestXOffset / characterWidth <= 2) {\r\n            scrollCursor.column += (offsets.x.left < offsets.x.right ? -3 : +2);\r\n        }\r\n        if (nearestYOffset / lineHeight <= 1) {\r\n            scrollCursor.row += (offsets.y.top < offsets.y.bottom ? -1 : +1);\r\n        }\r\n        var vScroll = cursor.row != scrollCursor.row;\r\n        var hScroll = cursor.column != scrollCursor.column;\r\n        var vMovement = !prevCursor || cursor.row != prevCursor.row;\r\n        if (vScroll || (hScroll && !vMovement)) {\r\n            if (!autoScrollStartTime)\r\n                autoScrollStartTime = now;\r\n            else if (now - autoScrollStartTime >= AUTOSCROLL_DELAY)\r\n                editor.renderer.scrollCursorIntoView(scrollCursor);\r\n        } else {\r\n            autoScrollStartTime = null;\r\n        }\r\n    }\r\n\r\n    function onDragInterval() {\r\n        var prevCursor = dragCursor;\r\n        dragCursor = editor.renderer.screenToTextCoordinates(x, y);\r\n        scrollCursorIntoView(dragCursor, prevCursor);\r\n        autoScroll(dragCursor, prevCursor);\r\n    }\r\n\r\n    function addDragMarker() {\r\n        range = editor.selection.toOrientedRange();\r\n        dragSelectionMarker = editor.session.addMarker(range, \"ace_selection\", editor.getSelectionStyle());\r\n        editor.clearSelection();\r\n        if (editor.isFocused())\r\n            editor.renderer.$cursorLayer.setBlinking(false);\r\n        clearInterval(timerId);\r\n        onDragInterval();\r\n        timerId = setInterval(onDragInterval, 20);\r\n        counter = 0;\r\n        event.addListener(document, \"mousemove\", onMouseMove);\r\n    }\r\n\r\n    function clearDragMarker() {\r\n        clearInterval(timerId);\r\n        editor.session.removeMarker(dragSelectionMarker);\r\n        dragSelectionMarker = null;\r\n        editor.selection.fromOrientedRange(range);\r\n        if (editor.isFocused() && !isInternal)\r\n            editor.renderer.$cursorLayer.setBlinking(!editor.getReadOnly());\r\n        range = null;\r\n        dragCursor = null;\r\n        counter = 0;\r\n        autoScrollStartTime = null;\r\n        cursorMovedTime = null;\r\n        event.removeListener(document, \"mousemove\", onMouseMove);\r\n    }\r\n\r\n    // sometimes other code on the page can stop dragleave event leaving editor stuck in the drag state\r\n    var onMouseMoveTimer = null;\r\n    function onMouseMove() {\r\n        if (onMouseMoveTimer == null) {\r\n            onMouseMoveTimer = setTimeout(function() {\r\n                if (onMouseMoveTimer != null && dragSelectionMarker)\r\n                    clearDragMarker();\r\n            }, 20);\r\n        }\r\n    }\r\n\r\n    function canAccept(dataTransfer) {\r\n        var types = dataTransfer.types;\r\n        return !types || Array.prototype.some.call(types, function(type) {\r\n            return type == 'text/plain' || type == 'Text';\r\n        });\r\n    }\r\n\r\n    function getDropEffect(e) {\r\n        var copyAllowed = ['copy', 'copymove', 'all', 'uninitialized'];\r\n        var moveAllowed = ['move', 'copymove', 'linkmove', 'all', 'uninitialized'];\r\n\r\n        var copyModifierState = useragent.isMac ? e.altKey : e.ctrlKey;\r\n\r\n        // IE throws error while dragging from another app\r\n        var effectAllowed = \"uninitialized\";\r\n        try {\r\n            effectAllowed = e.dataTransfer.effectAllowed.toLowerCase();\r\n        } catch (e) {}\r\n        var dropEffect = \"none\";\r\n\r\n        if (copyModifierState && copyAllowed.indexOf(effectAllowed) >= 0)\r\n            dropEffect = \"copy\";\r\n        else if (moveAllowed.indexOf(effectAllowed) >= 0)\r\n            dropEffect = \"move\";\r\n        else if (copyAllowed.indexOf(effectAllowed) >= 0)\r\n            dropEffect = \"copy\";\r\n\r\n        return dropEffect;\r\n    }\r\n}\r\n\r\n(function() {\r\n\r\n    this.dragWait = function() {\r\n        var interval = Date.now() - this.mousedownEvent.time;\r\n        if (interval > this.editor.getDragDelay())\r\n            this.startDrag();\r\n    };\r\n\r\n    this.dragWaitEnd = function() {\r\n        var target = this.editor.container;\r\n        target.draggable = false;\r\n        this.startSelect(this.mousedownEvent.getDocumentPosition());\r\n        this.selectEnd();\r\n    };\r\n\r\n    this.dragReadyEnd = function(e) {\r\n        this.editor.renderer.$cursorLayer.setBlinking(!this.editor.getReadOnly());\r\n        this.editor.unsetStyle(\"ace_dragging\");\r\n        this.editor.renderer.setCursorStyle(\"\");\r\n        this.dragWaitEnd();\r\n    };\r\n\r\n    this.startDrag = function(){\r\n        this.cancelDrag = false;\r\n        var editor = this.editor;\r\n        var target = editor.container;\r\n        target.draggable = true;\r\n        editor.renderer.$cursorLayer.setBlinking(false);\r\n        editor.setStyle(\"ace_dragging\");\r\n        var cursorStyle = useragent.isWin ? \"default\" : \"move\";\r\n        editor.renderer.setCursorStyle(cursorStyle);\r\n        this.setState(\"dragReady\");\r\n    };\r\n\r\n    this.onMouseDrag = function(e) {\r\n        var target = this.editor.container;\r\n        if (useragent.isIE && this.state == \"dragReady\") {\r\n            // IE does not handle [draggable] attribute set after mousedown\r\n            var distance = calcDistance(this.mousedownEvent.x, this.mousedownEvent.y, this.x, this.y);\r\n            if (distance > 3)\r\n                target.dragDrop();\r\n        }\r\n        if (this.state === \"dragWait\") {\r\n            var distance = calcDistance(this.mousedownEvent.x, this.mousedownEvent.y, this.x, this.y);\r\n            if (distance > 0) {\r\n                target.draggable = false;\r\n                this.startSelect(this.mousedownEvent.getDocumentPosition());\r\n            }\r\n        }\r\n    };\r\n\r\n    this.onMouseDown = function(e) {\r\n        if (!this.$dragEnabled)\r\n            return;\r\n        this.mousedownEvent = e;\r\n        var editor = this.editor;\r\n\r\n        var inSelection = e.inSelection();\r\n        var button = e.getButton();\r\n        var clickCount = e.domEvent.detail || 1;\r\n        if (clickCount === 1 && button === 0 && inSelection) {\r\n            if (e.editor.inMultiSelectMode && (e.getAccelKey() || e.getShiftKey()))\r\n                return;\r\n            this.mousedownEvent.time = Date.now();\r\n            var eventTarget = e.domEvent.target || e.domEvent.srcElement;\r\n            if (\"unselectable\" in eventTarget)\r\n                eventTarget.unselectable = \"on\";\r\n            if (editor.getDragDelay()) {\r\n                // https://code.google.com/p/chromium/issues/detail?id=286700\r\n                if (useragent.isWebKit) {\r\n                    this.cancelDrag = true;\r\n                    var mouseTarget = editor.container;\r\n                    mouseTarget.draggable = true;\r\n                }\r\n                this.setState(\"dragWait\");\r\n            } else {\r\n                this.startDrag();\r\n            }\r\n            this.captureMouse(e, this.onMouseDrag.bind(this));\r\n            // TODO: a better way to prevent default handler without preventing browser default action\r\n            e.defaultPrevented = true;\r\n        }\r\n    };\r\n\r\n}).call(DragdropHandler.prototype);\r\n\r\n\r\nfunction calcDistance(ax, ay, bx, by) {\r\n    return Math.sqrt(Math.pow(bx - ax, 2) + Math.pow(by - ay, 2));\r\n}\r\n\r\nexports.DragdropHandler = DragdropHandler;\r\n\r\n});"]}