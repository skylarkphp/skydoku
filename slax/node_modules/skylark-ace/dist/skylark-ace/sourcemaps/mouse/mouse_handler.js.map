{"version":3,"sources":["mouse/mouse_handler.js"],"names":["define","require","exports","module","event","useragent","DefaultHandlers","DefaultGutterHandler","GutterHandler","MouseEvent","DragdropHandler","config","MouseHandler","editor","_self","this","focusEditor","e","document","hasFocus","isFocused","activeElement","textInput","getElement","window","focus","mouseTarget","renderer","getMouseEventTarget","addListener","onMouseEvent","bind","onMouseMove","addMultiMouseDownListener","scrollBarV","inner","scrollBarH","filter","Boolean","addMouseWheelListener","container","onMouseWheel","addTouchMoveListener","onTouchMove","gutterEl","$gutter","isIE","element","on","state","$dragDelay","$dragEnabled","character","screenToTextCoordinates","x","y","range","session","selection","getRange","isEmpty","insideStart","row","column","setCursorStyle","name","_emit","listeners","_eventRegistry","mousemove","length","mouseEvent","speed","$scrollSpeed","wheelX","wheelY","setState","captureMouse","ev","mouseMoveHandler","isMousePressed","$keepTextAreaAtCursor","self","isWebKit","which","releaseMouse","clientX","clientY","$mouseMoved","onCaptureEnd","off","onOperationEnd","clearInterval","timerId","onCaptureInterval","$moveTextAreaToCursor","$onCaptureMouseMove","endOperation","isOldIE","domEvent","type","setTimeout","curOp","command","selectionChanged","startOperation","capture","setInterval","cancelContextMenu","stop","stopEvent","call","prototype","defineOptions","scrollSpeed","initialValue","dragDelay","isMac","dragEnabled","focusTimeout","tooltipFollowsMouse"],"mappings":"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","file":"../../mouse/mouse_handler.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\"use strict\";\r\n\r\nvar event = require(\"../lib/event\");\r\nvar useragent = require(\"../lib/useragent\");\r\nvar DefaultHandlers = require(\"./default_handlers\").DefaultHandlers;\r\nvar DefaultGutterHandler = require(\"./default_gutter_handler\").GutterHandler;\r\nvar MouseEvent = require(\"./mouse_event\").MouseEvent;\r\nvar DragdropHandler = require(\"./dragdrop_handler\").DragdropHandler;\r\nvar config = require(\"../config\");\r\n\r\nvar MouseHandler = function(editor) {\r\n    var _self = this;\r\n    this.editor = editor;\r\n\r\n    new DefaultHandlers(this);\r\n    new DefaultGutterHandler(this);\r\n    new DragdropHandler(this);\r\n\r\n    var focusEditor = function(e) {\r\n        // because we have to call event.preventDefault() any window on ie and iframes\r\n        // on other browsers do not get focus, so we have to call window.focus() here\r\n        var windowBlurred = !document.hasFocus || !document.hasFocus()\r\n            || !editor.isFocused() && document.activeElement == (editor.textInput && editor.textInput.getElement());\r\n        if (windowBlurred)\r\n            window.focus();\r\n        editor.focus();\r\n    };\r\n\r\n    var mouseTarget = editor.renderer.getMouseEventTarget();\r\n    event.addListener(mouseTarget, \"click\", this.onMouseEvent.bind(this, \"click\"));\r\n    event.addListener(mouseTarget, \"mousemove\", this.onMouseMove.bind(this, \"mousemove\"));\r\n    event.addMultiMouseDownListener([\r\n        mouseTarget,\r\n        editor.renderer.scrollBarV && editor.renderer.scrollBarV.inner,\r\n        editor.renderer.scrollBarH && editor.renderer.scrollBarH.inner,\r\n        editor.textInput && editor.textInput.getElement()\r\n    ].filter(Boolean), [400, 300, 250], this, \"onMouseEvent\");\r\n    event.addMouseWheelListener(editor.container, this.onMouseWheel.bind(this, \"mousewheel\"));\r\n    event.addTouchMoveListener(editor.container, this.onTouchMove.bind(this, \"touchmove\"));\r\n\r\n    var gutterEl = editor.renderer.$gutter;\r\n    event.addListener(gutterEl, \"mousedown\", this.onMouseEvent.bind(this, \"guttermousedown\"));\r\n    event.addListener(gutterEl, \"click\", this.onMouseEvent.bind(this, \"gutterclick\"));\r\n    event.addListener(gutterEl, \"dblclick\", this.onMouseEvent.bind(this, \"gutterdblclick\"));\r\n    event.addListener(gutterEl, \"mousemove\", this.onMouseEvent.bind(this, \"guttermousemove\"));\r\n\r\n    event.addListener(mouseTarget, \"mousedown\", focusEditor);\r\n    event.addListener(gutterEl, \"mousedown\", focusEditor);\r\n    if (useragent.isIE && editor.renderer.scrollBarV) {\r\n        event.addListener(editor.renderer.scrollBarV.element, \"mousedown\", focusEditor);\r\n        event.addListener(editor.renderer.scrollBarH.element, \"mousedown\", focusEditor);\r\n    }\r\n\r\n    editor.on(\"mousemove\", function(e){\r\n        if (_self.state || _self.$dragDelay || !_self.$dragEnabled)\r\n            return;\r\n\r\n        var character = editor.renderer.screenToTextCoordinates(e.x, e.y);\r\n        var range = editor.session.selection.getRange();\r\n        var renderer = editor.renderer;\r\n\r\n        if (!range.isEmpty() && range.insideStart(character.row, character.column)) {\r\n            renderer.setCursorStyle(\"default\");\r\n        } else {\r\n            renderer.setCursorStyle(\"\");\r\n        }\r\n    });\r\n};\r\n\r\n(function() {\r\n    this.onMouseEvent = function(name, e) {\r\n        this.editor._emit(name, new MouseEvent(e, this.editor));\r\n    };\r\n\r\n    this.onMouseMove = function(name, e) {\r\n        // optimization, because mousemove doesn't have a default handler.\r\n        var listeners = this.editor._eventRegistry && this.editor._eventRegistry.mousemove;\r\n        if (!listeners || !listeners.length)\r\n            return;\r\n\r\n        this.editor._emit(name, new MouseEvent(e, this.editor));\r\n    };\r\n\r\n    this.onMouseWheel = function(name, e) {\r\n        var mouseEvent = new MouseEvent(e, this.editor);\r\n        mouseEvent.speed = this.$scrollSpeed * 2;\r\n        mouseEvent.wheelX = e.wheelX;\r\n        mouseEvent.wheelY = e.wheelY;\r\n\r\n        this.editor._emit(name, mouseEvent);\r\n    };\r\n    \r\n    this.onTouchMove = function (name, e) {\r\n        var mouseEvent = new MouseEvent(e, this.editor);\r\n        mouseEvent.speed = 1;//this.$scrollSpeed * 2;\r\n        mouseEvent.wheelX = e.wheelX;\r\n        mouseEvent.wheelY = e.wheelY;\r\n        this.editor._emit(name, mouseEvent);\r\n    };\r\n\r\n    this.setState = function(state) {\r\n        this.state = state;\r\n    };\r\n\r\n    this.captureMouse = function(ev, mouseMoveHandler) {\r\n        this.x = ev.x;\r\n        this.y = ev.y;\r\n\r\n        this.isMousePressed = true;\r\n\r\n        // do not move textarea during selection\r\n        var editor = this.editor;\r\n        var renderer = this.editor.renderer;\r\n        if (renderer.$keepTextAreaAtCursor)\r\n            renderer.$keepTextAreaAtCursor = null;\r\n\r\n        var self = this;\r\n        var onMouseMove = function(e) {\r\n            if (!e) return;\r\n            // if editor is loaded inside iframe, and mouseup event is outside\r\n            // we won't recieve it, so we cancel on first mousemove without button\r\n            if (useragent.isWebKit && !e.which && self.releaseMouse)\r\n                return self.releaseMouse();\r\n\r\n            self.x = e.clientX;\r\n            self.y = e.clientY;\r\n            mouseMoveHandler && mouseMoveHandler(e);\r\n            self.mouseEvent = new MouseEvent(e, self.editor);\r\n            self.$mouseMoved = true;\r\n        };\r\n\r\n        var onCaptureEnd = function(e) {\r\n            editor.off(\"beforeEndOperation\", onOperationEnd);\r\n            clearInterval(timerId);\r\n            onCaptureInterval();\r\n            self[self.state + \"End\"] && self[self.state + \"End\"](e);\r\n            self.state = \"\";\r\n            if (renderer.$keepTextAreaAtCursor == null) {\r\n                renderer.$keepTextAreaAtCursor = true;\r\n                renderer.$moveTextAreaToCursor();\r\n            }\r\n            self.isMousePressed = false;\r\n            self.$onCaptureMouseMove = self.releaseMouse = null;\r\n            e && self.onMouseEvent(\"mouseup\", e);\r\n            editor.endOperation();\r\n        };\r\n\r\n        var onCaptureInterval = function() {\r\n            self[self.state] && self[self.state]();\r\n            self.$mouseMoved = false;\r\n        };\r\n\r\n        if (useragent.isOldIE && ev.domEvent.type == \"dblclick\") {\r\n            return setTimeout(function() {onCaptureEnd(ev);});\r\n        }\r\n\r\n        var onOperationEnd = function(e) {\r\n            if (!self.releaseMouse) return;\r\n            // some touchpads fire mouseup event after a slight delay, \r\n            // which can cause problems if user presses a keyboard shortcut quickly\r\n            if (editor.curOp.command.name && editor.curOp.selectionChanged) {\r\n                self[self.state + \"End\"] && self[self.state + \"End\"]();\r\n                self.state = \"\";\r\n                self.releaseMouse();\r\n            }\r\n        };\r\n\r\n        editor.on(\"beforeEndOperation\", onOperationEnd);\r\n        editor.startOperation({command: {name: \"mouse\"}});\r\n\r\n        self.$onCaptureMouseMove = onMouseMove;\r\n        self.releaseMouse = event.capture(this.editor.container, onMouseMove, onCaptureEnd);\r\n        var timerId = setInterval(onCaptureInterval, 20);\r\n    };\r\n    this.releaseMouse = null;\r\n    this.cancelContextMenu = function() {\r\n        var stop = function(e) {\r\n            if (e && e.domEvent && e.domEvent.type != \"contextmenu\")\r\n                return;\r\n            this.editor.off(\"nativecontextmenu\", stop);\r\n            if (e && e.domEvent)\r\n                event.stopEvent(e.domEvent);\r\n        }.bind(this);\r\n        setTimeout(stop, 10);\r\n        this.editor.on(\"nativecontextmenu\", stop);\r\n    };\r\n}).call(MouseHandler.prototype);\r\n\r\nconfig.defineOptions(MouseHandler.prototype, \"mouseHandler\", {\r\n    scrollSpeed: {initialValue: 2},\r\n    dragDelay: {initialValue: (useragent.isMac ? 150 : 0)},\r\n    dragEnabled: {initialValue: true},\r\n    focusTimeout: {initialValue: 0},\r\n    tooltipFollowsMouse: {initialValue: true}\r\n});\r\n\r\n\r\nexports.MouseHandler = MouseHandler;\r\n});\r\n"]}