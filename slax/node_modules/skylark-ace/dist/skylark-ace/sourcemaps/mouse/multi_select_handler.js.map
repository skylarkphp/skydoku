{"version":3,"sources":["mouse/multi_select_handler.js"],"names":["define","require","exports","module","event","useragent","isSamePoint","p1","p2","row","column","onMouseDown","e","ev","domEvent","alt","altKey","shift","shiftKey","ctrl","ctrlKey","accel","getAccelKey","button","getButton","isMac","editor","inMultiSelectMode","textInput","onContextMenu","selectionMode","selection","isMultiSelect","pos","getDocumentPosition","cursor","getCursor","inSelection","isEmpty","mouseX","x","mouseY","y","session","screenAnchor","renderer","pixelToScreenCoordinates","screenCursor","$mouseHandler","$enableJumpToDef","$blockSelectEnabled","cancelContextMenu","range","toOrientedRange","addSelectionMarker","oldRange","rangeList","rangeAtPoint","inVirtualSelectionMode","ranges","removeSelectionMarker","once","tmpSel","substractPoint","addRange","initialRange","stop","rectSel","blockSelect","newCursor","screenToDocumentPosition","offsetX","lead","moveToPosition","scrollCursorIntoView","removeSelectionMarkers","rectangularRangeBlock","$clickSelection","length","clone","forEach","updateSelectionMarkers","toSingleRange","documentToScreenPosition","onSelectionInterval","capture","container","clientX","clientY","clearInterval","timerId","i","setInterval","preventDefault","exitMultiSelectMode"],"mappings":"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","file":"../../mouse/multi_select_handler.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n * \r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n * \r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\r\nvar event = require(\"../lib/event\");\r\nvar useragent = require(\"../lib/useragent\");\r\n\r\n// mouse\r\nfunction isSamePoint(p1, p2) {\r\n    return p1.row == p2.row && p1.column == p2.column;\r\n}\r\n\r\nfunction onMouseDown(e) {\r\n    var ev = e.domEvent;\r\n    var alt = ev.altKey;\r\n    var shift = ev.shiftKey;\r\n    var ctrl = ev.ctrlKey;\r\n    var accel = e.getAccelKey();\r\n    var button = e.getButton();\r\n    \r\n    if (ctrl && useragent.isMac)\r\n        button = ev.button;\r\n\r\n    if (e.editor.inMultiSelectMode && button == 2) {\r\n        e.editor.textInput.onContextMenu(e.domEvent);\r\n        return;\r\n    }\r\n    \r\n    if (!ctrl && !alt && !accel) {\r\n        if (button === 0 && e.editor.inMultiSelectMode)\r\n            e.editor.exitMultiSelectMode();\r\n        return;\r\n    }\r\n    \r\n    if (button !== 0)\r\n        return;\r\n\r\n    var editor = e.editor;\r\n    var selection = editor.selection;\r\n    var isMultiSelect = editor.inMultiSelectMode;\r\n    var pos = e.getDocumentPosition();\r\n    var cursor = selection.getCursor();\r\n    var inSelection = e.inSelection() || (selection.isEmpty() && isSamePoint(pos, cursor));\r\n\r\n    var mouseX = e.x, mouseY = e.y;\r\n    var onMouseSelection = function(e) {\r\n        mouseX = e.clientX;\r\n        mouseY = e.clientY;\r\n    };\r\n    \r\n    var session = editor.session;\r\n    var screenAnchor = editor.renderer.pixelToScreenCoordinates(mouseX, mouseY);\r\n    var screenCursor = screenAnchor;\r\n    \r\n    var selectionMode;\r\n    if (editor.$mouseHandler.$enableJumpToDef) {\r\n        if (ctrl && alt || accel && alt)\r\n            selectionMode = shift ? \"block\" : \"add\";\r\n        else if (alt && editor.$blockSelectEnabled)\r\n            selectionMode = \"block\";\r\n    } else {\r\n        if (accel && !alt) {\r\n            selectionMode = \"add\";\r\n            if (!isMultiSelect && shift)\r\n                return;\r\n        } else if (alt && editor.$blockSelectEnabled) {\r\n            selectionMode = \"block\";\r\n        }\r\n    }\r\n    \r\n    if (selectionMode && useragent.isMac && ev.ctrlKey) {\r\n        editor.$mouseHandler.cancelContextMenu();\r\n    }\r\n\r\n    if (selectionMode == \"add\") {\r\n        if (!isMultiSelect && inSelection)\r\n            return; // dragging\r\n\r\n        if (!isMultiSelect) {\r\n            var range = selection.toOrientedRange();\r\n            editor.addSelectionMarker(range);\r\n        }\r\n\r\n        var oldRange = selection.rangeList.rangeAtPoint(pos);\r\n        \r\n        editor.inVirtualSelectionMode = true;\r\n        \r\n        if (shift) {\r\n            oldRange = null;\r\n            range = selection.ranges[0] || range;\r\n            editor.removeSelectionMarker(range);\r\n        }\r\n        editor.once(\"mouseup\", function() {\r\n            var tmpSel = selection.toOrientedRange();\r\n\r\n            if (oldRange && tmpSel.isEmpty() && isSamePoint(oldRange.cursor, tmpSel.cursor))\r\n                selection.substractPoint(tmpSel.cursor);\r\n            else {\r\n                if (shift) {\r\n                    selection.substractPoint(range.cursor);\r\n                } else if (range) {\r\n                    editor.removeSelectionMarker(range);\r\n                    selection.addRange(range);\r\n                }\r\n                selection.addRange(tmpSel);\r\n            }\r\n            editor.inVirtualSelectionMode = false;\r\n        });\r\n\r\n    } else if (selectionMode == \"block\") {\r\n        e.stop();\r\n        editor.inVirtualSelectionMode = true;        \r\n        var initialRange;\r\n        var rectSel = [];\r\n        var blockSelect = function() {\r\n            var newCursor = editor.renderer.pixelToScreenCoordinates(mouseX, mouseY);\r\n            var cursor = session.screenToDocumentPosition(newCursor.row, newCursor.column, newCursor.offsetX);\r\n\r\n            if (isSamePoint(screenCursor, newCursor) && isSamePoint(cursor, selection.lead))\r\n                return;\r\n            screenCursor = newCursor;\r\n            \r\n            editor.selection.moveToPosition(cursor);\r\n            editor.renderer.scrollCursorIntoView();\r\n\r\n            editor.removeSelectionMarkers(rectSel);\r\n            rectSel = selection.rectangularRangeBlock(screenCursor, screenAnchor);\r\n            if (editor.$mouseHandler.$clickSelection && rectSel.length == 1 && rectSel[0].isEmpty())\r\n                rectSel[0] = editor.$mouseHandler.$clickSelection.clone();\r\n            rectSel.forEach(editor.addSelectionMarker, editor);\r\n            editor.updateSelectionMarkers();\r\n        };\r\n        if (isMultiSelect && !accel) {\r\n            selection.toSingleRange();\r\n        } else if (!isMultiSelect && accel) {\r\n            initialRange = selection.toOrientedRange();\r\n            editor.addSelectionMarker(initialRange);\r\n        }\r\n        \r\n        if (shift)\r\n            screenAnchor = session.documentToScreenPosition(selection.lead);            \r\n        else\r\n            selection.moveToPosition(pos);\r\n        \r\n        screenCursor = {row: -1, column: -1};\r\n\r\n        var onMouseSelectionEnd = function(e) {\r\n            blockSelect();\r\n            clearInterval(timerId);\r\n            editor.removeSelectionMarkers(rectSel);\r\n            if (!rectSel.length)\r\n                rectSel = [selection.toOrientedRange()];\r\n            if (initialRange) {\r\n                editor.removeSelectionMarker(initialRange);\r\n                selection.toSingleRange(initialRange);\r\n            }\r\n            for (var i = 0; i < rectSel.length; i++)\r\n                selection.addRange(rectSel[i]);\r\n            editor.inVirtualSelectionMode = false;\r\n            editor.$mouseHandler.$clickSelection = null;\r\n        };\r\n\r\n        var onSelectionInterval = blockSelect;\r\n\r\n        event.capture(editor.container, onMouseSelection, onMouseSelectionEnd);\r\n        var timerId = setInterval(function() {onSelectionInterval();}, 20);\r\n\r\n        return e.preventDefault();\r\n    }\r\n}\r\n\r\n\r\nexports.onMouseDown = onMouseDown;\r\n\r\n});\r\n"]}