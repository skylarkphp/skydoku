{"version":3,"sources":["worker/worker_client.js"],"names":["define","require","exports","module","oop","net","EventEmitter","config","createWorker","workerUrl","Worker","postMessage","terminate","get","blob","script","qualifyURL","Blob","type","e","blobBuilder","window","BlobBuilder","WebKitBlobBuilder","MozBlobBuilder","append","getBlob","$workerBlob","blobURL","URL","webkitURL","createObjectURL","WorkerClient","worker","this","$createWorkerFromOldConfig","apply","arguments","$worker","$sendDeltaQueue","bind","changeListener","onMessage","callbackId","callbacks","onmessage","implement","topLevelNamespaces","mod","classname","importScripts","nameToUrl","toUrl","moduleUrl","normalizePath","$normalizePath","tlns","forEach","ns","replace","send","init","msg","data","_signal","name","callback","id","reportError","console","log","err","error","path","deltaQueue","$doc","off","cmd","args","command","call","push","emit","event","message","stack","code","ex","attachToDocument","doc","getValue","on","delta","setTimeout","action","start","lines","end","q","length","getLength","prototype","UIWorkerClient","main","emitSync","sender","Object","create","messageBuffer","workerClient","processNext","setEmitSync","val","shift","loadModule","Main"],"mappings":"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","file":"../../worker/worker_client.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\"use strict\";\r\n\r\nvar oop = require(\"../lib/oop\");\r\nvar net = require(\"../lib/net\");\r\nvar EventEmitter = require(\"../lib/event_emitter\").EventEmitter;\r\nvar config = require(\"../config\");\r\n\r\nfunction $workerBlob(workerUrl) {\r\n    // workerUrl can be protocol relative\r\n    // importScripts only takes fully qualified urls\r\n    var script = \"importScripts('\" + net.qualifyURL(workerUrl) + \"');\";\r\n    try {\r\n        return new Blob([script], {\"type\": \"application/javascript\"});\r\n    } catch (e) { // Backwards-compatibility\r\n        var BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder;\r\n        var blobBuilder = new BlobBuilder();\r\n        blobBuilder.append(script);\r\n        return blobBuilder.getBlob(\"application/javascript\");\r\n    }\r\n}\r\n\r\nfunction createWorker(workerUrl) {\r\n    if (typeof Worker == \"undefined\")\r\n        return { postMessage: function() {}, terminate: function() {} };\r\n    if (config.get(\"loadWorkerFromBlob\")) {\r\n        var blob = $workerBlob(workerUrl);\r\n        var URL = window.URL || window.webkitURL;\r\n        var blobURL = URL.createObjectURL(blob);\r\n        // calling URL.revokeObjectURL before worker is terminated breaks it on IE Edge\r\n        return new Worker(blobURL);\r\n    }\r\n    return new Worker(workerUrl);\r\n}\r\n\r\nvar WorkerClient = function(worker) {\r\n    if (!worker.postMessage)\r\n        worker = this.$createWorkerFromOldConfig.apply(this, arguments);\r\n\r\n    this.$worker = worker;\r\n    this.$sendDeltaQueue = this.$sendDeltaQueue.bind(this);\r\n    this.changeListener = this.changeListener.bind(this);\r\n    this.onMessage = this.onMessage.bind(this);\r\n\r\n    this.callbackId = 1;\r\n    this.callbacks = {};\r\n\r\n    this.$worker.onmessage = this.onMessage;\r\n};\r\n\r\n(function(){\r\n\r\n    oop.implement(this, EventEmitter);\r\n\r\n    this.$createWorkerFromOldConfig = function(topLevelNamespaces, mod, classname, workerUrl, importScripts) {\r\n        // nameToUrl is renamed to toUrl in requirejs 2\r\n        if (require.nameToUrl && !require.toUrl)\r\n            require.toUrl = require.nameToUrl;\r\n\r\n        if (config.get(\"packaged\") || !require.toUrl) {\r\n            workerUrl = workerUrl || config.moduleUrl(mod, \"worker\");\r\n        } else {\r\n            var normalizePath = this.$normalizePath;\r\n            workerUrl = workerUrl || normalizePath(require.toUrl(\"ace/worker/worker.js\", null, \"_\"));\r\n\r\n            var tlns = {};\r\n            topLevelNamespaces.forEach(function(ns) {\r\n                tlns[ns] = normalizePath(require.toUrl(ns, null, \"_\").replace(/(\\.js)?(\\?.*)?$/, \"\"));\r\n            });\r\n        }\r\n\r\n        this.$worker = createWorker(workerUrl);\r\n        if (importScripts) {\r\n            this.send(\"importScripts\", importScripts);\r\n        }\r\n        this.$worker.postMessage({\r\n            init : true,\r\n            tlns : tlns,\r\n            module : mod,\r\n            classname : classname\r\n        });\r\n        return this.$worker;\r\n    };\r\n\r\n    this.onMessage = function(e) {\r\n        var msg = e.data;\r\n        switch (msg.type) {\r\n            case \"event\":\r\n                this._signal(msg.name, {data: msg.data});\r\n                break;\r\n            case \"call\":\r\n                var callback = this.callbacks[msg.id];\r\n                if (callback) {\r\n                    callback(msg.data);\r\n                    delete this.callbacks[msg.id];\r\n                }\r\n                break;\r\n            case \"error\":\r\n                this.reportError(msg.data);\r\n                break;\r\n            case \"log\":\r\n                window.console && console.log && console.log.apply(console, msg.data);\r\n                break;\r\n        }\r\n    };\r\n    \r\n    this.reportError = function(err) {\r\n        window.console && console.error && console.error(err);\r\n    };\r\n\r\n    this.$normalizePath = function(path) {\r\n        return net.qualifyURL(path);\r\n    };\r\n\r\n    this.terminate = function() {\r\n        this._signal(\"terminate\", {});\r\n        this.deltaQueue = null;\r\n        this.$worker.terminate();\r\n        this.$worker = null;\r\n        if (this.$doc)\r\n            this.$doc.off(\"change\", this.changeListener);\r\n        this.$doc = null;\r\n    };\r\n\r\n    this.send = function(cmd, args) {\r\n        this.$worker.postMessage({command: cmd, args: args});\r\n    };\r\n\r\n    this.call = function(cmd, args, callback) {\r\n        if (callback) {\r\n            var id = this.callbackId++;\r\n            this.callbacks[id] = callback;\r\n            args.push(id);\r\n        }\r\n        this.send(cmd, args);\r\n    };\r\n\r\n    this.emit = function(event, data) {\r\n        try {\r\n            // firefox refuses to clone objects which have function properties\r\n            // TODO: cleanup event\r\n            if (data.data && data.data.err)\r\n                data.data.err = {message: data.data.err.message, stack: data.data.err.stack, code: data.data.err.code};\r\n            this.$worker.postMessage({event: event, data: {data: data.data}});\r\n        }\r\n        catch(ex) {\r\n            console.error(ex.stack);\r\n        }\r\n    };\r\n\r\n    this.attachToDocument = function(doc) {\r\n        if (this.$doc)\r\n            this.terminate();\r\n\r\n        this.$doc = doc;\r\n        this.call(\"setValue\", [doc.getValue()]);\r\n        doc.on(\"change\", this.changeListener);\r\n    };\r\n\r\n    this.changeListener = function(delta) {\r\n        if (!this.deltaQueue) {\r\n            this.deltaQueue = [];\r\n            setTimeout(this.$sendDeltaQueue, 0);\r\n        }\r\n        if (delta.action == \"insert\")\r\n            this.deltaQueue.push(delta.start, delta.lines);\r\n        else\r\n            this.deltaQueue.push(delta.start, delta.end);\r\n    };\r\n\r\n    this.$sendDeltaQueue = function() {\r\n        var q = this.deltaQueue;\r\n        if (!q) return;\r\n        this.deltaQueue = null;\r\n        if (q.length > 50 && q.length > this.$doc.getLength() >> 1) {\r\n            this.call(\"setValue\", [this.$doc.getValue()]);\r\n        } else\r\n            this.emit(\"change\", {data: q});\r\n    };\r\n\r\n}).call(WorkerClient.prototype);\r\n\r\n\r\nvar UIWorkerClient = function(topLevelNamespaces, mod, classname) {\r\n    var main = null;\r\n    var emitSync = false;\r\n    var sender = Object.create(EventEmitter);\r\n\r\n    var messageBuffer = [];\r\n    var workerClient = new WorkerClient({\r\n        messageBuffer: messageBuffer,\r\n        terminate: function() {},\r\n        postMessage: function(e) {\r\n            messageBuffer.push(e);\r\n            if (!main) return;\r\n            if (emitSync)\r\n                setTimeout(processNext);\r\n            else\r\n                processNext();\r\n        }\r\n    });\r\n\r\n    workerClient.setEmitSync = function(val) { emitSync = val; };\r\n\r\n    var processNext = function() {\r\n        var msg = messageBuffer.shift();\r\n        if (msg.command)\r\n            main[msg.command].apply(main, msg.args);\r\n        else if (msg.event)\r\n            sender._signal(msg.event, msg.data);\r\n    };\r\n\r\n    sender.postMessage = function(msg) {\r\n        workerClient.onMessage({data: msg});\r\n    };\r\n    sender.callback = function(data, callbackId) {\r\n        this.postMessage({type: \"call\", id: callbackId, data: data});\r\n    };\r\n    sender.emit = function(name, data) {\r\n        this.postMessage({type: \"event\", name: name, data: data});\r\n    };\r\n\r\n    config.loadModule([\"worker\", mod], function(Main) {\r\n        main = new Main[classname](sender);\r\n        while (messageBuffer.length)\r\n            processNext();\r\n    });\r\n\r\n    return workerClient;\r\n};\r\n\r\nexports.UIWorkerClient = UIWorkerClient;\r\nexports.WorkerClient = WorkerClient;\r\nexports.createWorker = createWorker;\r\n\r\n\r\n});\r\n"]}