{"version":3,"sources":["incremental_search.js"],"names":["define","require","exports","module","oop","Range","Search","SearchHighlight","iSearchCommandModule","ISearchKbd","IncrementalSearchKeyboardHandler","IncrementalSearch","this","$options","wrap","skipCurrent","$keyboardHandler","isRegExp","obj","RegExp","regExpToObject","re","string","String","start","indexOf","flagStart","lastIndexOf","expression","slice","flags","stringToRegExp","e","objectToRegExp","inherits","activate","ed","backwards","$editor","$startPos","$currentPos","getCursorPosition","needle","keyBinding","addKeyboardHandler","$originalEditorOnPaste","onPaste","bind","$mousedownHandler","addEventListener","onMouseDown","selectionFix","statusMessage","deactivate","reset","cancelSearch","removeKeyboardHandler","removeEventListener","message","editor","selection","isEmpty","session","$emacsMark","clearSelection","highlight","regexp","sess","$isearchHighlight","addDynamicMarker","setRegexp","_emit","$prevNeedle","moveCursorToPosition","pushEmacsMark","fromPoints","highlightAndFindWithNeedle","moveToNext","needleUpdateFunc","options","call","length","found","find","shouldSelect","emacsMark","end","setRange","addString","s","reObj","removeChar","c","substring","next","useCurrentOrPrevSearch","evt","text","convertNeedleToRegExp","convertNeedleToString","msg","showCommandLine","focus","console","log","prototype","dom","importCssString","commands","setupIncrementalSearch","val","usesIncrementalSearch","iSearchCommands","iSearchStartCommands","CommandManager","Editor","defineOptions","useIncrementalSearch","set","$handlers","forEach","handler","isEnabled"],"mappings":"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","file":"../incremental_search.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\"use strict\";\r\n\r\nvar oop = require(\"./lib/oop\");\r\nvar Range = require(\"./range\").Range;\r\nvar Search = require(\"./search\").Search;\r\nvar SearchHighlight = require(\"./search_highlight\").SearchHighlight;\r\nvar iSearchCommandModule = require(\"./commands/incremental_search_commands\");\r\nvar ISearchKbd = iSearchCommandModule.IncrementalSearchKeyboardHandler;\r\n\r\n/**\r\n * @class IncrementalSearch\r\n *\r\n * Implements immediate searching while the user is typing. When incremental\r\n * search is activated, keystrokes into the editor will be used for composing\r\n * a search term. Immediately after every keystroke the search is updated:\r\n * - so-far-matching characters are highlighted\r\n * - the cursor is moved to the next match\r\n *\r\n **/\r\n\r\n\r\n/**\r\n *\r\n *\r\n * Creates a new `IncrementalSearch` object.\r\n *\r\n * @constructor\r\n **/\r\nfunction IncrementalSearch() {\r\n    this.$options = {wrap: false, skipCurrent: false};\r\n    this.$keyboardHandler = new ISearchKbd(this);\r\n}\r\n\r\noop.inherits(IncrementalSearch, Search);\r\n\r\n// regexp handling\r\n\r\nfunction isRegExp(obj) {\r\n    return obj instanceof RegExp;\r\n}\r\n\r\nfunction regExpToObject(re) {\r\n    var string = String(re),\r\n        start = string.indexOf('/'),\r\n        flagStart = string.lastIndexOf('/');\r\n    return {\r\n        expression: string.slice(start+1, flagStart),\r\n        flags: string.slice(flagStart+1)\r\n    };\r\n}\r\n\r\nfunction stringToRegExp(string, flags) {\r\n    try {\r\n        return new RegExp(string, flags);\r\n    } catch (e) { return string; }\r\n}\r\n\r\nfunction objectToRegExp(obj) {\r\n    return stringToRegExp(obj.expression, obj.flags);\r\n}\r\n\r\n// iSearch class\r\n\r\n(function() {\r\n\r\n    this.activate = function(ed, backwards) {\r\n        this.$editor = ed;\r\n        this.$startPos = this.$currentPos = ed.getCursorPosition();\r\n        this.$options.needle = '';\r\n        this.$options.backwards = backwards;\r\n        ed.keyBinding.addKeyboardHandler(this.$keyboardHandler);\r\n        // we need to completely intercept paste, just registering an event handler does not work\r\n        this.$originalEditorOnPaste = ed.onPaste; ed.onPaste = this.onPaste.bind(this);\r\n        this.$mousedownHandler = ed.addEventListener('mousedown', this.onMouseDown.bind(this));\r\n        this.selectionFix(ed);\r\n        this.statusMessage(true);\r\n    };\r\n\r\n    this.deactivate = function(reset) {\r\n        this.cancelSearch(reset);\r\n        var ed = this.$editor;\r\n        ed.keyBinding.removeKeyboardHandler(this.$keyboardHandler);\r\n        if (this.$mousedownHandler) {\r\n            ed.removeEventListener('mousedown', this.$mousedownHandler);\r\n            delete this.$mousedownHandler;\r\n        }\r\n        ed.onPaste = this.$originalEditorOnPaste;\r\n        this.message('');\r\n    };\r\n\r\n    this.selectionFix = function(editor) {\r\n        // Fix selection bug: When clicked inside the editor\r\n        // editor.selection.$isEmpty is false even if the mouse click did not\r\n        // open a selection. This is interpreted by the move commands to\r\n        // extend the selection. To only extend the selection when there is\r\n        // one, we clear it here\r\n        if (editor.selection.isEmpty() && !editor.session.$emacsMark) {\r\n            editor.clearSelection();\r\n        }\r\n    };\r\n\r\n    this.highlight = function(regexp) {\r\n        var sess = this.$editor.session,\r\n            hl = sess.$isearchHighlight = sess.$isearchHighlight || sess.addDynamicMarker(\r\n                new SearchHighlight(null, \"ace_isearch-result\", \"text\"));\r\n        hl.setRegexp(regexp);\r\n        sess._emit(\"changeBackMarker\"); // force highlight layer redraw\r\n    };\r\n\r\n    this.cancelSearch = function(reset) {\r\n        var e = this.$editor;\r\n        this.$prevNeedle = this.$options.needle;\r\n        this.$options.needle = '';\r\n        if (reset) {\r\n            e.moveCursorToPosition(this.$startPos);\r\n            this.$currentPos = this.$startPos;\r\n        } else {\r\n            e.pushEmacsMark && e.pushEmacsMark(this.$startPos, false);\r\n        }\r\n        this.highlight(null);\r\n        return Range.fromPoints(this.$currentPos, this.$currentPos);\r\n    };\r\n\r\n    this.highlightAndFindWithNeedle = function(moveToNext, needleUpdateFunc) {\r\n        if (!this.$editor) return null;\r\n        var options = this.$options;\r\n\r\n        // get search term\r\n        if (needleUpdateFunc) {\r\n            options.needle = needleUpdateFunc.call(this, options.needle || '') || '';\r\n        }\r\n        if (options.needle.length === 0) {\r\n            this.statusMessage(true);\r\n            return this.cancelSearch(true);\r\n        }\r\n\r\n        // try to find the next occurrence and enable  highlighting marker\r\n        options.start = this.$currentPos;\r\n        var session = this.$editor.session,\r\n            found = this.find(session),\r\n            shouldSelect = this.$editor.emacsMark ?\r\n                !!this.$editor.emacsMark() : !this.$editor.selection.isEmpty();\r\n        if (found) {\r\n            if (options.backwards) found = Range.fromPoints(found.end, found.start);\r\n            this.$editor.selection.setRange(Range.fromPoints(shouldSelect ? this.$startPos : found.end, found.end));\r\n            if (moveToNext) this.$currentPos = found.end;\r\n            // highlight after cursor move, so selection works properly\r\n            this.highlight(options.re);\r\n        }\r\n\r\n        this.statusMessage(found);\r\n\r\n        return found;\r\n    };\r\n\r\n    this.addString = function(s) {\r\n        return this.highlightAndFindWithNeedle(false, function(needle) {\r\n            if (!isRegExp(needle))\r\n              return needle + s;\r\n            var reObj = regExpToObject(needle);\r\n            reObj.expression += s;\r\n            return objectToRegExp(reObj);\r\n        });\r\n    };\r\n\r\n    this.removeChar = function(c) {\r\n        return this.highlightAndFindWithNeedle(false, function(needle) {\r\n            if (!isRegExp(needle))\r\n              return needle.substring(0, needle.length-1);\r\n            var reObj = regExpToObject(needle);\r\n            reObj.expression = reObj.expression.substring(0, reObj.expression.length-1);\r\n            return objectToRegExp(reObj);\r\n        });\r\n    };\r\n\r\n    this.next = function(options) {\r\n        // try to find the next occurrence of whatever we have searched for\r\n        // earlier.\r\n        // options = {[backwards: BOOL], [useCurrentOrPrevSearch: BOOL]}\r\n        options = options || {};\r\n        this.$options.backwards = !!options.backwards;\r\n        this.$currentPos = this.$editor.getCursorPosition();\r\n        return this.highlightAndFindWithNeedle(true, function(needle) {\r\n            return options.useCurrentOrPrevSearch && needle.length === 0 ?\r\n                this.$prevNeedle || '' : needle;\r\n        });\r\n    };\r\n\r\n    this.onMouseDown = function(evt) {\r\n        // when mouse interaction happens then we quit incremental search\r\n        this.deactivate();\r\n        return true;\r\n    };\r\n\r\n    this.onPaste = function(text) {\r\n        this.addString(text);\r\n    };\r\n\r\n    this.convertNeedleToRegExp = function() {\r\n        return this.highlightAndFindWithNeedle(false, function(needle) {\r\n            return isRegExp(needle) ? needle : stringToRegExp(needle, 'ig');\r\n        });\r\n    };\r\n\r\n    this.convertNeedleToString = function() {\r\n        return this.highlightAndFindWithNeedle(false, function(needle) {\r\n            return isRegExp(needle) ? regExpToObject(needle).expression : needle;\r\n        });\r\n    };\r\n\r\n    this.statusMessage = function(found) {\r\n        var options = this.$options, msg = '';\r\n        msg += options.backwards ? 'reverse-' : '';\r\n        msg += 'isearch: ' + options.needle;\r\n        msg += found ? '' : ' (not found)';\r\n        this.message(msg);\r\n    };\r\n\r\n    this.message = function(msg) {\r\n        if (this.$editor.showCommandLine) {\r\n            this.$editor.showCommandLine(msg);\r\n            this.$editor.focus();\r\n        } else {\r\n            console.log(msg);\r\n        }\r\n    };\r\n\r\n}).call(IncrementalSearch.prototype);\r\n\r\n\r\nexports.IncrementalSearch = IncrementalSearch;\r\n\r\n\r\n/**\r\n *\r\n * Config settings for enabling/disabling [[IncrementalSearch `IncrementalSearch`]].\r\n *\r\n **/\r\n\r\nvar dom = require('./lib/dom');\r\ndom.importCssString && dom.importCssString(\"\\\r\n.ace_marker-layer .ace_isearch-result {\\\r\n  position: absolute;\\\r\n  z-index: 6;\\\r\n  box-sizing: border-box;\\\r\n}\\\r\ndiv.ace_isearch-result {\\\r\n  border-radius: 4px;\\\r\n  background-color: rgba(255, 200, 0, 0.5);\\\r\n  box-shadow: 0 0 4px rgb(255, 200, 0);\\\r\n}\\\r\n.ace_dark div.ace_isearch-result {\\\r\n  background-color: rgb(100, 110, 160);\\\r\n  box-shadow: 0 0 4px rgb(80, 90, 140);\\\r\n}\", \"incremental-search-highlighting\");\r\n\r\n// support for default keyboard handler\r\nvar commands = require(\"./commands/command_manager\");\r\n(function() {\r\n    this.setupIncrementalSearch = function(editor, val) {\r\n        if (this.usesIncrementalSearch == val) return;\r\n        this.usesIncrementalSearch = val;\r\n        var iSearchCommands = iSearchCommandModule.iSearchStartCommands;\r\n        var method = val ? 'addCommands' : 'removeCommands';\r\n        this[method](iSearchCommands);\r\n    };\r\n}).call(commands.CommandManager.prototype);\r\n\r\n// incremental search config option\r\nvar Editor = require(\"./editor\").Editor;\r\nrequire(\"./config\").defineOptions(Editor.prototype, \"editor\", {\r\n    useIncrementalSearch: {\r\n        set: function(val) {\r\n            this.keyBinding.$handlers.forEach(function(handler) {\r\n                if (handler.setupIncrementalSearch) {\r\n                    handler.setupIncrementalSearch(this, val);\r\n                }\r\n            });\r\n            this._emit('incrementalSearchSettingChanged', {isEnabled: val});\r\n        }\r\n    }\r\n});\r\n\r\n});\r\n"]}