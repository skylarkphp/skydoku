{"version":3,"sources":["ext/error_marker.js"],"names":["define","require","exports","module","LineWidgets","dom","Range","showErrorMarker","editor","dir","session","widgetManager","attach","pos","getCursorPosition","row","oldWidget","getWidgetsAtRow","filter","w","type","destroy","gutterAnno","annotations","getAnnotations","sort","comparePoints","length","i","array","needle","comparator","first","last","mid","c","binarySearch","column","annotation","slice","matched","findAnnotations","sc","renderer","$gutterLayer","$annotations","text","className","unfold","selection","moveToPosition","fixedWidth","coverGutter","el","createElement","appendChild","arrow","left","$cursorLayer","getPixelPosition","style","gutterWidth","innerHTML","join","kb","_","hashId","keyString","command","$mouseHandler","isMousePressed","keyBinding","removeKeyboardHandler","removeLineWidget","off","addKeyboardHandler","on","addLineWidget","onmousedown","focus","bind","scrollCursorIntoView","bottom","offsetHeight","importCssString"],"mappings":"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","file":"../../ext/error_marker.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2012, Ajax.org B.V.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine(function(require, exports, module) {\r\n\"use strict\";\r\nvar LineWidgets = require(\"../line_widgets\").LineWidgets;\r\nvar dom = require(\"../lib/dom\");\r\nvar Range = require(\"../range\").Range;\r\n\r\nfunction binarySearch(array, needle, comparator) {\r\n    var first = 0;\r\n    var last = array.length - 1;\r\n\r\n    while (first <= last) {\r\n        var mid = (first + last) >> 1;\r\n        var c = comparator(needle, array[mid]);\r\n        if (c > 0)\r\n            first = mid + 1;\r\n        else if (c < 0)\r\n            last = mid - 1;\r\n        else\r\n            return mid;\r\n    }\r\n\r\n    // Return the nearest lesser index, \"-1\" means \"0, \"-2\" means \"1\", etc.\r\n    return -(first + 1);\r\n}\r\n\r\nfunction findAnnotations(session, row, dir) {\r\n    var annotations = session.getAnnotations().sort(Range.comparePoints);\r\n    if (!annotations.length)\r\n        return;\r\n    \r\n    var i = binarySearch(annotations, {row: row, column: -1}, Range.comparePoints);\r\n    if (i < 0)\r\n        i = -i - 1;\r\n    \r\n    if (i >= annotations.length)\r\n        i = dir > 0 ? 0 : annotations.length - 1;\r\n    else if (i === 0 && dir < 0)\r\n        i = annotations.length - 1;\r\n    \r\n    var annotation = annotations[i];\r\n    if (!annotation || !dir)\r\n        return;\r\n\r\n    if (annotation.row === row) {\r\n        do {\r\n            annotation = annotations[i += dir];\r\n        } while (annotation && annotation.row === row);\r\n        if (!annotation)\r\n            return annotations.slice();\r\n    }\r\n    \r\n    \r\n    var matched = [];\r\n    row = annotation.row;\r\n    do {\r\n        matched[dir < 0 ? \"unshift\" : \"push\"](annotation);\r\n        annotation = annotations[i += dir];\r\n    } while (annotation && annotation.row == row);\r\n    return matched.length && matched;\r\n}\r\n\r\nexports.showErrorMarker = function(editor, dir) {\r\n    var session = editor.session;\r\n    if (!session.widgetManager) {\r\n        session.widgetManager = new LineWidgets(session);\r\n        session.widgetManager.attach(editor);\r\n    }\r\n    \r\n    var pos = editor.getCursorPosition();\r\n    var row = pos.row;\r\n    var oldWidget = session.widgetManager.getWidgetsAtRow(row).filter(function(w) {\r\n        return w.type == \"errorMarker\";\r\n    })[0];\r\n    if (oldWidget) {\r\n        oldWidget.destroy();\r\n    } else {\r\n        row -= dir;\r\n    }\r\n    var annotations = findAnnotations(session, row, dir);\r\n    var gutterAnno;\r\n    if (annotations) {\r\n        var annotation = annotations[0];\r\n        pos.column = (annotation.pos && typeof annotation.column != \"number\"\r\n            ? annotation.pos.sc\r\n            : annotation.column) || 0;\r\n        pos.row = annotation.row;\r\n        gutterAnno = editor.renderer.$gutterLayer.$annotations[pos.row];\r\n    } else if (oldWidget) {\r\n        return;\r\n    } else {\r\n        gutterAnno = {\r\n            text: [\"Looks good!\"],\r\n            className: \"ace_ok\"\r\n        };\r\n    }\r\n    editor.session.unfold(pos.row);\r\n    editor.selection.moveToPosition(pos);\r\n    \r\n    var w = {\r\n        row: pos.row, \r\n        fixedWidth: true,\r\n        coverGutter: true,\r\n        el: dom.createElement(\"div\"),\r\n        type: \"errorMarker\"\r\n    };\r\n    var el = w.el.appendChild(dom.createElement(\"div\"));\r\n    var arrow = w.el.appendChild(dom.createElement(\"div\"));\r\n    arrow.className = \"error_widget_arrow \" + gutterAnno.className;\r\n    \r\n    var left = editor.renderer.$cursorLayer\r\n        .getPixelPosition(pos).left;\r\n    arrow.style.left = left + editor.renderer.gutterWidth - 5 + \"px\";\r\n    \r\n    w.el.className = \"error_widget_wrapper\";\r\n    el.className = \"error_widget \" + gutterAnno.className;\r\n    el.innerHTML = gutterAnno.text.join(\"<br>\");\r\n    \r\n    el.appendChild(dom.createElement(\"div\"));\r\n    \r\n    var kb = function(_, hashId, keyString) {\r\n        if (hashId === 0 && (keyString === \"esc\" || keyString === \"return\")) {\r\n            w.destroy();\r\n            return {command: \"null\"};\r\n        }\r\n    };\r\n    \r\n    w.destroy = function() {\r\n        if (editor.$mouseHandler.isMousePressed)\r\n            return;\r\n        editor.keyBinding.removeKeyboardHandler(kb);\r\n        session.widgetManager.removeLineWidget(w);\r\n        editor.off(\"changeSelection\", w.destroy);\r\n        editor.off(\"changeSession\", w.destroy);\r\n        editor.off(\"mouseup\", w.destroy);\r\n        editor.off(\"change\", w.destroy);\r\n    };\r\n    \r\n    editor.keyBinding.addKeyboardHandler(kb);\r\n    editor.on(\"changeSelection\", w.destroy);\r\n    editor.on(\"changeSession\", w.destroy);\r\n    editor.on(\"mouseup\", w.destroy);\r\n    editor.on(\"change\", w.destroy);\r\n    \r\n    editor.session.widgetManager.addLineWidget(w);\r\n    \r\n    w.el.onmousedown = editor.focus.bind(editor);\r\n    \r\n    editor.renderer.scrollCursorIntoView(null, 0.5, {bottom: w.el.offsetHeight});\r\n};\r\n\r\n\r\ndom.importCssString(\"\\\r\n    .error_widget_wrapper {\\\r\n        background: inherit;\\\r\n        color: inherit;\\\r\n        border:none\\\r\n    }\\\r\n    .error_widget {\\\r\n        border-top: solid 2px;\\\r\n        border-bottom: solid 2px;\\\r\n        margin: 5px 0;\\\r\n        padding: 10px 40px;\\\r\n        white-space: pre-wrap;\\\r\n    }\\\r\n    .error_widget.ace_error, .error_widget_arrow.ace_error{\\\r\n        border-color: #ff5a5a\\\r\n    }\\\r\n    .error_widget.ace_warning, .error_widget_arrow.ace_warning{\\\r\n        border-color: #F1D817\\\r\n    }\\\r\n    .error_widget.ace_info, .error_widget_arrow.ace_info{\\\r\n        border-color: #5a5a5a\\\r\n    }\\\r\n    .error_widget.ace_ok, .error_widget_arrow.ace_ok{\\\r\n        border-color: #5aaa5a\\\r\n    }\\\r\n    .error_widget_arrow {\\\r\n        position: absolute;\\\r\n        border: solid 5px;\\\r\n        border-top-color: transparent!important;\\\r\n        border-right-color: transparent!important;\\\r\n        border-left-color: transparent!important;\\\r\n        top: -5px;\\\r\n    }\\\r\n\", \"\");\r\n\r\n});"]}