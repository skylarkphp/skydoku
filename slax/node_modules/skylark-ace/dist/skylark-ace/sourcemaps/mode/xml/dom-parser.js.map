{"version":3,"sources":["mode/xml/dom-parser.js"],"names":["define","require","exports","module","XMLReader","DOMImplementation","DOMParser","options","this","locator","DOMHandler","cdata","position","node","lineNumber","columnNumber","_locator","l","systemId","_toString","chars","start","length","substr","java","lang","String","appendElement","hander","currentElement","appendChild","document","prototype","parseFromString","source","mimeType","sax","domBuilder","errorHandler","defaultNSMap","xmlns","entityMap","lt","gt","amp","quot","apos","setDocumentLocator","errorImpl","isCallback","Function","build","key","fn","msg","i","arguments","buildErrorHandler","test","nbsp","copy","parse","error","startDocument","createDocument","documentURI","startElement","namespaceURI","localName","qName","attrs","doc","el","createElementNS","len","getURI","value","getValue","attr","getQName","createAttributeNS","getOffset","nodeValue","setAttributeNode","endElement","current","tagName","parentNode","startPrefixMapping","prefix","uri","endPrefixMapping","processingInstruction","target","data","ins","createProcessingInstruction","ignorableWhitespace","ch","characters","apply","charNode","createCDATASection","createTextNode","skippedEntity","name","endDocument","normalize","comment","comm","createComment","startCDATA","endCDATA","startDTD","publicId","impl","implementation","createDocumentType","dt","warning","console","warn","fatalError","replace"],"mappings":"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","file":"../../../mode/xml/dom-parser.js","sourcesContent":["define(function(require, exports, module) {\r\n\t'use strict';\r\n\r\n\tvar XMLReader = require('./sax'),\r\n\t\tDOMImplementation = require('./dom');\r\n\r\nfunction DOMParser(options){\r\n\tthis.options = options ||{locator:{}};\r\n\t\r\n}\r\nDOMParser.prototype.parseFromString = function(source,mimeType){\t\r\n\tvar options = this.options;\r\n\tvar sax =  new XMLReader();\r\n\tvar domBuilder = options.domBuilder || new DOMHandler();//contentHandler and LexicalHandler\r\n\tvar errorHandler = options.errorHandler;\r\n\tvar locator = options.locator;\r\n\tvar defaultNSMap = options.xmlns||{};\r\n\tvar entityMap = {'lt':'<','gt':'>','amp':'&','quot':'\"','apos':\"'\"}\r\n\tif(locator){\r\n\t\tdomBuilder.setDocumentLocator(locator)\r\n\t}\r\n\t\r\n\tsax.errorHandler = buildErrorHandler(errorHandler,domBuilder,locator);\r\n\tsax.domBuilder = options.domBuilder || domBuilder;\r\n\tif(/\\/x?html?$/.test(mimeType)){\r\n\t\tentityMap.nbsp = '\\xa0';\r\n\t\tentityMap.copy = '\\xa9';\r\n\t\tdefaultNSMap['']= 'http://www.w3.org/1999/xhtml';\r\n\t}\r\n\tif(source){\r\n\t\tsax.parse(source,defaultNSMap,entityMap);\r\n\t}else{\r\n\t\tsax.errorHandler.error(\"invalid document source\");\r\n\t}\r\n\treturn domBuilder.document;\r\n}\r\nfunction buildErrorHandler(errorImpl,domBuilder,locator){\r\n\tif(!errorImpl){\r\n\t\tif(domBuilder instanceof DOMHandler){\r\n\t\t\treturn domBuilder;\r\n\t\t}\r\n\t\terrorImpl = domBuilder ;\r\n\t}\r\n\tvar errorHandler = {}\r\n\tvar isCallback = errorImpl instanceof Function;\r\n\tlocator = locator||{}\r\n\tfunction build(key){\r\n\t\tvar fn = errorImpl[key];\r\n\t\tif(!fn){\r\n\t\t\tif(isCallback){\r\n\t\t\t\tfn = errorImpl.length == 2?function(msg){errorImpl(key,msg)}:errorImpl;\r\n\t\t\t}else{\r\n\t\t\t\tvar i=arguments.length;\r\n\t\t\t\twhile(--i){\r\n\t\t\t\t\tif(fn = errorImpl[arguments[i]]){\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\terrorHandler[key] = fn && function(msg){\r\n\t\t\tfn(msg+_locator(locator), msg, locator);\r\n\t\t}||function(){};\r\n\t}\r\n\tbuild('warning','warn');\r\n\tbuild('error','warn','warning');\r\n\tbuild('fatalError','warn','warning','error');\r\n\treturn errorHandler;\r\n}\r\n/**\r\n * +ContentHandler+ErrorHandler\r\n * +LexicalHandler+EntityResolver2\r\n * -DeclHandler-DTDHandler \r\n * \r\n * DefaultHandler:EntityResolver, DTDHandler, ContentHandler, ErrorHandler\r\n * DefaultHandler2:DefaultHandler,LexicalHandler, DeclHandler, EntityResolver2\r\n * @link http://www.saxproject.org/apidoc/org/xml/sax/helpers/DefaultHandler.html\r\n */\r\nfunction DOMHandler() {\r\n    this.cdata = false;\r\n}\r\nfunction position(locator,node){\r\n\tnode.lineNumber = locator.lineNumber;\r\n\tnode.columnNumber = locator.columnNumber;\r\n}\r\n/**\r\n * @see org.xml.sax.ContentHandler#startDocument\r\n * @link http://www.saxproject.org/apidoc/org/xml/sax/ContentHandler.html\r\n */ \r\nDOMHandler.prototype = {\r\n\tstartDocument : function() {\r\n    \tthis.document = new DOMImplementation().createDocument(null, null, null);\r\n    \tif (this.locator) {\r\n        \tthis.document.documentURI = this.locator.systemId;\r\n    \t}\r\n\t},\r\n\tstartElement:function(namespaceURI, localName, qName, attrs) {\r\n\t\tvar doc = this.document;\r\n\t    var el = doc.createElementNS(namespaceURI, qName||localName);\r\n\t    var len = attrs.length;\r\n\t    appendElement(this, el);\r\n\t    this.currentElement = el;\r\n\t    \r\n\t\tthis.locator && position(this.locator,el)\r\n\t    for (var i = 0 ; i < len; i++) {\r\n\t        var namespaceURI = attrs.getURI(i);\r\n\t        var value = attrs.getValue(i);\r\n\t        var qName = attrs.getQName(i);\r\n\t\t\tvar attr = doc.createAttributeNS(namespaceURI, qName);\r\n\t\t\tif( attr.getOffset){\r\n\t\t\t\tposition(attr.getOffset(1),attr)\r\n\t\t\t}\r\n\t\t\tattr.value = attr.nodeValue = value;\r\n\t\t\tel.setAttributeNode(attr)\r\n\t    }\r\n\t},\r\n\tendElement:function(namespaceURI, localName, qName) {\r\n\t\tvar current = this.currentElement\r\n\t    var tagName = current.tagName;\r\n\t    this.currentElement = current.parentNode;\r\n\t},\r\n\tstartPrefixMapping:function(prefix, uri) {\r\n\t},\r\n\tendPrefixMapping:function(prefix) {\r\n\t},\r\n\tprocessingInstruction:function(target, data) {\r\n\t    var ins = this.document.createProcessingInstruction(target, data);\r\n\t    this.locator && position(this.locator,ins)\r\n\t    appendElement(this, ins);\r\n\t},\r\n\tignorableWhitespace:function(ch, start, length) {\r\n\t},\r\n\tcharacters:function(chars, start, length) {\r\n\t\tchars = _toString.apply(this,arguments)\r\n\t\t//console.log(chars)\r\n\t\tif(this.currentElement && chars){\r\n\t\t\tif (this.cdata) {\r\n\t\t\t\tvar charNode = this.document.createCDATASection(chars);\r\n\t\t\t\tthis.currentElement.appendChild(charNode);\r\n\t\t\t} else {\r\n\t\t\t\tvar charNode = this.document.createTextNode(chars);\r\n\t\t\t\tthis.currentElement.appendChild(charNode);\r\n\t\t\t}\r\n\t\t\tthis.locator && position(this.locator,charNode)\r\n\t\t}\r\n\t},\r\n\tskippedEntity:function(name) {\r\n\t},\r\n\tendDocument:function() {\r\n\t\tthis.document.normalize();\r\n\t},\r\n\tsetDocumentLocator:function (locator) {\r\n\t    if(this.locator = locator){// && !('lineNumber' in locator)){\r\n\t    \tlocator.lineNumber = 0;\r\n\t    }\r\n\t},\r\n\t//LexicalHandler\r\n\tcomment:function(chars, start, length) {\r\n\t\tchars = _toString.apply(this,arguments)\r\n\t    var comm = this.document.createComment(chars);\r\n\t    this.locator && position(this.locator,comm)\r\n\t    appendElement(this, comm);\r\n\t},\r\n\t\r\n\tstartCDATA:function() {\r\n\t    //used in characters() methods\r\n\t    this.cdata = true;\r\n\t},\r\n\tendCDATA:function() {\r\n\t    this.cdata = false;\r\n\t},\r\n\t\r\n\tstartDTD:function(name, publicId, systemId) {\r\n\t\tvar impl = this.document.implementation;\r\n\t    if (impl && impl.createDocumentType) {\r\n\t        var dt = impl.createDocumentType(name, publicId, systemId);\r\n\t        this.locator && position(this.locator,dt)\r\n\t        appendElement(this, dt);\r\n\t    }\r\n\t},\r\n\t/**\r\n\t * @see org.xml.sax.ErrorHandler\r\n\t * @link http://www.saxproject.org/apidoc/org/xml/sax/ErrorHandler.html\r\n\t */\r\n\twarning:function(error) {\r\n\t\tconsole.warn(error,_locator(this.locator));\r\n\t},\r\n\terror:function(error) {\r\n\t\tconsole.error(error,_locator(this.locator));\r\n\t},\r\n\tfatalError:function(error) {\r\n\t\tconsole.error(error,_locator(this.locator));\r\n\t    throw error;\r\n\t}\r\n}\r\nfunction _locator(l){\r\n\tif(l){\r\n\t\treturn '\\n@'+(l.systemId ||'')+'#[line:'+l.lineNumber+',col:'+l.columnNumber+']'\r\n\t}\r\n}\r\nfunction _toString(chars,start,length){\r\n\tif(typeof chars == 'string'){\r\n\t\treturn chars.substr(start,length)\r\n\t}else{//java sax connect width xmldom on rhino(what about: \"? && !(chars instanceof String)\")\r\n\t\tif(chars.length >= start+length || start){\r\n\t\t\treturn new java.lang.String(chars,start,length)+'';\r\n\t\t}\r\n\t\treturn chars;\r\n\t}\r\n}\r\n\r\n/*\r\n * @link http://www.saxproject.org/apidoc/org/xml/sax/ext/LexicalHandler.html\r\n * used method of org.xml.sax.ext.LexicalHandler:\r\n *  #comment(chars, start, length)\r\n *  #startCDATA()\r\n *  #endCDATA()\r\n *  #startDTD(name, publicId, systemId)\r\n *\r\n *\r\n * IGNORED method of org.xml.sax.ext.LexicalHandler:\r\n *  #endDTD()\r\n *  #startEntity(name)\r\n *  #endEntity(name)\r\n *\r\n *\r\n * @link http://www.saxproject.org/apidoc/org/xml/sax/ext/DeclHandler.html\r\n * IGNORED method of org.xml.sax.ext.DeclHandler\r\n * \t#attributeDecl(eName, aName, type, mode, value)\r\n *  #elementDecl(name, model)\r\n *  #externalEntityDecl(name, publicId, systemId)\r\n *  #internalEntityDecl(name, value)\r\n * @link http://www.saxproject.org/apidoc/org/xml/sax/ext/EntityResolver2.html\r\n * IGNORED method of org.xml.sax.EntityResolver2\r\n *  #resolveEntity(String name,String publicId,String baseURI,String systemId)\r\n *  #resolveEntity(publicId, systemId)\r\n *  #getExternalSubset(name, baseURI)\r\n * @link http://www.saxproject.org/apidoc/org/xml/sax/DTDHandler.html\r\n * IGNORED method of org.xml.sax.DTDHandler\r\n *  #notationDecl(name, publicId, systemId) {};\r\n *  #unparsedEntityDecl(name, publicId, systemId, notationName) {};\r\n */\r\n\"endDTD,startEntity,endEntity,attributeDecl,elementDecl,externalEntityDecl,internalEntityDecl,resolveEntity,getExternalSubset,notationDecl,unparsedEntityDecl\".replace(/\\w+/g,function(key){\r\n\tDOMHandler.prototype[key] = function(){return null}\r\n})\r\n\r\n/* Private static helpers treated below as private instance methods, so don't need to add these to the public API; we might use a Relator to also get rid of non-standard public properties */\r\nfunction appendElement (hander,node) {\r\n    if (!hander.currentElement) {\r\n        hander.document.appendChild(node);\r\n    } else {\r\n        hander.currentElement.appendChild(node);\r\n    }\r\n}//appendChild and setAttributeNS are preformance key\r\n\r\nreturn {\r\n\t\tDOMParser: DOMParser\r\n\t };\r\n});\r\n\r\n"]}