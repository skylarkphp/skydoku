/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(e,t,i){"use strict";var s=e("../lib/oop"),n=e("../lib/dom"),h=e("../lib/lang"),a=e("./lines").Lines,r=e("../lib/event_emitter").EventEmitter,o=function(e){this.dom=n,this.element=this.dom.createElement("div"),this.element.className="ace_layer ace_text-layer",e.appendChild(this.element),this.$updateEolChar=this.$updateEolChar.bind(this),this.$lines=new a(this.element)};(function(){s.implement(this,r),this.EOF_CHAR="¶",this.EOL_CHAR_LF="¬",this.EOL_CHAR_CRLF="¤",this.EOL_CHAR=this.EOL_CHAR_LF,this.TAB_CHAR="—",this.SPACE_CHAR="·",this.$padding=0,this.MAX_LINE_LENGTH=1e4,this.$updateEolChar=function(){var e=this.session.doc,t="\n"==e.getNewLineCharacter()&&"windows"!=e.getNewLineMode()?this.EOL_CHAR_LF:this.EOL_CHAR_CRLF;if(this.EOL_CHAR!=t)return this.EOL_CHAR=t,!0},this.setPadding=function(e){this.$padding=e,this.element.style.margin="0 "+e+"px"},this.getLineHeight=function(){return this.$fontMetrics.$characterSize.height||0},this.getCharacterWidth=function(){return this.$fontMetrics.$characterSize.width||0},this.$setFontMetrics=function(e){this.$fontMetrics=e,this.$fontMetrics.on("changeCharacterSize",function(e){this._signal("changeCharacterSize",e)}.bind(this)),this.$pollSizeChanges()},this.checkForSizeChanges=function(){this.$fontMetrics.checkForSizeChanges()},this.$pollSizeChanges=function(){return this.$pollSizeChangesTimer=this.$fontMetrics.$pollSizeChanges()},this.setSession=function(e){this.session=e,e&&this.$computeTabString()},this.showInvisibles=!1,this.setShowInvisibles=function(e){return this.showInvisibles!=e&&(this.showInvisibles=e,this.$computeTabString(),!0)},this.displayIndentGuides=!0,this.setDisplayIndentGuides=function(e){return this.displayIndentGuides!=e&&(this.displayIndentGuides=e,this.$computeTabString(),!0)},this.$tabStrings=[],this.onChangeTabSize=this.$computeTabString=function(){var e=this.session.getTabSize();this.tabSize=e;for(var t=this.$tabStrings=[0],i=1;i<e+1;i++){if(this.showInvisibles)(s=this.dom.createElement("span")).className="ace_invisible ace_invisible_tab",s.textContent=h.stringRepeat(this.TAB_CHAR,i),t.push(s);else t.push(this.dom.createTextNode(h.stringRepeat(" ",i),this.element))}if(this.displayIndentGuides){this.$indentGuideRe=/\s\S| \t|\t |\s$/;var s,n="ace_indent-guide",a="",r="";if(this.showInvisibles){n+=" ace_invisible",a=" ace_invisible_space",r=" ace_invisible_tab";var o=h.stringRepeat(this.SPACE_CHAR,this.tabSize),l=h.stringRepeat(this.TAB_CHAR,this.tabSize)}else l=o=h.stringRepeat(" ",this.tabSize);(s=this.dom.createElement("span")).className=n+a,s.textContent=o,this.$tabStrings[" "]=s,(s=this.dom.createElement("span")).className=n+r,s.textContent=l,this.$tabStrings["\t"]=s}},this.updateLines=function(e,t,i){if(this.config.lastRow!=e.lastRow||this.config.firstRow!=e.firstRow)return this.update(e);this.config=e;for(var s=Math.max(t,e.firstRow),n=Math.min(i,e.lastRow),h=this.element.childNodes,a=0,r=e.firstRow;r<s;r++){if(o=this.session.getFoldLine(r)){if(o.containsRow(s)){s=o.start.row;break}r=o.end.row}a++}for(var o,l=!1,u=(r=s,(o=this.session.getNextFoldLine(r))?o.start.row:1/0);r>u&&(r=o.end.row+1,u=(o=this.session.getNextFoldLine(r,o))?o.start.row:1/0),!(r>n);){var d=h[a++];if(d){this.dom.removeChildren(d),this.$renderLine(d,r,r==u&&o);var c=e.lineHeight*this.session.getRowLength(r)+"px";d.style.height!=c&&(l=!0,d.style.height=c)}r++}if(l)for(;a<this.$lines.cells.length;){var p=this.$lines.cells[a++];p.element.style.top=this.$lines.computeLineTop(p.row,e,this.session)+"px"}},this.scrollLines=function(e){var t=this.config;if(this.config=e,this.$lines.pageChanged(t,e))return this.update(e);this.$lines.moveContainer(e);var i=e.lastRow,s=t?t.lastRow:-1;if(!t||s<e.firstRow)return this.update(e);if(i<t.firstRow)return this.update(e);if(!t||t.lastRow<e.firstRow)return this.update(e);if(e.lastRow<t.firstRow)return this.update(e);if(t.firstRow<e.firstRow)for(var n=this.session.getFoldedRowCount(t.firstRow,e.firstRow-1);n>0;n--)this.$lines.shift();if(t.lastRow>e.lastRow)for(n=this.session.getFoldedRowCount(e.lastRow+1,t.lastRow);n>0;n--)this.$lines.pop();e.firstRow<t.firstRow&&this.$lines.unshift(this.$renderLinesFragment(e,e.firstRow,t.firstRow-1)),e.lastRow>t.lastRow&&this.$lines.push(this.$renderLinesFragment(e,t.lastRow+1,e.lastRow))},this.$renderLinesFragment=function(e,t,i){for(var s=[],h=t,a=this.session.getNextFoldLine(h),r=a?a.start.row:1/0;h>r&&(h=a.end.row+1,r=(a=this.session.getNextFoldLine(h,a))?a.start.row:1/0),!(h>i);){var o=this.$lines.createCell(h,e,this.session),l=o.element;this.dom.removeChildren(l),n.setStyle(l.style,"height",this.$lines.computeLineHeight(h,e,this.session)+"px"),n.setStyle(l.style,"top",this.$lines.computeLineTop(h,e,this.session)+"px"),this.$renderLine(l,h,h==r&&a),this.$useLineGroups()?l.className="ace_line_group":l.className="ace_line",s.push(o),h++}return s},this.update=function(e){this.$lines.moveContainer(e),this.config=e;for(var t=e.firstRow,i=e.lastRow,s=this.$lines;s.getLength();)s.pop();s.push(this.$renderLinesFragment(e,t,i))},this.$textToken={text:!0,rparen:!0,lparen:!0},this.$renderToken=function(e,t,i,s){for(var a,r=/(\t)|( +)|([\x00-\x1f\x80-\xa0\xad\u1680\u180E\u2000-\u200f\u2028\u2029\u202F\u205F\uFEFF\uFFF9-\uFFFC]+)|(\u3000)|([\u1100-\u115F\u11A3-\u11A7\u11FA-\u11FF\u2329-\u232A\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u2FFB\u3001-\u303E\u3041-\u3096\u3099-\u30FF\u3105-\u312D\u3131-\u318E\u3190-\u31BA\u31C0-\u31E3\u31F0-\u321E\u3220-\u3247\u3250-\u32FE\u3300-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFAFF\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE66\uFE68-\uFE6B\uFF01-\uFF60\uFFE0-\uFFE6]|[\uD800-\uDBFF][\uDC00-\uDFFF])/g,o=this.dom.createFragment(this.element),l=0;a=r.exec(s);){var u=a[1],d=a[2],c=a[3],p=a[4],g=a[5];if(this.showInvisibles||!d){var f=l!=a.index?s.slice(l,a.index):"";if(l=a.index+a[0].length,f&&o.appendChild(this.dom.createTextNode(f,this.element)),u){var m=this.session.getScreenTabSize(t+a.index);o.appendChild(this.$tabStrings[m].cloneNode(!0)),t+=m-1}else if(d){if(this.showInvisibles)(v=this.dom.createElement("span")).className="ace_invisible ace_invisible_space",v.textContent=h.stringRepeat(this.SPACE_CHAR,d.length),o.appendChild(v);else o.appendChild(this.com.createTextNode(d,this.element))}else if(c){(v=this.dom.createElement("span")).className="ace_invisible ace_invisible_space ace_invalid",v.textContent=h.stringRepeat(this.SPACE_CHAR,c.length),o.appendChild(v)}else if(p){this.showInvisibles&&this.SPACE_CHAR;t+=1,(v=this.dom.createElement("span")).style.width=2*this.config.characterWidth+"px",v.className=this.showInvisibles?"ace_cjk ace_invisible ace_invisible_space":"ace_cjk",v.textContent=this.showInvisibles?this.SPACE_CHAR:"",o.appendChild(v)}else if(g){t+=1,(v=n.createElement("span")).style.width=2*this.config.characterWidth+"px",v.className="ace_cjk",v.textContent=g,o.appendChild(v)}}}if(o.appendChild(this.dom.createTextNode(l?s.slice(l):s,this.element)),this.$textToken[i.type])e.appendChild(o);else{var C="ace_"+i.type.replace(/\./g," ace_"),v=this.dom.createElement("span");"fold"==i.type&&(v.style.width=i.value.length*this.config.characterWidth+"px"),v.className=C,v.appendChild(o),e.appendChild(v)}return t+s.length},this.renderIndentGuide=function(e,t,i){var s=t.search(this.$indentGuideRe);if(s<=0||s>=i)return t;if(" "==t[0]){for(var n=(s-=s%this.tabSize)/this.tabSize,h=0;h<n;h++)e.appendChild(this.$tabStrings[" "].cloneNode(!0));return t.substr(s)}if("\t"==t[0]){for(h=0;h<s;h++)e.appendChild(this.$tabStrings["\t"].cloneNode(!0));return t.substr(s)}return t},this.$createLineElement=function(e){var t=this.dom.createElement("div");return t.className="ace_line",t.style.height=this.config.lineHeight+"px",t},this.$renderWrappedLine=function(e,t,i){var s=0,n=0,a=i[0],r=0,o=this.$createLineElement();e.appendChild(o);for(var l=0;l<t.length;l++){var u=t[l],d=u.value;if(0==l&&this.displayIndentGuides){if(s=d.length,!(d=this.renderIndentGuide(o,d,a)))continue;s-=d.length}if(s+d.length<a)r=this.$renderToken(o,r,u,d),s+=d.length;else{for(;s+d.length>=a;)r=this.$renderToken(o,r,u,d.substring(0,a-s)),d=d.substring(a-s),s=a,o=this.$createLineElement(),e.appendChild(o),o.appendChild(this.dom.createTextNode(h.stringRepeat(" ",i.indent),this.element)),r=0,a=i[++n]||Number.MAX_VALUE;0!=d.length&&(s+=d.length,r=this.$renderToken(o,r,u,d))}}},this.$renderSimpleLine=function(e,t){var i=0,s=t[0],n=s.value;this.displayIndentGuides&&(n=this.renderIndentGuide(e,n)),n&&(i=this.$renderToken(e,i,s,n));for(var h=1;h<t.length;h++){if(i+(n=(s=t[h]).value).length>this.MAX_LINE_LENGTH)return this.$renderOverflowMessage(e,i,s,n);i=this.$renderToken(e,i,s,n)}},this.$renderOverflowMessage=function(e,t,i,s){this.$renderToken(e,t,i,s.slice(0,this.MAX_LINE_LENGTH-t));var n=this.dom.createElement("span");n.className="ace_inline_button ace_keyword ace_toggle_wrap",n.style.position="absolute",n.style.right="0",n.textContent="<click to see more...>",e.appendChild(n)},this.$renderLine=function(e,t,i){if(i||0==i||(i=this.session.getFoldLine(t)),i)var s=this.$getFoldLineTokens(t,i);else s=this.session.getTokens(t);var n=e;if(s.length){var h=this.session.getRowSplitData(t);if(h&&h.length){this.$renderWrappedLine(e,s,h);n=e.lastChild}else{n=e;this.$useLineGroups()&&(n=this.$createLineElement(),e.appendChild(n)),this.$renderSimpleLine(n,s)}}else this.$useLineGroups()&&(n=this.$createLineElement(),e.appendChild(n));if(this.showInvisibles&&n){i&&(t=i.end.row);var a=this.dom.createElement("span");a.className="ace_invisible ace_invisible_eol",a.textContent=t==this.session.getLength()-1?this.EOF_CHAR:this.EOL_CHAR,n.appendChild(a)}},this.$getFoldLineTokens=function(e,t){var i=this.session,s=[];var n=i.getTokens(e);return t.walk(function(e,t,h,a,r){null!=e?s.push({type:"fold",value:e}):(r&&(n=i.getTokens(t)),n.length&&function(e,t,i){for(var n=0,h=0;h+e[n].value.length<t;)if(h+=e[n].value.length,++n==e.length)return;for(h!=t&&((a=e[n].value.substring(t-h)).length>i-t&&(a=a.substring(0,i-t)),s.push({type:e[n].type,value:a}),h=t+a.length,n+=1);h<i&&n<e.length;){var a;(a=e[n].value).length+h>i?s.push({type:e[n].type,value:a.substring(0,i-h)}):s.push(e[n]),h+=a.length,n+=1}}(n,a,h))},t.end.row,this.session.getLine(t.end.row).length),s},this.$useLineGroups=function(){return this.session.getUseWrapMode()},this.destroy=function(){}}).call(o.prototype),t.Text=o});
//# sourceMappingURL=../sourcemaps/layer/text.js.map
