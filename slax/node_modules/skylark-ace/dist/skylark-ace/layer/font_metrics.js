/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(require,exports,module){var e=require("../lib/oop"),t=require("../lib/dom"),i=require("../lib/lang"),s=require("../lib/event"),h=require("../lib/useragent"),r=require("../lib/event_emitter").EventEmitter,n="function"==typeof ResizeObserver,o=200,a=exports.FontMetrics=function(e){this.el=t.createElement("div"),this.$setMeasureNodeStyles(this.el.style,!0),this.$main=t.createElement("div"),this.$setMeasureNodeStyles(this.$main.style),this.$measureNode=t.createElement("div"),this.$setMeasureNodeStyles(this.$measureNode.style),this.el.appendChild(this.$main),this.el.appendChild(this.$measureNode),e.appendChild(this.el),this.$measureNode.innerHTML=i.stringRepeat("X",256),this.$characterSize={width:0,height:0},n?this.$addObserver():this.checkForSizeChanges()};(function(){e.implement(this,r),this.$characterSize={width:0,height:0},this.$setMeasureNodeStyles=function(e,t){e.width=e.height="auto",e.left=e.top="0px",e.visibility="hidden",e.position="absolute",e.whiteSpace="pre",h.isIE<8?e["font-family"]="inherit":e.font="inherit",e.overflow=t?"hidden":"visible"},this.checkForSizeChanges=function(e){if(void 0===e&&(e=this.$measureSizes()),e&&(this.$characterSize.width!==e.width||this.$characterSize.height!==e.height)){this.$measureNode.style.fontWeight="bold";var t=this.$measureSizes();this.$measureNode.style.fontWeight="",this.$characterSize=e,this.charSizes=Object.create(null),this.allowBoldFonts=t&&t.width===e.width&&t.height===e.height,this._emit("changeCharacterSize",{data:e})}},this.$addObserver=function(){var e=this;this.$observer=new window.ResizeObserver(function(t){var i=t[0].contentRect;e.checkForSizeChanges({height:i.height,width:i.width/256})}),this.$observer.observe(this.$measureNode)},this.$pollSizeChanges=function(){if(this.$pollSizeChangesTimer||this.$observer)return this.$pollSizeChangesTimer;var e=this;return this.$pollSizeChangesTimer=s.onIdle(function t(){e.checkForSizeChanges(),s.onIdle(t,500)},500)},this.setPolling=function(e){e?this.$pollSizeChanges():this.$pollSizeChangesTimer&&(clearInterval(this.$pollSizeChangesTimer),this.$pollSizeChangesTimer=0)},this.$measureSizes=function(e){var t={height:(e||this.$measureNode).clientHeight,width:(e||this.$measureNode).clientWidth/256};return 0===t.width||0===t.height?null:t},this.$measureCharWidth=function(e){return this.$main.innerHTML=i.stringRepeat(e,256),this.$main.getBoundingClientRect().width/256},this.getCharacterWidth=function(e){var t=this.charSizes[e];return void 0===t&&(t=this.charSizes[e]=this.$measureCharWidth(e)/this.$characterSize.width),t},this.destroy=function(){clearInterval(this.$pollSizeChangesTimer),this.$observer&&this.$observer.disconnect(),this.el&&this.el.parentNode&&this.el.parentNode.removeChild(this.el)},this.$getZoom=function e(t){return t?(window.getComputedStyle(t).zoom||1)*e(t.parentElement):1},this.$initTransformMeasureNodes=function(){var e=function(e,t){return["div",{style:"position: absolute;top:"+e+"px;left:"+t+"px;"}]};this.els=t.buildDom([e(0,0),e(o,0),e(0,o),e(o,o)],this.el)},this.transformCoordinates=function(e,t){e&&(e=r(1/this.$getZoom(this.el),e));function i(e,t,i){var s=e[1]*t[0]-e[0]*t[1];return[(-t[1]*i[0]+t[0]*i[1])/s,(+e[1]*i[0]-e[0]*i[1])/s]}function s(e,t){return[e[0]-t[0],e[1]-t[1]]}function h(e,t){return[e[0]+t[0],e[1]+t[1]]}function r(e,t){return[e*t[0],e*t[1]]}function n(e){var t=e.getBoundingClientRect();return[t.left,t.top]}this.els||this.$initTransformMeasureNodes();var a=n(this.els[0]),l=n(this.els[1]),d=n(this.els[2]),c=n(this.els[3]),u=i(s(c,l),s(c,d),s(h(l,d),h(c,a))),$=r(1+u[0],s(l,a)),m=r(1+u[1],s(d,a));if(t){var f=t,g=u[0]*f[0]/o+u[1]*f[1]/o+1,v=h(r(f[0],$),r(f[1],m));return h(r(1/g/o,v),a)}var p=s(e,a),S=i(s($,r(u[0],p)),s(m,r(u[1],p)),p);return r(o,S)}}).call(a.prototype)});
//# sourceMappingURL=../sourcemaps/layer/font_metrics.js.map
