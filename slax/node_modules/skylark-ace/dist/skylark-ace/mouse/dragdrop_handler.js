/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(require,exports,module){"use strict";var e=require("../lib/dom"),t=require("../lib/event"),n=require("../lib/useragent"),r=200,i=200,a=5;function o(o){var d=o.editor,l=e.createElement("img");l.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",n.isOpera&&(l.style.cssText="width:1px;height:1px;position:fixed;top:0;left:0;z-index:2147483647;opacity:0;");["dragWait","dragWaitEnd","startDrag","dragReadyEnd","onMouseDrag"].forEach(function(e){o[e]=this[e]},this),d.addEventListener("mousedown",this.onMouseDown.bind(o));var c,u,g,h,f,v,m,y,D,p,w,E=d.container,A=0;function b(){var e=v;(function(e,t){var n=Date.now(),r=!t||e.row!=t.row,o=!t||e.column!=t.column;!p||r||o?(d.moveCursorToPosition(e),p=n,w={x:u,y:g}):s(w.x,w.y,u,g)>a?p=null:n-p>=i&&(d.renderer.scrollCursorIntoView(),p=null)})(v=d.renderer.screenToTextCoordinates(u,g),e),function(e,t){var n=Date.now(),i=d.renderer.layerConfig.lineHeight,a=d.renderer.layerConfig.characterWidth,o=d.renderer.scroller.getBoundingClientRect(),s={x:{left:u-o.left,right:o.right-u},y:{top:g-o.top,bottom:o.bottom-g}},l=Math.min(s.x.left,s.x.right),c=Math.min(s.y.top,s.y.bottom),h={row:e.row,column:e.column};l/a<=2&&(h.column+=s.x.left<s.x.right?-3:2),c/i<=1&&(h.row+=s.y.top<s.y.bottom?-1:1);var f=e.row!=h.row,v=e.column!=h.column,m=!t||e.row!=t.row;f||v&&!m?D?n-D>=r&&d.renderer.scrollCursorIntoView(h):D=n:D=null}(v,e)}function x(){f=d.selection.toOrientedRange(),c=d.session.addMarker(f,"ace_selection",d.getSelectionStyle()),d.clearSelection(),d.isFocused()&&d.renderer.$cursorLayer.setBlinking(!1),clearInterval(h),b(),h=setInterval(b,20),A=0,t.addListener(document,"mousemove",L)}function S(){clearInterval(h),d.session.removeMarker(c),c=null,d.selection.fromOrientedRange(f),d.isFocused()&&!y&&d.renderer.$cursorLayer.setBlinking(!d.getReadOnly()),f=null,v=null,A=0,D=null,p=null,t.removeListener(document,"mousemove",L)}this.onDragStart=function(e){if(this.cancelDrag||!E.draggable){var t=this;return setTimeout(function(){t.startSelect(),t.captureMouse(e)},0),e.preventDefault()}f=d.getSelectionRange();var r=e.dataTransfer;r.effectAllowed=d.getReadOnly()?"copy":"copyMove",n.isOpera&&(d.container.appendChild(l),l.scrollTop=0),r.setDragImage&&r.setDragImage(l,0,0),n.isOpera&&d.container.removeChild(l),r.clearData(),r.setData("Text",d.session.getTextRange()),y=!0,this.setState("drag")},this.onDragEnd=function(e){if(E.draggable=!1,y=!1,this.setState(null),!d.getReadOnly()){var t=e.dataTransfer.dropEffect;m||"move"!=t||d.session.remove(d.getSelectionRange()),d.renderer.$cursorLayer.setBlinking(!0)}this.editor.unsetStyle("ace_dragging"),this.editor.renderer.setCursorStyle("")},this.onDragEnter=function(e){if(!d.getReadOnly()&&M(e.dataTransfer))return u=e.clientX,g=e.clientY,c||x(),A++,e.dataTransfer.dropEffect=m=O(e),t.preventDefault(e)},this.onDragOver=function(e){if(!d.getReadOnly()&&M(e.dataTransfer))return u=e.clientX,g=e.clientY,c||(x(),A++),null!==T&&(T=null),e.dataTransfer.dropEffect=m=O(e),t.preventDefault(e)},this.onDragLeave=function(e){if(--A<=0&&c)return S(),m=null,t.preventDefault(e)},this.onDrop=function(e){if(v){var n=e.dataTransfer;if(y)switch(m){case"move":f=f.contains(v.row,v.column)?{start:v,end:v}:d.moveText(f,v);break;case"copy":f=d.moveText(f,v,!0)}else{var r=n.getData("Text");f={start:v,end:d.session.insert(v,r)},d.focus(),m=null}return S(),t.preventDefault(e)}},t.addListener(E,"dragstart",this.onDragStart.bind(o)),t.addListener(E,"dragend",this.onDragEnd.bind(o)),t.addListener(E,"dragenter",this.onDragEnter.bind(o)),t.addListener(E,"dragover",this.onDragOver.bind(o)),t.addListener(E,"dragleave",this.onDragLeave.bind(o)),t.addListener(E,"drop",this.onDrop.bind(o));var T=null;function L(){null==T&&(T=setTimeout(function(){null!=T&&c&&S()},20))}function M(e){var t=e.types;return!t||Array.prototype.some.call(t,function(e){return"text/plain"==e||"Text"==e})}function O(e){var t=["copy","copymove","all","uninitialized"],r=n.isMac?e.altKey:e.ctrlKey,i="uninitialized";try{i=e.dataTransfer.effectAllowed.toLowerCase()}catch(e){}var a="none";return r&&t.indexOf(i)>=0?a="copy":["move","copymove","linkmove","all","uninitialized"].indexOf(i)>=0?a="move":t.indexOf(i)>=0&&(a="copy"),a}}function s(e,t,n,r){return Math.sqrt(Math.pow(n-e,2)+Math.pow(r-t,2))}(function(){this.dragWait=function(){Date.now()-this.mousedownEvent.time>this.editor.getDragDelay()&&this.startDrag()},this.dragWaitEnd=function(){this.editor.container.draggable=!1,this.startSelect(this.mousedownEvent.getDocumentPosition()),this.selectEnd()},this.dragReadyEnd=function(e){this.editor.renderer.$cursorLayer.setBlinking(!this.editor.getReadOnly()),this.editor.unsetStyle("ace_dragging"),this.editor.renderer.setCursorStyle(""),this.dragWaitEnd()},this.startDrag=function(){this.cancelDrag=!1;var e=this.editor;e.container.draggable=!0,e.renderer.$cursorLayer.setBlinking(!1),e.setStyle("ace_dragging");var t=n.isWin?"default":"move";e.renderer.setCursorStyle(t),this.setState("dragReady")},this.onMouseDrag=function(e){var t=this.editor.container;n.isIE&&"dragReady"==this.state&&(s(this.mousedownEvent.x,this.mousedownEvent.y,this.x,this.y)>3&&t.dragDrop());"dragWait"===this.state&&(s(this.mousedownEvent.x,this.mousedownEvent.y,this.x,this.y)>0&&(t.draggable=!1,this.startSelect(this.mousedownEvent.getDocumentPosition())))},this.onMouseDown=function(e){if(this.$dragEnabled){this.mousedownEvent=e;var t=this.editor,r=e.inSelection(),i=e.getButton();if(1===(e.domEvent.detail||1)&&0===i&&r){if(e.editor.inMultiSelectMode&&(e.getAccelKey()||e.getShiftKey()))return;this.mousedownEvent.time=Date.now();var a=e.domEvent.target||e.domEvent.srcElement;if("unselectable"in a&&(a.unselectable="on"),t.getDragDelay()){if(n.isWebKit)this.cancelDrag=!0,t.container.draggable=!0;this.setState("dragWait")}else this.startDrag();this.captureMouse(e,this.onMouseDrag.bind(this)),e.defaultPrevented=!0}}}}).call(o.prototype),exports.DragdropHandler=o});
//# sourceMappingURL=../sourcemaps/mouse/dragdrop_handler.js.map
