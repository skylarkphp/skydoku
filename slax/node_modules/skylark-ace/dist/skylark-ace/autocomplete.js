/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(t,e,i){"use strict";var o=t("./keyboard/hash_handler").HashHandler,s=t("./autocomplete/popup").AcePopup,n=t("./autocomplete/util"),h=(t("./lib/event"),t("./lib/lang")),r=t("./lib/dom"),l=t("./snippets").snippetManager,p=function(){this.autoInsert=!1,this.autoSelect=!0,this.exactMatch=!1,this.gatherCompletionsId=0,this.keyboardHandler=new o,this.keyboardHandler.bindKeys(this.commands),this.blurListener=this.blurListener.bind(this),this.changeListener=this.changeListener.bind(this),this.mousedownListener=this.mousedownListener.bind(this),this.mousewheelListener=this.mousewheelListener.bind(this),this.changeTimer=h.delayedCall(function(){this.updateCompletions(!0)}.bind(this)),this.tooltipTimer=h.delayedCall(this.updateDocTooltip.bind(this),50)};(function(){this.$init=function(){return this.popup=new s(document.body||document.documentElement),this.popup.on("click",function(t){this.insertMatch(),t.stop()}.bind(this)),this.popup.focus=this.editor.focus.bind(this.editor),this.popup.on("show",this.tooltipTimer.bind(null,null)),this.popup.on("select",this.tooltipTimer.bind(null,null)),this.popup.on("changeHoverMarker",this.tooltipTimer.bind(null,null)),this.popup},this.getPopup=function(){return this.popup||this.$init()},this.openPopup=function(t,e,i){this.popup||this.$init(),this.popup.autoSelect=this.autoSelect,this.popup.setData(this.completions.filtered,this.completions.filterText),t.keyBinding.addKeyboardHandler(this.keyboardHandler);var o=t.renderer;if(this.popup.setRow(this.autoSelect?0:-1),i)i&&!e&&this.detach();else{this.popup.setTheme(t.getTheme()),this.popup.setFontSize(t.getFontSize());var s=o.layerConfig.lineHeight,n=o.$cursorLayer.getPixelPosition(this.base,!0);n.left-=this.popup.getTextLeftOffset();var h=t.container.getBoundingClientRect();n.top+=h.top-o.layerConfig.offset,n.left+=h.left-t.renderer.scrollLeft,n.left+=o.gutterWidth,this.popup.show(n,s)}},this.detach=function(){this.editor.keyBinding.removeKeyboardHandler(this.keyboardHandler),this.editor.off("changeSelection",this.changeListener),this.editor.off("blur",this.blurListener),this.editor.off("mousedown",this.mousedownListener),this.editor.off("mousewheel",this.mousewheelListener),this.changeTimer.cancel(),this.hideDocTooltip(),this.gatherCompletionsId+=1,this.popup&&this.popup.isOpen&&this.popup.hide(),this.base&&this.base.detach(),this.activated=!1,this.completions=this.base=null},this.changeListener=function(t){var e=this.editor.selection.lead;(e.row!=this.base.row||e.column<this.base.column)&&this.detach(),this.activated?this.changeTimer.schedule():this.detach()},this.blurListener=function(t){var e=document.activeElement,i=this.editor.textInput.getElement(),o=t.relatedTarget&&this.tooltipNode&&this.tooltipNode.contains(t.relatedTarget),s=this.popup&&this.popup.container;e==i||e.parentNode==s||o||e==this.tooltipNode||t.relatedTarget==i||this.detach()},this.mousedownListener=function(t){this.detach()},this.mousewheelListener=function(t){this.detach()},this.goTo=function(t){var e=this.popup.getRow(),i=this.popup.session.getLength()-1;switch(t){case"up":e=e<=0?i:e-1;break;case"down":e=e>=i?-1:e+1;break;case"start":e=0;break;case"end":e=i}this.popup.setRow(e)},this.insertMatch=function(t,e){if(t||(t=this.popup.getData(this.popup.getRow())),!t)return!1;if(t.completer&&t.completer.insertMatch)t.completer.insertMatch(this.editor,t);else{if(this.completions.filterText)for(var i,o=this.editor.selection.getAllRanges(),s=0;i=o[s];s++)i.start.column-=this.completions.filterText.length,this.editor.session.remove(i);t.snippet?l.insertSnippet(this.editor,t.snippet):this.editor.execCommand("insertstring",t.value||t)}this.detach()},this.commands={Up:function(t){t.completer.goTo("up")},Down:function(t){t.completer.goTo("down")},"Ctrl-Up|Ctrl-Home":function(t){t.completer.goTo("start")},"Ctrl-Down|Ctrl-End":function(t){t.completer.goTo("end")},Esc:function(t){t.completer.detach()},Return:function(t){return t.completer.insertMatch()},"Shift-Return":function(t){t.completer.insertMatch(null,{deleteSuffix:!0})},Tab:function(t){var e=t.completer.insertMatch();if(e||t.tabstopManager)return e;t.completer.goTo("down")},PageUp:function(t){t.completer.popup.gotoPageUp()},PageDown:function(t){t.completer.popup.gotoPageDown()}},this.gatherCompletions=function(t,e){var i=t.getSession(),o=t.getCursorPosition(),s=n.getCompletionPrefix(t);this.base=i.doc.createAnchor(o.row,o.column-s.length),this.base.$insertRight=!0;var h=[],r=t.completers.length;return t.completers.forEach(function(l,p){l.getCompletions(t,i,o,s,function(i,o){!i&&o&&(h=h.concat(o)),e(null,{prefix:n.getCompletionPrefix(t),matches:h,finished:0==--r})})}),!0},this.showPopup=function(t){this.editor&&this.detach(),this.activated=!0,this.editor=t,t.completer!=this&&(t.completer&&t.completer.detach(),t.completer=this),t.on("changeSelection",this.changeListener),t.on("blur",this.blurListener),t.on("mousedown",this.mousedownListener),t.on("mousewheel",this.mousewheelListener),this.updateCompletions()},this.updateCompletions=function(t){if(t&&this.base&&this.completions){var e=this.editor.getCursorPosition(),i=this.editor.session.getTextRange({start:this.base,end:e});if(i==this.completions.filterText)return;return this.completions.setFilter(i),this.completions.filtered.length?1!=this.completions.filtered.length||this.completions.filtered[0].value!=i||this.completions.filtered[0].snippet?void this.openPopup(this.editor,i,t):this.detach():this.detach()}var o=this.gatherCompletionsId;this.gatherCompletions(this.editor,function(e,i){var s=function(){if(i.finished)return this.detach()}.bind(this),n=i.prefix,h=i&&i.matches;if(!h||!h.length)return s();if(0===n.indexOf(i.prefix)&&o==this.gatherCompletionsId){this.completions=new c(h),this.exactMatch&&(this.completions.exactMatch=!0),this.completions.setFilter(n);var r=this.completions.filtered;return r.length&&(1!=r.length||r[0].value!=n||r[0].snippet)?this.autoInsert&&1==r.length&&i.finished?this.insertMatch(r[0]):void this.openPopup(this.editor,n,t):s()}}.bind(this))},this.cancelContextMenu=function(){this.editor.$mouseHandler.cancelContextMenu()},this.updateDocTooltip=function(){var t=this.popup,e=t.data,i=e&&(e[t.getHoveredRow()]||e[t.getRow()]),o=null;return i&&this.editor&&this.popup.isOpen?(this.editor.completers.some(function(t){return t.getDocTooltip&&(o=t.getDocTooltip(i)),o}),o||(o=i),"string"==typeof o&&(o={docText:o}),o&&(o.docHTML||o.docText)?void this.showDocTooltip(o):this.hideDocTooltip()):this.hideDocTooltip()},this.showDocTooltip=function(t){this.tooltipNode||(this.tooltipNode=r.createElement("div"),this.tooltipNode.className="ace_tooltip ace_doc-tooltip",this.tooltipNode.style.margin=0,this.tooltipNode.style.pointerEvents="auto",this.tooltipNode.tabIndex=-1,this.tooltipNode.onblur=this.blurListener.bind(this),this.tooltipNode.onclick=this.onTooltipClick.bind(this));var e=this.tooltipNode;t.docHTML?e.innerHTML=t.docHTML:t.docText&&(e.textContent=t.docText),e.parentNode||document.body.appendChild(e);var i=this.popup,o=i.container.getBoundingClientRect();e.style.top=i.container.style.top,e.style.bottom=i.container.style.bottom,e.style.display="block",window.innerWidth-o.right<320?o.left<320?i.isTopdown?(e.style.top=o.bottom+"px",e.style.left=o.left+"px",e.style.right="",e.style.bottom=""):(e.style.top=i.container.offsetTop-e.offsetHeight+"px",e.style.left=o.left+"px",e.style.right="",e.style.bottom=""):(e.style.right=window.innerWidth-o.left+"px",e.style.left=""):(e.style.left=o.right+1+"px",e.style.right="")},this.hideDocTooltip=function(){if(this.tooltipTimer.cancel(),this.tooltipNode){var t=this.tooltipNode;this.editor.isFocused()||document.activeElement!=t||this.editor.focus(),this.tooltipNode=null,t.parentNode&&t.parentNode.removeChild(t)}},this.onTooltipClick=function(t){for(var e=t.target;e&&e!=this.tooltipNode;){if("A"==e.nodeName&&e.href){e.rel="noreferrer",e.target="_blank";break}e=e.parentNode}}}).call(p.prototype),p.startCommand={name:"startAutocomplete",exec:function(t){t.completer||(t.completer=new p),t.completer.autoInsert=!1,t.completer.autoSelect=!0,t.completer.showPopup(t),t.completer.cancelContextMenu()},bindKey:"Ctrl-Space|Ctrl-Shift-Space|Alt-Space"};var c=function(t,e){this.all=t,this.filtered=t,this.filterText=e||"",this.exactMatch=!1};(function(){this.setFilter=function(t){if(t.length>this.filterText&&0===t.lastIndexOf(this.filterText,0))var e=this.filtered;else e=this.all;this.filterText=t;var i=null;e=(e=(e=this.filterCompletions(e,this.filterText)).sort(function(t,e){return e.exactMatch-t.exactMatch||e.$score-t.$score||(t.caption||t.value)<(e.caption||e.value)})).filter(function(t){var e=t.snippet||t.caption||t.value;return e!==i&&(i=e,!0)}),this.filtered=e},this.filterCompletions=function(t,e){var i=[],o=e.toUpperCase(),s=e.toLowerCase();t:for(var n,h=0;n=t[h];h++){var r=n.caption||n.value||n.snippet;if(r){var l,p,c=-1,a=0,d=0;if(this.exactMatch){if(e!==r.substr(0,e.length))continue t}else{var u=r.toLowerCase().indexOf(s);if(u>-1)d=u;else for(var f=0;f<e.length;f++){var m=r.indexOf(s[f],c+1),g=r.indexOf(o[f],c+1);if((l=m>=0&&(g<0||m<g)?m:g)<0)continue t;(p=l-c-1)>0&&(-1===c&&(d+=10),d+=p,a|=1<<f),c=l}}n.matchMask=a,n.exactMatch=d?0:1,n.$score=(n.score||0)-d,i.push(n)}}return i}}).call(c.prototype),e.Autocomplete=p,e.FilteredList=c});
//# sourceMappingURL=sourcemaps/autocomplete.js.map
