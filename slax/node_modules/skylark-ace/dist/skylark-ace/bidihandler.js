/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(require,exports,module){"use strict";var i=require("./lib/bidiutil"),t=require("./lib/lang"),s=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac\u202B]/,e=function(t){this.session=t,this.bidiMap={},this.currentRow=null,this.bidiUtil=i,this.charWidths=[],this.EOL="¬",this.showInvisibles=!0,this.isRtlDir=!1,this.$isRtl=!1,this.line="",this.wrapIndent=0,this.EOF="¶",this.RLE="‫",this.contentWidth=0,this.fontMetrics=null,this.rtlLineOffset=0,this.wrapOffset=0,this.isMoveLeftOperation=!1,this.seenBidi=s.test(t.getValue())};(function(){this.isBidiRow=function(i,t,s){return!!this.seenBidi&&(i!==this.currentRow&&(this.currentRow=i,this.updateRowLine(t,s),this.updateBidiMap()),this.bidiMap.bidiLevels)},this.onChange=function(i){this.seenBidi?this.currentRow=null:"insert"==i.action&&s.test(i.lines.join("\n"))&&(this.seenBidi=!0,this.currentRow=null)},this.getDocumentRow=function(){var i=0,t=this.session.$screenRowCache;if(t.length){var s=this.session.$getRowCacheIndex(t,this.currentRow);s>=0&&(i=this.session.$docRowCache[s])}return i},this.getSplitIndex=function(){var i=0,t=this.session.$screenRowCache;if(t.length)for(var s,e=this.session.$getRowCacheIndex(t,this.currentRow);this.currentRow-i>0&&(s=this.session.$getRowCacheIndex(t,this.currentRow-i-1))===e;)e=s,i++;else i=this.currentRow;return i},this.updateRowLine=function(s,e){void 0===s&&(s=this.getDocumentRow());var h=s===this.session.getLength()-1?this.EOF:this.EOL;if(this.wrapIndent=0,this.line=this.session.getLine(s),this.isRtlDir=this.$isRtl||this.line.charAt(0)===this.RLE,this.session.$useWrapMode){var n=this.session.$wrapData[s];n&&(void 0===e&&(e=this.getSplitIndex()),e>0&&n.length?(this.wrapIndent=n.indent,this.wrapOffset=this.wrapIndent*this.charWidths[i.L],this.line=e<n.length?this.line.substring(n[e-1],n[e]):this.line.substring(n[n.length-1])):this.line=this.line.substring(0,n[e])),e==n.length&&(this.line+=this.showInvisibles?h:i.DOT)}else this.line+=this.showInvisibles?h:i.DOT;var r,a=this.session,o=0;this.line=this.line.replace(/\t|[\u1100-\u2029, \u202F-\uFFE6]/g,function(s,e){return"\t"===s||a.isFullWidth(s.charCodeAt(0))?(r="\t"===s?a.getScreenTabSize(e+o):2,o+=r-1,t.stringRepeat(i.DOT,r)):s}),this.isRtlDir&&(this.fontMetrics.$main.textContent=this.line.charAt(this.line.length-1)==i.DOT?this.line.substr(0,this.line.length-1):this.line,this.rtlLineOffset=this.contentWidth-this.fontMetrics.$main.getBoundingClientRect().width)},this.updateBidiMap=function(){var t=[];i.hasBidiCharacters(this.line,t)||this.isRtlDir?this.bidiMap=i.doBidiReorder(this.line,t,this.isRtlDir):this.bidiMap={}},this.markAsDirty=function(){this.currentRow=null},this.updateCharacterWidths=function(t){if(this.characterWidth!==t.$characterSize.width){this.fontMetrics=t;var s=this.characterWidth=t.$characterSize.width,e=t.$measureCharWidth("ה");this.charWidths[i.L]=this.charWidths[i.EN]=this.charWidths[i.ON_R]=s,this.charWidths[i.R]=this.charWidths[i.AN]=e,this.charWidths[i.R_H]=.45*e,this.charWidths[i.B]=this.charWidths[i.RLE]=0,this.currentRow=null}},this.setShowInvisibles=function(i){this.showInvisibles=i,this.currentRow=null},this.setEolChar=function(i){this.EOL=i},this.setContentWidth=function(i){this.contentWidth=i},this.isRtlLine=function(i){return!!this.$isRtl||(void 0!=i?this.session.getLine(i).charAt(0)==this.RLE:this.isRtlDir)},this.setRtlDirection=function(i,t){for(var s=i.getCursorPosition(),e=i.selection.getSelectionAnchor().row;e<=s.row;e++)t||i.session.getLine(e).charAt(0)!==i.session.$bidiHandler.RLE?t&&i.session.getLine(e).charAt(0)!==i.session.$bidiHandler.RLE&&i.session.doc.insert({column:0,row:e},i.session.$bidiHandler.RLE):i.session.doc.removeInLine(e,0,1)},this.getPosLeft=function(t){t-=this.wrapIndent;var s=this.line.charAt(0)===this.RLE?1:0,e=t>s?this.session.getOverwrite()?t:t-1:s,h=i.getVisualFromLogicalIdx(e,this.bidiMap),n=this.bidiMap.bidiLevels,r=0;!this.session.getOverwrite()&&t<=s&&n[h]%2!=0&&h++;for(var a=0;a<h;a++)r+=this.charWidths[n[a]];return!this.session.getOverwrite()&&t>s&&n[h]%2==0&&(r+=this.charWidths[n[h]]),this.wrapIndent&&(r+=this.isRtlDir?-1*this.wrapOffset:this.wrapOffset),this.isRtlDir&&(r+=this.rtlLineOffset),r},this.getSelections=function(i,t){var s,e=this.bidiMap,h=e.bidiLevels,n=[],r=0,a=Math.min(i,t)-this.wrapIndent,o=Math.max(i,t)-this.wrapIndent,l=!1,c=!1,d=0;this.wrapIndent&&(r+=this.isRtlDir?-1*this.wrapOffset:this.wrapOffset);for(var u,f=0;f<h.length;f++)u=e.logicalFromVisual[f],s=h[f],(l=u>=a&&u<o)&&!c?d=r:!l&&c&&n.push({left:d,width:r-d}),r+=this.charWidths[s],c=l;if(l&&f===h.length&&n.push({left:d,width:r-d}),this.isRtlDir)for(var w=0;w<n.length;w++)n[w].left+=this.rtlLineOffset;return n},this.offsetToCol=function(i){this.isRtlDir&&(i-=this.rtlLineOffset);var t=0,s=(i=Math.max(i,0),0),e=0,h=this.bidiMap.bidiLevels,n=this.charWidths[h[e]];for(this.wrapIndent&&(i-=this.isRtlDir?-1*this.wrapOffset:this.wrapOffset);i>s+n/2;){if(s+=n,e===h.length-1){n=0;break}n=this.charWidths[h[++e]]}return e>0&&h[e-1]%2!=0&&h[e]%2==0?(i<s&&e--,t=this.bidiMap.logicalFromVisual[e]):e>0&&h[e-1]%2==0&&h[e]%2!=0?t=1+(i>s?this.bidiMap.logicalFromVisual[e]:this.bidiMap.logicalFromVisual[e-1]):this.isRtlDir&&e===h.length-1&&0===n&&h[e-1]%2==0||!this.isRtlDir&&0===e&&h[e]%2!=0?t=1+this.bidiMap.logicalFromVisual[e]:(e>0&&h[e-1]%2!=0&&0!==n&&e--,t=this.bidiMap.logicalFromVisual[e]),0===t&&this.isRtlDir&&t++,t+this.wrapIndent}}).call(e.prototype),exports.BidiHandler=e});
//# sourceMappingURL=sourcemaps/bidihandler.js.map
