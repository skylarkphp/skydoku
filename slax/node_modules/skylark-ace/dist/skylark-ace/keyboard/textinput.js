/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(e,t,n){"use strict";var o=e("../lib/event"),i=e("../lib/useragent"),r=e("../lib/dom"),s=e("../lib/lang"),a=i.isChrome<18,u=i.isIE,c=i.isChrome>63,l=e("../lib/keys"),d=l.KEY_MODS,f=i.isIOS,p=f?/\s/:/\n/;t.TextInput=function(e,t){var n=r.createElement("textarea");n.className="ace_text-input",n.setAttribute("wrap","off"),n.setAttribute("autocorrect","off"),n.setAttribute("autocapitalize","off"),n.setAttribute("spellcheck",!1),n.style.opacity="0",e.insertBefore(n,e.firstChild);var m=!1,v=!1,h=!1,g=!1,y="";i.isMobile||(n.style.fontSize="1px");var x=!1,C=!1,E="",T=0,b=0;try{var L=document.activeElement===n}catch(e){}o.addListener(n,"blur",function(e){C||(t.onBlur(e),L=!1)}),o.addListener(n,"focus",function(e){if(!C){if(L=!0,i.isEdge)try{if(!document.hasFocus())return}catch(e){}t.onFocus(e),i.isEdge?setTimeout(S):S()}}),this.$focusScroll=!1,this.focus=function(){if(y||c||"browser"==this.$focusScroll)return n.focus({preventScroll:!0});var e=n.style.top;n.style.position="fixed",n.style.top="0px";try{var t=0!=n.getBoundingClientRect().top}catch(e){return}var o=[];if(t)for(var i=n.parentElement;i&&1==i.nodeType;)o.push(i),i.setAttribute("ace_nocontext",!0),i=!i.parentElement&&i.getRootNode?i.getRootNode().host:i.parentElement;n.focus({preventScroll:!0}),t&&o.forEach(function(e){e.removeAttribute("ace_nocontext")}),setTimeout(function(){n.style.position="","0px"==n.style.top&&(n.style.top=e)},0)},this.blur=function(){n.blur()},this.isFocused=function(){return L},t.on("beforeEndOperation",function(){t.curOp&&"insertstring"==t.curOp.command.name||(h&&(E=n.value="",K()),S())});var S=f?function(e){if(L&&(!m||e)&&!g){e||(e="");var o="\n ab"+e+"cde fg\n";o!=n.value&&(n.value=E=o);var i=4+(e.length||(t.selection.isEmpty()?0:1));4==T&&b==i||n.setSelectionRange(4,i),T=4,b=i}}:function(){if(!h&&!g&&(L||w)){h=!0;var e=t.selection,o=e.getRange(),i=e.cursor.row,r=o.start.column,s=o.end.column,a=t.session.getLine(i);if(o.start.row!=i){var u=t.session.getLine(i-1);r=o.start.row<i-1?0:r,s+=u.length+1,a=u+"\n"+a}else if(o.end.row!=i){var c=t.session.getLine(i+1);s=o.end.row>i+1?c.length:s,s+=a.length+1,a=a+"\n"+c}a.length>400&&(r<400&&s<400?a=a.slice(0,400):(a="\n",r=0,s=1));var l=a+"\n\n";if(l!=E&&(n.value=E=l,T=b=l.length),w&&(T=n.selectionStart,b=n.selectionEnd),b!=s||T!=r||n.selectionEnd!=b)try{n.setSelectionRange(r,s),T=r,b=s}catch(e){}h=!1}};L&&t.onFocus();var k=null;this.setInputHandler=function(e){k=e},this.getInputHandler=function(){return k};var w=!1,I=function(e,o){if(w&&(w=!1),v)return S(),e&&t.onPaste(e),v=!1,"";for(var i=n.selectionStart,r=n.selectionEnd,s=T,a=E.length-b,u=e,c=e.length-i,l=e.length-r,d=0;s>0&&E[d]==e[d];)d++,s--;for(u=u.slice(d),d=1;a>0&&E.length-d>T-1&&E[E.length-d]==e[e.length-d];)d++,a--;return c-=d-1,l-=d-1,u=u.slice(0,u.length-d+1),o||c!=u.length||s||a||l?(g=!0,u&&!s&&!a&&!c&&!l||x?t.onTextInput(u):t.onTextInput(u,{extendLeft:s,extendRight:a,restoreStart:c,restoreEnd:l}),g=!1,E=e,T=i,b=r,u):""},A=function(e){if(h)return F();var t=n.value,o=I(t,!0);(t.length>500||p.test(o))&&S()},R=function(e,t,n){var o=e.clipboardData||window.clipboardData;if(o&&!a){var i=u||n?"Text":"text/plain";try{return t?!1!==o.setData(i,t):o.getData(i)}catch(e){if(!n)return R(e,t,!0)}}},M=function(e,i){var r=t.getCopyText();if(!r)return o.preventDefault(e);R(e,r)?(f&&(S(r),m=r,setTimeout(function(){m=!1},10)),i?t.onCut():t.onCopy(),o.preventDefault(e)):(m=!0,n.value=r,n.select(),setTimeout(function(){m=!1,S(),i?t.onCut():t.onCopy()}))},O=function(e){M(e,!0)},$=function(e){M(e,!1)},D=function(e){var r=R(e);"string"==typeof r?(r&&t.onPaste(r,e),i.isIE&&setTimeout(S),o.preventDefault(e)):(n.value="",v=!0)};o.addCommandKeyListener(n,t.onCommandKey.bind(t)),o.addListener(n,"select",function(e){h||(m?m=!1:function(e){return 0===e.selectionStart&&e.selectionEnd>=E.length&&e.value===E&&E&&e.selectionEnd!==b}(n)&&(t.selectAll(),S()))}),o.addListener(n,"input",A),o.addListener(n,"cut",O),o.addListener(n,"copy",$),o.addListener(n,"paste",D),"oncut"in n&&"oncopy"in n&&"onpaste"in n||o.addListener(e,"keydown",function(e){if((!i.isMac||e.metaKey)&&e.ctrlKey)switch(e.keyCode){case 67:$(e);break;case 86:D(e);break;case 88:O(e)}});var F=function(){if(h&&t.onCompositionUpdate&&!t.$readOnly){if(x)return W();if(h.useTextareaForIME)t.onCompositionUpdate(n.value);else{var e=n.value;I(e),h.markerRange&&(h.context&&(h.markerRange.start.column=h.selectionStart=h.context.compositionStartOffset),h.markerRange.end.column=h.markerRange.start.column+b-h.selectionStart)}}},K=function(e){t.onCompositionEnd&&!t.$readOnly&&(h=!1,t.onCompositionEnd(),t.off("mousedown",W),e&&A())};function W(){C=!0,n.blur(),n.focus(),C=!1}var _,B=s.delayedCall(F,50).schedule.bind(null,null);function z(){clearTimeout(_),_=setTimeout(function(){y&&(n.style.cssText=y,y=""),null==t.renderer.$keepTextAreaAtCursor&&(t.renderer.$keepTextAreaAtCursor=!0,t.renderer.$moveTextAreaToCursor())},0)}o.addListener(n,"compositionstart",function(e){if(!h&&t.onCompositionStart&&!t.$readOnly&&(h={},!x)){setTimeout(F,0),t.on("mousedown",W);var o=t.getSelectionRange();o.end.row=o.start.row,o.end.column=o.start.column,h.markerRange=o,h.selectionStart=T,t.onCompositionStart(h),h.useTextareaForIME?(n.value="",E="",T=0,b=0):(n.msGetInputContext&&(h.context=n.msGetInputContext()),n.getInputContext&&(h.context=n.getInputContext()))}}),o.addListener(n,"compositionupdate",F),o.addListener(n,"keyup",function(e){27==e.keyCode&&n.value.length<n.selectionStart&&(h||(E=n.value),T=b=-1,S()),B()}),o.addListener(n,"keydown",B),o.addListener(n,"compositionend",K),this.getElement=function(){return n},this.setCommandMode=function(e){x=e,n.readOnly=!1},this.setReadOnly=function(e){x||(n.readOnly=e)},this.setCopyWithEmptySelection=function(e){},this.onContextMenu=function(e){w=!0,S(),t._emit("nativecontextmenu",{target:t,domEvent:e}),this.moveToMouse(e,!0)},this.moveToMouse=function(e,s){y||(y=n.style.cssText),n.style.cssText=(s?"z-index:100000;":"")+(i.isIE?"opacity:0.1;":"")+"text-indent: -"+(T+b)*t.renderer.characterWidth*.5+"px;";var a=t.container.getBoundingClientRect(),u=r.computedStyle(t.container),c=a.top+(parseInt(u.borderTopWidth)||0),l=a.left+(parseInt(a.borderLeftWidth)||0),d=a.bottom-c-n.clientHeight-2,f=function(e){n.style.left=e.clientX-l-2+"px",n.style.top=Math.min(e.clientY-c-2,d)+"px"};f(e),"mousedown"==e.type&&(t.renderer.$keepTextAreaAtCursor&&(t.renderer.$keepTextAreaAtCursor=null),clearTimeout(_),i.isWin&&o.capture(t.container,f,z))},this.onContextMenuClose=z;var H=function(e){t.textInput.onContextMenu(e),z()};o.addListener(n,"mouseup",H),o.addListener(n,"mousedown",function(e){e.preventDefault(),z()}),o.addListener(t.renderer.scroller,"contextmenu",H),o.addListener(n,"contextmenu",H),f&&function(e,t,n){var o=null,i=!1;n.addEventListener("keydown",function(e){o&&clearTimeout(o),i=!0},!0),n.addEventListener("keyup",function(e){o=setTimeout(function(){i=!1},100)},!0);var r=function(e){if(document.activeElement===n&&!i&&!h&&!m){var o=n.selectionStart,r=n.selectionEnd,s=null,a=0;console.log(o,r),0==o?s=l.up:1==o?s=l.home:r>b&&"\n"==E[r]?s=l.end:o<T&&" "==E[o-1]?(s=l.left,a=d.option):o<T||o==T&&b!=T&&o==r?s=l.left:r>b&&E.slice(0,r).split("\n").length>2?s=l.down:r>b&&" "==E[r-1]?(s=l.right,a=d.option):(r>b||r==b&&b!=T&&o==r)&&(s=l.right),o!==r&&(a|=d.shift),s&&(t.onCommandKey(null,a,s),T=o,b=r,S(""))}};document.addEventListener("selectionchange",r),t.on("destroy",function(){document.removeEventListener("selectionchange",r)})}(0,t,n)}});
//# sourceMappingURL=../sourcemaps/keyboard/textinput.js.map
