/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(require,exports,module){"use strict";var e=require("../lib/event"),t=require("../lib/useragent"),n=require("../lib/dom"),o=require("../lib/lang"),i=t.isChrome<18,r=t.isIE,s=t.isChrome>63,a=require("../lib/keys"),u=a.KEY_MODS,c=t.isIOS,l=c?/\s/:/\n/;exports.TextInput=function(d,f){var p=n.createElement("textarea");p.className="ace_text-input",p.setAttribute("wrap","off"),p.setAttribute("autocorrect","off"),p.setAttribute("autocapitalize","off"),p.setAttribute("spellcheck",!1),p.style.opacity="0",d.insertBefore(p,d.firstChild);var m=!1,v=!1,h=!1,g=!1,y="";t.isMobile||(p.style.fontSize="1px");var x=!1,C=!1,E="",T=0,b=0;try{var L=document.activeElement===p}catch(e){}e.addListener(p,"blur",function(e){C||(f.onBlur(e),L=!1)}),e.addListener(p,"focus",function(e){if(!C){if(L=!0,t.isEdge)try{if(!document.hasFocus())return}catch(e){}f.onFocus(e),t.isEdge?setTimeout(S):S()}}),this.$focusScroll=!1,this.focus=function(){if(y||s||"browser"==this.$focusScroll)return p.focus({preventScroll:!0});var e=p.style.top;p.style.position="fixed",p.style.top="0px";try{var t=0!=p.getBoundingClientRect().top}catch(e){return}var n=[];if(t)for(var o=p.parentElement;o&&1==o.nodeType;)n.push(o),o.setAttribute("ace_nocontext",!0),o=!o.parentElement&&o.getRootNode?o.getRootNode().host:o.parentElement;p.focus({preventScroll:!0}),t&&n.forEach(function(e){e.removeAttribute("ace_nocontext")}),setTimeout(function(){p.style.position="","0px"==p.style.top&&(p.style.top=e)},0)},this.blur=function(){p.blur()},this.isFocused=function(){return L},f.on("beforeEndOperation",function(){f.curOp&&"insertstring"==f.curOp.command.name||(h&&(E=p.value="",K()),S())});var S=c?function(e){if(L&&(!m||e)&&!g){e||(e="");var t="\n ab"+e+"cde fg\n";t!=p.value&&(p.value=E=t);var n=4+(e.length||(f.selection.isEmpty()?0:1));4==T&&b==n||p.setSelectionRange(4,n),T=4,b=n}}:function(){if(!h&&!g&&(L||w)){h=!0;var e=f.selection,t=e.getRange(),n=e.cursor.row,o=t.start.column,i=t.end.column,r=f.session.getLine(n);if(t.start.row!=n){var s=f.session.getLine(n-1);o=t.start.row<n-1?0:o,i+=s.length+1,r=s+"\n"+r}else if(t.end.row!=n){var a=f.session.getLine(n+1);i=t.end.row>n+1?a.length:i,i+=r.length+1,r=r+"\n"+a}r.length>400&&(o<400&&i<400?r=r.slice(0,400):(r="\n",o=0,i=1));var u=r+"\n\n";if(u!=E&&(p.value=E=u,T=b=u.length),w&&(T=p.selectionStart,b=p.selectionEnd),b!=i||T!=o||p.selectionEnd!=b)try{p.setSelectionRange(o,i),T=o,b=i}catch(e){}h=!1}};L&&f.onFocus();var k=null;this.setInputHandler=function(e){k=e},this.getInputHandler=function(){return k};var w=!1,I=function(e,t){if(w&&(w=!1),v)return S(),e&&f.onPaste(e),v=!1,"";for(var n=p.selectionStart,o=p.selectionEnd,i=T,r=E.length-b,s=e,a=e.length-n,u=e.length-o,c=0;i>0&&E[c]==e[c];)c++,i--;for(s=s.slice(c),c=1;r>0&&E.length-c>T-1&&E[E.length-c]==e[e.length-c];)c++,r--;return a-=c-1,u-=c-1,s=s.slice(0,s.length-c+1),t||a!=s.length||i||r||u?(g=!0,s&&!i&&!r&&!a&&!u||x?f.onTextInput(s):f.onTextInput(s,{extendLeft:i,extendRight:r,restoreStart:a,restoreEnd:u}),g=!1,E=e,T=n,b=o,s):""},A=function(e){if(h)return F();var t=p.value,n=I(t,!0);(t.length>500||l.test(n))&&S()},R=function(e,t,n){var o=e.clipboardData||window.clipboardData;if(o&&!i){var s=r||n?"Text":"text/plain";try{return t?!1!==o.setData(s,t):o.getData(s)}catch(e){if(!n)return R(e,t,!0)}}},M=function(t,n){var o=f.getCopyText();if(!o)return e.preventDefault(t);R(t,o)?(c&&(S(o),m=o,setTimeout(function(){m=!1},10)),n?f.onCut():f.onCopy(),e.preventDefault(t)):(m=!0,p.value=o,p.select(),setTimeout(function(){m=!1,S(),n?f.onCut():f.onCopy()}))},O=function(e){M(e,!0)},$=function(e){M(e,!1)},D=function(n){var o=R(n);"string"==typeof o?(o&&f.onPaste(o,n),t.isIE&&setTimeout(S),e.preventDefault(n)):(p.value="",v=!0)};e.addCommandKeyListener(p,f.onCommandKey.bind(f)),e.addListener(p,"select",function(e){h||(m?m=!1:function(e){return 0===e.selectionStart&&e.selectionEnd>=E.length&&e.value===E&&E&&e.selectionEnd!==b}(p)&&(f.selectAll(),S()))}),e.addListener(p,"input",A),e.addListener(p,"cut",O),e.addListener(p,"copy",$),e.addListener(p,"paste",D),"oncut"in p&&"oncopy"in p&&"onpaste"in p||e.addListener(d,"keydown",function(e){if((!t.isMac||e.metaKey)&&e.ctrlKey)switch(e.keyCode){case 67:$(e);break;case 86:D(e);break;case 88:O(e)}});var F=function(){if(h&&f.onCompositionUpdate&&!f.$readOnly){if(x)return W();if(h.useTextareaForIME)f.onCompositionUpdate(p.value);else{var e=p.value;I(e),h.markerRange&&(h.context&&(h.markerRange.start.column=h.selectionStart=h.context.compositionStartOffset),h.markerRange.end.column=h.markerRange.start.column+b-h.selectionStart)}}},K=function(e){f.onCompositionEnd&&!f.$readOnly&&(h=!1,f.onCompositionEnd(),f.off("mousedown",W),e&&A())};function W(){C=!0,p.blur(),p.focus(),C=!1}var _,B=o.delayedCall(F,50).schedule.bind(null,null);function z(){clearTimeout(_),_=setTimeout(function(){y&&(p.style.cssText=y,y=""),null==f.renderer.$keepTextAreaAtCursor&&(f.renderer.$keepTextAreaAtCursor=!0,f.renderer.$moveTextAreaToCursor())},0)}e.addListener(p,"compositionstart",function(e){if(!h&&f.onCompositionStart&&!f.$readOnly&&(h={},!x)){setTimeout(F,0),f.on("mousedown",W);var t=f.getSelectionRange();t.end.row=t.start.row,t.end.column=t.start.column,h.markerRange=t,h.selectionStart=T,f.onCompositionStart(h),h.useTextareaForIME?(p.value="",E="",T=0,b=0):(p.msGetInputContext&&(h.context=p.msGetInputContext()),p.getInputContext&&(h.context=p.getInputContext()))}}),e.addListener(p,"compositionupdate",F),e.addListener(p,"keyup",function(e){27==e.keyCode&&p.value.length<p.selectionStart&&(h||(E=p.value),T=b=-1,S()),B()}),e.addListener(p,"keydown",B),e.addListener(p,"compositionend",K),this.getElement=function(){return p},this.setCommandMode=function(e){x=e,p.readOnly=!1},this.setReadOnly=function(e){x||(p.readOnly=e)},this.setCopyWithEmptySelection=function(e){},this.onContextMenu=function(e){w=!0,S(),f._emit("nativecontextmenu",{target:f,domEvent:e}),this.moveToMouse(e,!0)},this.moveToMouse=function(o,i){y||(y=p.style.cssText),p.style.cssText=(i?"z-index:100000;":"")+(t.isIE?"opacity:0.1;":"")+"text-indent: -"+(T+b)*f.renderer.characterWidth*.5+"px;";var r=f.container.getBoundingClientRect(),s=n.computedStyle(f.container),a=r.top+(parseInt(s.borderTopWidth)||0),u=r.left+(parseInt(r.borderLeftWidth)||0),c=r.bottom-a-p.clientHeight-2,l=function(e){p.style.left=e.clientX-u-2+"px",p.style.top=Math.min(e.clientY-a-2,c)+"px"};l(o),"mousedown"==o.type&&(f.renderer.$keepTextAreaAtCursor&&(f.renderer.$keepTextAreaAtCursor=null),clearTimeout(_),t.isWin&&e.capture(f.container,l,z))},this.onContextMenuClose=z;var H=function(e){f.textInput.onContextMenu(e),z()};e.addListener(p,"mouseup",H),e.addListener(p,"mousedown",function(e){e.preventDefault(),z()}),e.addListener(f.renderer.scroller,"contextmenu",H),e.addListener(p,"contextmenu",H),c&&function(e,t,n){var o=null,i=!1;n.addEventListener("keydown",function(e){o&&clearTimeout(o),i=!0},!0),n.addEventListener("keyup",function(e){o=setTimeout(function(){i=!1},100)},!0);var r=function(e){if(document.activeElement===n&&!i&&!h&&!m){var o=n.selectionStart,r=n.selectionEnd,s=null,c=0;console.log(o,r),0==o?s=a.up:1==o?s=a.home:r>b&&"\n"==E[r]?s=a.end:o<T&&" "==E[o-1]?(s=a.left,c=u.option):o<T||o==T&&b!=T&&o==r?s=a.left:r>b&&E.slice(0,r).split("\n").length>2?s=a.down:r>b&&" "==E[r-1]?(s=a.right,c=u.option):(r>b||r==b&&b!=T&&o==r)&&(s=a.right),o!==r&&(c|=u.shift),s&&(t.onCommandKey(null,c,s),T=o,b=r,S(""))}};document.addEventListener("selectionchange",r),t.on("destroy",function(){document.removeEventListener("selectionchange",r)})}(0,f,p)}});
//# sourceMappingURL=../sourcemaps/keyboard/textinput.js.map
