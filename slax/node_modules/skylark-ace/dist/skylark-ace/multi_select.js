/**
 * skylark-ace - A version of ace v1.4.3 that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(function(require,exports,module){var e=require("./range_list").RangeList,t=require("./range").Range,n=require("./selection").Selection,i=require("./mouse/multi_select_handler").onMouseDown,s=require("./lib/event"),r=require("./lib/lang"),o=require("./commands/multi_select_commands");exports.commands=o.defaultCommands.concat(o.multiSelectCommands);var l=new(0,require("./search").Search);var a=require("./edit_session").EditSession;(function(){this.getSelectionMarkers=function(){return this.$selectionMarkers}}).call(a.prototype),function(){this.ranges=null,this.rangeList=null,this.addRange=function(e,t){if(e){if(!this.inMultiSelectMode&&0===this.rangeCount){var n=this.toOrientedRange();if(this.rangeList.add(n),this.rangeList.add(e),2!=this.rangeList.ranges.length)return this.rangeList.removeAll(),t||this.fromOrientedRange(e);this.rangeList.removeAll(),this.rangeList.add(n),this.$onAddRange(n)}e.cursor||(e.cursor=e.end);var i=this.rangeList.add(e);return this.$onAddRange(e),i.length&&this.$onRemoveRange(i),this.rangeCount>1&&!this.inMultiSelectMode&&(this._signal("multiSelect"),this.inMultiSelectMode=!0,this.session.$undoSelect=!1,this.rangeList.attach(this.session)),t||this.fromOrientedRange(e)}},this.toSingleRange=function(e){e=e||this.ranges[0];var t=this.rangeList.removeAll();t.length&&this.$onRemoveRange(t),e&&this.fromOrientedRange(e)},this.substractPoint=function(e){var t=this.rangeList.substractPoint(e);if(t)return this.$onRemoveRange(t),t[0]},this.mergeOverlappingRanges=function(){var e=this.rangeList.merge();e.length&&this.$onRemoveRange(e)},this.$onAddRange=function(e){this.rangeCount=this.rangeList.ranges.length,this.ranges.unshift(e),this._signal("addRange",{range:e})},this.$onRemoveRange=function(e){if(this.rangeCount=this.rangeList.ranges.length,1==this.rangeCount&&this.inMultiSelectMode){var t=this.rangeList.ranges.pop();e.push(t),this.rangeCount=0}for(var n=e.length;n--;){var i=this.ranges.indexOf(e[n]);this.ranges.splice(i,1)}this._signal("removeRange",{ranges:e}),0===this.rangeCount&&this.inMultiSelectMode&&(this.inMultiSelectMode=!1,this._signal("singleSelect"),this.session.$undoSelect=!0,this.rangeList.detach(this.session)),(t=t||this.ranges[0])&&!t.isEqual(this.getRange())&&this.fromOrientedRange(t)},this.$initRangeList=function(){this.rangeList||(this.rangeList=new e,this.ranges=[],this.rangeCount=0)},this.getAllRanges=function(){return this.rangeCount?this.rangeList.ranges.concat():[this.getRange()]},this.splitIntoLines=function(){if(this.rangeCount>1){var e=this.rangeList.ranges,n=e[e.length-1],i=t.fromPoints(e[0].start,n.end);this.toSingleRange(),this.setSelectionRange(i,n.cursor==n.start)}else{i=this.getRange();var s=this.isBackwards(),r=i.start.row,o=i.end.row;if(r==o){if(s)var l=i.end,a=i.start;else l=i.start,a=i.end;return this.addRange(t.fromPoints(a,a)),void this.addRange(t.fromPoints(l,l))}var c=[],h=this.getLineRange(r,!0);h.start.column=i.start.column,c.push(h);for(var u=r+1;u<o;u++)c.push(this.getLineRange(u,!0));(h=this.getLineRange(o,!0)).end.column=i.end.column,c.push(h),c.forEach(this.addRange,this)}},this.toggleBlockSelection=function(){if(this.rangeCount>1){var e=this.rangeList.ranges,n=e[e.length-1],i=t.fromPoints(e[0].start,n.end);this.toSingleRange(),this.setSelectionRange(i,n.cursor==n.start)}else{var s=this.session.documentToScreenPosition(this.cursor),r=this.session.documentToScreenPosition(this.anchor);this.rectangularRangeBlock(s,r).forEach(this.addRange,this)}},this.rectangularRangeBlock=function(e,n,i){var s=[],r=e.column<n.column;if(r)var o=e.column,l=n.column,a=e.offsetX,c=n.offsetX;else o=n.column,l=e.column,a=n.offsetX,c=e.offsetX;var h,u,g,d=e.row<n.row;if(d)var m=e.row,f=n.row;else m=n.row,f=e.row;o<0&&(o=0),m<0&&(m=0),m==f&&(i=!0);for(var S=m;S<=f;S++){var v=t.fromPoints(this.session.screenToDocumentPosition(S,o,a),this.session.screenToDocumentPosition(S,l,c));if(v.isEmpty()){if(h&&(u=v.end,g=h,u.row==g.row&&u.column==g.column))break;h=v.end}v.cursor=r?v.start:v.end,s.push(v)}if(d&&s.reverse(),!i){for(var R=s.length-1;s[R].isEmpty()&&R>0;)R--;if(R>0)for(var M=0;s[M].isEmpty();)M++;for(var p=R;p>=M;p--)s[p].isEmpty()&&s.splice(p,1)}return s}}.call(n.prototype);var c=require("./editor").Editor;function h(e){e.$multiselectOnSessionChange||(e.$onAddRange=e.$onAddRange.bind(e),e.$onRemoveRange=e.$onRemoveRange.bind(e),e.$onMultiSelect=e.$onMultiSelect.bind(e),e.$onSingleSelect=e.$onSingleSelect.bind(e),e.$multiselectOnSessionChange=exports.onSessionChange.bind(e),e.$checkMultiselectChange=e.$checkMultiselectChange.bind(e),e.$multiselectOnSessionChange(e),e.on("changeSession",e.$multiselectOnSessionChange),e.on("mousedown",i),e.commands.addCommands(o.defaultCommands),function(e){var t=e.textInput.getElement(),n=!1;function i(t){n&&(e.renderer.setMouseCursor(""),n=!1)}s.addListener(t,"keydown",function(t){var s=18==t.keyCode&&!(t.ctrlKey||t.shiftKey||t.metaKey);e.$blockSelectEnabled&&s?n||(e.renderer.setMouseCursor("crosshair"),n=!0):n&&i()}),s.addListener(t,"keyup",i),s.addListener(t,"blur",i)}(e))}(function(){this.updateSelectionMarkers=function(){this.renderer.updateCursor(),this.renderer.updateBackMarkers()},this.addSelectionMarker=function(e){e.cursor||(e.cursor=e.end);var t=this.getSelectionStyle();return e.marker=this.session.addMarker(e,"ace_selection",t),this.session.$selectionMarkers.push(e),this.session.selectionMarkerCount=this.session.$selectionMarkers.length,e},this.removeSelectionMarker=function(e){if(e.marker){this.session.removeMarker(e.marker);var t=this.session.$selectionMarkers.indexOf(e);-1!=t&&this.session.$selectionMarkers.splice(t,1),this.session.selectionMarkerCount=this.session.$selectionMarkers.length}},this.removeSelectionMarkers=function(e){for(var t=this.session.$selectionMarkers,n=e.length;n--;){var i=e[n];if(i.marker){this.session.removeMarker(i.marker);var s=t.indexOf(i);-1!=s&&t.splice(s,1)}}this.session.selectionMarkerCount=t.length},this.$onAddRange=function(e){this.addSelectionMarker(e.range),this.renderer.updateCursor(),this.renderer.updateBackMarkers()},this.$onRemoveRange=function(e){this.removeSelectionMarkers(e.ranges),this.renderer.updateCursor(),this.renderer.updateBackMarkers()},this.$onMultiSelect=function(e){this.inMultiSelectMode||(this.inMultiSelectMode=!0,this.setStyle("ace_multiselect"),this.keyBinding.addKeyboardHandler(o.keyboardHandler),this.commands.setDefaultHandler("exec",this.$onMultiSelectExec),this.renderer.updateCursor(),this.renderer.updateBackMarkers())},this.$onSingleSelect=function(e){this.session.multiSelect.inVirtualMode||(this.inMultiSelectMode=!1,this.unsetStyle("ace_multiselect"),this.keyBinding.removeKeyboardHandler(o.keyboardHandler),this.commands.removeDefaultHandler("exec",this.$onMultiSelectExec),this.renderer.updateCursor(),this.renderer.updateBackMarkers(),this._emit("changeSelection"))},this.$onMultiSelectExec=function(e){var t=e.command,n=e.editor;if(n.multiSelect){if(t.multiSelectAction)"forEach"==t.multiSelectAction?i=n.forEachSelection(t,e.args):"forEachLine"==t.multiSelectAction?i=n.forEachSelection(t,e.args,!0):"single"==t.multiSelectAction?(n.exitMultiSelectMode(),i=t.exec(n,e.args||{})):i=t.multiSelectAction(n,e.args||{});else{var i=t.exec(n,e.args||{});n.multiSelect.addRange(n.multiSelect.toOrientedRange()),n.multiSelect.mergeOverlappingRanges()}return i}},this.forEachSelection=function(e,t,i){if(!this.inVirtualSelectionMode){var s,r=i&&i.keepOrder,o=1==i||i&&i.$byLines,l=this.session,a=this.selection,c=a.rangeList,h=(r?a:c).ranges;if(!h.length)return e.exec?e.exec(this,t||{}):e(this,t||{});var u=a._eventRegistry;a._eventRegistry={};var g=new n(l);this.inVirtualSelectionMode=!0;for(var d=h.length;d--;){if(o)for(;d>0&&h[d].start.row==h[d-1].end.row;)d--;g.fromOrientedRange(h[d]),g.index=d,this.selection=l.selection=g;var m=e.exec?e.exec(this,t||{}):e(this,t||{});s||void 0===m||(s=m),g.toOrientedRange(h[d])}g.detach(),this.selection=l.selection=a,this.inVirtualSelectionMode=!1,a._eventRegistry=u,a.mergeOverlappingRanges(),a.ranges[0]&&a.fromOrientedRange(a.ranges[0]);var f=this.renderer.$scrollAnimation;return this.onCursorChange(),this.onSelectionChange(),f&&f.from==f.to&&this.renderer.animateScrolling(f.from),s}},this.exitMultiSelectMode=function(){this.inMultiSelectMode&&!this.inVirtualSelectionMode&&this.multiSelect.toSingleRange()},this.getSelectedText=function(){var e="";if(this.inMultiSelectMode&&!this.inVirtualSelectionMode){for(var t=this.multiSelect.rangeList.ranges,n=[],i=0;i<t.length;i++)n.push(this.session.getTextRange(t[i]));var s=this.session.getDocument().getNewLineCharacter();(e=n.join(s)).length==(n.length-1)*s.length&&(e="")}else this.selection.isEmpty()||(e=this.session.getTextRange(this.getSelectionRange()));return e},this.$checkMultiselectChange=function(e,t){if(this.inMultiSelectMode&&!this.inVirtualSelectionMode){var n=this.multiSelect.ranges[0];if(this.multiSelect.isEmpty()&&t==this.multiSelect.anchor)return;var i=t==this.multiSelect.anchor?n.cursor==n.start?n.end:n.start:n.cursor;i.row!=t.row||this.session.$clipPositionToDocument(i.row,i.column).column!=t.column?this.multiSelect.toSingleRange(this.multiSelect.toOrientedRange()):this.multiSelect.mergeOverlappingRanges()}},this.findAll=function(e,t,n){if((t=t||{}).needle=e||t.needle,void 0==t.needle){var i=this.selection.isEmpty()?this.selection.getWordRange():this.selection.getRange();t.needle=this.session.getTextRange(i)}this.$search.set(t);var s=this.$search.findAll(this.session);if(!s.length)return 0;var r=this.multiSelect;n||r.toSingleRange(s[0]);for(var o=s.length;o--;)r.addRange(s[o],!0);return i&&r.rangeList.rangeAtPoint(i.start)&&r.addRange(i,!0),s.length},this.selectMoreLines=function(e,n){var i=this.selection.toOrientedRange(),s=i.cursor==i.end,r=this.session.documentToScreenPosition(i.cursor);this.selection.$desiredColumn&&(r.column=this.selection.$desiredColumn);var o,l=this.session.screenToDocumentPosition(r.row+e,r.column);if(i.isEmpty())c=l;else var a=this.session.documentToScreenPosition(s?i.end:i.start),c=this.session.screenToDocumentPosition(a.row+e,a.column);s?(o=t.fromPoints(l,c)).cursor=o.start:(o=t.fromPoints(c,l)).cursor=o.end;if(o.desiredColumn=r.column,this.selection.inMultiSelectMode){if(n)var h=i.cursor}else this.selection.addRange(i);this.selection.addRange(o),h&&this.selection.substractPoint(h)},this.transposeSelections=function(e){for(var t=this.session,n=t.multiSelect,i=n.ranges,s=i.length;s--;){if((l=i[s]).isEmpty()){var r=t.getWordRange(l.start.row,l.start.column);l.start.row=r.start.row,l.start.column=r.start.column,l.end.row=r.end.row,l.end.column=r.end.column}}n.mergeOverlappingRanges();var o=[];for(s=i.length;s--;){var l=i[s];o.unshift(t.getTextRange(l))}e<0?o.unshift(o.pop()):o.push(o.shift());for(s=i.length;s--;){r=(l=i[s]).clone();t.replace(l,o[s]),l.start.row=r.start.row,l.start.column=r.start.column}n.fromOrientedRange(n.ranges[0])},this.selectMore=function(e,t,n){var i=this.session,s=i.multiSelect.toOrientedRange();if(!s.isEmpty()||((s=i.getWordRange(s.start.row,s.start.column)).cursor=-1==e?s.start:s.end,this.multiSelect.addRange(s),!n)){var r=function(e,t,n){return l.$options.wrap=!0,l.$options.needle=t,l.$options.backwards=-1==n,l.find(e)}(i,i.getTextRange(s),e);r&&(r.cursor=-1==e?r.start:r.end,this.session.unfold(r),this.multiSelect.addRange(r),this.renderer.scrollCursorIntoView(null,.5)),t&&this.multiSelect.substractPoint(s.cursor)}},this.alignCursors=function(){var e=this.session,n=e.multiSelect,i=n.ranges,s=-1,o=i.filter(function(e){if(e.cursor.row==s)return!0;s=e.cursor.row});if(i.length&&o.length!=i.length-1){o.forEach(function(e){n.substractPoint(e.cursor)});var l=0,a=1/0,c=i.map(function(t){var n=t.cursor,i=e.getLine(n.row).substr(n.column).search(/\S/g);return-1==i&&(i=0),n.column>l&&(l=n.column),i<a&&(a=i),i});i.forEach(function(n,i){var s=n.cursor,o=l-s.column,h=c[i]-a;o>h?e.insert(s,r.stringRepeat(" ",o-h)):e.remove(new t(s.row,s.column,s.row,s.column-o+h)),n.start.column=n.end.column=l,n.start.row=n.end.row=s.row,n.cursor=n.end}),n.fromOrientedRange(i[0]),this.renderer.updateCursor(),this.renderer.updateBackMarkers()}else{var h=this.selection.getRange(),u=h.start.row,g=h.end.row,d=u==g;if(d){var m,f=this.session.getLength();do{m=this.session.getLine(g)}while(/[=:]/.test(m)&&++g<f);do{m=this.session.getLine(u)}while(/[=:]/.test(m)&&--u>0);u<0&&(u=0),g>=f&&(g=f-1)}var S=this.session.removeFullLines(u,g);S=this.$reAlignText(S,d),this.session.insert({row:u,column:0},S.join("\n")+"\n"),d||(h.start.column=0,h.end.column=S[S.length-1].length),this.selection.setRange(h)}},this.$reAlignText=function(e,t){var n,i,s,o=!0,l=!0;return e.map(function(e){var t=e.match(/(\s*)(.*?)(\s*)([=:].*)/);return t?null==n?(n=t[1].length,i=t[2].length,s=t[3].length,t):(n+i+s!=t[1].length+t[2].length+t[3].length&&(l=!1),n!=t[1].length&&(o=!1),n>t[1].length&&(n=t[1].length),i<t[2].length&&(i=t[2].length),s>t[3].length&&(s=t[3].length),t):[e]}).map(t?c:o?l?function(e){return e[2]?a(n+i-e[2].length)+e[2]+a(s)+e[4].replace(/^([=:])\s+/,"$1 "):e[0]}:c:function(e){return e[2]?a(n)+e[2]+a(s)+e[4].replace(/^([=:])\s+/,"$1 "):e[0]});function a(e){return r.stringRepeat(" ",e)}function c(e){return e[2]?a(n)+e[2]+a(i-e[2].length+s)+e[4].replace(/^([=:])\s+/,"$1 "):e[0]}}}).call(c.prototype),exports.onSessionChange=function(e){var t=e.session;t&&!t.multiSelect&&(t.$selectionMarkers=[],t.selection.$initRangeList(),t.multiSelect=t.selection),this.multiSelect=t&&t.multiSelect;var n=e.oldSession;n&&(n.multiSelect.off("addRange",this.$onAddRange),n.multiSelect.off("removeRange",this.$onRemoveRange),n.multiSelect.off("multiSelect",this.$onMultiSelect),n.multiSelect.off("singleSelect",this.$onSingleSelect),n.multiSelect.lead.off("change",this.$checkMultiselectChange),n.multiSelect.anchor.off("change",this.$checkMultiselectChange)),t&&(t.multiSelect.on("addRange",this.$onAddRange),t.multiSelect.on("removeRange",this.$onRemoveRange),t.multiSelect.on("multiSelect",this.$onMultiSelect),t.multiSelect.on("singleSelect",this.$onSingleSelect),t.multiSelect.lead.on("change",this.$checkMultiselectChange),t.multiSelect.anchor.on("change",this.$checkMultiselectChange)),t&&this.inMultiSelectMode!=t.selection.inMultiSelectMode&&(t.selection.inMultiSelectMode?this.$onMultiSelect():this.$onSingleSelect())},exports.MultiSelect=h,require("./config").defineOptions(c.prototype,"editor",{enableMultiselect:{set:function(e){h(this),e?(this.on("changeSession",this.$multiselectOnSessionChange),this.on("mousedown",i)):(this.off("changeSession",this.$multiselectOnSessionChange),this.off("mousedown",i))},value:!0},enableBlockSelect:{set:function(e){this.$blockSelectEnabled=e},value:!0}})});
//# sourceMappingURL=sourcemaps/multi_select.js.map
