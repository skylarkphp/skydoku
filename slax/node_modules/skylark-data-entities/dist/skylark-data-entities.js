/**
 * skylark-data-entities - The skylark entityframework library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
!function(t,e){var i=e.define,n=e.require,r="function"==typeof i&&i.amd,s=!r&&"undefined"!=typeof exports;if(!r&&!i){var a={};i=e.define=function(t,e,i){"function"==typeof i?(a[t]={factory:i,deps:e.map(function(e){return function(t,e){if("."!==t[0])return t;var i=e.split("/"),n=t.split("/");i.pop();for(var r=0;r<n.length;r++)"."!=n[r]&&(".."==n[r]?i.pop():i.push(n[r]));return i.join("/")}(e,t)}),resolved:!1,exports:null},n(t)):a[t]={factory:null,resolved:!0,exports:i}},n=e.require=function(t){if(!a.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var i=a[t];if(!i.resolved){var r=[];i.deps.forEach(function(t){r.push(n(t))}),i.exports=i.factory.apply(e,r)||null,i.resolved=!0}return i.exports}}if(!i)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(t,e){t("skylark-data-entities/entities",["skylark-langx/langx"],function(t){function e(){return e}return t.mixin(e,{emulateHTTP:!1,emulateJSON:!1,backends:{}}),e}),t("skylark-data-entities/Entity",["skylark-langx/langx","./entities"],function(t,e){var i=function(t,e){var i=e.error;e.error=function(n){i&&i.call(e.context,t,n,e),t.trigger("error",t,n,e)}},n=t.Stateful.inherit({sync:function(){return e.sync.apply(this,arguments)},matches:function(e){return t.isMatch(this.attributes,e)},fetch:function(e){var n=this,r=(e=t.mixin({parse:!0},e)).success;return e.success=function(t){var i=e.parse?n.parse(t,e):t;if(!n.set(i,e))return!1;r&&r.call(e.context,n,t,e),n.trigger("sync",n,t,e)},i(this,e),this.sync("read",this,e)},save:function(e,n,r){var s;null==e||"object"==typeof e?(s=e,r=n):(s={})[e]=n;var a=(r=t.mixin({validate:!0,parse:!0},r)).wait;if(s&&!a){if(!this.set(s,r))return!1}else if(!this._validate(s,r))return!1;var o=this,c=r.success,u=this.attributes;r.success=function(e){o.attributes=u;var i=r.parse?o.parse(e,r):e;if(a&&(i=t.mixin({},s,i)),i&&!o.set(i,r))return!1;c&&c.call(r.context,o,e,r),o.trigger("sync",o,e,r)},i(this,r),s&&a&&(this.attributes=t.mixin({},u,s));var h=this.isNew()?"create":r.patch?"patch":"update";"patch"!==h||r.attrs||(r.attrs=s);var l=this.sync(h,this,r);return this.attributes=u,l},destroy:function(e){var n=this,r=(e=e?t.clone(e):{}).success,s=e.wait,a=function(){n.stopListening(),n.trigger("destroy",n,n.collection,e)};e.success=function(t){s&&a(),r&&r.call(e.context,n,t,e),n.isNew()||n.trigger("sync",n,t,e)};var o=!1;return this.isNew()?t.defer(e.success):(i(this,e),o=this.sync("delete",this,e)),s||a(),o},url:function(){var e=t.result(this,"urlRoot")||t.result(this.collection,"url")||urlError();if(this.isNew())return e;var i=this.get(this.idAttribute);return e.replace(/[^\/]$/,"$&/")+encodeURIComponent(i)},parse:function(t,e){return t}});return e.Entity=n}),t("skylark-data-entities/Collection",["skylark-langx/langx","./entities","./Entity"],function(t,e,i){var n=t.Evented.inherit({_construct:function(e,i){i||(i={}),i.entity&&(this.entity=i.entity),void 0!==i.comparator&&(this.comparator=i.comparator),this._reset(),e&&this.reset(e,t.mixin({silent:!0},i))}}),r={add:!0,remove:!0,merge:!0},s={add:!0,remove:!1},a=function(t,e,i){i=Math.min(Math.max(i,0),t.length);var n,r=Array(t.length-i),s=e.length;for(n=0;n<r.length;n++)r[n]=t[n+i];for(n=0;n<s;n++)t[n+i]=e[n];for(n=0;n<r.length;n++)t[n+s+i]=r[n]};return n.partial({entity:i,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return e.sync.apply(this,arguments)},add:function(e,i){return this.set(e,t.mixin({merge:!1},i,s))},remove:function(e,i){i=t.mixin({},i);var n=!t.isArray(e);e=n?[e]:e.slice();var r=this._removeEntitys(e,i);return!i.silent&&r.length&&(i.changes={added:[],merged:[],removed:r},this.trigger("update",this,i)),n?r[0]:r},set:function(e,i){if(null!=e){(i=t.mixin({},r,i)).parse&&!this._isEntity(e)&&(e=this.parse(e,i)||[]);var n=!t.isArray(e);e=n?[e]:e.slice();var s=i.at;null!=s&&(s=+s),s>this.length&&(s=this.length),s<0&&(s+=this.length+1);var o,c,u=[],h=[],l=[],d=[],f={},g=i.add,y=i.merge,p=i.remove,v=!1,m=this.comparator&&null==s&&!1!==i.sort,k=t.isString(this.comparator)?this.comparator:null;for(c=0;c<e.length;c++){o=e[c];var x=this.get(o);if(x){if(y&&o!==x){var b=this._isEntity(o)?o.attributes:o;i.parse&&(b=x.parse(b,i)),x.set(b,i),l.push(x),m&&!v&&(v=x.hasChanged(k))}f[x.cid]||(f[x.cid]=!0,u.push(x)),e[c]=x}else g&&(o=e[c]=this._prepareEntity(o,i))&&(h.push(o),this._addReference(o,i),f[o.cid]=!0,u.push(o))}if(p){for(c=0;c<this.length;c++)o=this.entities[c],f[o.cid]||d.push(o);d.length&&this._removeEntitys(d,i)}var E=!1,S=!m&&g&&p;if(u.length&&S?(E=this.length!==u.length||this.entities.some(function(t,e){return t!==u[e]}),this.entities.length=0,a(this.entities,u,0),this.length=this.entities.length):h.length&&(m&&(v=!0),a(this.entities,h,null==s?this.length:s),this.length=this.entities.length),v&&this.sort({silent:!0}),!i.silent){for(c=0;c<h.length;c++)null!=s&&(i.index=s+c),(o=h[c]).trigger("add",o,this,i);(v||E)&&this.trigger("sort",this,i),(h.length||d.length||l.length)&&(i.changes={added:h,removed:d,merged:l},this.trigger("update",this,i))}return n?e[0]:e}},reset:function(e,i){i=i?t.clone(i):{};for(var n=0;n<this.entities.length;n++)this._removeReference(this.entities[n],i);return i.previousEntitys=this.entities,this._reset(),e=this.add(e,t.mixin({silent:!0},i)),i.silent||this.trigger("reset",this,i),e},push:function(e,i){return this.add(e,t.mixin({at:this.length},i))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t)},unshift:function(e,i){return this.add(e,t.mixin({at:0},i))},shift:function(t){var e=this.at(0);return this.remove(e,t)},slice:function(){return slice.apply(this.entities,arguments)},get:function(t){if(null!=t)return this._byId[t]||this._byId[this.entityId(t.attributes||t)]||t.cid&&this._byId[t.cid]},has:function(t){return null!=this.get(t)},at:function(t){return t<0&&(t+=this.length),this.entities[t]},where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(e){var i=this.comparator;if(!i)throw new Error("Cannot sort a set without a comparator");e||(e={});var n=i.length;return t.isFunction(i)&&(i=t.proxy(i,this)),1===n||t.isString(i)?this.entities=this.sortBy(i):this.entities.sort(i),e.silent||this.trigger("sort",this,e),this},pluck:function(t){return this.map(t+"")},fetch:function(e){var i=(e=t.mixin({parse:!0},e)).success,n=this;return e.success=function(t){var r=e.reset?"reset":"set";n[r](t,e),i&&i.call(e.context,n,t,e),n.trigger("sync",n,t,e)},function(t,e){var i=e.error;e.error=function(n){i&&i.call(e.context,t,n,e),t.trigger("error",t,n,e)}}(this,e),this.sync("read",this,e)},create:function(e,i){var n=(i=i?t.clone(i):{}).wait;if(!(e=this._prepareEntity(e,i)))return!1;n||this.add(e,i);var r=this,s=i.success;return i.success=function(t,e,i){n&&r.add(t,i),s&&s.call(i.context,t,e,i)},e.save(null,i),e},parse:function(t,e){return t},clone:function(){return new this.constructor(this.entities,{entity:this.entity,comparator:this.comparator})},entityId:function(t){return t[this.entity.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.entities=[],this._byId={}},_prepareEntity:function(e,i){if(this._isEntity(e))return e.collection||(e.collection=this),e;(i=i?t.clone(i):{}).collection=this;var n=new this.entity(e,i);return n.validationError?(this.trigger("invalid",this,n.validationError,i),!1):n},_removeEntitys:function(t,e){for(var i=[],n=0;n<t.length;n++){var r=this.get(t[n]);if(r){var s=this.indexOf(r);this.entities.splice(s,1),this.length--,delete this._byId[r.cid];var a=this.entityId(r.attributes);null!=a&&delete this._byId[a],e.silent||(e.index=s,r.trigger("remove",r,this,e)),i.push(r),this._removeReference(r,e)}}return i},_isEntity:function(t){return t instanceof i},_addReference:function(t,e){this._byId[t.cid]=t;var i=this.entityId(t.attributes);null!=i&&(this._byId[i]=t),t.on("all",this._onEntityEvent,this)},_removeReference:function(t,e){delete this._byId[t.cid];var i=this.entityId(t.attributes);null!=i&&delete this._byId[i],this===t.collection&&delete t.collection,t.off("all",this._onEntityEvent,this)},_onEntityEvent:function(t,e,i,n){if(e){if(("add"===t||"remove"===t)&&i!==this)return;if("destroy"===t&&this.remove(e,n),"change"===t){var r=this.entityId(e.previousAttributes()),s=this.entityId(e.attributes);r!==s&&(null!=r&&delete this._byId[r],null!=s&&(this._byId[s]=e))}}this.trigger.apply(this,arguments)}}),e.Collection=n}),t("skylark-data-entities/backends/registry",[],function(){var t={};return{add:function(e,i){t[e]=i},remove:function(t){delete provides[t]},get:function(e){return t[e]}}}),t("skylark-data-entities/sync",["skylark-langx/langx","./entities","./backends/registry"],function(t,e,i){return e.sync=function(e,n,r){if(!r.backend)throw new Error("The backend is not specified");var s=i.get(r.backend);if(!s)throw new Error("The backend is not defined:"+r.backend);var a=s.sync;if(!a)throw new Error("The backend sync method is not defined:"+r.backend);var o=t.mixin({},s.options,r);return a.apply(this,[e,n,o])}}),t("skylark-data-entities/backends/ajaxSync",["skylark-langx/langx","../entities"],function(t,e){var i={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"};return e.backends.ajaxSync=function(n,r,s){var a=i[n];t.defaults(s||(s={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var o={type:a,dataType:"json"};s.url||(o.url=t.result(r,"url")||urlError());null!=s.data||!r||"create"!==n&&"update"!==n&&"patch"!==n||(o.contentType="application/json",o.data=JSON.stringify(s.attrs||r.toJSON(s)));s.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{entity:o.data}:{});if(s.emulateHTTP&&("PUT"===a||"DELETE"===a||"PATCH"===a)){o.type="POST",s.emulateJSON&&(o.data._method=a);var c=s.beforeSend;s.beforeSend=function(t){if(t.setRequestHeader("X-HTTP-Method-Override",a),c)return c.apply(this,arguments)}}"GET"===o.type||s.emulateJSON||(o.processData=!1);var u=s.error;s.error=function(t,e,i){s.textStatus=e,s.errorThrown=i,u&&u.call(s.context,t,e,i)};var h=s.xhr=t.Xhr.request(t.mixin(o,s));return r.trigger("request",r,h,s),h}}),t("skylark-data-entities/backends/localSync",["skylark-langx/langx","../entities"],function(t,e){function i(){return(65536*(1+Math.random())|0).toString(16).substring(1)}var n=t.klass({_construct:function(t){this.name=t;var e=this.localStorage().getItem(this.name);this.records=e&&e.split(",")||[]},save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(t){return t.id||(t.id=i()+i()+"-"+i()+"-"+i()+"-"+i()+"-"+i()+i()+i(),t.set(t.idAttribute,t.id)),this.localStorage().setItem(this.name+"-"+t.id,JSON.stringify(t)),this.records.push(t.id.toString()),this.save(),this.find(t)},update:function(t){return this.localStorage().setItem(this.name+"-"+t.id,JSON.stringify(t)),_.include(this.records,t.id.toString())||this.records.push(t.id.toString()),this.save(),this.find(t)},find:function(t){return this.jsonData(this.localStorage().getItem(this.name+"-"+t.id))},findAll:function(){return _(this.records).chain().map(function(t){return this.jsonData(this.localStorage().getItem(this.name+"-"+t))},this).compact().value()},destroy:function(t){return!t.isNew()&&(this.localStorage().removeItem(this.name+"-"+t.id),this.records=_.reject(this.records,function(e){return e===t.id.toString()}),this.save(),t)},localStorage:function(){return localStorage},jsonData:function(t){return t&&JSON.parse(t)}});function r(e,i,n){var r,s,a=i.localStorage||i.collection.localStorage,o=t.Deferred();try{switch(e){case"read":r=void 0!=i.id?a.find(i):a.findAll();break;case"create":r=a.create(i);break;case"update":r=a.update(i);break;case"delete":r=a.destroy(i)}}catch(t){s=t.code===DOMException.QUOTA_EXCEEDED_ERR&&0===window.localStorage.length?"Private browsing is unsupported":t.message}return r?(i.trigger("sync",i,r,n),n&&n.success&&n.success(r),o&&o.resolve(r)):(s=s||"Record Not Found",n&&n.error&&n.error(s),o&&o.reject(s)),n&&n.complete&&n.complete(r),o&&o.promise()}return e.backends.LocalStorage=r.LocalStorage=n,e.backends.localSync=r}),t("skylark-data-entities/main",["./entities","./Collection","./Entity","./sync","./backends/ajaxSync","./backends/localSync","./backends/registry"],function(t){return t}),t("skylark-data-entities",["skylark-data-entities/main"],function(t){return t})}(i),!r){var o=n("skylark-langx/skylark");s?module.exports=o:e.skylarkjs=o}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-data-entities.js.map
