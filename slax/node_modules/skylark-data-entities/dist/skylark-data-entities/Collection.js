/**
 * skylark-data-entities - The skylark entityframework library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx/langx","./entities","./Entity"],function(t,i,e){var n=t.Evented.inherit({_construct:function(i,e){e||(e={}),e.entity&&(this.entity=e.entity),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),i&&this.reset(i,t.mixin({silent:!0},e))}}),r={add:!0,remove:!0,merge:!0},s={add:!0,remove:!1},h=function(t,i,e){e=Math.min(Math.max(e,0),t.length);var n,r=Array(t.length-e),s=i.length;for(n=0;n<r.length;n++)r[n]=t[n+e];for(n=0;n<s;n++)t[n+e]=i[n];for(n=0;n<r.length;n++)t[n+s+e]=r[n]};return n.partial({entity:e,initialize:function(){},toJSON:function(t){return this.map(function(i){return i.toJSON(t)})},sync:function(){return i.sync.apply(this,arguments)},add:function(i,e){return this.set(i,t.mixin({merge:!1},e,s))},remove:function(i,e){e=t.mixin({},e);var n=!t.isArray(i);i=n?[i]:i.slice();var r=this._removeEntitys(i,e);return!e.silent&&r.length&&(e.changes={added:[],merged:[],removed:r},this.trigger("update",this,e)),n?r[0]:r},set:function(i,e){if(null!=i){(e=t.mixin({},r,e)).parse&&!this._isEntity(i)&&(i=this.parse(i,e)||[]);var n=!t.isArray(i);i=n?[i]:i.slice();var s=e.at;null!=s&&(s=+s),s>this.length&&(s=this.length),s<0&&(s+=this.length+1);var o,a,l=[],u=[],c=[],d=[],f={},g=e.add,y=e.merge,v=e.remove,p=!1,m=this.comparator&&null==s&&!1!==e.sort,_=t.isString(this.comparator)?this.comparator:null;for(a=0;a<i.length;a++){o=i[a];var E=this.get(o);if(E){if(y&&o!==E){var b=this._isEntity(o)?o.attributes:o;e.parse&&(b=E.parse(b,e)),E.set(b,e),c.push(E),m&&!p&&(p=E.hasChanged(_))}f[E.cid]||(f[E.cid]=!0,l.push(E)),i[a]=E}else g&&(o=i[a]=this._prepareEntity(o,e))&&(u.push(o),this._addReference(o,e),f[o.cid]=!0,l.push(o))}if(v){for(a=0;a<this.length;a++)f[(o=this.entities[a]).cid]||d.push(o);d.length&&this._removeEntitys(d,e)}var I=!1,x=!m&&g&&v;if(l.length&&x?(I=this.length!==l.length||this.entities.some(function(t,i){return t!==l[i]}),this.entities.length=0,h(this.entities,l,0),this.length=this.entities.length):u.length&&(m&&(p=!0),h(this.entities,u,null==s?this.length:s),this.length=this.entities.length),p&&this.sort({silent:!0}),!e.silent){for(a=0;a<u.length;a++)null!=s&&(e.index=s+a),(o=u[a]).trigger("add",o,this,e);(p||I)&&this.trigger("sort",this,e),(u.length||d.length||c.length)&&(e.changes={added:u,removed:d,merged:c},this.trigger("update",this,e))}return n?i[0]:i}},reset:function(i,e){e=e?t.clone(e):{};for(var n=0;n<this.entities.length;n++)this._removeReference(this.entities[n],e);return e.previousEntitys=this.entities,this._reset(),i=this.add(i,t.mixin({silent:!0},e)),e.silent||this.trigger("reset",this,e),i},push:function(i,e){return this.add(i,t.mixin({at:this.length},e))},pop:function(t){var i=this.at(this.length-1);return this.remove(i,t)},unshift:function(i,e){return this.add(i,t.mixin({at:0},e))},shift:function(t){var i=this.at(0);return this.remove(i,t)},slice:function(){return slice.apply(this.entities,arguments)},get:function(t){if(null!=t)return this._byId[t]||this._byId[this.entityId(t.attributes||t)]||t.cid&&this._byId[t.cid]},has:function(t){return null!=this.get(t)},at:function(t){return t<0&&(t+=this.length),this.entities[t]},where:function(t,i){return this[i?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(i){var e=this.comparator;if(!e)throw new Error("Cannot sort a set without a comparator");i||(i={});var n=e.length;return t.isFunction(e)&&(e=t.proxy(e,this)),1===n||t.isString(e)?this.entities=this.sortBy(e):this.entities.sort(e),i.silent||this.trigger("sort",this,i),this},pluck:function(t){return this.map(t+"")},fetch:function(i){var e=(i=t.mixin({parse:!0},i)).success,n=this;return i.success=function(t){var r=i.reset?"reset":"set";n[r](t,i),e&&e.call(i.context,n,t,i),n.trigger("sync",n,t,i)},function(t,i){var e=i.error;i.error=function(n){e&&e.call(i.context,t,n,i),t.trigger("error",t,n,i)}}(this,i),this.sync("read",this,i)},create:function(i,e){var n=(e=e?t.clone(e):{}).wait;if(!(i=this._prepareEntity(i,e)))return!1;n||this.add(i,e);var r=this,s=e.success;return e.success=function(t,i,e){n&&r.add(t,e),s&&s.call(e.context,t,i,e)},i.save(null,e),i},parse:function(t,i){return t},clone:function(){return new this.constructor(this.entities,{entity:this.entity,comparator:this.comparator})},entityId:function(t){return t[this.entity.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.entities=[],this._byId={}},_prepareEntity:function(i,e){if(this._isEntity(i))return i.collection||(i.collection=this),i;(e=e?t.clone(e):{}).collection=this;var n=new this.entity(i,e);return n.validationError?(this.trigger("invalid",this,n.validationError,e),!1):n},_removeEntitys:function(t,i){for(var e=[],n=0;n<t.length;n++){var r=this.get(t[n]);if(r){var s=this.indexOf(r);this.entities.splice(s,1),this.length--,delete this._byId[r.cid];var h=this.entityId(r.attributes);null!=h&&delete this._byId[h],i.silent||(i.index=s,r.trigger("remove",r,this,i)),e.push(r),this._removeReference(r,i)}}return e},_isEntity:function(t){return t instanceof e},_addReference:function(t,i){this._byId[t.cid]=t;var e=this.entityId(t.attributes);null!=e&&(this._byId[e]=t),t.on("all",this._onEntityEvent,this)},_removeReference:function(t,i){delete this._byId[t.cid];var e=this.entityId(t.attributes);null!=e&&delete this._byId[e],this===t.collection&&delete t.collection,t.off("all",this._onEntityEvent,this)},_onEntityEvent:function(t,i,e,n){if(i){if(("add"===t||"remove"===t)&&e!==this)return;if("destroy"===t&&this.remove(i,n),"change"===t){var r=this.entityId(i.previousAttributes()),s=this.entityId(i.attributes);r!==s&&(null!=r&&delete this._byId[r],null!=s&&(this._byId[s]=i))}}this.trigger.apply(this,arguments)}}),i.Collection=n});
//# sourceMappingURL=sourcemaps/Collection.js.map
