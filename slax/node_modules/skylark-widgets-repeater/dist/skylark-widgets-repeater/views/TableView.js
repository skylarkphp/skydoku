/**
 * skylark-widgets-repeater - The skylark repeater widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-widgets/skylark-widgets-repeater/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-domx-browser","skylark-domx-eventer","skylark-domx-noder","skylark-domx-geom","skylark-domx-query","../views","./ViewBase"],function(e,t,a,i,r,n,s,o){var l=o.inherit({klassName:"TableView",options:{columnRendered:null,columnSizing:!0,columnSyncing:!0,highlightSortedColumn:!0,infiniteScroll:!1,noItemsHTML:"no items found",selectable:!1,sortClearing:!1,rowRendered:null,frozenColumns:0,actions:!1},clearSelectedItems:function(){this.repeater.$canvas.find(".repeater-table-check").remove(),this.repeater.$canvas.find(".repeater-table table tbody tr.selected").removeClass("selected")},highlightColumn:function(e,t){var a=this.repeater.$canvas.find(".repeater-table-wrapper > table tbody");(this.options.highlightSortedColumn||t)&&(a.find("td.sorted").removeClass("sorted"),a.find("tr").each(function(){n(this).find("td:nth-child("+(e+1)+")").filter(function(){return!n(this).parent().hasClass("empty")}).addClass("sorted")}))},getSelectedItems:function(){var e=[];return this.repeater.$canvas.find(".repeater-table .repeater-table-wrapper > table tbody tr.selected").each(function(){var t=n(this);e.push({data:t.data("item_data"),element:t})}),e},positionHeadings:function(){var e=this.repeater.$element.find(".repeater-table-wrapper"),t=e.offset().left;e.scrollLeft()>0?e.find(".repeater-table-heading").each(function(){var e=n(this),a=e.parents("th:first").offset().left-t+"px";e.addClass("shifted").css("left",a)}):e.find(".repeater-table-heading").each(function(){n(this).removeClass("shifted").css("left","")})},setSelectedItems:function(e,t){var a,i,r,s=this.options.selectable,o=this,l=e;n.isArray(l)||(l=[l]);var d=function(e){i=n(this),(i.data("item_data")||{})[l[a].property]===l[a].value&&c(i,l[a].selected,e)},c=function(e,a,i){var r;void 0===a||a?(t||"multi"===s||o.clearSelectedItems(),e.hasClass("selected")||(e.addClass("selected"),(o.options.frozenColumns||"multi"===o.options.selectable)&&((r=o.repeater.$element.find(".frozen-column-wrapper tr:nth-child("+(i+1)+")")).addClass("selected"),r.find(".repeater-select-checkbox").addClass("checked")),o.options.actions&&o.repeater.$element.find(".actions-column-wrapper tr:nth-child("+(i+1)+")").addClass("selected"),e.find("td:first").prepend('<div class="repeater-table-check"><span class="glyphicon glyphicon-ok"></span></div>'))):(o.options.frozenColumns&&((r=o.repeater.$element.find(".frozen-column-wrapper tr:nth-child("+(i+1)+")")).addClass("selected"),r.find(".repeater-select-checkbox").removeClass("checked")),o.options.actions&&o.repeater.$element.find(".actions-column-wrapper tr:nth-child("+(i+1)+")").removeClass("selected"),e.find(".repeater-table-check").remove(),e.removeClass("selected"))};for(r=!0===t||"multi"===s?l.length:s&&l.length>0?1:0,a=0;a<r;a++)void 0!==l[a].index?(i=this.repeater.$canvas.find(".repeater-table .repeater-table-wrapper > table tbody tr:nth-child("+(l[a].index+1)+")")).length>0&&c(i,l[a].selected,l[a].index):void 0!==l[a].property&&void 0!==l[a].value&&this.repeater.$canvas.find(".repeater-table .repeater-table-wrapper > table tbody tr").each(d)},sizeHeadings:function(){this.repeater.$element.find(".repeater-table table").find("thead th").each(function(){var e=n(this),t=e.find(".repeater-table-heading");t.css({height:e.outerHeight()}),t.outerWidth(t.data("forced-width")||e.outerWidth())})},setFrozenColumns:function(){var e=this.repeater.$canvas.find(".table-frozen"),t=this.repeater.$element.find(".repeater-canvas"),a=this.repeater.$element.find(".repeater-table .repeater-table-wrapper > table"),i=this.repeater.$element.find(".repeater-table"),r=this.options.frozenColumns,s=this;if("multi"===this.options.selectable&&(r+=1,t.addClass("multi-select-enabled")),e.length<1){var o=n('<div class="frozen-column-wrapper"></div>').insertBefore(a),l=a.clone().addClass("table-frozen");l.find("th:not(:lt("+r+"))").remove(),l.find("td:not(:nth-child(n+0):nth-child(-n+"+r+"))").remove();var d=l.clone().removeClass("table-frozen");d.find("tbody").remove();var c=n('<div class="frozen-thead-wrapper"></div>').append(d),p=c.find("th label.checkbox-custom.checkbox-inline");p.attr("id",p.attr("id")+"_cloned"),o.append(l),i.append(c),this.repeater.$canvas.addClass("frozen-enabled")}this.sizeFrozenColumns(),n(".frozen-thead-wrapper .repeater-table-heading").on("click",function(){var e=n(this).parent("th").index();e+=1,s.repeater.$element.find(".repeater-table-wrapper > table thead th:nth-child("+e+") .repeater-table-heading")[0].click()})},positionColumns:function(){var e=this.repeater.$element.find(".repeater-canvas"),t=e.scrollTop(),a=e.scrollLeft(),i=this.options.frozenColumns||"multi"===this.options.selectable,r=this.options.actions,n=this.repeater.$element.find(".repeater-canvas").outerWidth(),s=this.repeater.$element.find(".repeater-table .repeater-table-wrapper > table").outerWidth()-(n-(this.repeater.$element.find(".table-actions")?this.repeater.$element.find(".table-actions").outerWidth():0))>=a;t>0?e.find(".repeater-table-heading").css("top",t):e.find(".repeater-table-heading").css("top","0"),a>0?(i&&(e.find(".frozen-thead-wrapper").css("left",a),e.find(".frozen-column-wrapper").css("left",a)),r&&s&&(e.find(".actions-thead-wrapper").css("right",-a),e.find(".actions-column-wrapper").css("right",-a))):(i&&(e.find(".frozen-thead-wrapper").css("left","0"),e.find(".frozen-column-wrapper").css("left","0")),r&&(e.find(".actions-thead-wrapper").css("right","0"),e.find(".actions-column-wrapper").css("right","0")))},createItemActions:function(){var e,t,a="",i=this,r=this.repeater.$element.find(".repeater-table .repeater-table-wrapper > table"),s=this.repeater.$canvas.find(".table-actions");for(e=0,t=this.options.actions.items.length;e<t;e++){var o=this.options.actions.items[e],l=o.html;a+='<li><a href="#" data-action="'+o.name+'" class="action-item"> '+l+"</a></li>"}var d='<div class="btn-group"><button type="button" class="btn btn-xs btn-default dropdown-toggle repeater-actions-button" data-toggle="dropdown" data-flip="auto" aria-expanded="false"><span class="caret"></span></button><ul class="dropdown-menu dropdown-menu-right" role="menu">'+a+"</ul></div>";if(s.length<1){var c=n('<div class="actions-column-wrapper" style="width: '+this.actions_width+'px"></div>').insertBefore(r),p=r.clone().addClass("table-actions");if(p.find("th:not(:last-child)").remove(),p.find("tr td:not(:last-child)").remove(),"multi"===this.options.selectable||"action"===this.options.selectable)p.find("thead tr").html('<th><div class="repeater-table-heading">'+d+"</div></th>"),"action"!==this.options.selectable&&p.find("thead .btn").attr("disabled","disabled");else{var h=this.options.actions.label||'<span class="actions-hidden">a</span>';p.find("thead tr").addClass("empty-heading").html("<th>"+h+'<div class="repeater-table-heading">'+h+"</div></th>")}p.find("td").each(function(e){n(this).html(d),n(this).find("a").attr("data-row",e+1)}),c.append(p),this.repeater.$canvas.addClass("actions-enabled")}this.sizeActionsTable(),this.repeater.$element.find(".table-actions tbody .action-item").on("click",function(e){if(!i.isDisabled){var t={actionName:n(this).data("action"),rows:[n(this).data("row")]};i.getActionItems(t,e)}}),this.repeater.$element.find(".table-actions thead .action-item").on("click",function(e){if(!i.isDisabled){var t={actionName:n(this).data("action"),rows:[]},a=".repeater-table-wrapper > table .selected";"action"===i.options.selectable&&(a=".repeater-table-wrapper > table tr"),i.repeater.$element.find(a).each(function(e){t.rows.push(e+1)}),i.getActionItems(t,e)}})},getActionItems:function(e,t){for(var a=[],i=n.grep(this.options.actions.items,function(t){return t.name===e.actionName})[0],r=0,s=e.rows.length;r<s;r++){var o=this.repeater.$canvas.find(".repeater-table-wrapper > table tbody tr:nth-child("+e.rows[r]+")");a.push({item:o,rowData:o.data("item_data")})}if(1===a.length&&(a=a[0]),i.clickAction){i.clickAction(a,function(){},t)}},sizeActionsTable:function(){var e=this.repeater.$element.find(".repeater-table table.table-actions"),t=e.find("thead tr th"),a=this.repeater.$element.find(".repeater-table-wrapper > table");t.outerHeight(a.find("thead tr th").outerHeight()),t.find(".repeater-table-heading").outerHeight(t.outerHeight()),e.find("tbody tr td:first-child").each(function(e){n(this).outerHeight(a.find("tbody tr:eq("+e+") td").outerHeight())})},sizeFrozenColumns:function(){var e=this.repeater.$element.find(".repeater-table .repeater-table-wrapper > table");this.repeater.$element.find(".repeater-table table.table-frozen tr").each(function(t){n(this).height(e.find("tr:eq("+t+")").height())});var t=e.find("td:eq(0)").outerWidth();this.repeater.$element.find(".frozen-column-wrapper, .frozen-thead-wrapper").width(t)},frozenOptionsInitialize:function(){var e=this.repeater.$element.find(".frozen-column-wrapper .checkbox-inline"),t=this.repeater.$element.find(".header-checkbox .checkbox-custom"),a=this.repeater.$element.find(".repeater-table table"),i=this;this.repeater.$element.find("tr.selectable").on("mouseover mouseleave",function(e){var t=n(this).index();t+=1,"mouseover"===e.type?a.find("tbody tr:nth-child("+t+")").addClass("hovered"):a.find("tbody tr:nth-child("+t+")").removeClass("hovered")}),t.checkbox(),e.checkbox();var r=this.repeater.$element.find(".table-frozen tbody .checkbox-inline"),s=this.repeater.$element.find(".frozen-thead-wrapper thead .checkbox-inline input");function o(e){i.revertingCheckbox=!0,e.checkbox("toggle"),delete i.revertingCheckbox}r.on("change",function(e){if(e.preventDefault(),!i.revertingCheckbox)if(i.isDisabled)o(n(e.currentTarget));else{var t=n(this).attr("data-row");t=parseInt(t,10)+1,i.repeater.$element.find(".repeater-table-wrapper > table tbody tr:nth-child("+t+")").click();var a=i.repeater.$element.find(".table-frozen tbody .checkbox-inline.checked").length;0===a?(s.prop("checked",!1),s.prop("indeterminate",!1)):a===r.length?(s.prop("checked",!0),s.prop("indeterminate",!1)):(s.prop("checked",!1),s.prop("indeterminate",!0))}}),s.on("change",function(t){i.revertingCheckbox||(i.isDisabled?o(n(t.currentTarget)):n(this).is(":checked")?(i.repeater.$element.find(".repeater-table-wrapper > table tbody tr:not(.selected)").click(),i.repeater.$element.trigger("selected.lark.repeaterList",e)):(i.repeater.$element.find(".repeater-table-wrapper > table tbody tr.selected").click(),i.repeater.$element.trigger("deselected.lark.repeaterList",e)))})},cleared:function(){this.options.columnSyncing&&this.sizeHeadings()},dataOptions:function(e){return this.sortDirection&&(e.sortDirection=this.sortDirection),this.sortProperty&&(e.sortProperty=this.sortProperty),e},enabled:function(e){this.options.actions&&(e.status?(this.repeater.$canvas.find(".repeater-actions-button").removeAttr("disabled"),m.call(this)):this.repeater.$canvas.find(".repeater-actions-button").attr("disabled","disabled"))},initialize:function(e,t){this.sortDirection=null,this.sortProperty=null,this.specialBrowserClass=u(),this.actions_width=void 0!==this.options.actions.width?this.options.actions.width:37,this.noItems=!1,t()},resize:function(){b.call(this,this.repeater.$element.find(".repeater-table-wrapper > table thead tr")),this.options.actions&&this.sizeActionsTable(),(this.options.frozenColumns||"multi"===this.options.selectable)&&this.sizeFrozenColumns(),this.options.columnSyncing&&this.sizeHeadings()},selected:function(){var e,t=this.options.infiniteScroll;this.firstRender=!0,this.repeater.$loader.addClass("noHeader"),t&&(e="object"==typeof t?t:{},this.repeater.infiniteScrolling(!0,e))},before:function(e){var t,a=e.container.find(".repeater-table"),i=this;return e.data.count>0?this.noItems=!1:this.noItems=!0,a.length<1&&((a=n('<div class="repeater-table '+this.specialBrowserClass+'" data-preserve="shallow"><div class="repeater-table-wrapper" data-infinite="true" data-preserve="shallow"><table aria-readonly="true" class="table" data-preserve="shallow" role="grid"></table></div></div>')).find(".repeater-table-wrapper").on("scroll.lark.repeaterList",function(){i.options.columnSyncing&&i.positionHeadings()}),(i.options.frozenColumns||i.options.actions||"multi"===i.options.selectable)&&e.container.on("scroll.lark.repeaterList",function(){i.positionColumns()}),e.container.append(a)),e.container.removeClass("actions-enabled actions-enabled multi-select-enabled"),t=a.find("table"),f.call(this,t,e.data),h.call(this,t,e.data),!1},renderItem:function(e){return p.call(this,e.container,e.subset,e.index),!1},after:function(){var e;return!this.options.frozenColumns&&"multi"!==this.options.selectable||this.noItems||this.setFrozenColumns(),this.options.actions&&!this.noItems&&(this.createItemActions(),this.sizeActionsTable()),!this.options.frozenColumns&&!this.options.actions&&"multi"!==this.options.selectable||this.noItems||(this.positionColumns(),this.frozenOptionsInitialize()),this.options.columnSyncing&&(this.sizeHeadings(),this.positionHeadings()),(e=this.repeater.$canvas.find(".repeater-table-wrapper > table .repeater-table-heading.sorted")).length>0&&this.highlightColumn(e.data("fu_item_index")),!1}}),d=function(e,t,a,i,r){var s=i[r].className,o=t[a][i[r].property],l=n("<td></td>"),d=i[r]._auto_width,c=i[r].property;if(!1!==this.options.actions&&"@_ACTIONS_@"===c&&(o='<div class="repeater-table-actions-placeholder" style="width: '+this.actions_width+'px"></div>'),o=void 0!==o?o:"",l.addClass(void 0!==s?s:"").append(o),void 0!==d&&l.outerWidth(d),e.append(l),"multi"===this.options.selectable&&"@_CHECKBOX_@"===i[r].property){var p='<label data-row="'+a+'" class="checkbox-custom checkbox-inline body-checkbox repeater-select-checkbox"><input class="sr-only" type="checkbox"></label>';l.html(p)}return l},c=function(e,t,a){var i,r,s,o,l,d="glyphicon-chevron-down",c="glyphicon-chevron-up",p=n('<div class="repeater-table-heading"><span class="glyphicon rlc"></span></div>'),h='<div class="repeater-table-heading header-checkbox"><label id="'+((this.repeater.$element.attr("id")+"_"||"")+"checkall")+'" class="checkbox-custom checkbox-inline"><input class="sr-only" type="checkbox" value=""><span class="checkbox-label">&nbsp;</span></label></div>',f=n("<th></th>"),b=this;if(p.data("fu_item_index",a),p.prepend(t[a].label),f.html(p.html()).find("[id]").removeAttr("id"),"@_CHECKBOX_@"!==t[a].property?f.append(p):f.append(h),i=f.add(p),o=p.find(".glyphicon.rlc:first"),l=o.add(f.find(".glyphicon.rlc:first")),this.options.actions&&"@_ACTIONS_@"===t[a].property){var u=this.actions_width;f.css("width",u),p.css("width",u)}void 0!==(r=t[a].className)&&i.addClass(r),(s=t[a].sortable)&&(i.addClass("sortable"),p.on("click.lark.repeaterList",function(){b.isDisabled||(b.sortProperty="string"==typeof s?s:t[a].property,p.hasClass("sorted")?o.hasClass(c)?(l.removeClass(c).addClass(d),b.sortDirection="desc"):b.options.sortClearing?(i.removeClass("sorted"),l.removeClass(d),b.sortDirection=null,b.sortProperty=null):(l.removeClass(d).addClass(c),b.sortDirection="asc"):(e.find("th, .repeater-table-heading").removeClass("sorted"),l.removeClass(d).addClass(c),b.sortDirection="asc",i.addClass("sorted")),b.repeater.render({clearInfinite:!0,pageIncrement:null}))})),"asc"!==t[a].sortDirection&&"desc"!==t[a].sortDirection||(e.find("th, .repeater-table-heading").removeClass("sorted"),i.addClass("sortable sorted"),"asc"===t[a].sortDirection?(l.addClass(c),this.sortDirection="asc"):(l.addClass(d),this.sortDirection="desc"),this.sortProperty="string"==typeof s?s:t[a].property),e.append(f)},p=function(e,t,a){var i=n("<tr></tr>");if(this.options.selectable&&(i.data("item_data",t[a]),"action"!==this.options.selectable)){i.addClass("selectable"),i.attr("tabindex",0);var r=this;i.on("click.lark.repeaterList",function(){(function(e){var t="multi"===e.options.selectable,a=e.options.actions,i=e.$element;if(!e.isDisabled){var r=n(this),s=n(this).index()+1,o=i.find(".frozen-column-wrapper tr:nth-child("+s+")"),l=i.find(".actions-column-wrapper tr:nth-child("+s+")"),d=i.find(".frozen-column-wrapper tr:nth-child("+s+") .checkbox-inline");r.is(".selected")?(r.removeClass("selected"),t?(d.click(),o.removeClass("selected"),a&&l.removeClass("selected")):r.find(".repeater-table-check").remove(),i.trigger("deselected.lark.repeaterList",r)):(t?(d.click(),r.addClass("selected"),o.addClass("selected"),a&&l.addClass("selected")):(e.$canvas.find(".repeater-table-check").remove(),e.$canvas.find(".repeater-table tbody tr.selected").each(function(){n(this).removeClass("selected"),i.trigger("deselected.lark.repeaterList",n(this))}),r.find("td:first").prepend('<div class="repeater-table-check"><span class="glyphicon glyphicon-ok"></span></div>'),r.addClass("selected"),o.addClass("selected")),i.trigger("selected.lark.repeaterList",r)),m.call(e)}}).call(this,r)}),i.keyup(function(e){13===e.keyCode&&i.trigger("click.lark.repeaterList")})}this.options.actions&&!this.options.selectable&&i.data("item_data",t[a]);for(var s=[],o=0,l=this.columns.length;o<l;o++)s.push(d.call(this,i,t,a,this.columns,o));if(e.append(i),this.options.columnRendered)for(var c=0,p=s.length;c<p;c++)"@_CHECKBOX_@"!==this.columns[c].property&&"@_ACTIONS_@"!==this.columns[c].property&&this.options.columnRendered({container:i,columnAttr:this.columns[c].property,item:s[c],rowData:t[a]},function(){});this.options.rowRendered&&this.options.rowRendered({container:e,item:i,rowData:t[a]},function(){})},h=function(e,t){var a,i=e.find("tbody");i.length<1&&(i=n('<tbody data-container="true"></tbody>'),e.append(i)),"string"==typeof t.error&&t.error.length>0?((a=n('<tr class="empty text-danger"><td colspan="'+this.columns.length+'"></td></tr>')).find("td").append(t.error),i.append(a)):t.items&&t.items.length<1&&((a=n('<tr class="empty"><td colspan="'+this.columns.length+'"></td></tr>')).find("td").append(this.options.noItemsHTML),i.append(a))},f=function(e,t){var a,i,r,s=t.columns||[],o=e.find("thead");if(this.firstRender||function(e,t){if(!t)return!1;if(!e||t.length!==e.length)return!0;for(var a=0,i=t.length;a<i;a++){if(!e[a])return!0;for(var r in t[a])if(t[a].hasOwnProperty(r)&&e[a][r]!==t[a][r])return!0}return!1}(this.columns,s)||0===o.length){if(o.remove(),"multi"===this.options.selectable&&!this.noItems){s.splice(0,0,{label:"c",property:"@_CHECKBOX_@",sortable:!1})}if(this.columns=s,this.firstRender=!1,this.repeater.$loader.removeClass("noHeader"),this.options.actions){var l={label:this.options.actions.label||'<span class="actions-hidden">a</span>',property:"@_ACTIONS_@",sortable:!1,width:this.actions_width};s.push(l)}for(r=(o=n('<thead data-preserve="deep"><tr></tr></thead>')).find("tr"),a=0,i=s.length;a<i;a++)c.call(this,r,s,a);if(e.prepend(o),"multi"===this.options.selectable&&!this.noItems){var d=this.repeater.$element.find(".repeater-table-wrapper .header-checkbox").outerWidth();n.grep(s,function(e){return"@_CHECKBOX_@"===e.property})[0].width=d}b.call(this,r)}},b=function(e){var t,a,i,r,s=[],o=this;if(this.options.columnSizing&&(t=0,r=0,e.find("th").each(function(){var e,a=n(this);if(void 0!==o.columns[t].width)e=o.columns[t].width,a.outerWidth(e),r+=a.outerWidth(),o.columns[t]._auto_width=e;else{var i=a.find(".repeater-table-heading").outerWidth();s.push({col:a,index:t,minWidth:i})}t++}),(a=s.length)>0)){var l=this.repeater.$canvas.find(".repeater-table-wrapper").outerWidth();for(i=Math.floor((l-r)/a),t=0;t<a;t++)s[t].minWidth>i&&(i=s[t].minWidth),s[t].col.outerWidth(i),this.columns[s[t].index]._auto_width=i}},u=function(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),a=e.indexOf("Firefox");return t>0?"ie-"+parseInt(e.substring(t+5,e.indexOf(".",t)),10):a>0?"firefox":""},m=function(){var e=".repeater-table-wrapper > table .selected",t=this.repeater.$element.find(".table-actions");"action"===this.options.selectable&&(e=".repeater-table-wrapper > table tr"),this.repeater.$canvas.find(e).length>0?t.find("thead .btn").removeAttr("disabled"):t.find("thead .btn").attr("disabled","disabled")};return s.table={name:"table",ctor:l},l});
//# sourceMappingURL=../sourcemaps/views/TableView.js.map
