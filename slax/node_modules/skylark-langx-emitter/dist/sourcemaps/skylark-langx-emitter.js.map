{"version":3,"sources":["skylark-langx-emitter.js"],"names":["define","skylark","types","objects","arrays","klass","slice","Array","prototype","compact","isDefined","isPlainObject","isFunction","isString","isEmptyObject","mixin","safeMixin","parse","event","segs","split","name","ns","join","Emitter","on","events","selector","data","callback","ctx","one","self","this","_hub","each","type","fn","undefined","forEach","parsed","push","emit","e","CustomEvent","Object","defineProperty","value","args","call","arguments","concat","eventName","listeners","len","length","reCompact","i","listener","startsWith","apply","listened","evtArr","_events","listenTo","obj","listening","listeningTo","_listeningTo","listeningEvents","listeningEvent","indexOf","listenToOnce","off","evts","liveEvents","_","unlistenTo","j","trigger","createEvent","props","attach","main"],"mappings":"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","file":"../skylark-langx-emitter.js","sourcesContent":["define('skylark-langx-emitter/Emitter',[\r\n  \"skylark-langx-ns/ns\",\r\n  \"skylark-langx-types\",\r\n  \"skylark-langx-objects\",\r\n  \"skylark-langx-arrays\",\r\n  \"skylark-langx-klass\"\r\n],function(skylark,types,objects,arrays,klass){\r\n    var slice = Array.prototype.slice,\r\n        compact = arrays.compact,\r\n        isDefined = types.isDefined,\r\n        isPlainObject = types.isPlainObject,\r\n        isFunction = types.isFunction,\r\n        isString = types.isString,\r\n        isEmptyObject = types.isEmptyObject,\r\n        mixin = objects.mixin,\r\n        safeMixin = objects.safeMixin;\r\n\r\n    function parse(event) {\r\n        var segs = (\"\" + event).split(\".\");\r\n        return {\r\n            name: segs[0],\r\n            ns: segs.slice(1).join(\" \")\r\n        };\r\n    }\r\n\r\n    var Emitter = klass({\r\n        on: function(events, selector, data, callback, ctx, /*used internally*/ one) {\r\n            var self = this,\r\n                _hub = this._hub || (this._hub = {});\r\n\r\n            if (isPlainObject(events)) {\r\n                ctx = callback;\r\n                each(events, function(type, fn) {\r\n                    self.on(type, selector, data, fn, ctx, one);\r\n                });\r\n                return this;\r\n            }\r\n\r\n            if (!isString(selector) && !isFunction(callback)) {\r\n                ctx = callback;\r\n                callback = data;\r\n                data = selector;\r\n                selector = undefined;\r\n            }\r\n\r\n            if (isFunction(data)) {\r\n                ctx = callback;\r\n                callback = data;\r\n                data = null;\r\n            }\r\n\r\n            if (isString(events)) {\r\n                events = events.split(/\\s/)\r\n            }\r\n\r\n            events.forEach(function(event) {\r\n                var parsed = parse(event),\r\n                    name = parsed.name,\r\n                    ns = parsed.ns;\r\n\r\n                (_hub[name] || (_hub[name] = [])).push({\r\n                    fn: callback,\r\n                    selector: selector,\r\n                    data: data,\r\n                    ctx: ctx,\r\n                    ns : ns,\r\n                    one: one\r\n                });\r\n            });\r\n\r\n            return this;\r\n        },\r\n\r\n        one: function(events, selector, data, callback, ctx) {\r\n            return this.on(events, selector, data, callback, ctx, 1);\r\n        },\r\n\r\n        emit: function(e /*,argument list*/ ) {\r\n            if (!this._hub) {\r\n                return this;\r\n            }\r\n\r\n            var self = this;\r\n\r\n            if (isString(e)) {\r\n                e = new CustomEvent(e);\r\n            }\r\n\r\n            Object.defineProperty(e,\"target\",{\r\n                value : this\r\n            });\r\n\r\n            var args = slice.call(arguments, 1);\r\n            if (isDefined(args)) {\r\n                args = [e].concat(args);\r\n            } else {\r\n                args = [e];\r\n            }\r\n            [e.type || e.name, \"all\"].forEach(function(eventName) {\r\n                var parsed = parse(eventName),\r\n                    name = parsed.name,\r\n                    ns = parsed.ns;\r\n\r\n                var listeners = self._hub[name];\r\n                if (!listeners) {\r\n                    return;\r\n                }\r\n\r\n                var len = listeners.length,\r\n                    reCompact = false;\r\n\r\n                for (var i = 0; i < len; i++) {\r\n                    var listener = listeners[i];\r\n                    if (ns && (!listener.ns ||  !listener.ns.startsWith(ns))) {\r\n                        continue;\r\n                    }\r\n                    if (e.data) {\r\n                        if (listener.data) {\r\n                            e.data = mixin({}, listener.data, e.data);\r\n                        }\r\n                    } else {\r\n                        e.data = listener.data || null;\r\n                    }\r\n                    listener.fn.apply(listener.ctx, args);\r\n                    if (listener.one) {\r\n                        listeners[i] = null;\r\n                        reCompact = true;\r\n                    }\r\n                }\r\n\r\n                if (reCompact) {\r\n                    self._hub[eventName] = compact(listeners);\r\n                }\r\n\r\n            });\r\n            return this;\r\n        },\r\n\r\n        listened: function(event) {\r\n            var evtArr = ((this._hub || (this._events = {}))[event] || []);\r\n            return evtArr.length > 0;\r\n        },\r\n\r\n        listenTo: function(obj, event, callback, /*used internally*/ one) {\r\n            if (!obj) {\r\n                return this;\r\n            }\r\n\r\n            // Bind callbacks on obj,\r\n            if (isString(callback)) {\r\n                callback = this[callback];\r\n            }\r\n\r\n            if (one) {\r\n                obj.one(event, callback, this);\r\n            } else {\r\n                obj.on(event, callback, this);\r\n            }\r\n\r\n            //keep track of them on listening.\r\n            var listeningTo = this._listeningTo || (this._listeningTo = []),\r\n                listening;\r\n\r\n            for (var i = 0; i < listeningTo.length; i++) {\r\n                if (listeningTo[i].obj == obj) {\r\n                    listening = listeningTo[i];\r\n                    break;\r\n                }\r\n            }\r\n            if (!listening) {\r\n                listeningTo.push(\r\n                    listening = {\r\n                        obj: obj,\r\n                        events: {}\r\n                    }\r\n                );\r\n            }\r\n            var listeningEvents = listening.events,\r\n                listeningEvent = listeningEvents[event] = listeningEvents[event] || [];\r\n            if (listeningEvent.indexOf(callback) == -1) {\r\n                listeningEvent.push(callback);\r\n            }\r\n\r\n            return this;\r\n        },\r\n\r\n        listenToOnce: function(obj, event, callback) {\r\n            return this.listenTo(obj, event, callback, 1);\r\n        },\r\n\r\n        off: function(events, callback) {\r\n            var _hub = this._hub || (this._hub = {});\r\n            if (isString(events)) {\r\n                events = events.split(/\\s/)\r\n            }\r\n\r\n            events.forEach(function(event) {\r\n                var parsed = parse(event),\r\n                    name = parsed.name,\r\n                    ns = parsed.ns;\r\n\r\n                var evts = _hub[name];\r\n\r\n                if (evts) {\r\n                    var liveEvents = [];\r\n\r\n                    if (callback || ns) {\r\n                        for (var i = 0, len = evts.length; i < len; i++) {\r\n                            \r\n                            if (callback && evts[i].fn !== callback && evts[i].fn._ !== callback) {\r\n                                liveEvents.push(evts[i]);\r\n                                continue;\r\n                            } \r\n\r\n                            if (ns && (!evts[i].ns || evts[i].ns.indexOf(ns)!=0)) {\r\n                                liveEvents.push(evts[i]);\r\n                                continue;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (liveEvents.length) {\r\n                        _hub[name] = liveEvents;\r\n                    } else {\r\n                        delete _hub[name];\r\n                    }\r\n\r\n                }\r\n            });\r\n\r\n            return this;\r\n        },\r\n        unlistenTo: function(obj, event, callback) {\r\n            var listeningTo = this._listeningTo;\r\n            if (!listeningTo) {\r\n                return this;\r\n            }\r\n            for (var i = 0; i < listeningTo.length; i++) {\r\n                var listening = listeningTo[i];\r\n\r\n                if (obj && obj != listening.obj) {\r\n                    continue;\r\n                }\r\n\r\n                var listeningEvents = listening.events;\r\n                for (var eventName in listeningEvents) {\r\n                    if (event && event != eventName) {\r\n                        continue;\r\n                    }\r\n\r\n                    var listeningEvent = listeningEvents[eventName];\r\n\r\n                    for (var j = 0; j < listeningEvent.length; j++) {\r\n                        if (!callback || callback == listeningEvent[i]) {\r\n                            listening.obj.off(eventName, listeningEvent[i], this);\r\n                            listeningEvent[i] = null;\r\n                        }\r\n                    }\r\n\r\n                    listeningEvent = listeningEvents[eventName] = compact(listeningEvent);\r\n\r\n                    if (isEmptyObject(listeningEvent)) {\r\n                        listeningEvents[eventName] = null;\r\n                    }\r\n\r\n                }\r\n\r\n                if (isEmptyObject(listeningEvents)) {\r\n                    listeningTo[i] = null;\r\n                }\r\n            }\r\n\r\n            listeningTo = this._listeningTo = compact(listeningTo);\r\n            if (isEmptyObject(listeningTo)) {\r\n                this._listeningTo = null;\r\n            }\r\n\r\n            return this;\r\n        },\r\n\r\n        trigger  : function() {\r\n            return this.emit.apply(this,arguments);\r\n        }\r\n    });\r\n\r\n    Emitter.createEvent = function (type,props) {\r\n        var e = new CustomEvent(type,props);\r\n        return safeMixin(e, props);\r\n    };\r\n\r\n    return skylark.attach(\"langx.Emitter\",Emitter);\r\n\r\n});\ndefine('skylark-langx-emitter/Evented',[\r\n  \"skylark-langx-ns/ns\",\r\n\t\"./Emitter\"\r\n],function(skylark,Emitter){\r\n\treturn skylark.attach(\"langx.Evented\",Emitter);\r\n});\ndefine('skylark-langx-emitter/main',[\r\n\t\"./Emitter\",\r\n\t\"./Evented\"\r\n],function(Emitter){\r\n\treturn Emitter;\r\n});\ndefine('skylark-langx-emitter', ['skylark-langx-emitter/main'], function (main) { return main; });\n\n"]}