{"version":3,"sources":["Coder.js"],"names":["define","skylark","langx","Widget","styler","datax","util","template","addons","Coder","klassName","pluginName","options","files","showBlank","runScripts","pane","debounce","general","[object Object]","$coderContainer","opts","this","gerneral","push","super","_init","_private","_get","key","_set","value","html","css","js","$container","_elm","paneActive","_velm","container","addClass","containerClass","paneActiveClass","on","change","bind","type","markup","load","hasFileClass","fileIndex","file","$parent","querySelector","findFile","$editor","document","createElement","innerHTML","editorContent","url","className","editorClass","appendChild","content","$textarea","setValue","status","statusLoading","fetch","err","res","statusFetchError","clearStatus","val","target","e","data","cachedContent","emit","errs","params","removeClass","preventDefault","statusType","messages","length","$status","statusClass","statusActiveClass","forEach","statusMessage","attach"],"mappings":"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","file":"../Coder.js","sourcesContent":["define([\n    'skylark-langx/skylark',\n    'skylark-langx/langx',\n    'skylark-widgets-base/Widget',\n    \"skylark-domx-styler\",\n    \"skylark-domx-data\",\n    './util',\n    './template',\n    \"./addons\"\n], function (skylark,langx,Widget, styler,datax,util, template,addons) {\n    'use strict';\n    class Coder extends Widget{\n        get klassName() {\n          return \"Coder\";\n        } \n\n        get pluginName(){\n          return \"lark.coder\";\n        } \n\n        //default options\n        get options () {\n            return {\n                files: [],\n                showBlank: false,\n                runScripts: true,\n                pane: 'result',\n                debounce: 250,\n                addons: {\n                    \"general\" : [\"render\"]\n                }\n            }\n        }\n\n        _init ($coderContainer, opts) {\n            //if (!$coderContainer) {\n            //    throw new Error(\"Can't find Coder container.\");\n            // }\n\n            var options = this.options;\n            if (options.runScripts === false) {\n                options.addons.gerneral.push('scriptless');\n            }\n\n            super._init();\n            //Widget.prototype._init.call(this);\n\n            var _private = {};\n            this._get = function (key) {\n                return _private[key];\n            };\n            this._set = function (key, value) {\n                _private[key] = value;\n                return _private[key];\n            };\n\n\n            this._set('cachedContent', {\n                html: null,\n                css: null,\n                js: null\n            });\n\n            var $container = this.$container = this._elm;\n\n            var paneActive = this._set('paneActive', options.pane);\n\n            var velm = this._velm;\n            velm.html(template.container())\n                .addClass(template.containerClass())\n                .addClass(template.paneActiveClass(paneActive))\n                .on('keyup', langx.debounce(this.change.bind(this), options.debounce))\n                .on('change', langx.debounce(this.change.bind(this), options.debounce))\n                .on('click', this.pane.bind(this));\n\n            this._set('$status', {});\n            for (let type of [\n                    'html',\n                    'css',\n                    'js'\n                ]) {\n                this.markup(type);\n            }\n        }\n\n        _startup() {\n            var options = this.options;\n            this.paneActive = this._get('paneActive');\n            for (let type of [\n                    'html',\n                    'css',\n                    'js'\n                ]) {\n                this.load(type);\n            }\n            if (options.showBlank) {\n                for (let type of [\n                        'html',\n                        'css',\n                        'js'\n                    ]) {\n                    this._velm.addClass(template.hasFileClass(type));\n                }\n            }\n\n        }\n\n        findFile(type) {\n            var file = {};\n            //var options = this._get('options');\n            var options = this.options;\n            for (let fileIndex in options.files) {\n                let file = options.files[fileIndex];\n                if (file.type === type) {\n                    return file;\n                }\n            }\n            return file;\n        }\n        markup(type) {\n            //var $container = this._get('$container');\n            var $container = this._elm;\n            var $parent = $container.querySelector(`.coder-pane-${ type }`);\n            var file = this.findFile(type);\n            var $editor = document.createElement('div');\n            $editor.innerHTML = template.editorContent(type, file.url);\n            $editor.className = template.editorClass(type);\n            $parent.appendChild($editor);\n            this._get('$status')[type] = $parent.querySelector('.coder-status');\n            if (typeof file.url !== 'undefined' || typeof file.content !== 'undefined') {\n                styler.addClass($container, template.hasFileClass(type));\n            }\n        }\n        load(type) {\n            var file = this.findFile(type);\n            //var $textarea = this._get('$container').querySelector(`.coder-pane-${ type } textarea`);\n            var $textarea = this._elm.querySelector(`.coder-pane-${ type } textarea`);\n            if (typeof file.content !== 'undefined') {\n                this.setValue($textarea, file.content);\n            } else if (typeof file.url !== 'undefined') {\n                this.status('loading', [template.statusLoading(file.url)], {\n                    type: type,\n                    file: file\n                });\n                util.fetch(file.url, (err, res) => {\n                    if (err) {\n                        this.status('error', [template.statusFetchError(err)], { type: type });\n                        return;\n                    }\n                    this.clearStatus('loading', { type: type });\n                    this.setValue($textarea, res);\n                });\n            } else {\n                this.setValue($textarea, '');\n            }\n        }\n        setValue($textarea, val) {\n            $textarea.value = val;\n            this.change({ target: $textarea });\n        }\n        change(e) {\n            var type = datax.data(e.target, 'coder-type');\n            if (!type) {\n                return;\n            }\n            var cachedContent = this._get('cachedContent');\n            if (cachedContent[type] === e.target.value) {\n                return;\n            }\n            cachedContent[type] = e.target.value;\n            this.emit('change', {\n                type: type,\n                file: datax.data(e.target, 'coder-file'),\n                content: cachedContent[type]\n            });\n        }\n        errors(errs, params) {\n            this.status('error', errs, params);\n        }\n        pane(e) {\n            if (!datax.data(e.target, 'coder-type')) {\n                return;\n            }\n            //var $container = this._get('$container');\n            var $container = this._elm;\n            var paneActive = this._get('paneActive');\n            styler.removeClass($container, template.paneActiveClass(paneActive));\n            paneActive = this._set('paneActive', datax.data(e.target, 'coder-type'));\n            styler.addClass($container, template.paneActiveClass(paneActive));\n            e.preventDefault();\n        }\n        status(statusType = 'error', messages = [], params = {}) {\n            if (!messages.length) {\n                return this.clearStatus(statusType, params);\n            }\n            var $status = this._get('$status');\n            styler.addClass($status[params.type], template.statusClass(statusType));\n            //styler.addClass(this._get('$container'), template.statusActiveClass(params.type));\n            styler.addClass(this._elm, template.statusActiveClass(params.type));\n            var markup = '';\n            messages.forEach(function (err) {\n                markup += template.statusMessage(err);\n            });\n            $status[params.type].innerHTML = markup;\n        }\n        clearStatus(statusType, params) {\n            var $status = this._get('$status');\n            styler.removeClass($status[params.type], template.statusClass(statusType));\n            //styler.removeClass(this._get('$container'), template.statusActiveClass(params.type));\n            styler.removeClass(this._elm, template.statusActiveClass(params.type));\n            $status[params.type].innerHTML = '';\n        }\n    }\n    Coder.addons = addons;\n\n    return skylark.attach(\"widgets.Coder\",Coder);\n});"]}